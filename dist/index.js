!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("react")):"function"==typeof define&&define.amd?define("ocrcc-chat-widget",["React"],t):"object"==typeof exports?exports["ocrcc-chat-widget"]=t(require("react")):e["ocrcc-chat-widget"]=t(e.React)}(window,(function(e){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/dist/",n(n.s=49)}([function(e,t,n){"use strict";var o=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;var r=o(n(55));const i=r.default.getLogger("matrix");t.logger=i,i.setLevel(r.default.levels.DEBUG)},function(e,t,n){var o=n(54);function r(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return r=function(){return e},e}e.exports=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!==o(e)&&"function"!=typeof e)return{default:e};var t=r();if(t&&t.has(e))return t.get(e);var n={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(n,s,a):n[s]=e[s]}return n.default=e,t&&t.set(e,n),n}},function(e,t,n){"use strict";var o=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.encodeParams=function(e){let t="";for(const n in e)e.hasOwnProperty(n)&&(t+="&"+encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.substring(1)},t.encodeUri=function(e,t){for(const n in t)t.hasOwnProperty(n)&&(e=e.replace(n,encodeURIComponent(t[n])));return e},t.map=function(e,t){const n=new Array(e.length);for(let o=0;o<e.length;o++)n[o]=t(e[o]);return n},t.filter=function(e,t){const n=[];for(let o=0;o<e.length;o++)t(e[o],o,e)&&n.push(e[o]);return n},t.keys=function(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(n);return t},t.values=function(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t},t.forEach=function(e,t){for(let n=0;n<e.length;n++)t(e[n],n)},t.findElement=function(e,t,n){let o;if(n){for(o=e.length-1;o>=0;o--)if(t(e[o],o,e))return e[o]}else for(o=0;o<e.length;o++)if(t(e[o],o,e))return e[o]},t.removeElement=function(e,t,n){let o,r;if(n){for(o=e.length-1;o>=0;o--)if(t(e[o],o,e))return r=e[o],e.splice(o,1),r}else for(o=0;o<e.length;o++)if(t(e[o],o,e))return r=e[o],e.splice(o,1),r;return!1},t.isFunction=function(e){return"[object Function]"==Object.prototype.toString.call(e)},t.isArray=function(e){return Array.isArray?Array.isArray(e):Boolean(e&&e.constructor===Array)},t.checkObjectHasKeys=function(e,t){for(let n=0;n<t.length;n++)if(!e.hasOwnProperty(t[n]))throw new Error("Missing required key: "+t[n])},t.checkObjectHasNoAdditionalKeys=function(e,t){for(const n in e)if(e.hasOwnProperty(n)&&-1===t.indexOf(n))throw new Error("Unknown key: "+n)},t.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},t.deepCompare=function e(t,n){if(t===n)return!0;if(typeof t!=typeof n)return!1;if("number"==typeof t&&isNaN(t)&&isNaN(n))return!0;if(null===t||null===n)return t===n;if(!(t instanceof Object))return!1;if(t.constructor!==n.constructor||t.prototype!==n.prototype)return!1;if(t instanceof RegExp||t instanceof Date)return t.toString()===n.toString();if(t instanceof Array){if(t.length!==n.length)return!1;for(let o=0;o<t.length;o++)if(!e(t[o],n[o]))return!1}else{let o;for(o in n)if(n.hasOwnProperty(o)!==t.hasOwnProperty(o))return!1;for(o in n){if(n.hasOwnProperty(o)!==t.hasOwnProperty(o))return!1;if(!e(t[o],n[o]))return!1}}return!0},t.extend=function(){const e=arguments[0]||{};for(let t=1;t<arguments.length;t++){const n=arguments[t];for(const t in n)e[t]=n[t]}return e},t.runPolyfills=function(){Array.prototype.filter||(Array.prototype.filter=function(e){if(null==this)throw new TypeError;const t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;const o=[],r=arguments.length>=2?arguments[1]:void 0;for(let i=0;i<n;i++)if(i in t){const n=t[i];e.call(r,n,i,t)&&o.push(n)}return o});Array.prototype.map||(Array.prototype.map=function(e,t){let n,o;if(null==this)throw new TypeError(" this is null or not defined");const r=Object(this),i=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");arguments.length>1&&(n=t);const s=new Array(i);for(o=0;o<i;){var a,c;o in r&&(a=r[o],c=e.call(n,a,o,r),s[o]=c),o++}return s});Array.prototype.forEach||(Array.prototype.forEach=function(e,t){let n,o;if(null==this)throw new TypeError(" this is null or not defined");const r=Object(this),i=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),o=0;o<i;){var s;o in r&&(s=r[o],e.call(n,s,o,r)),o++}})},t.inherits=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},t.polyfillSuper=function(e,t,...n){try{t.call(e,...n)}catch(o){const r=new t(...n);Object.assign(e,r)}},t.isNumber=function(e){return"number"==typeof e&&isFinite(e)},t.removeHiddenChars=function(e){return(0,r.default)(e.normalize("NFD").replace(i,""))},t.escapeRegExp=s,t.globToRegexp=function(e,t){t="boolean"!=typeof t||t;let n=s(e);n=(n=n.replace(/\\\*/g,".*")).replace(/\?/g,"."),t&&(n=n.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,n,o,r){return"["+(t?"^":"")+n.replace(/\\-/,"-")+"]"})));return n},t.ensureNoTrailingSlash=function(e){return e&&e.endsWith("/")?e.substr(0,e.length-1):e},t.sleep=function(e,t){return new Promise(n=>{setTimeout(n,e,t)})},t.isNullOrUndefined=function(e){return null==e},t.defer=function(){let e,t;const n=new Promise((n,o)=>{e=n,t=o});return{resolve:e,reject:t,promise:n}},t.promiseMapSeries=async function(e,t){for(const n of await e)await t(await n)},t.promiseTry=function(e){return new Promise(t=>t(e()))};var r=o(n(56));const i=/[\u2000-\u200F\u202A-\u202F\u0300-\u036f\uFEFF\s]/g;function s(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";var o,r="object"==typeof Reflect?Reflect:null,i=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};o=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function u(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function l(e,t,n,o){var r,i,s,a;if("function"!=typeof n)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n);if(void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),s=i[t]),void 0===s)s=i[t]=n,++e._eventsCount;else if("function"==typeof s?s=i[t]=o?[n,s]:[s,n]:o?s.unshift(n):s.push(n),(r=u(e))>0&&s.length>r&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return e}function d(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,i(this.listener,this.target,e))}function h(e,t,n){var o={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=d.bind(o);return r.listener=n,o.wrapFn=r,r}function p(e,t,n){var o=e._events;if(void 0===o)return[];var r=o[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):g(r,r.length)}function f(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),o=0;o<t;++o)n[o]=e[o];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return u(this)},a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var o="error"===e,r=this._events;if(void 0!==r)o=o&&void 0===r.error;else if(!o)return!1;if(o){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=r[e];if(void 0===c)return!1;if("function"==typeof c)i(c,this,t);else{var u=c.length,l=g(c,u);for(n=0;n<u;++n)i(l[n],this,t)}return!0},a.prototype.addListener=function(e,t){return l(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return l(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,h(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,h(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,o,r,i,s;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(o=this._events))return this;if(void 0===(n=o[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){s=n[i].listener,r=i;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(o[e]=n[0]),void 0!==o.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,n,o;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,i=Object.keys(n);for(o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(o=t.length-1;o>=0;o--)this.removeListener(e,t[o]);return this},a.prototype.listeners=function(e){return p(this,e,!0)},a.prototype.rawListeners=function(e){return p(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},a.prototype.listenerCount=f,a.prototype.eventNames=function(){return this._eventsCount>0?o(this._events):[]}},function(e,t){e.exports=function(e){return e&&e.__esModule?e:{default:e}}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixEvent=t.EventStatus=void 0;var r=n(4),i=o(n(2)),s=n(0);t.EventStatus={NOT_SENT:"not_sent",ENCRYPTING:"encrypting",SENDING:"sending",QUEUED:"queued",SENT:"sent",CANCELLED:"cancelled"};const a={};function c(e){return a[e]||(a[e]=e),a[e]}const u=function(e){["state_key","type","sender","room_id","membership"].forEach(t=>{e[t]&&(e[t]=c(e[t]))}),["membership","avatar_url","displayname"].forEach(t=>{e.content&&e.content[t]&&(e.content[t]=c(e.content[t]))}),["rel_type"].forEach(t=>{e.content&&e.content["m.relates_to"]&&e.content["m.relates_to"][t]&&(e.content["m.relates_to"][t]=c(e.content["m.relates_to"][t]))}),this.event=e||{},this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,this._pushActions=null,this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this._clearEvent={},this._senderCurve25519Key=null,this._claimedEd25519Key=null,this._forwardingCurve25519KeyChain=[],this._decryptionPromise=null,this._retryDecryption=!1};t.MatrixEvent=u,i.inherits(u,r.EventEmitter),i.extend(u.prototype,{getId:function(){return this.event.event_id},getSender:function(){return this.event.sender||this.event.user_id},getType:function(){return this._clearEvent.type||this.event.type},getWireType:function(){return this.event.type},getRoomId:function(){return this.event.room_id},getTs:function(){return this.event.origin_server_ts},getDate:function(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null},getOriginalContent:function(){return this._localRedactionEvent?{}:this._clearEvent.content||this.event.content||{}},getContent:function(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()},getWireContent:function(){return this.event.content||{}},getPrevContent:function(){return this.getUnsigned().prev_content||this.event.prev_content||{}},getDirectionalContent:function(){return this.forwardLooking?this.getContent():this.getPrevContent()},getAge:function(){return this.getUnsigned().age||this.event.age},getLocalAge:function(){return Date.now()-this.getTs()},getStateKey:function(){return this.event.state_key},isState:function(){return void 0!==this.event.state_key},makeEncrypted:function(e,t,n,o){this._clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this._senderCurve25519Key=n,this._claimedEd25519Key=o},isBeingDecrypted:function(){return null!=this._decryptionPromise},isDecryptionFailure:function(){return this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"===this._clearEvent.content.msgtype},attemptDecryption:async function(e){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"!==this._clearEvent.content.msgtype)throw new Error("Attempt to decrypt event which has already been encrypted");return this._decryptionPromise?(s.logger.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this._retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this._decryptionLoop(e),this._decryptionPromise)},cancelAndResendKeyRequest:function(e,t){const n=this.getWireContent();return e.requestRoomKey({algorithm:n.algorithm,room_id:this.getRoomId(),session_id:n.session_id,sender_key:n.sender_key},this.getKeyRequestRecipients(t),!0)},getKeyRequestRecipients:function(e){const t=this.getWireContent(),n=[{userId:e,deviceId:"*"}],o=this.getSender();return o!==e&&n.push({userId:o,deviceId:t.device_id}),n},_decryptionLoop:async function(e){for(await Promise.resolve();;){let t,n;this._retryDecryption=!1;try{t=e?await e.decryptEvent(this):this._badEncryptedMessage("Encryption not enabled")}catch(e){if("DecryptionError"!==e.name)return s.logger.error(`Error decrypting event (id=${this.getId()}): ${e.stack||e}`),this._decryptionPromise=null,void(this._retryDecryption=!1);if(n=e,this._retryDecryption){s.logger.log(`Got error decrypting event (id=${this.getId()}: `+`${e}), but retrying`);continue}s.logger.warn(`Error decrypting event (id=${this.getId()}): ${e.detailedString}`),t=this._badEncryptedMessage(e.message)}return this._decryptionPromise=null,this._retryDecryption=!1,this._setClearData(t),this.setPushActions(null),void this.emit("Event.decrypted",this,n)}},_badEncryptedMessage:function(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}},_setClearData:function(e){this._clearEvent=e.clearEvent,this._senderCurve25519Key=e.senderCurve25519Key||null,this._claimedEd25519Key=e.claimedEd25519Key||null,this._forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[]},getClearContent:function(){const e=this._clearEvent;return e&&e.content?e.content:null},isEncrypted:function(){return"m.room.encrypted"===this.event.type},getSenderKey:function(){return this._senderCurve25519Key},getKeysClaimed:function(){return{ed25519:this._claimedEd25519Key}},getClaimedEd25519Key:function(){return this._claimedEd25519Key},getForwardingCurve25519KeyChain:function(){return this._forwardingCurve25519KeyChain},getUnsigned:function(){return this.event.unsigned||{}},unmarkLocallyRedacted:function(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e},markLocallyRedacted:function(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)},makeRedacted:function(e){if(!e.event)throw new Error("invalid redaction_event in makeRedacted");let t;for(t in this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&(l[t]||delete this.event[t]);const n=d[this.getType()]||{},o=this.getContent();for(t in o)o.hasOwnProperty(t)&&(n[t]||delete o[t])},isRedacted:function(){return Boolean(this.getUnsigned().redacted_because)},isRedaction:function(){return"m.room.redaction"===this.getType()},getPushActions:function(){return this._pushActions},setPushActions:function(e){this._pushActions=e},handleRemoteEcho:function(e){const t=this.getUnsigned(),n=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit("Event.localEventIdReplaced",this)},isSending(){return!!this.status},setStatus(e){this.status=e,this.emit("Event.status",this,e)},replaceLocalEventId(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)},isRelation(e){const t=this.getWireContent(),n=t&&t["m.relates_to"];return n&&n.rel_type&&n.event_id&&(e&&n.rel_type===e||!e)},getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null},makeReplaced(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))},getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status},getServerAggregatedRelation(e){const t=this.getUnsigned()["m.relations"];if(t)return t[e]},replacingEventId(){const e=this.getServerAggregatedRelation("m.replace");return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0},replacingEvent(){return this._replacingEvent},replacingEventDate(){const e=this.getServerAggregatedRelation("m.replace");if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()},localRedactionEvent(){return this._localRedactionEvent},getAssociatedId(){const e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0},hasAssocation(){return!!this.getAssociatedId()},updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)},flagCancelled(e=!0){this._isCancelled=e},isCancelled(){return this._isCancelled},toJSON(){const e={type:this.getType(),sender:this.getSender(),content:this.getContent(),event_id:this.getId(),origin_server_ts:this.getTs(),unsigned:this.getUnsigned(),room_id:this.getRoomId()};return this.isRedaction()&&(e.redacts=this.event.redacts),this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}});const l=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce((function(e,t){return e[t]=1,e}),{}),d={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},function(e,t,n){"use strict";(function(e,o){var r=n(5),i=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.encryptMessageForDevice=async function(e,t,n,o,r,i,c){const u=i.getIdentityKey(),l=await o.getSessionIdForDevice(u);if(null===l)return;s.logger.log("Using sessionid "+l+" for device "+r+":"+i.deviceId);const d={sender:t,sender_device:n,keys:{ed25519:o.deviceEd25519Key},recipient:r,recipient_keys:{ed25519:i.getFingerprint()}};a.extend(d,c),e[u]=await o.encryptMessage(u,l,JSON.stringify(d))},t.ensureOlmSessionsForDevices=async function(e,t,n,o){const r=[],i={},a={};for(const t in n){if(!n.hasOwnProperty(t))continue;i[t]={};const s=n[t];for(let n=0;n<s.length;n++){const c=s[n],u=c.deviceId,l=c.getIdentityKey();e._sessionsInProgress[l]||(e._sessionsInProgress[l]=new Promise((t,n)=>{a[l]={resolve:(...n)=>{delete e._sessionsInProgress[l],t(...n)},reject:(...t)=>{delete e._sessionsInProgress[l],n(...t)}}}));const d=await e.getSessionIdForDevice(l,a[l]);null!==d&&a[l]&&(delete e._sessionsInProgress[l],a[l].resolve(),delete a[l]),(null===d||o)&&r.push([t,u]),i[t][u]={device:c,sessionId:d}}}if(0===r.length)return i;let c;try{c=await t.claimOneTimeKeys(r,"signed_curve25519")}catch(e){for(const e of Object.values(a))e.resolve();throw s.logger.log("failed to claim one-time keys",e,r),e}const l=c.one_time_keys||{},d=[];for(const t in n){if(!n.hasOwnProperty(t))continue;const r=l[t]||{},c=n[t];for(let n=0;n<c.length;n++){const l=c[n],h=l.deviceId,p=l.getIdentityKey();if(i[t][h].sessionId&&!o)continue;const f=r[h]||{};let g=null;for(const e in f)0===e.indexOf("signed_curve25519:")&&(g=f[e]);if(g)d.push(u(e,g,t,l).then(e=>{a[p]&&a[p].resolve(e),i[t][h].sessionId=e},e=>{throw a[p]&&a[p].resolve(),e}));else{const e="No one-time keys (alg=signed_curve25519) for device "+t+":"+h;s.logger.warn(e),a[p]&&a[p].resolve()}}}return await Promise.all(d),i},t.verifySignature=l,t.pkSign=function(t,n,o,r){let i=!1;if(n instanceof Uint8Array){const t=new e.Olm.PkSigning;r=t.init_with_seed(n),n=t,i=!0}const s=t.signatures||{};delete t.signatures;const a=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=s[o]||{};return s[o]=e,e["ed25519:"+r]=n.sign(c.default.stringify(t))}finally{t.signatures=s,a&&(t.unsigned=a),i&&n.free()}},t.pkVerify=function(t,n,o){const r="ed25519:"+n;if(!(t.signatures&&t.signatures[o]&&t.signatures[o][r]))throw new Error("No signature");const i=t.signatures[o][r],s=new e.Olm.Utility,a=t.signatures;delete t.signatures;const u=t.unsigned;t.unsigned&&delete t.unsigned;try{s.ed25519_verify(n,c.default.stringify(t),i)}finally{t.signatures=a,u&&(t.unsigned=u),s.free()}},t.encodeBase64=function(e){return o.from(e).toString("base64")},t.decodeBase64=function(e){return o.from(e,"base64")},t.MEGOLM_BACKUP_ALGORITHM=t.MEGOLM_ALGORITHM=t.OLM_ALGORITHM=void 0;var s=n(0),a=i(n(2)),c=r(n(24));t.OLM_ALGORITHM="m.olm.v1.curve25519-aes-sha2";t.MEGOLM_ALGORITHM="m.megolm.v1.aes-sha2";async function u(e,t,n,o){const r=o.deviceId;try{await l(e,t,n,r,o.getFingerprint())}catch(e){return s.logger.error("Unable to verify signature on one-time key for device "+n+":"+r+":",e),null}let i;try{i=await e.createOutboundSession(o.getIdentityKey(),t.key)}catch(e){return s.logger.error("Error starting olm session with device "+n+":"+r+": "+e),null}return s.logger.log("Started new olm sessionid "+i+" for device "+n+":"+r),i}async function l(e,t,n,o,r){const i="ed25519:"+o,s=((t.signatures||{})[n]||{})[i];if(!s)throw Error("No signature");const a=Object.assign({},t);delete a.unsigned,delete a.signatures;const u=c.default.stringify(a);e.verifySignature(r,u,s)}t.MEGOLM_BACKUP_ALGORITHM="m.megolm_backup.v1.curve25519-aes-sha2"}).call(this,n(3),n(23).Buffer)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimeline=r;var o=n(35);function r(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new o.RoomState(this._roomId),this._startState.paginationToken=null,this._endState=new o.RoomState(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}r.BACKWARDS="b",r.FORWARDS="f",r.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");for(const t of e)Object.freeze(t);this._startState.setStateEvents(e),this._endState.setStateEvents(e)},r.prototype.forkLive=function(e){const t=this.getState(e),n=new r(this._eventTimelineSet);return n._startState=t.clone(),n._endState=t,this._endState=t.clone(),n},r.prototype.fork=function(e){const t=this.getState(e),n=new r(this._eventTimelineSet);return n._startState=t.clone(),n._endState=t.clone(),n},r.prototype.getRoomId=function(){return this._roomId},r.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},r.prototype.getTimelineSet=function(){return this._eventTimelineSet},r.prototype.getBaseIndex=function(){return this._baseIndex},r.prototype.getEvents=function(){return this._events},r.prototype.getState=function(e){if(e==r.BACKWARDS)return this._startState;if(e==r.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},r.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},r.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},r.prototype.getNeighbouringTimeline=function(e){if(e==r.BACKWARDS)return this._prevTimeline;if(e==r.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},r.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==r.BACKWARDS)this._prevTimeline=e;else{if(t!=r.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},r.prototype.addEvent=function(e,t){const n=t?this._startState:this._endState,o=this.getTimelineSet();let i;o.room&&o.room.getUnfilteredTimelineSet()===o&&(r.setEventMetadata(e,n,t),e.isState()&&(n.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||r.setEventMetadata(e,n,t))),i=t?0:this._events.length,this._events.splice(i,0,e),t&&this._baseIndex++},r.setEventMetadata=function(e,t,n){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&n&&(e.forwardLooking=!1)},r.prototype.removeEvent=function(e){for(let t=this._events.length-1;t>=0;t--){const n=this._events[t];if(n.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,n}return null},r.prototype.toString=function(){return this._name}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBCryptoStore=void 0;var r=n(0),i=n(81),s=n(16),a=o(n(82)),c=n(22),u=o(n(39));class l{constructor(e,t){this._indexedDB=e,this._dbName=t,this._backendPromise=null}static exists(e,t){return u.exists(e,t)}_connect(){return this._backendPromise?this._backendPromise:(this._backendPromise=new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));r.logger.log(`connecting to indexeddb ${this._dbName}`);const n=this._indexedDB.open(this._dbName,a.VERSION);n.onupgradeneeded=e=>{const t=e.target.result,n=e.oldVersion;a.upgradeDatabase(t,n)},n.onblocked=()=>{r.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{r.logger.log("Error connecting to indexeddb",e),t(e.target.error)},n.onsuccess=t=>{const n=t.target.result;r.logger.log(`connected to indexeddb ${this._dbName}`),e(new a.Backend(n))}}).then(e=>e.doTxn("readonly",[l.STORE_INBOUND_GROUP_SESSIONS,l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(t=>{if("VersionError"===t.name)throw r.logger.warn("Crypto DB is too new for us to use!",t),new c.InvalidCryptoStoreError(c.InvalidCryptoStoreError.TOO_NEW);r.logger.warn(`unable to connect to indexeddb ${this._dbName}`+`: falling back to localStorage store: ${t}`);try{return new i.LocalStorageCryptoStore(e.localStorage)}catch(t){return r.logger.warn(`unable to open localStorage: falling back to in-memory store: ${t}`),new s.MemoryCryptoStore}}),this._backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));r.logger.log(`Removing indexeddb instance: ${this._dbName}`);const n=this._indexedDB.deleteDatabase(this._dbName);n.onblocked=()=>{r.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=e=>{r.logger.log("Error deleting data from indexeddb",e),t(e.target.error)},n.onsuccess=()=>{r.logger.log(`Removed indexeddb instance: ${this._dbName}`),e()}}).catch(e=>{r.logger.warn(`unable to delete IndexedDBCryptoStore: ${e}`)})}getOrAddOutgoingRoomKeyRequest(e){return this._connect().then(t=>t.getOrAddOutgoingRoomKeyRequest(e))}getOutgoingRoomKeyRequest(e){return this._connect().then(t=>t.getOutgoingRoomKeyRequest(e))}getOutgoingRoomKeyRequestByState(e){return this._connect().then(t=>t.getOutgoingRoomKeyRequestByState(e))}getOutgoingRoomKeyRequestsByTarget(e,t,n){return this._connect().then(o=>o.getOutgoingRoomKeyRequestsByTarget(e,t,n))}updateOutgoingRoomKeyRequest(e,t,n){return this._connect().then(o=>o.updateOutgoingRoomKeyRequest(e,t,n))}deleteOutgoingRoomKeyRequest(e,t){return this._connect().then(n=>n.deleteOutgoingRoomKeyRequest(e,t))}getAccount(e,t){this._backendPromise.then(n=>{n.getAccount(e,t)})}storeAccount(e,t){this._backendPromise.then(n=>{n.storeAccount(e,t)})}getCrossSigningKeys(e,t){this._backendPromise.then(n=>{n.getCrossSigningKeys(e,t)})}storeCrossSigningKeys(e,t){this._backendPromise.then(n=>{n.storeCrossSigningKeys(e,t)})}countEndToEndSessions(e,t){this._backendPromise.then(n=>{n.countEndToEndSessions(e,t)})}getEndToEndSession(e,t,n,o){this._backendPromise.then(r=>{r.getEndToEndSession(e,t,n,o)})}getEndToEndSessions(e,t,n){this._backendPromise.then(o=>{o.getEndToEndSessions(e,t,n)})}getAllEndToEndSessions(e,t){this._backendPromise.then(n=>{n.getAllEndToEndSessions(e,t)})}storeEndToEndSession(e,t,n,o){this._backendPromise.then(r=>{r.storeEndToEndSession(e,t,n,o)})}storeEndToEndSessionProblem(e,t,n){return this._backendPromise.then(async o=>{await o.storeEndToEndSessionProblem(e,t,n)})}getEndToEndSessionProblem(e,t){return this._backendPromise.then(async n=>await n.getEndToEndSessionProblem(e,t))}filterOutNotifiedErrorDevices(e){return this._backendPromise.then(async t=>await t.filterOutNotifiedErrorDevices(e))}getEndToEndInboundGroupSession(e,t,n,o){this._backendPromise.then(r=>{r.getEndToEndInboundGroupSession(e,t,n,o)})}getAllEndToEndInboundGroupSessions(e,t){this._backendPromise.then(n=>{n.getAllEndToEndInboundGroupSessions(e,t)})}addEndToEndInboundGroupSession(e,t,n,o){this._backendPromise.then(r=>{r.addEndToEndInboundGroupSession(e,t,n,o)})}storeEndToEndInboundGroupSession(e,t,n,o){this._backendPromise.then(r=>{r.storeEndToEndInboundGroupSession(e,t,n,o)})}storeEndToEndInboundGroupSessionWithheld(e,t,n,o){this._backendPromise.then(r=>{r.storeEndToEndInboundGroupSessionWithheld(e,t,n,o)})}storeEndToEndDeviceData(e,t){this._backendPromise.then(n=>{n.storeEndToEndDeviceData(e,t)})}getEndToEndDeviceData(e,t){this._backendPromise.then(n=>{n.getEndToEndDeviceData(e,t)})}storeEndToEndRoom(e,t,n){this._backendPromise.then(o=>{o.storeEndToEndRoom(e,t,n)})}getEndToEndRooms(e,t){this._backendPromise.then(n=>{n.getEndToEndRooms(e,t)})}getSessionsNeedingBackup(e){return this._connect().then(t=>t.getSessionsNeedingBackup(e))}countSessionsNeedingBackup(e){return this._connect().then(t=>t.countSessionsNeedingBackup(e))}unmarkSessionsNeedingBackup(e,t){return this._connect().then(n=>n.unmarkSessionsNeedingBackup(e,t))}markSessionsNeedingBackup(e,t){return this._connect().then(n=>n.markSessionsNeedingBackup(e,t))}doTxn(e,t,n){return this._connect().then(o=>o.doTxn(e,t,n))}}t.IndexedDBCryptoStore=l,l.STORE_ACCOUNT="account",l.STORE_SESSIONS="sessions",l.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",l.STORE_DEVICE_DATA="device_data",l.STORE_ROOMS="rooms",l.STORE_BACKUP="sessions_needing_backup"}).call(this,n(3))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.newVerificationError=r,t.errorFactory=i,t.errorFromEvent=function(e){const t=e.getContent();if(t){const{code:e,reason:n}=t;return{code:e,reason:n}}return{code:"Unknown error",reason:"m.unknown"}},t.newInvalidMessageError=t.newUserMismatchError=t.newKeyMismatchError=t.newUnexpectedMessageError=t.newUnknownMethodError=t.newUnknownTransactionError=t.newTimeoutError=t.newUserCancelledError=void 0;var o=n(6);function r(e,t,n){return(n=n||{}).code=e,n.reason=t,new o.MatrixEvent({type:"m.key.verification.cancel",content:n})}function i(e,t){return function(n){return r(e,t,n)}}const s=i("m.user","Cancelled by user");t.newUserCancelledError=s;const a=i("m.timeout","Timed out");t.newTimeoutError=a;const c=i("m.unknown_transaction","Unknown transaction");t.newUnknownTransactionError=c;const u=i("m.unknown_method","Unknown method");t.newUnknownMethodError=u;const l=i("m.unexpected_message","Unexpected message");t.newUnexpectedMessageError=l;const d=i("m.key_mismatch","Key mismatch");t.newKeyMismatchError=d;const h=i("m.user_error","User mismatch");t.newUserMismatchError=h;const p=i("m.invalid_message","Invalid message");t.newInvalidMessageError=p},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.User=s;var r=o(n(2)),i=n(4);function s(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this._unstable_statusMessage="",this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}r.inherits(s,i.EventEmitter),s.prototype.setPresenceEvent=function(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const n=[];(e.getContent().presence!==this.presence||t)&&n.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&n.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&n.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&n.push("User.currentlyActive"),this.presence=e.getContent().presence,n.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(let t=0;t<n.length;t++)this.emit(n[t],e,this)},s.prototype.setDisplayName=function(e){const t=this.displayName;this.displayName=e,e!==t&&this._updateModifiedTime()},s.prototype.setRawDisplayName=function(e){this.rawDisplayName=e},s.prototype.setAvatarUrl=function(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},s.prototype._updateModifiedTime=function(){this._modified=Date.now()},s.prototype.getLastModifiedTime=function(){return this._modified},s.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},s.prototype._unstable_updateStatusMessage=function(e){e.getContent()?this._unstable_statusMessage=e.getContent().status:this._unstable_statusMessage="",this._updateModifiedTime(),this.emit("User._unstable_statusMessage",this)}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixHttpApi=c,t.MatrixError=l,t.PREFIX_MEDIA_R0=t.PREFIX_IDENTITY_V2=t.PREFIX_IDENTITY_V1=t.PREFIX_UNSTABLE=t.PREFIX_R0=void 0;var r=n(67),i=o(n(2)),s=n(0),a=o(n(68));t.PREFIX_R0="/_matrix/client/r0";t.PREFIX_UNSTABLE="/_matrix/client/unstable";t.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1";t.PREFIX_IDENTITY_V2="/_matrix/identity/v2";function c(e,t){i.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}t.PREFIX_MEDIA_R0="/_matrix/media/r0",c.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){const e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(t,n){i.isFunction(n)?n={callback:n}:void 0===n&&(n={});const o=!1!==n.includeFilename,r=n.type||t.type||"application/octet-stream",c=n.name||t.name;let l=t;l.stream&&"function"!=typeof l.stream&&(s.logger.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=l.stream);let d=n.rawResponse;void 0===d&&(e.XMLHttpRequest?d=!1:(s.logger.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),d=!0));let h=n.onlyContentUri;d||void 0!==h||(e.XMLHttpRequest?(s.logger.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),h=!0):h=!1);const p={loaded:0,total:0};let f,g=null;if(d||(g=function(e){let t=JSON.parse(e);if(h&&void 0===(t=t.content_uri))throw Error("Bad response");return t}),e.XMLHttpRequest){const t=i.defer(),s=new e.XMLHttpRequest;p.xhr=s;const d=u(t,n.callback,this.opts.onlyData),h=function(){s.abort(),d(new Error("Timeout"))};s.timeout_timer=a.setTimeout(h,3e4),s.onreadystatechange=function(){switch(s.readyState){case e.XMLHttpRequest.DONE:var t;a.clearTimeout(s.timeout_timer);try{if(!s.responseText)throw new Error("No response body.");t=s.responseText,g&&(t=g(t))}catch(e){return e.http_status=s.status,void d(e)}d(void 0,s,t)}},s.upload.addEventListener("progress",(function(e){a.clearTimeout(s.timeout_timer),p.loaded=e.loaded,p.total=e.total,s.timeout_timer=a.setTimeout(h,3e4),n.progressHandler&&n.progressHandler({loaded:e.loaded,total:e.total})}));let m=this.opts.baseUrl+"/_matrix/media/r0/upload";const y=[];o&&c&&y.push("filename="+encodeURIComponent(c)),this.useAuthorizationHeader||y.push("access_token="+encodeURIComponent(this.opts.accessToken)),y.length>0&&(m+="?"+y.join("&")),s.open("POST",m),this.useAuthorizationHeader&&s.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),s.setRequestHeader("Content-Type",r),s.send(l),(f=t.promise).abort=s.abort.bind(s)}else{const e={};o&&c&&(e.filename=c),f=this.authedRequest(n.callback,"POST","/upload",e,l,{prefix:"/_matrix/media/r0",headers:{"Content-Type":r},json:!1,bodyParser:g})}const m=this,y=f.finally((function(){for(let e=0;e<m.uploads.length;++e)if(m.uploads[e]===p)return void m.uploads.splice(e,1)}));return y.abort=f.abort,p.promise=y,this.uploads.push(p),y},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,n,o,r,s){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");const a=this.opts.idBaseUrl+r+n;if(void 0!==e&&!i.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:a,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=o:"object"==typeof o&&(c.json=o),s&&(c.headers.Authorization=`Bearer ${s}`);const l=i.defer();return this.opts.request(c,u(l,e,this.opts.onlyData)),l.promise},authedRequest:function(e,t,n,o,r,i){o||(o={}),this.useAuthorizationHeader?(isFinite(i)&&(i={localTimeoutMs:i}),i||(i={}),i.headers||(i.headers={}),i.headers.Authorization||(i.headers.Authorization="Bearer "+this.opts.accessToken),o.access_token&&delete o.access_token):o.access_token||(o.access_token=this.opts.accessToken);const s=this.request(e,t,n,o,r,i),a=this;return s.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?a.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&a.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),s},request:function(e,t,n,o,r,i){const s=void 0!==(i=i||{}).prefix?i.prefix:this.opts.prefix,a=this.opts.baseUrl+s+n;return this.requestOtherUrl(e,t,a,o,r,i)},requestOtherUrl:function(e,t,n,o,r,i){return null==i?i={}:isFinite(i)&&(i={localTimeoutMs:i}),this._request(e,t,n,o,r,i)},getUrl:function(e,t,n){let o="";return t&&(o="?"+i.encodeParams(t)),this.opts.baseUrl+n+e+o},_request:function(e,t,n,o,r,s){if(void 0!==e&&!i.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);s=s||{};const c=this;if(this.opts.extraParams)for(const e in this.opts.extraParams)this.opts.extraParams.hasOwnProperty(e)&&(o[e]=this.opts.extraParams[e]);const d=i.extend({},s.headers||{}),h=void 0===s.json||s.json;let p=s.bodyParser;h&&(r&&(r=JSON.stringify(r),d["content-type"]="application/json"),d.accept||(d.accept="application/json"),void 0===p&&(p=function(e){return JSON.parse(e)}));const f=i.defer();let g,m,y=!1;const _=s.localTimeoutMs||this.opts.localTimeoutMs,v=()=>{_&&(g&&a.clearTimeout(g),g=a.setTimeout((function(){y=!0,m&&m.abort&&m.abort(),f.reject(new l({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:_}))}),_))};v();const S=f.promise;try{(m=this.opts.request({uri:n,method:t,withCredentials:!1,qs:o,qsStringifyOptions:s.qsStringifyOptions,useQuerystring:!0,body:r,json:!1,timeout:_,headers:d||{},_matrix_opts:this.opts},(function(t,n,o){if(_&&(a.clearTimeout(g),y))return;u(f,e,c.opts.onlyData,p)(t,n,o)})))&&("onprogress"in m&&(m.onprogress=e=>{v()}),m.abort&&(S.abort=m.abort.bind(m)))}catch(t){f.reject(t),e&&e(t)}return S}};const u=function(e,t,n,o){return t=t||function(){},function(i,s,a){if(!i)try{s.statusCode>=400?i=function(e,t){const n=e.statusCode,o=function(e){let t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return(0,r.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e);let i;if(o)if("application/json"===o.type){const e="object"==typeof t?t:JSON.parse(t);i=new l(e)}else"text/plain"===o.type&&(i=new Error(`Server returned ${n} error: ${t}`));i||(i=new Error(`Server returned ${n} error`));return i.httpStatus=n,i}(s,a):o&&(a=o(a))}catch(e){i=new Error(`Error parsing server response: ${e}`)}if(i)e.reject(i),t(i);else{const o={code:s.statusCode,headers:s.headers,data:a};e.resolve(n?a:o),t(null,n?a:o)}}};function l(e){e=e||{},this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}l.prototype=Object.create(Error.prototype),l.prototype.constructor=l}).call(this,n(3))},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.getHttpUriForMxc=function(e,t,n,o,i,s){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";let a=t.slice(6),c="/_matrix/media/r0/download/";const u={};n&&(u.width=Math.round(n));o&&(u.height=Math.round(o));i&&(u.method=i);r.keys(u).length>0&&(c="/_matrix/media/r0/thumbnail/");const l=a.indexOf("#");let d="";l>=0&&(d=a.substr(l),a=a.substr(0,l));return e+c+a+(0===r.keys(u).length?"":"?"+r.encodeParams(u))+d},t.getIdenticonUri=function(e,t,n,o){if(!t)return null;n||(n=96);o||(o=96);const i={width:n,height:o},s=r.encodeUri("/_matrix/media/unstable/identicon/$ident",{$ident:t});return e+s+(0===r.keys(i).length?"":"?"+r.encodeParams(i))};var r=o(n(2))},function(e,t,n){"use strict";function o(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=r.UNVERIFIED,this.known=!1,this.unsigned={},this.signatures={}}Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=o,o.fromStorage=function(e,t){const n=new o(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n},o.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}},o.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},o.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},o.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},o.prototype.isBlocked=function(){return this.verified==r.BLOCKED},o.prototype.isVerified=function(){return this.verified==r.VERIFIED},o.prototype.isUnverified=function(){return this.verified==r.UNVERIFIED},o.prototype.isKnown=function(){return 1==this.known},o.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};const r=o.DeviceVerification},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomString=function(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;++o)t+=n.charAt(Math.floor(Math.random()*n.length));return t}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryCryptoStore=void 0;var r=n(0),i=o(n(2));t.MemoryCryptoStore=class{constructor(){this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._sessions={},this._sessionProblems={},this._notifiedErrorDevices={},this._inboundGroupSessions={},this._inboundGroupSessionsWithheld={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={}}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return i.promiseTry(()=>{const n=this._getOutgoingRoomKeyRequest(t);return n?(r.logger.log("already have key request outstanding for "+`${t.room_id} / ${t.session_id}: `+"not sending another"),n):(r.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this._outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this._outgoingRoomKeyRequests)if(i.deepCompare(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this._outgoingRoomKeyRequests)for(const n of e)if(t.state===n)return Promise.resolve(t);return Promise.resolve(null)}getOutgoingRoomKeyRequestsByTarget(e,t,n){const o=[];for(const r of this._outgoingRoomKeyRequests)for(const i of n)r.state===i&&r.recipients.includes({userId:e,deviceId:t})&&o.push(r);return Promise.resolve(o)}updateOutgoingRoomKeyRequest(e,t,n){for(const o of this._outgoingRoomKeyRequests)if(o.requestId===e)return o.state!=t?(r.logger.warn(`Cannot update room key request from ${t} `+`as it was already updated to ${o.state}`),Promise.resolve(null)):(Object.assign(o,n),Promise.resolve(o));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let n=0;n<this._outgoingRoomKeyRequests.length;n++){const o=this._outgoingRoomKeyRequests[n];if(o.requestId===e)return o.state!=t?(r.logger.warn(`Cannot delete room key request in state ${o.state} `+`(expected ${t})`),Promise.resolve(null)):(this._outgoingRoomKeyRequests.splice(n,1),Promise.resolve(o))}return Promise.resolve(null)}getAccount(e,t){t(this._account)}storeAccount(e,t){this._account=t}getCrossSigningKeys(e,t){t(this._crossSigningKeys)}storeCrossSigningKeys(e,t){this._crossSigningKeys=t}countEndToEndSessions(e,t){return Object.keys(this._sessions).length}getEndToEndSession(e,t,n,o){o((this._sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,n){n(this._sessions[e]||{})}getAllEndToEndSessions(e,t){for(const e of Object.values(this._sessions))for(const n of Object.values(e))t(n)}storeEndToEndSession(e,t,n,o){let r=this._sessions[e];void 0===r&&(r={},this._sessions[e]=r),r[t]=n}async storeEndToEndSessionProblem(e,t,n){const o=this._sessionProblems[e]=this._sessionProblems[e]||[];o.push({type:t,fixed:n,time:Date.now()}),o.sort((e,t)=>e.time-t.time)}async getEndToEndSessionProblem(e,t){const n=this._sessionProblems[e]||[];if(!n.length)return null;const o=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:o.fixed});return o.fixed?null:o}async filterOutNotifiedErrorDevices(e){const t=this._notifiedErrorDevices,n=[];for(const o of e){const{userId:e,deviceInfo:r}=o;e in t?r.deviceId in t[e]||(n.push(o),t[e][r.deviceId]=!0):(n.push(o),t[e]={[r.deviceId]:!0})}return n}getEndToEndInboundGroupSession(e,t,n,o){const r=e+"/"+t;o(this._inboundGroupSessions[r]||null,this._inboundGroupSessionsWithheld[r]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this._inboundGroupSessions))t({senderKey:e.substr(0,43),sessionId:e.substr(44),sessionData:this._inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,n,o){const r=e+"/"+t;void 0===this._inboundGroupSessions[r]&&(this._inboundGroupSessions[r]=n)}storeEndToEndInboundGroupSession(e,t,n,o){this._inboundGroupSessions[e+"/"+t]=n}storeEndToEndInboundGroupSessionWithheld(e,t,n,o){const r=e+"/"+t;this._inboundGroupSessionsWithheld[r]=n}getEndToEndDeviceData(e,t){t(this._deviceData)}storeEndToEndDeviceData(e,t){this._deviceData=e}storeEndToEndRoom(e,t,n){this._rooms[e]=t}getEndToEndRooms(e,t){t(this._rooms)}getSessionsNeedingBackup(e){const t=[];for(const n in this._sessionsNeedingBackup)if(this._inboundGroupSessions[n]&&(t.push({senderKey:n.substr(0,43),sessionId:n.substr(44),sessionData:this._inboundGroupSessions[n]}),e&&n.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this._sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this._sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this._sessionsNeedingBackup[e]=!0}return Promise.resolve()}doTxn(e,t,n){return Promise.resolve(n(null))}}},function(e,t,n){"use strict";var o=n(60),r=n(62);function i(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}t.parse=v,t.resolve=function(e,t){return v(e,!1,!0).resolve(t)},t.resolveObject=function(e,t){return e?v(e,!1,!0).resolveObject(t):t},t.format=function(e){r.isString(e)&&(e=v(e));return e instanceof i?e.format():i.prototype.format.call(e)},t.Url=i;var s=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,c=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,u=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(u),d=["%","/","?",";","#"].concat(l),h=["/","?","#"],p=/^[+a-z0-9A-Z_-]{0,63}$/,f=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,g={javascript:!0,"javascript:":!0},m={javascript:!0,"javascript:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},_=n(63);function v(e,t,n){if(e&&r.isObject(e)&&e instanceof i)return e;var o=new i;return o.parse(e,t,n),o}i.prototype.parse=function(e,t,n){if(!r.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var i=e.indexOf("?"),a=-1!==i&&i<e.indexOf("#")?"?":"#",u=e.split(a);u[0]=u[0].replace(/\\/g,"/");var v=e=u.join(a);if(v=v.trim(),!n&&1===e.split("#").length){var S=c.exec(v);if(S)return this.path=v,this.href=v,this.pathname=S[1],S[2]?(this.search=S[2],this.query=t?_.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var E=s.exec(v);if(E){var b=(E=E[0]).toLowerCase();this.protocol=b,v=v.substr(E.length)}if(n||E||v.match(/^\/\/[^@\/]+@[^@\/]+/)){var w="//"===v.substr(0,2);!w||E&&m[E]||(v=v.substr(2),this.slashes=!0)}if(!m[E]&&(w||E&&!y[E])){for(var I,R,T=-1,k=0;k<h.length;k++){-1!==(O=v.indexOf(h[k]))&&(-1===T||O<T)&&(T=O)}-1!==(R=-1===T?v.lastIndexOf("@"):v.lastIndexOf("@",T))&&(I=v.slice(0,R),v=v.slice(R+1),this.auth=decodeURIComponent(I)),T=-1;for(k=0;k<d.length;k++){var O;-1!==(O=v.indexOf(d[k]))&&(-1===T||O<T)&&(T=O)}-1===T&&(T=v.length),this.host=v.slice(0,T),v=v.slice(T),this.parseHost(),this.hostname=this.hostname||"";var C="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!C)for(var D=this.hostname.split(/\./),A=(k=0,D.length);k<A;k++){var P=D[k];if(P&&!P.match(p)){for(var M="",U=0,N=P.length;U<N;U++)P.charCodeAt(U)>127?M+="x":M+=P[U];if(!M.match(p)){var L=D.slice(0,k),x=D.slice(k+1),K=P.match(f);K&&(L.push(K[1]),x.unshift(K[2])),x.length&&(v="/"+x.join(".")+v),this.hostname=L.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),C||(this.hostname=o.toASCII(this.hostname));var B=this.port?":"+this.port:"",q=this.hostname||"";this.host=q+B,this.href+=this.host,C&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==v[0]&&(v="/"+v))}if(!g[b])for(k=0,A=l.length;k<A;k++){var j=l[k];if(-1!==v.indexOf(j)){var F=encodeURIComponent(j);F===j&&(F=escape(j)),v=v.split(j).join(F)}}var $=v.indexOf("#");-1!==$&&(this.hash=v.substr($),v=v.slice(0,$));var G=v.indexOf("?");if(-1!==G?(this.search=v.substr(G),this.query=v.substr(G+1),t&&(this.query=_.parse(this.query)),v=v.slice(0,G)):t&&(this.search="",this.query={}),v&&(this.pathname=v),y[b]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){B=this.pathname||"";var V=this.search||"";this.path=B+V}return this.href=this.format(),this},i.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",o=this.hash||"",i=!1,s="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&r.isObject(this.query)&&Object.keys(this.query).length&&(s=_.stringify(this.query));var a=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||y[t])&&!1!==i?(i="//"+(i||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):i||(i=""),o&&"#"!==o.charAt(0)&&(o="#"+o),a&&"?"!==a.charAt(0)&&(a="?"+a),t+i+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+o},i.prototype.resolve=function(e){return this.resolveObject(v(e,!1,!0)).format()},i.prototype.resolveObject=function(e){if(r.isString(e)){var t=new i;t.parse(e,!1,!0),e=t}for(var n=new i,o=Object.keys(this),s=0;s<o.length;s++){var a=o[s];n[a]=this[a]}if(n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol){for(var c=Object.keys(e),u=0;u<c.length;u++){var l=c[u];"protocol"!==l&&(n[l]=e[l])}return y[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n}if(e.protocol&&e.protocol!==n.protocol){if(!y[e.protocol]){for(var d=Object.keys(e),h=0;h<d.length;h++){var p=d[h];n[p]=e[p]}return n.href=n.format(),n}if(n.protocol=e.protocol,e.host||m[e.protocol])n.pathname=e.pathname;else{for(var f=(e.pathname||"").split("/");f.length&&!(e.host=f.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==f[0]&&f.unshift(""),f.length<2&&f.unshift(""),n.pathname=f.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var g=n.pathname||"",_=n.search||"";n.path=g+_}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var v=n.pathname&&"/"===n.pathname.charAt(0),S=e.host||e.pathname&&"/"===e.pathname.charAt(0),E=S||v||n.host&&e.pathname,b=E,w=n.pathname&&n.pathname.split("/")||[],I=(f=e.pathname&&e.pathname.split("/")||[],n.protocol&&!y[n.protocol]);if(I&&(n.hostname="",n.port=null,n.host&&(""===w[0]?w[0]=n.host:w.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===f[0]?f[0]=e.host:f.unshift(e.host)),e.host=null),E=E&&(""===f[0]||""===w[0])),S)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,w=f;else if(f.length)w||(w=[]),w.pop(),w=w.concat(f),n.search=e.search,n.query=e.query;else if(!r.isNullOrUndefined(e.search)){if(I)n.hostname=n.host=w.shift(),(C=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=C.shift(),n.host=n.hostname=C.shift());return n.search=e.search,n.query=e.query,r.isNull(n.pathname)&&r.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!w.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var R=w.slice(-1)[0],T=(n.host||e.host||w.length>1)&&("."===R||".."===R)||""===R,k=0,O=w.length;O>=0;O--)"."===(R=w[O])?w.splice(O,1):".."===R?(w.splice(O,1),k++):k&&(w.splice(O,1),k--);if(!E&&!b)for(;k--;k)w.unshift("..");!E||""===w[0]||w[0]&&"/"===w[0].charAt(0)||w.unshift(""),T&&"/"!==w.join("/").substr(-1)&&w.push("");var C,D=""===w[0]||w[0]&&"/"===w[0].charAt(0);I&&(n.hostname=n.host=D?"":w.length?w.shift():"",(C=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=C.shift(),n.host=n.hostname=C.shift()));return(E=E||n.host&&w.length)&&!D&&w.unshift(""),w.length?n.pathname=w.join("/"):(n.pathname=null,n.path=null),r.isNull(n.pathname)&&r.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},i.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PushProcessor=s;var o=n(2);const r=["override","content","room","sender","underride"],i=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function s(e){const t={},n=(e,t,n)=>{for(let o=0;o<r.length;++o){const i=r[o],s=t[i];for(let t=0;t<s.length;++t){const o=s[t];if(!o.enabled)continue;const r=a(i,o,n);if(r&&this.ruleMatchesEvent(r,e))return o.kind=i,o}}return null},a=function(e,t,n){const o={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":o.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;o.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;o.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;o.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return n&&o.conditions.push({kind:"device",profile_tag:n}),o},c=function(e,t){const n={event_match:p,device:h,contains_display_name:d,room_member_count:l,sender_notification_permission:u};return!!n[e.kind]&&n[e.kind](e,t)},u=function(t,n){const o=t.key;if(!o)return!1;const r=e.getRoom(n.getRoomId());return!(!r||!r.currentState)&&r.currentState.mayTriggerNotifOfType(o,n.getSender())},l=function(t,n){if(!t.is)return!1;const o=e.getRoom(n.getRoomId());if(!o||!o.currentState||!o.currentState.members)return!1;const r=o.currentState.getJoinedMemberCount(),i=t.is.match(/^([=<>]*)([0-9]*)$/);if(!i)return!1;const s=i[1],a=parseInt(i[2]);if(isNaN(a))return!1;switch(s){case"":case"==":return r==a;case"<":return r<a;case">":return r>a;case"<=":return r<=a;case">=":return r>=a;default:return!1}},d=function(t,n){let r=n.getContent();if(n.isEncrypted()&&n.getClearContent()&&(r=n.getClearContent()),!r||!r.body||"string"!=typeof r.body)return!1;const i=e.getRoom(n.getRoomId());if(!(i&&i.currentState&&i.currentState.members&&i.currentState.getMember(e.credentials.userId)))return!1;const s=i.currentState.getMember(e.credentials.userId).name,a=new RegExp("(^|\\W)"+(0,o.escapeRegExp)(s)+"(\\W|$)","i");return r.body.search(a)>-1},h=function(e,t){return!1},p=function(e,t){if(!e.key)return!1;const n=g(e.key,t);if("string"!=typeof n)return!1;if(e.value)return e.value===n;let o;return o="content.body"==e.key?f("(^|\\W)",e.pattern,"(\\W|$)"):f("^",e.pattern,"$"),!!n.match(o)},f=function(e,n,r){return t[n]?t[n]:(t[n]=new RegExp(e+(0,o.globToRegexp)(n)+r,"i"),t[n])},g=function(e,t){const n=e.split(".");let r;const i=n[0];for("content"===i?(r=t.getContent(),n.shift()):"type"===i?(r=t.getType(),n.shift()):r=t.event;n.length>0;){const e=n.shift();if((0,o.isNullOrUndefined)(r[e]))return null;r=r[e]}return r},m=function(t,o){const r=function(t,o){if(!o||!o.device)return null;if(t.getSender()==e.credentials.userId)return null;const r=Object.keys(o.device);for(let e=0;e<r.length;++e){const t=r[e],i=o.device[t],s=n(i,t);if(s)return s}return n(t,o.global)}(t,o);if(!r)return{};const i=s.actionListToActionsObject(r.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight="content"==r.kind),i};this.ruleMatchesEvent=function(e,t){let n=!0;for(let o=0;o<e.conditions.length;++o){const r=e.conditions[o];n&=c(r,t)}return n},this.actionsForEvent=function(t){const n=function(e){const t=JSON.parse(JSON.stringify(e));e.global||(e.global={}),e.global.override||(e.global.override=[]);const n=e.global.override;for(const e of i){if(!n.find(t=>t.rule_id===e.rule_id)){const t=e.rule_id;console.warn(`Adding default global override for ${t}`),n.push(e)}}return t}(e.pushRules);return m(t,n)},this.getPushRuleById=function(t){for(const n of["device","global"])if(void 0!==e.pushRules[n])for(const o of r)if(void 0!==e.pushRules[n][o])for(const r of e.pushRules[n][o])if(r.rule_id===t)return r;return null}}s.actionListToActionsObject=function(e){const t={notify:!1,tweaks:{}};for(let n=0;n<e.length;++n){const o=e[n];"notify"===o?t.notify=!0:"object"==typeof o&&(void 0===o.value&&(o.value=!0),t.tweaks[o.set_tweak]=o.value)}return t},s.rewriteDefaultRules=function(e){let t=JSON.parse(JSON.stringify(e));return t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.override=t.global.override.map(e=>{const t=i.find(t=>t.rule_id===e.rule_id);return t?(e.default=t.default,e.conditions=t.conditions,e.actions=t.actions,e):e}),t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=i;var o=n(69);function r(e,t,n){const o=t.split(".");let r=e;for(let e=0;e<o.length-1;e++)r[o[e]]||(r[o[e]]={}),r=r[o[e]];r[o[o.length-1]]=n}function i(e,t){this.userId=e,this.filterId=t,this.definition={}}i.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0},i.LAZY_LOADING_SYNC_FILTER={room:{state:i.LAZY_LOADING_MESSAGES_FILTER}},i.prototype.getFilterId=function(){return this.filterId},i.prototype.getDefinition=function(){return this.definition},i.prototype.setDefinition=function(e){this.definition=e;const t=e.room,n={};t&&(t.rooms&&(n.rooms=t.rooms),t.rooms&&(n.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new o.FilterComponent(n),this._room_timeline_filter=new o.FilterComponent(t&&t.timeline||{})},i.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},i.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},i.prototype.setTimelineLimit=function(e){r(this.definition,"room.timeline.limit",e)},i.prototype.setIncludeLeaveRooms=function(e){r(this.definition,"room.include_leave",e)},i.fromJson=function(e,t,n){const o=new i(e,t);return o.setDefinition(n),o}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomMember=a;var r=n(4),i=n(13),s=o(n(2));function a(e,t){this.roomId=e,this.userId=t,this.typing=!1,this.name=t,this.rawDisplayName=t,this.powerLevel=0,this.powerLevelNorm=0,this.user=null,this.membership=null,this.events={member:null},this._isOutOfBand=!1,this._updateModifiedTime()}s.inherits(a,r.EventEmitter),a.prototype.markOutOfBand=function(){this._isOutOfBand=!0},a.prototype.isOutOfBand=function(){return this._isOutOfBand},a.prototype.setMembershipEvent=function(e,t){if("m.room.member"!==e.getType())return;this._isOutOfBand=!1,this.events.member=e;const n=this.membership;this.membership=e.getDirectionalContent().membership;const o=this.name;this.name=function(e,t,n){if(!t||t===e)return e;if(!s.removeHiddenChars(t))return e;if(!n)return t;let o=/@.+:.+/.test(t);o||(o=/[\u200E\u200F\u202A-\u202F]/.test(t));if(!o){const r=n.getUserIdsWithDisplayName(t);o=r.some(t=>t!==e)}if(o)return t+" ("+e+")";return t}(this.userId,e.getDirectionalContent().displayname,t),this.rawDisplayName=e.getDirectionalContent().displayname||this.userId,n!==this.membership&&(this._updateModifiedTime(),this.emit("RoomMember.membership",e,this,n)),o!==this.name&&(this._updateModifiedTime(),this.emit("RoomMember.name",e,this,o))},a.prototype.setPowerLevelEvent=function(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let n=t.users_default||0;s.forEach(s.values(t.users),(function(e){n=Math.max(n,e)}));const o=this.powerLevel,r=this.powerLevelNorm;t.users&&void 0!==t.users[this.userId]?this.powerLevel=t.users[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,n>0&&(this.powerLevelNorm=100*this.powerLevel/n),o===this.powerLevel&&r===this.powerLevelNorm||(this._updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))},a.prototype.setTypingEvent=function(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const n=e.getContent().user_ids;s.isArray(n)&&(-1!==n.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this._updateModifiedTime(),this.emit("RoomMember.typing",e,this)))},a.prototype._updateModifiedTime=function(){this._modified=Date.now()},a.prototype.getLastModifiedTime=function(){return this._modified},a.prototype.isKicked=function(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()},a.prototype.getDMInviter=function(){if(this.events.member){const e=this.events.member;let t=e.getContent(),n=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),n=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return n}},a.prototype.getAvatarUrl=function(e,t,n,o,r,s){void 0===r&&(r=!0);const a=this.getMxcAvatarUrl();if(!a&&!r)return null;const c=(0,i.getHttpUriForMxc)(e,a,t,n,o,s);return c||(r?(0,i.getIdenticonUri)(e,this.userId,t,n):null)},a.prototype.getMxcAvatarUrl=function(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReEmitter=void 0;t.ReEmitter=class{constructor(e){this.target=e,this.boundHandlers={}}_handleEvent(e,...t){this.target.emit(e,...t)}reEmit(e,t){const n=(t,...n)=>{t(...n,e)};for(const o of t){void 0===this.boundHandlers[o]&&(this.boundHandlers[o]=this._handleEvent.bind(this,o));const t=n.bind(this,this.boundHandlers[o]);e.on(o,t)}}}},function(e,t,n){"use strict";function o(e,t){const n=`Store is invalid because ${e}, `+"please stop the client, delete all data and start the client again",o=Reflect.construct(Error,[n]);return Reflect.setPrototypeOf(o,Reflect.getPrototypeOf(this)),o.reason=e,o.value=t,o}function r(e){const t=`Crypto store is invalid because ${e}, `+"please stop the client, delete all data and start the client again",n=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.name="InvalidCryptoStoreError",n}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStoreError=o,t.InvalidCryptoStoreError=r,o.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",o.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(o,Error),r.TOO_NEW="TOO_NEW",r.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(r,Error)},function(e,t,n){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var o=n(77),r=n(78),i=n(79);function s(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(e,t){if(s()<t)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=c.prototype:(null===e&&(e=new c(t)),e.length=t),e}function c(e,t,n){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return d(this,e)}return u(this,e,t,n)}function u(e,t,n,o){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,o){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(o||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===o?new Uint8Array(t):void 0===o?new Uint8Array(t,n):new Uint8Array(t,n,o);c.TYPED_ARRAY_SUPPORT?(e=t).__proto__=c.prototype:e=h(e,t);return e}(e,t,n,o):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!c.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var o=0|f(t,n),r=(e=a(e,o)).write(t,n);r!==o&&(e=e.slice(0,r));return e}(e,t,n):function(e,t){if(c.isBuffer(t)){var n=0|p(t.length);return 0===(e=a(e,n)).length?e:(t.copy(e,0,0,n),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(o=t.length)!=o?a(e,0):h(e,t);if("Buffer"===t.type&&i(t.data))return h(e,t.data)}var o;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function d(e,t){if(l(t),e=a(e,t<0?0:0|p(t)),!c.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function h(e,t){var n=t.length<0?0:0|p(t.length);e=a(e,n);for(var o=0;o<n;o+=1)e[o]=255&t[o];return e}function p(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function f(e,t){if(c.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return j(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return F(e).length;default:if(o)return j(e).length;t=(""+t).toLowerCase(),o=!0}}function g(e,t,n){var o=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return D(this,t,n);case"utf8":case"utf-8":return T(this,t,n);case"ascii":return O(this,t,n);case"latin1":case"binary":return C(this,t,n);case"base64":return R(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,t,n);default:if(o)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function m(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function y(e,t,n,o,r){if(0===e.length)return-1;if("string"==typeof n?(o=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=r?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(r)return-1;n=e.length-1}else if(n<0){if(!r)return-1;n=0}if("string"==typeof t&&(t=c.from(t,o)),c.isBuffer(t))return 0===t.length?-1:_(e,t,n,o,r);if("number"==typeof t)return t&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):_(e,[t],n,o,r);throw new TypeError("val must be string, number or Buffer")}function _(e,t,n,o,r){var i,s=1,a=e.length,c=t.length;if(void 0!==o&&("ucs2"===(o=String(o).toLowerCase())||"ucs-2"===o||"utf16le"===o||"utf-16le"===o)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(r){var l=-1;for(i=n;i<a;i++)if(u(e,i)===u(t,-1===l?0:i-l)){if(-1===l&&(l=i),i-l+1===c)return l*s}else-1!==l&&(i-=i-l),l=-1}else for(n+c>a&&(n=a-c),i=n;i>=0;i--){for(var d=!0,h=0;h<c;h++)if(u(e,i+h)!==u(t,h)){d=!1;break}if(d)return i}return-1}function v(e,t,n,o){n=Number(n)||0;var r=e.length-n;o?(o=Number(o))>r&&(o=r):o=r;var i=t.length;if(i%2!=0)throw new TypeError("Invalid hex string");o>i/2&&(o=i/2);for(var s=0;s<o;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function S(e,t,n,o){return $(j(t,e.length-n),e,n,o)}function E(e,t,n,o){return $(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,o)}function b(e,t,n,o){return E(e,t,n,o)}function w(e,t,n,o){return $(F(t),e,n,o)}function I(e,t,n,o){return $(function(e,t){for(var n,o,r,i=[],s=0;s<e.length&&!((t-=2)<0);++s)n=e.charCodeAt(s),o=n>>8,r=n%256,i.push(r),i.push(o);return i}(t,e.length-n),e,n,o)}function R(e,t,n){return 0===t&&n===e.length?o.fromByteArray(e):o.fromByteArray(e.slice(t,n))}function T(e,t,n){n=Math.min(e.length,n);for(var o=[],r=t;r<n;){var i,s,a,c,u=e[r],l=null,d=u>239?4:u>223?3:u>191?2:1;if(r+d<=n)switch(d){case 1:u<128&&(l=u);break;case 2:128==(192&(i=e[r+1]))&&(c=(31&u)<<6|63&i)>127&&(l=c);break;case 3:i=e[r+1],s=e[r+2],128==(192&i)&&128==(192&s)&&(c=(15&u)<<12|(63&i)<<6|63&s)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:i=e[r+1],s=e[r+2],a=e[r+3],128==(192&i)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&i)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(l=c)}null===l?(l=65533,d=1):l>65535&&(l-=65536,o.push(l>>>10&1023|55296),l=56320|1023&l),o.push(l),r+=d}return function(e){var t=e.length;if(t<=k)return String.fromCharCode.apply(String,e);var n="",o=0;for(;o<t;)n+=String.fromCharCode.apply(String,e.slice(o,o+=k));return n}(o)}t.Buffer=c,t.SlowBuffer=function(e){+e!=e&&(e=0);return c.alloc(+e)},t.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=s(),c.poolSize=8192,c._augment=function(e){return e.__proto__=c.prototype,e},c.from=function(e,t,n){return u(null,e,t,n)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(e,t,n){return function(e,t,n,o){return l(t),t<=0?a(e,t):void 0!==n?"string"==typeof o?a(e,t).fill(n,o):a(e,t).fill(n):a(e,t)}(null,e,t,n)},c.allocUnsafe=function(e){return d(null,e)},c.allocUnsafeSlow=function(e){return d(null,e)},c.isBuffer=function(e){return!(null==e||!e._isBuffer)},c.compare=function(e,t){if(!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,o=t.length,r=0,i=Math.min(n,o);r<i;++r)if(e[r]!==t[r]){n=e[r],o=t[r];break}return n<o?-1:o<n?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!i(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var o=c.allocUnsafe(t),r=0;for(n=0;n<e.length;++n){var s=e[n];if(!c.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(o,r),r+=s.length}return o},c.byteLength=f,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)m(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)m(this,t,t+3),m(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)m(this,t,t+7),m(this,t+1,t+6),m(this,t+2,t+5),m(this,t+3,t+4);return this},c.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?T(this,0,e):g.apply(this,arguments)},c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},c.prototype.compare=function(e,t,n,o,r){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===o&&(o=0),void 0===r&&(r=this.length),t<0||n>e.length||o<0||r>this.length)throw new RangeError("out of range index");if(o>=r&&t>=n)return 0;if(o>=r)return-1;if(t>=n)return 1;if(this===e)return 0;for(var i=(r>>>=0)-(o>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(i,s),u=this.slice(o,r),l=e.slice(t,n),d=0;d<a;++d)if(u[d]!==l[d]){i=u[d],s=l[d];break}return i<s?-1:s<i?1:0},c.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},c.prototype.indexOf=function(e,t,n){return y(this,e,t,n,!0)},c.prototype.lastIndexOf=function(e,t,n){return y(this,e,t,n,!1)},c.prototype.write=function(e,t,n,o){if(void 0===t)o="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)o=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===o&&(o="utf8")):(o=n,n=void 0)}var r=this.length-t;if((void 0===n||n>r)&&(n=r),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");o||(o="utf8");for(var i=!1;;)switch(o){case"hex":return v(this,e,t,n);case"utf8":case"utf-8":return S(this,e,t,n);case"ascii":return E(this,e,t,n);case"latin1":case"binary":return b(this,e,t,n);case"base64":return w(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,e,t,n);default:if(i)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),i=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var k=4096;function O(e,t,n){var o="";n=Math.min(e.length,n);for(var r=t;r<n;++r)o+=String.fromCharCode(127&e[r]);return o}function C(e,t,n){var o="";n=Math.min(e.length,n);for(var r=t;r<n;++r)o+=String.fromCharCode(e[r]);return o}function D(e,t,n){var o=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>o)&&(n=o);for(var r="",i=t;i<n;++i)r+=q(e[i]);return r}function A(e,t,n){for(var o=e.slice(t,n),r="",i=0;i<o.length;i+=2)r+=String.fromCharCode(o[i]+256*o[i+1]);return r}function P(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function M(e,t,n,o,r,i){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<i)throw new RangeError('"value" argument is out of bounds');if(n+o>e.length)throw new RangeError("Index out of range")}function U(e,t,n,o){t<0&&(t=65535+t+1);for(var r=0,i=Math.min(e.length-n,2);r<i;++r)e[n+r]=(t&255<<8*(o?r:1-r))>>>8*(o?r:1-r)}function N(e,t,n,o){t<0&&(t=4294967295+t+1);for(var r=0,i=Math.min(e.length-n,4);r<i;++r)e[n+r]=t>>>8*(o?r:3-r)&255}function L(e,t,n,o,r,i){if(n+o>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function x(e,t,n,o,i){return i||L(e,0,n,4),r.write(e,t,n,o,23,4),n+4}function K(e,t,n,o,i){return i||L(e,0,n,8),r.write(e,t,n,o,52,8),n+8}c.prototype.slice=function(e,t){var n,o=this.length;if((e=~~e)<0?(e+=o)<0&&(e=0):e>o&&(e=o),(t=void 0===t?o:~~t)<0?(t+=o)<0&&(t=0):t>o&&(t=o),t<e&&(t=e),c.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=c.prototype;else{var r=t-e;n=new c(r,void 0);for(var i=0;i<r;++i)n[i]=this[i+e]}return n},c.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var o=this[e],r=1,i=0;++i<t&&(r*=256);)o+=this[e+i]*r;return o},c.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var o=this[e+--t],r=1;t>0&&(r*=256);)o+=this[e+--t]*r;return o},c.prototype.readUInt8=function(e,t){return t||P(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return t||P(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return t||P(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return t||P(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return t||P(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var o=this[e],r=1,i=0;++i<t&&(r*=256);)o+=this[e+i]*r;return o>=(r*=128)&&(o-=Math.pow(2,8*t)),o},c.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var o=t,r=1,i=this[e+--o];o>0&&(r*=256);)i+=this[e+--o]*r;return i>=(r*=128)&&(i-=Math.pow(2,8*t)),i},c.prototype.readInt8=function(e,t){return t||P(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){t||P(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt16BE=function(e,t){t||P(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt32LE=function(e,t){return t||P(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return t||P(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return t||P(e,4,this.length),r.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return t||P(e,4,this.length),r.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return t||P(e,8,this.length),r.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return t||P(e,8,this.length),r.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||M(this,e,t,n,Math.pow(2,8*n)-1,0);var r=1,i=0;for(this[t]=255&e;++i<n&&(r*=256);)this[t+i]=e/r&255;return t+n},c.prototype.writeUIntBE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||M(this,e,t,n,Math.pow(2,8*n)-1,0);var r=n-1,i=1;for(this[t+r]=255&e;--r>=0&&(i*=256);)this[t+r]=e/i&255;return t+n},c.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,1,255,0),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):U(this,e,t,!0),t+2},c.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):U(this,e,t,!1),t+2},c.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):N(this,e,t,!0),t+4},c.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):N(this,e,t,!1),t+4},c.prototype.writeIntLE=function(e,t,n,o){if(e=+e,t|=0,!o){var r=Math.pow(2,8*n-1);M(this,e,t,n,r-1,-r)}var i=0,s=1,a=0;for(this[t]=255&e;++i<n&&(s*=256);)e<0&&0===a&&0!==this[t+i-1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+n},c.prototype.writeIntBE=function(e,t,n,o){if(e=+e,t|=0,!o){var r=Math.pow(2,8*n-1);M(this,e,t,n,r-1,-r)}var i=n-1,s=1,a=0;for(this[t+i]=255&e;--i>=0&&(s*=256);)e<0&&0===a&&0!==this[t+i+1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+n},c.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,1,127,-128),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):U(this,e,t,!0),t+2},c.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):U(this,e,t,!1),t+2},c.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):N(this,e,t,!0),t+4},c.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||M(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):N(this,e,t,!1),t+4},c.prototype.writeFloatLE=function(e,t,n){return x(this,e,t,!0,n)},c.prototype.writeFloatBE=function(e,t,n){return x(this,e,t,!1,n)},c.prototype.writeDoubleLE=function(e,t,n){return K(this,e,t,!0,n)},c.prototype.writeDoubleBE=function(e,t,n){return K(this,e,t,!1,n)},c.prototype.copy=function(e,t,n,o){if(n||(n=0),o||0===o||(o=this.length),t>=e.length&&(t=e.length),t||(t=0),o>0&&o<n&&(o=n),o===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-t<o-n&&(o=e.length-t+n);var r,i=o-n;if(this===e&&n<t&&t<o)for(r=i-1;r>=0;--r)e[r+t]=this[r+n];else if(i<1e3||!c.TYPED_ARRAY_SUPPORT)for(r=0;r<i;++r)e[r+t]=this[r+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+i),t);return i},c.prototype.fill=function(e,t,n,o){if("string"==typeof e){if("string"==typeof t?(o=t,t=0,n=this.length):"string"==typeof n&&(o=n,n=this.length),1===e.length){var r=e.charCodeAt(0);r<256&&(e=r)}if(void 0!==o&&"string"!=typeof o)throw new TypeError("encoding must be a string");if("string"==typeof o&&!c.isEncoding(o))throw new TypeError("Unknown encoding: "+o)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var i;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(i=t;i<n;++i)this[i]=e;else{var s=c.isBuffer(e)?e:j(new c(e,o).toString()),a=s.length;for(i=0;i<n-t;++i)this[i+t]=s[i%a]}return this};var B=/[^+\/0-9A-Za-z-_]/g;function q(e){return e<16?"0"+e.toString(16):e.toString(16)}function j(e,t){var n;t=t||1/0;for(var o=e.length,r=null,i=[],s=0;s<o;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!r){if(n>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(s+1===o){(t-=3)>-1&&i.push(239,191,189);continue}r=n;continue}if(n<56320){(t-=3)>-1&&i.push(239,191,189),r=n;continue}n=65536+(r-55296<<10|n-56320)}else r&&(t-=3)>-1&&i.push(239,191,189);if(r=null,n<128){if((t-=1)<0)break;i.push(n)}else if(n<2048){if((t-=2)<0)break;i.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;i.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return i}function F(e){return o.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(B,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function $(e,t,n,o){for(var r=0;r<o&&!(r+n>=t.length||r>=e.length);++r)t[r+n]=e[r];return r}}).call(this,n(3))},function(e,t,n){"use strict";for(var o=/[\\\"\x00-\x1F]/g,r={},i=0;i<32;++i)r[String.fromCharCode(i)]="\\U"+("0000"+i.toString(16)).slice(-4).toUpperCase();function s(e){return o.lastIndex=0,e.replace(o,(function(e){return r[e]}))}function a(e){switch(typeof e){case"string":return'"'+s(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",n="",o=0;o<e.length;++o)n+=t,t=",",n+=a(e[o]);return","!=t?"[]":n+"]"}(e):function(e){var t="{",n="",o=Object.keys(e);o.sort();for(var r=0;r<o.length;++r){var i=o[r];n+=t+'"'+s(i)+'":',t=",",n+=a(e[i])}return","!=t?"{}":n+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}r["\b"]="\\b",r["\t"]="\\t",r["\n"]="\\n",r["\f"]="\\f",r["\r"]="\\r",r['"']='\\"',r["\\"]="\\\\",e.exports={stringify:a}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.registerAlgorithm=function(e,t,n){o[e]=t,r[e]=n},t.UnknownDeviceError=t.DecryptionError=t.DecryptionAlgorithm=t.EncryptionAlgorithm=t.DECRYPTION_CLASSES=t.ENCRYPTION_CLASSES=void 0;const o={};t.ENCRYPTION_CLASSES=o;const r={};t.DECRYPTION_CLASSES=r;t.EncryptionAlgorithm=class{constructor(e){this._userId=e.userId,this._deviceId=e.deviceId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}onRoomMembership(e,t,n){}};t.DecryptionAlgorithm=class{constructor(e){this._userId=e.userId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}onRoomKeyEvent(e){}importRoomKey(e){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){}};class i extends Error{constructor(e,t,n){super(t),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let n=e.name+"[msg: "+e.message;t&&(n+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", "));return n+="]"}(this,n)}}t.DecryptionError=i;class s extends Error{constructor(e,t){super(e),this.name="UnknownDeviceError",this.devices=t}}t.UnknownDeviceError=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationRequest=t.PHASE_DONE=t.PHASE_CANCELLED=t.PHASE_STARTED=t.PHASE_REQUESTED=t.PHASE_UNSENT=t.DONE_TYPE=t.CANCEL_TYPE=t.START_TYPE=t.REQUEST_TYPE=t.EVENT_PREFIX=void 0;var o=n(0),r=n(94),i=n(4),s=n(10);const a=6e5,c=3e3,u="m.key.verification.";t.EVENT_PREFIX=u;const l=u+"request";t.REQUEST_TYPE=l;const d=u+"start";t.START_TYPE=d;const h=u+"cancel";t.CANCEL_TYPE=h;const p=u+"done";t.DONE_TYPE=p;const f=1;t.PHASE_UNSENT=f;const g=2;t.PHASE_REQUESTED=g;const m=4;t.PHASE_STARTED=m;const y=5;t.PHASE_CANCELLED=y;const _=6;t.PHASE_DONE=_;class v extends i.EventEmitter{constructor(e,t,n,o){super(),this.channel=e,this._verificationMethods=t,this._client=o,this._commonMethods=[],this._setPhase(f,!1),this._requestEvent=null,this._otherUserId=n,this._initiatedByMe=null,this._startTimestamp=null}static validateEvent(e,t,n,r){const i=t.getContent();if(!e.startsWith(u))return!1;if(e===l&&!Array.isArray(i.methods))return!1;if(!(e!==l&&e!==d||"string"==typeof i.from_device&&0!==i.from_device.length))return!1;if(Number.isFinite(n)){const e=Date.now()-n;if(e>a-c||e<-a/2)return o.logger.log("received verification that is too old or from the future"),!1}return!0}get methods(){return this._commonMethods}get timeout(){const e=Date.now()-this._startTimestamp;return Math.max(0,a-e)}get event(){return this._requestEvent}get phase(){return this._phase}get verifier(){return this._verifier}get pending(){return this._phase!==f&&this._phase!==_&&this._phase!==y}get initiatedByMe(){return this._initiatedByMe}get requestingUserId(){return this.initiatedByMe?this._client.getUserId():this._otherUserId}get receivingUserId(){return this.initiatedByMe?this._otherUserId:this._client.getUserId()}beginKeyVerification(e,t=null){if(!this._verifier&&this._hasValidPreStartPhase()){if(this._commonMethods.length&&!this._commonMethods.includes(e))throw(0,s.newUnknownMethodError)();if(this._verifier=this._createVerifier(e,null,t),!this._verifier)throw(0,s.newUnknownMethodError)()}return this._verifier}async sendRequest(){if(this._phase===f){this._initiatedByMe=!0,this._setPhase(g,!1);const e=[...this._verificationMethods.keys()];await this.channel.send(l,{methods:e}),this.emit("change")}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(this._phase!==y){if(this._verifier)return this._verifier.cancel((0,s.errorFactory)(t,e));this._setPhase(y,!1),await this.channel.send(h,{code:t,reason:e}),this.emit("change")}}waitForVerifier(){return this.verifier?Promise.resolve(this.verifier):new Promise(e=>{const t=()=>{this.verifier&&(this.off("change",t),e(this.verifier))};this.on("change",t)})}_setPhase(e,t=!0){this._phase=e,t&&this.emit("change")}async handleEvent(e,t,n){const o=t.getContent();e!==l&&e!==d||null===this._startTimestamp&&(this._startTimestamp=n),e===l?await this._handleRequest(o,t):e===d&&await this._handleStart(o,t),this._verifier&&(e===h||this._verifier.events&&this._verifier.events.includes(e))&&this._verifier.handleEvent(t),e===h?this._handleCancel():e===p&&this._handleDone()}async _handleRequest(e,t){if(this._phase===f){const n=e.methods;this._commonMethods=n.filter(e=>this._verificationMethods.has(e)),this._requestEvent=t,this._initiatedByMe=this._wasSentByMe(t),this._setPhase(g)}else this._phase!==g&&(o.logger.warn("Ignoring flagged verification request from "+t.getSender()),await this.cancel((0,s.errorFromEvent)((0,s.newUnexpectedMessageError)())))}_hasValidPreStartPhase(){return this._phase===g||this.channel.constructor.canCreateRequest(d)&&this._phase===f}async _handleStart(e,t){if(this._hasValidPreStartPhase()){const{method:n}=e;this._verificationMethods.has(n)?(this.phase===f&&(this._initiatedByMe=this._wasSentByMe(t)),this._verifier=this._createVerifier(n,t),this._setPhase(m)):await this.cancel((0,s.errorFromEvent)((0,s.newUnknownMethodError)()))}}handleVerifierSend(e,t){e===h?this._handleCancel():e===d&&(this._phase!==f&&this._phase!==g||(this._initiatedByMe=this.phase===f,this._setPhase(m)))}_handleCancel(){this._phase!==y&&this._setPhase(y)}_handleDone(){this._phase===m&&this._setPhase(_)}_createVerifier(e,t=null,n=null){const o=t&&this._wasSentByMe(t),{userId:i,deviceId:s}=this._getVerifierTarget(t,n),a=this._verificationMethods.get(e);if(a)return new a(new r.RequestCallbackChannel(this,this.channel),this._client,i,s,o?null:t);console.warn("could not find verifier constructor for method",e)}_getVerifierTarget(e,t){if(t)return t;{let t;if(e&&!this._wasSentByMe(e))t=e;else{if(!this._requestEvent||this._wasSentByMe(this._requestEvent))throw new Error("can't determine who the verifier should be targeted at. No .request or .start event and no targetDevice");t=this._requestEvent}const n=t.getSender(),o=t.getContent();return{userId:n,deviceId:o&&o.from_device}}}_wasSentByMe(e){if(e.getSender()!==this._client.getUserId())return!1;const t=e.getContent();return!(!t||t.from_device!==this._client.getDeviceId())}}t.VerificationRequest=v},function(e,t,n){"use strict";var o=Object.prototype.hasOwnProperty,r=Array.isArray,i=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),s=function(e,t){for(var n=t&&t.plainObjects?Object.create(null):{},o=0;o<e.length;++o)void 0!==e[o]&&(n[o]=e[o]);return n};e.exports={arrayToObject:s,assign:function(e,t){return Object.keys(t).reduce((function(e,n){return e[n]=t[n],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],n=[],o=0;o<t.length;++o)for(var i=t[o],s=i.obj[i.prop],a=Object.keys(s),c=0;c<a.length;++c){var u=a[c],l=s[u];"object"==typeof l&&null!==l&&-1===n.indexOf(l)&&(t.push({obj:s,prop:u}),n.push(l))}return function(e){for(;e.length>1;){var t=e.pop(),n=t.obj[t.prop];if(r(n)){for(var o=[],i=0;i<n.length;++i)void 0!==n[i]&&o.push(n[i]);t.obj[t.prop]=o}}}(t),e},decode:function(e,t,n){var o=e.replace(/\+/g," ");if("iso-8859-1"===n)return o.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(o)}catch(e){return o}},encode:function(e,t,n){if(0===e.length)return e;var o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===n)return escape(o).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var r="",s=0;s<o.length;++s){var a=o.charCodeAt(s);45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122?r+=o.charAt(s):a<128?r+=i[a]:a<2048?r+=i[192|a>>6]+i[128|63&a]:a<55296||a>=57344?r+=i[224|a>>12]+i[128|a>>6&63]+i[128|63&a]:(s+=1,a=65536+((1023&a)<<10|1023&o.charCodeAt(s)),r+=i[240|a>>18]+i[128|a>>12&63]+i[128|a>>6&63]+i[128|63&a])}return r},isBuffer:function(e){return!(!e||"object"!=typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},merge:function e(t,n,i){if(!n)return t;if("object"!=typeof n){if(r(t))t.push(n);else{if(!t||"object"!=typeof t)return[t,n];(i&&(i.plainObjects||i.allowPrototypes)||!o.call(Object.prototype,n))&&(t[n]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(n);var a=t;return r(t)&&!r(n)&&(a=s(t,i)),r(t)&&r(n)?(n.forEach((function(n,r){if(o.call(t,r)){var s=t[r];s&&"object"==typeof s&&n&&"object"==typeof n?t[r]=e(s,n,i):t.push(n)}else t[r]=n})),t):Object.keys(n).reduce((function(t,r){var s=n[r];return o.call(t,r)?t[r]=e(t[r],s,i):t[r]=s,t}),a)}}},function(t,n){t.exports=e},function(e,t,n){e.exports=n(51)()},function(e,t,n){"use strict";(function(e){var o=n(5);Object.defineProperty(t,"__esModule",{value:!0});var r={ContentHelpers:!0,request:!0,getRequest:!0,wrapRequest:!0,setCryptoStoreFactory:!0,createClient:!0,createNewMatrixCall:!0,setMatrixCallAudioOutput:!0,setMatrixCallAudioInput:!0,setMatrixCallVideoInput:!0};t.request=function(e){P=e},t.getRequest=function(){return P},t.wrapRequest=function(e){const t=P;P=function(n,o){return e(t,n,o)}},t.setCryptoStoreFactory=function(e){M=e},t.createClient=function(t){"string"==typeof t&&(t={baseUrl:t});return t.request=t.request||P,t.store=t.store||new a.MemoryStore({localStorage:e.localStorage}),t.scheduler=t.scheduler||new c.MatrixScheduler,t.cryptoStore=t.cryptoStore||M(),new u.MatrixClient(t)},Object.defineProperty(t,"createNewMatrixCall",{enumerable:!0,get:function(){return D.createNewMatrixCall}}),Object.defineProperty(t,"setMatrixCallAudioOutput",{enumerable:!0,get:function(){return D.setAudioOutput}}),Object.defineProperty(t,"setMatrixCallAudioInput",{enumerable:!0,get:function(){return D.setAudioInput}}),Object.defineProperty(t,"setMatrixCallVideoInput",{enumerable:!0,get:function(){return D.setVideoInput}}),t.ContentHelpers=void 0;var i=o(n(1)),s=n(16);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=n(31);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=n(58);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var u=n(59);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var l=n(12);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var d=n(97);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var h=n(46);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var p=n(22);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=n(6);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var g=n(33);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var m=n(36);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var y=n(8);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var _=n(34);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var v=n(20);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var S=n(35);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var E=n(11);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var b=n(19);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var w=n(98);Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var I=n(99);Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var R=n(32);Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))}));var T=n(100);Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))}));var k=n(103);Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))}));var O=n(9);Object.keys(O).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))}));var C=n(13);Object.keys(C).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(r,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return C[e]}}))}));var D=n(37);const A=Promise.resolve().then(()=>(0,i.default)(n(38)));let P;t.ContentHelpers=A;let M=()=>new s.MemoryCryptoStore}).call(this,n(3))},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryStore=s;var r=n(11),i=o(n(2));function s(e){e=e||{},this.rooms={},this.groups={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage,this._oobMembers={},this._clientOptions={}}s.prototype={getSyncToken:function(){return this.syncToken},isNewlyCreated:function(){return Promise.resolve(!0)},setSyncToken:function(e){this.syncToken=e},storeGroup:function(e){this.groups[e.groupId]=e},getGroup:function(e){return this.groups[e]||null},getGroups:function(){return i.values(this.groups)},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));const t=this;e.currentState.getMembers().forEach((function(n){t._onRoomMember(null,e.currentState,n)}))},_onRoomMember:function(e,t,n){if("invite"===n.membership)return;const o=this.users[n.userId]||new r.User(n.userId);n.name&&(o.setDisplayName(n.name),n.events.member&&o.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&o.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[o.userId]=o},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return i.values(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return i.map(i.values(this.rooms),(function(e){return e.summary}))},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return i.values(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,n,o){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;try{return this.localStorage.getItem("mxjssdk_memory_filter_"+e)}catch(e){}return null},setFilterIdByName:function(e,t){if(this.localStorage)try{this.localStorage.setItem("mxjssdk_memory_filter_"+e,t)}catch(e){}},storeAccountDataEvents:function(e){const t=this;e.forEach((function(e){t.accountData[e.getType()]=e}))},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(e){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()},getOutOfBandMembers:function(e){return Promise.resolve(this._oobMembers[e]||null)},setOutOfBandMembers:function(e,t){return this._oobMembers[e]=t,Promise.resolve()},clearOutOfBandMembers:function(){return this._oobMembers={},Promise.resolve()},getClientOptions:function(){return Promise.resolve(this._clientOptions)},storeClientOptions:function(e){return this._clientOptions=Object.assign({},e),Promise.resolve()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SERVICE_TYPES=void 0;const o=Object.freeze({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"});t.SERVICE_TYPES=o},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.Room=m;var r=n(4),i=n(34),s=n(8),a=n(13),c=o(n(2)),u=n(6),l=n(20),d=n(73),h=n(0),p=n(21);const f=["1","2","3","4","5"];function g(e,t,n){const o={content:{},type:"m.receipt",room_id:t.getRoomId()};return o.content[t.getId()]={},o.content[t.getId()][n]={},o.content[t.getId()][n][e]={ts:t.getTs()},new u.MatrixEvent(o)}function m(e,t,n,o){if((o=o||{}).pendingEventOrdering=o.pendingEventOrdering||"chronological",this.reEmitter=new p.ReEmitter(this),-1===["chronological","detached"].indexOf(o.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+o.pendingEventOrdering+"'");this.myUserId=n,this.roomId=e,this.name=e,this.tags={},this.accountData={},this.summary=null,this.storageToken=o.storageToken,this._opts=o,this._txnToEvent={},this._receipts={},this._receiptCacheByEventId={},this._realReceipts={},this._notificationCounts={},this._timelineSets=[new i.EventTimelineSet(this,o)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this._fixUpLegacyTimelineFields(),this._filteredTimelineSets={},"detached"==this._opts.pendingEventOrdering&&(this._pendingEventList=[]),this._blacklistUnverifiedDevices=null,this._selfMembership=null,this._summaryHeroes=null,this._client=t,this._opts.lazyLoadMembers?this._membersPromise=null:this._membersPromise=Promise.resolve()}c.inherits(m,r.EventEmitter),m.prototype.getVersion=function(){const e=this.currentState.getStateEvents("m.room.create","");if(!e)return h.logger.warn("Room "+this.room_id+" does not have an m.room.create event"),"1";const t=e.getContent().room_version;return void 0===t?"1":t},m.prototype.shouldUpgradeToVersion=function(){return f.includes(this.getVersion())?null:"5"},m.prototype.getRecommendedVersion=async function(){let e=(await this._client.getCapabilities())["m.room_versions"];if(!e){e={default:"5",available:{}};for(const t of f)e.available[t]="stable"}let t=this._checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){if(h.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),!(e=(await this._client.getCapabilities(!0))["m.room_versions"]))return h.logger.warn("No room version capability - assuming upgrade required."),t;t=this._checkVersionAgainstCapability(e)}return t},m.prototype._checkVersionAgainstCapability=function(e){const t=this.getVersion();h.logger.log(`[${this.roomId}] Current version: ${t}`),h.logger.log(`[${this.roomId}] Version capability: `,e);const n={version:t,needsUpgrade:!1,urgent:!1};return t===e.default?n:Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)?n:(n.version=e.default,n.needsUpgrade=!0,n.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),n.urgent?h.logger.warn(`URGENT upgrade required on ${this.roomId}`):h.logger.warn(`Non-urgent upgrade required on ${this.roomId}`),n)},m.prototype.userMayUpgradeRoom=function(e){return this.currentState.maySendStateEvent("m.room.tombstone",e)},m.prototype.getPendingEvents=function(){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList},m.prototype.hasPendingEvent=function(e){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call hasPendingEvent with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList.some(t=>t.getId()===e)},m.prototype.getLiveTimeline=function(){return this.getUnfilteredTimelineSet().getLiveTimeline()},m.prototype.getLastActiveTimestamp=function(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER},m.prototype.getMyMembership=function(){return this._selfMembership},m.prototype.getDMInviter=function(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this._selfMembership){if(2==this.getInvitedAndJoinedMemberCount()&&this._summaryHeroes.length)return this._summaryHeroes[0]}},m.prototype.guessDMUserId=function(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length)return this._summaryHeroes[0];const t=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return t?t.userId:this.myUserId},m.prototype.getAvatarFallbackMember=function(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length;if(e){const e=this._summaryHeroes.map(e=>this.getMember(e)).find(e=>!!e);if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find(e=>e.userId!==this.myUserId);if(e)return e}if(e){const e=this._summaryHeroes.map(e=>this._client.getUser(e)).find(e=>!!e);if(e){const t=new l.RoomMember(this.roomId,e.userId);return t.user=e,t}}},m.prototype.updateMyMembership=function(e){const t=this._selfMembership;this._selfMembership=e,t!==e&&("leave"===e&&this._cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))},m.prototype._loadMembersFromServer=async function(){const e=this._client.store.getSyncToken(),t=c.encodeParams({not_membership:"leave",at:e}),n=c.encodeUri("/rooms/$roomId/members?"+t,{$roomId:this.roomId}),o=this._client._http;return(await o.authedRequest(void 0,"GET",n)).chunk},m.prototype._loadMembers=async function(){let e=!1,t=await this._client.store.getOutOfBandMembers(this.roomId);return null===t&&(e=!0,t=await this._loadMembersFromServer(),h.logger.log(`LL: got ${t.length} `+`members from server for room ${this.roomId}`)),{memberEvents:t.map(this._client.getEventMapper()),fromServer:e}},m.prototype.loadMembersIfNeeded=function(){if(this._membersPromise)return this._membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this._loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this._client.isCryptoEnabled()&&this._client.isRoomEncrypted(this.roomId)&&this._client._crypto.trackRoomDevices(this.roomId),e.fromServer)).catch(e=>{throw this._membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){const e=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>e.events.member.event);return h.logger.log(`LL: telling store to write ${e.length}`+` members for room ${this.roomId}`),this._client.store.setOutOfBandMembers(this.roomId,e).catch(e=>{h.logger.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{h.logger.error(e)}),this._membersPromise=e,this._membersPromise},m.prototype.clearLoadedMembersIfNeeded=async function(){this._opts.lazyLoadMembers&&this._membersPromise&&(await this.loadMembersIfNeeded(),await this._client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this._membersPromise=null)},m.prototype._cleanupAfterLeaving=function(){this.clearLoadedMembersIfNeeded().catch(e=>{h.logger.error("error after clearing loaded members from "+`room ${this.roomId} after leaving`),h.logger.log(e)})},m.prototype.resetLiveTimeline=function(e,t){for(let n=0;n<this._timelineSets.length;n++)this._timelineSets[n].resetLiveTimeline(e,t);this._fixUpLegacyTimelineFields()},m.prototype._fixUpLegacyTimelineFields=function(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(s.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(s.EventTimeline.FORWARDS)},m.prototype.hasUnverifiedDevices=async function(){if(!this._client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){if((await this._client.getStoredDevicesForUser(t.userId)).some(e=>e.isUnverified()))return!0}return!1},m.prototype.getTimelineSets=function(){return this._timelineSets},m.prototype.getUnfilteredTimelineSet=function(){return this._timelineSets[0]},m.prototype.getTimelineForEvent=function(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)},m.prototype.addTimeline=function(){return this.getUnfilteredTimelineSet().addTimeline()},m.prototype.findEventById=function(e){return this.getUnfilteredTimelineSet().findEventById(e)},m.prototype.getUnreadNotificationCount=function(e){return e=e||"total",this._notificationCounts[e]},m.prototype.setUnreadNotificationCount=function(e,t){this._notificationCounts[e]=t},m.prototype.setSummary=function(e){const t=e["m.heroes"],n=e["m.joined_member_count"],o=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(o)&&this.currentState.setInvitedMemberCount(o),Array.isArray(t)&&(this._summaryHeroes=t.filter(e=>e!==this.myUserId))},m.prototype.setBlacklistUnverifiedDevices=function(e){this._blacklistUnverifiedDevices=e},m.prototype.getBlacklistUnverifiedDevices=function(){return this._blacklistUnverifiedDevices},m.prototype.getAvatarUrl=function(e,t,n,o,r){const i=this.currentState.getStateEvents("m.room.avatar","");if(void 0===r&&(r=!0),!i&&!r)return null;const s=i?i.getContent().url:null;return s?(0,a.getHttpUriForMxc)(e,s,t,n,o):r?(0,a.getIdenticonUri)(e,this.roomId,t,n):null},m.prototype.getAliases=function(){const e=[],t=this.currentState.getStateEvents("m.room.aliases");if(t)for(let n=0;n<t.length;++n){const o=t[n];if(c.isArray(o.getContent().aliases)){const t=o.getContent().aliases.filter(e=>"string"==typeof e&&("#"===e[0]&&!!e.endsWith(`:${o.getStateKey()}`)));Array.prototype.push.apply(e,t)}}return e},m.prototype.getCanonicalAlias=function(){const e=this.currentState.getStateEvents("m.room.canonical_alias","");return e?e.getContent().alias:null},m.prototype.addEventsToTimeline=function(e,t,n,o){n.getTimelineSet().addEventsToTimeline(e,t,n,o)},m.prototype.getMember=function(e){return this.currentState.getMember(e)},m.prototype.getJoinedMembers=function(){return this.getMembersWithMembership("join")},m.prototype.getJoinedMemberCount=function(){return this.currentState.getJoinedMemberCount()},m.prototype.getInvitedMemberCount=function(){return this.currentState.getInvitedMemberCount()},m.prototype.getInvitedAndJoinedMemberCount=function(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()},m.prototype.getMembersWithMembership=function(e){return c.filter(this.currentState.getMembers(),(function(t){return t.membership===e}))},m.prototype.getEncryptionTargetMembers=async function(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e},m.prototype.shouldEncryptForInvitedMembers=function(){const e=this.currentState.getStateEvents("m.room.history_visibility","");return e&&e.getContent()&&"joined"!==e.getContent().history_visibility},m.prototype.getDefaultRoomName=function(e){return _(this,e,!0)},m.prototype.hasMembershipState=function(e,t){const n=this.getMember(e);return!!n&&n.membership===t},m.prototype.getOrCreateFilteredTimelineSet=function(e){if(this._filteredTimelineSets[e.filterId])return this._filteredTimelineSets[e.filterId];const t=Object.assign({filter:e},this._opts),n=new i.EventTimelineSet(this,t);this.reEmitter.reEmit(n,["Room.timeline","Room.timelineReset"]),this._filteredTimelineSets[e.filterId]=n,this._timelineSets.push(n);const o=this.getLiveTimeline();o.getEvents().forEach((function(e){n.addLiveEvent(e)}));let r=o;for(;r.getNeighbouringTimeline(s.EventTimeline.BACKWARDS);)r=r.getNeighbouringTimeline(s.EventTimeline.BACKWARDS);return n.getLiveTimeline().setPaginationToken(r.getPaginationToken(s.EventTimeline.BACKWARDS),s.EventTimeline.BACKWARDS),n},m.prototype.removeFilteredTimelineSet=function(e){const t=this._filteredTimelineSets[e.filterId];delete this._filteredTimelineSets[e.filterId];const n=this._timelineSets.indexOf(t);n>-1&&this._timelineSets.splice(n,1)},m.prototype._addLiveEvent=function(e,t){if(e.isRedaction()){const t=e.event.redacts,n=this.getUnfilteredTimelineSet().findEventById(t);if(n){if(n.makeRedacted(e),n.getStateKey()){this.currentState.getStateEvents(n.getType(),n.getStateKey()).getId()===n.getId()&&this.currentState.setStateEvents([n])}this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){const t=this._txnToEvent[e.getUnsigned().transaction_id];if(t)return void this._handleRemoteEcho(e,t)}for(let n=0;n<this._timelineSets.length;n++)this._timelineSets[n].addLiveEvent(e,t);e.sender&&"m.room.redaction"!==e.getType()&&this.addReceipt(g(e.sender.userId,e,"m.read"),!0)},m.prototype.addPendingEvent=function(e,t){if(e.status!==u.EventStatus.SENDING)throw new Error("addPendingEvent called on an event with status "+e.status);if(this._txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(s.EventTimeline.setEventMetadata(e,this.getLiveTimeline().getState(s.EventTimeline.FORWARDS),!1),this._txnToEvent[t]=e,"detached"==this._opts.pendingEventOrdering){if(this._pendingEventList.some(e=>e.status===u.EventStatus.NOT_SENT)&&(h.logger.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(u.EventStatus.NOT_SENT)),this._pendingEventList.push(e),e.isRelation()&&this._aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let n=this._pendingEventList&&this._pendingEventList.find(e=>e.getId()===t);n||(n=this.getUnfilteredTimelineSet().findEventById(t)),n&&(n.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}}else for(let t=0;t<this._timelineSets.length;t++){const n=this._timelineSets[t];n.getFilter()?n.getFilter().filterRoomTimeline([e]).length&&n.addEventToTimeline(e,n.getLiveTimeline(),!1):n.addEventToTimeline(e,n.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)},m.prototype._aggregateNonLiveRelation=function(e){for(let t=0;t<this._timelineSets.length;t++){const n=this._timelineSets[t];n.getFilter()?n.getFilter().filterRoomTimeline([e]).length&&n.aggregateRelations(e):n.aggregateRelations(e)}},m.prototype._handleRemoteEcho=function(e,t){const n=t.getId(),o=e.getId(),r=t.status;delete this._txnToEvent[e.getUnsigned().transaction_id],this._pendingEventList&&c.removeElement(this._pendingEventList,(function(e){return e.getId()==n}),!1),t.handleRemoteEcho(e.event);for(let e=0;e<this._timelineSets.length;e++){this._timelineSets[e].handleRemoteEcho(t,n,o)}this.emit("Room.localEchoUpdated",t,this,n,r)};const y={};function _(e,t,n){if(!n){const t=e.currentState.getStateEvents("m.room.name","");if(t&&t.getContent()&&t.getContent().name)return t.getContent().name}let o=e.getCanonicalAlias();if(!o){const t=e.getAliases();t.length&&(o=t[0])}if(o)return o;const r=e.currentState.getJoinedMemberCount()+e.currentState.getInvitedMemberCount()-1;let i=null;if(e._summaryHeroes)i=e._summaryHeroes.map(t=>{const n=e.getMember(t);return n?n.name:t});else{let n=e.currentState.getMembers().filter(e=>e.userId!==t&&("invite"===e.membership||"join"===e.membership));n.sort((e,t)=>e.userId.localeCompare(t.userId)),i=(n=n.slice(0,5)).map(e=>e.name)}if(r)return v(i,r);if("join"==e.getMyMembership()){const t=e.currentState.getStateEvents("m.room.third_party_invite");if(t&&t.length){return`Inviting ${v(t.map(e=>e.getContent().display_name))}`}}let s=i;return s.length||(s=e.currentState.getMembers().filter(e=>e.userId!==t&&"invite"!==e.membership&&"join"!==e.membership).map(e=>e.name)),s.length?`Empty room (was ${v(s)})`:"Empty room"}function v(e,t=e.length+1){const n=t-1;if(e.length){if(1===e.length&&n<=1)return e[0];if(2===e.length&&n<=2)return`${e[0]} and ${e[1]}`;return n>1?`${e[0]} and ${n} others`:`${e[0]} and 1 other`}return"Empty room"}y[u.EventStatus.ENCRYPTING]=[u.EventStatus.SENDING,u.EventStatus.NOT_SENT],y[u.EventStatus.SENDING]=[u.EventStatus.ENCRYPTING,u.EventStatus.QUEUED,u.EventStatus.NOT_SENT,u.EventStatus.SENT],y[u.EventStatus.QUEUED]=[u.EventStatus.SENDING,u.EventStatus.CANCELLED],y[u.EventStatus.SENT]=[],y[u.EventStatus.NOT_SENT]=[u.EventStatus.SENDING,u.EventStatus.QUEUED,u.EventStatus.CANCELLED],y[u.EventStatus.CANCELLED]=[],m.prototype.updatePendingEvent=function(e,t,n){if(h.logger.log(`setting pendingEvent status to ${t} in ${e.getRoomId()}`),t==u.EventStatus.SENT&&!n)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==u.EventStatus.SENT){if(this.getUnfilteredTimelineSet().eventIdToTimeline(n))return}const o=e.status,r=e.getId();if(!o)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const i=y[o];if(!i||i.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+o+"->"+t);if(e.setStatus(t),t==u.EventStatus.SENT){e.replaceLocalEventId(n);for(let e=0;e<this._timelineSets.length;e++)this._timelineSets[e].replaceEventId(r,n)}else if(t==u.EventStatus.CANCELLED){if(this._pendingEventList){const e=this._pendingEventList.findIndex(e=>e.getId()===r);if(-1!==e){const[t]=this._pendingEventList.splice(e,1);t.isRedaction()&&this._revertRedactionLocalEcho(t)}}this.removeEvent(r)}this.emit("Room.localEchoUpdated",e,this,r,o)},m.prototype._revertRedactionLocalEcho=function(e){const t=e.event.redacts;if(!t)return;const n=this.getUnfilteredTimelineSet().findEventById(t);n&&(n.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),n.isRelation()&&this._aggregateNonLiveRelation(n))},m.prototype.addLiveEvents=function(e,t){let n;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this._timelineSets.length;n++){const e=this._timelineSets[n].getLiveTimeline();if(e.getPaginationToken(s.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+e.getPaginationToken(s.EventTimeline.FORWARDS)+")");if(e.getNeighbouringTimeline(s.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++)this._addLiveEvent(e[n],t)},m.prototype.addEphemeralEvents=function(e){for(const t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)},m.prototype.removeEvents=function(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])},m.prototype.removeEvent=function(e){let t=!1;for(let n=0;n<this._timelineSets.length;n++){const o=this._timelineSets[n].removeEvent(e);o&&(o.isRedaction()&&this._revertRedactionLocalEcho(o),t=!0)}return t},m.prototype.recalculate=function(){const e=this,t=this.currentState.getStateEvents("m.room.member",this.myUserId);if(t&&"invite"===t.getContent().membership){const n=t.event.invite_room_state||[];c.forEach(n,(function(t){e.currentState.getStateEvents(t.type,t.state_key)||e.currentState.setStateEvents([new u.MatrixEvent({type:t.type,state_key:t.state_key,content:t.content,event_id:"$fake"+Date.now(),room_id:e.roomId,user_id:e.myUserId})])}))}const n=this.name;this.name=_(this,this.myUserId),this.summary=new d.RoomSummary(this.roomId,{title:this.name}),n!==this.name&&this.emit("Room.name",this)},m.prototype.getUsersReadUpTo=function(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))},m.prototype.getEventReadUpTo=function(e,t){let n=this._receipts;return t&&(n=this._realReceipts),void 0===n["m.read"]||void 0===n["m.read"][e]?null:n["m.read"][e].eventId},m.prototype.hasUserReadEvent=function(e,t){const n=this.getEventReadUpTo(e,!1);if(n===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=this.timeline.length-1;e>=0;--e){const o=this.timeline[e];if(o.getId()===t)return!1;if(o.getId()===n)return!0}return!1},m.prototype.getReceiptsForEvent=function(e){return this._receiptCacheByEventId[e.getId()]||[]},m.prototype.addReceipt=function(e,t){void 0===t&&(t=!1),t||this._addReceiptsToStructure(e,this._realReceipts),this._addReceiptsToStructure(e,this._receipts),this._receiptCacheByEventId=this._buildReceiptCache(this._receipts),this.emit("Room.receipt",e,this)},m.prototype._addReceiptsToStructure=function(e,t){const n=this;c.keys(e.getContent()).forEach((function(o){c.keys(e.getContent()[o]).forEach((function(r){c.keys(e.getContent()[o][r]).forEach((function(i){const s=e.getContent()[o][r][i];t[r]||(t[r]={});const a=t[r][i];if(a){const e=n.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,o);if(null!==e&&e>=0)return}else t[r][i]={};t[r][i]={eventId:o,data:s}}))}))}))},m.prototype._buildReceiptCache=function(e){const t={};return c.keys(e).forEach((function(n){c.keys(e[n]).forEach((function(o){const r=e[n][o];t[r.eventId]||(t[r.eventId]=[]),t[r.eventId].push({userId:o,type:n,data:r.data})}))})),t},m.prototype._addLocalEchoReceipt=function(e,t,n){this.addReceipt(g(e,t,n),!0)},m.prototype.addTags=function(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)},m.prototype.addAccountData=function(e){for(let t=0;t<e.length;t++){const n=e[t];"m.tag"===n.getType()&&this.addTags(n),this.accountData[n.getType()]=n,this.emit("Room.accountData",n,this)}},m.prototype.getAccountData=function(e){return this.accountData[e]},m.prototype.maySendMessage=function(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent("m.room.message",this.myUserId)}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimelineSet=d;var r=n(4),i=n(8),s=n(6),a=o(n(2)),c=n(0),u=n(71);let l;function d(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new i.EventTimeline(this),this._unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null,this._unstableClientRelationAggregation&&(this._relations={})}l=c.logger.log.bind(c.logger),a.inherits(d,r.EventEmitter),d.prototype.getTimelines=function(){return this._timelines},d.prototype.getFilter=function(){return this._filter},d.prototype.setFilter=function(e){this._filter=e},d.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},d.prototype.getLiveTimeline=function(){return this._liveTimeline},d.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},d.prototype.replaceEventId=function(e,t){const n=this._eventIdToTimeline[e];n&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=n)},d.prototype.resetLiveTimeline=function(e,t){const n=!this._timelineSupport||!t,o=this._liveTimeline,r=n?o.forkLive(i.EventTimeline.FORWARDS):o.fork(i.EventTimeline.FORWARDS);n?(this._timelines=[r],this._eventIdToTimeline={}):this._timelines.push(r),t&&o.setPaginationToken(t,i.EventTimeline.FORWARDS),r.setPaginationToken(e,i.EventTimeline.BACKWARDS),this._liveTimeline=r,this.emit("Room.timelineReset",this.room,this,n)},d.prototype.getTimelineForEvent=function(e){const t=this._eventIdToTimeline[e];return void 0===t?null:t},d.prototype.findEventById=function(e){const t=this.getTimelineForEvent(e);if(t)return a.findElement(t.getEvents(),(function(t){return t.getId()==e}))},d.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new i.EventTimeline(this);return this._timelines.push(e),e},d.prototype.addEventsToTimeline=function(e,t,n,o){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this._filter&&!(e=this._filter.filterRoomTimeline(e)).length)return;const r=t?i.EventTimeline.BACKWARDS:i.EventTimeline.FORWARDS,s=t?i.EventTimeline.FORWARDS:i.EventTimeline.BACKWARDS;let a=!1,u=!1;for(let o=0;o<e.length;o++){const d=e[o],h=d.getId(),p=this._eventIdToTimeline[h];if(!p){this.addEventToTimeline(d,n,t),u=!0,a=!0;continue}if(u=!1,p==n){l("Event "+h+" already in timeline "+n);continue}const f=n.getNeighbouringTimeline(r);if(f){l(p==f?"Event "+h+" in neighbouring timeline - switching to "+p:"Event "+h+" already in a different timeline "+p),n=p;continue}c.logger.info("Already have timeline for "+h+" - joining timeline "+n+" to "+p);const g=p===this._liveTimeline,m=n===this._liveTimeline,y=r===i.EventTimeline.BACKWARDS&&g,_=r===i.EventTimeline.FORWARDS&&m;y||_?(y&&c.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+p+")"),_&&c.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")")):(n.setNeighbouringTimeline(p,r),p.setNeighbouringTimeline(n,s),n=p,a=!0)}if(u||!a){if(r===i.EventTimeline.FORWARDS&&n===this._liveTimeline)return c.logger.warn({lastEventWasNew:u,didUpdate:a}),void c.logger.warn("Refusing to set forwards pagination token of live timeline "+`${n} to ${o}`);n.setPaginationToken(o,r)}},d.prototype.addLiveEvent=function(e,t){if(this._filter){if(!this._filter.filterRoomTimeline([e]).length)return}const n=this._eventIdToTimeline[e.getId()];if(n)if("replace"===t){l("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=n.getEvents();for(let o=0;o<t.length;o++)if(t[o].getId()===e.getId()){i.EventTimeline.setEventMetadata(e,n.getState(i.EventTimeline.FORWARDS),!1),t[o].encryptedType||(t[o]=e);break}}else l("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1)},d.prototype.addEventToTimeline=function(e,t,n){const o=e.getId();t.addEvent(e,n),this._eventIdToTimeline[o]=t,this.setRelationsTarget(e),this.aggregateRelations(e);const r={timeline:t,liveEvent:!n&&t==this._liveTimeline};this.emit("Room.timeline",e,this.room,Boolean(n),!1,r)},d.prototype.handleRemoteEcho=function(e,t,n){const o=this._eventIdToTimeline[t];o?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[n]=o):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},d.prototype.removeEvent=function(e){const t=this._eventIdToTimeline[e];if(!t)return null;const n=t.removeEvent(e);if(n){delete this._eventIdToTimeline[e];const o={timeline:t};this.emit("Room.timeline",n,this.room,void 0,!0,o)}return n},d.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;const n=this._eventIdToTimeline[e],o=this._eventIdToTimeline[t];if(void 0===n)return null;if(void 0===o)return null;if(n===o){let o,r;const i=n.getEvents();for(let n=0;n<i.length&&(void 0===o||void 0===r);n++){const s=i[n].getId();s==e&&(o=n),s==t&&(r=n)}return o-r}let r=n;for(;r;){if(r===o)return-1;r=r.getNeighbouringTimeline(i.EventTimeline.FORWARDS)}for(r=n;r;){if(r===o)return 1;r=r.getNeighbouringTimeline(i.EventTimeline.BACKWARDS)}return null},d.prototype.getRelationsForEvent=function(e,t,n){if(!this._unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!n)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this._relations[e]||{})[t]||{})[n]},d.prototype.setRelationsTarget=function(e){if(!this._unstableClientRelationAggregation)return;const t=this._relations[e.getId()];if(!t)return;const n=t["m.replace"];if(!n)return;const o=n["m.room.message"];o&&o.setTargetEvent(e)},d.prototype.aggregateRelations=function(e){if(!this._unstableClientRelationAggregation)return;if(e.isRedacted()||e.status===s.EventStatus.CANCELLED)return;if(e.isBeingDecrypted())return void e.once("Event.decrypted",()=>{this.aggregateRelations(e)});const t=e.getRelation();if(!t)return;const n=t.event_id,o=t.rel_type,r=e.getType();let i=this._relations[n];i||(i=this._relations[n]={});let a=i[o];a||(a=i[o]={});let c,l=a[r],d=!1;l||(l=a[r]=new u.Relations(o,r,this.room),d=!0,(c=this.findEventById(n))&&l.setTargetEvent(c)),l.addEvent(e),d&&c&&c.emit("Event.relationsCreated",o,r)}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomState=u;var r=n(4),i=n(20),s=n(0),a=o(n(2));const c=1;function u(e,t){this.roomId=e,this.members={},this.events={},this.paginationToken=null,this._sentinels={},this._updateModifiedTime(),this._displayNameToUserIds={},this._userIdsToDisplayNames={},this._tokenToInvite={},this._joinedMemberCount=null,this._summaryJoinedMemberCount=null,this._invitedMemberCount=null,this._summaryInvitedMemberCount=null,t||(t={status:c}),this._oobMemberFlags=t}function l(e,t,n){const o=e._userIdsToDisplayNames[t];if(delete e._userIdsToDisplayNames[t],o){const n=a.removeHiddenChars(o),r=e._displayNameToUserIds[n];if(r){const o=r.filter(e=>e!==t);e._displayNameToUserIds[n]=o}}e._userIdsToDisplayNames[t]=n;const r=n&&a.removeHiddenChars(n);r&&(e._displayNameToUserIds[r]||(e._displayNameToUserIds[r]=[]),e._displayNameToUserIds[r].push(t))}a.inherits(u,r.EventEmitter),u.prototype.getJoinedMemberCount=function(){return null!==this._summaryJoinedMemberCount?this._summaryJoinedMemberCount:(null===this._joinedMemberCount&&(this._joinedMemberCount=this.getMembers().reduce((e,t)=>"join"===t.membership?e+1:e,0)),this._joinedMemberCount)},u.prototype.setJoinedMemberCount=function(e){this._summaryJoinedMemberCount=e},u.prototype.getInvitedMemberCount=function(){return null!==this._summaryInvitedMemberCount?this._summaryInvitedMemberCount:(null===this._invitedMemberCount&&(this._invitedMemberCount=this.getMembers().reduce((e,t)=>"invite"===t.membership?e+1:e,0)),this._invitedMemberCount)},u.prototype.setInvitedMemberCount=function(e){this._summaryInvitedMemberCount=e},u.prototype.getMembers=function(){return a.values(this.members)},u.prototype.getMembersExcept=function(e){return a.values(this.members).filter(t=>!e.includes(t.userId))},u.prototype.getMember=function(e){return this.members[e]||null},u.prototype.getSentinelMember=function(e){if(!e)return null;let t=this._sentinels[e];if(void 0===t){t=new i.RoomMember(this.roomId,e);const n=this.members[e];n&&t.setMembershipEvent(n.events.member,this),this._sentinels[e]=t}return t},u.prototype.getStateEvents=function(e,t){if(!this.events[e])return void 0===t?[]:null;if(void 0===t)return a.values(this.events[e]);const n=this.events[e][t];return n||null},u.prototype.clone=function(){const e=new u(this.roomId,this._oobMemberFlags),t=this._oobMemberFlags.status;return this._oobMemberFlags.status=c,Object.values(this.events).forEach(t=>{const n=Object.values(t);e.setStateEvents(n)}),this._oobMemberFlags.status=t,null!==this._summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this._summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),3==this._oobMemberFlags.status&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){e.getMember(t.userId).markOutOfBand()}}),e},u.prototype.setUnknownStateEvents=function(e){const t=e.filter(e=>void 0===this.events[e.getType()]||void 0===this.events[e.getType()][e.getStateKey()]);this.setStateEvents(t)},u.prototype.setStateEvents=function(e){const t=this;this._updateModifiedTime(),a.forEach(e,(function(e){e.getRoomId()===t.roomId&&e.isState()&&(t._setStateEvent(e),"m.room.member"===e.getType()&&(l(t,e.getStateKey(),e.getContent().displayname),function(e,t){if(!t.getContent().third_party_invite)return;const n=(t.getContent().third_party_invite.signed||{}).token;if(!n)return;if(!e.getStateEvents("m.room.third_party_invite",n))return;e._tokenToInvite[n]=t}(t,e)),t.emit("RoomState.events",e,t))})),a.forEach(e,(function(e){if(e.getRoomId()===t.roomId&&e.isState())if("m.room.member"===e.getType()){const n=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const o=t._getOrCreateMember(n,e);o.setMembershipEvent(e,t),t._updateMember(o),t.emit("RoomState.members",e,t,o)}else if("m.room.power_levels"===e.getType()){const n=a.values(t.members);a.forEach(n,(function(n){n.setPowerLevelEvent(e),t.emit("RoomState.members",e,t,n)})),t._sentinels={}}}))},u.prototype._getOrCreateMember=function(e,t){let n=this.members[e];return n||(n=new i.RoomMember(this.roomId,e),this.members[e]=n,this.emit("RoomState.newMember",t,this,n)),n},u.prototype._setStateEvent=function(e){void 0===this.events[e.getType()]&&(this.events[e.getType()]={}),this.events[e.getType()][e.getStateKey()]=e},u.prototype._updateMember=function(e){const t=this.getStateEvents("m.room.power_levels","");t&&e.setPowerLevelEvent(t),delete this._sentinels[e.userId],this.members[e.userId]=e,this._joinedMemberCount=null,this._invitedMemberCount=null},u.prototype.needsOutOfBandMembers=function(){return this._oobMemberFlags.status===c},u.prototype.markOutOfBandMembersStarted=function(){this._oobMemberFlags.status===c&&(this._oobMemberFlags.status=2)},u.prototype.markOutOfBandMembersFailed=function(){2===this._oobMemberFlags.status&&(this._oobMemberFlags.status=c)},u.prototype.clearOutOfBandMembers=function(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),s.logger.log(`LL: RoomState removed ${e} members...`),this._oobMemberFlags.status=c},u.prototype.setOutOfBandMembers=function(e){s.logger.log(`LL: RoomState about to set ${e.length} OOB members ...`),2===this._oobMemberFlags.status&&(s.logger.log("LL: RoomState put in OOB_STATUS_FINISHED state ..."),this._oobMemberFlags.status=3,e.forEach(e=>this._setOutOfBandMember(e)))},u.prototype._setOutOfBandMember=function(e){if("m.room.member"!==e.getType())return;const t=e.getStateKey(),n=this.getMember(t);if(n&&!n.isOutOfBand())return;const o=this._getOrCreateMember(t,e);o.setMembershipEvent(e,this),o.markOutOfBand(),l(this,o.userId,o.name),this._setStateEvent(e),this._updateMember(o),this.emit("RoomState.members",e,this,o)},u.prototype.setTypingEvent=function(e){a.forEach(a.values(this.members),(function(t){t.setTypingEvent(e)}))},u.prototype.getInviteForThreePidToken=function(e){return this._tokenToInvite[e]||null},u.prototype._updateModifiedTime=function(){this._modified=Date.now()},u.prototype.getLastModifiedTime=function(){return this._modified},u.prototype.getUserIdsWithDisplayName=function(e){return this._displayNameToUserIds[a.removeHiddenChars(e)]||[]},u.prototype.maySendRedactionForEvent=function(e,t){const n=this.getMember(t);if(!n||"leave"===n.membership)return!1;if(e.status||e.isRedacted())return!1;const o=this.maySendEvent("m.room.redaction",t);return e.getSender()===t?o:this._hasSufficientPowerLevelFor("redact",n.powerLevel)},u.prototype._hasSufficientPowerLevelFor=function(e,t){const n=this.getStateEvents("m.room.power_levels","");let o={};n&&(o=n.getContent());let r=50;return a.isNumber(o[e])&&(r=o[e]),t>=r},u.prototype.maySendMessage=function(e){return this._maySendEventOfType("m.room.message",e,!1)},u.prototype.maySendEvent=function(e,t){return this._maySendEventOfType(e,t,!1)},u.prototype.mayClientSendStateEvent=function(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)},u.prototype.maySendStateEvent=function(e,t){return this._maySendEventOfType(e,t,!0)},u.prototype._maySendEventOfType=function(e,t,n){const o=this.getStateEvents("m.room.power_levels","");let r,i={},s=0,a=0,c=0;if(o){i=(r=o.getContent()).events||{},s=Number.isFinite(r.state_default)?r.state_default:50;const e=r.users&&r.users[t];Number.isFinite(e)?c=e:Number.isFinite(r.users_default)&&(c=r.users_default),Number.isFinite(r.events_default)&&(a=r.events_default)}let u=n?s:a;return Number.isFinite(i[e])&&(u=i[e]),c>=u},u.prototype.mayTriggerNotifOfType=function(e,t){const n=this.getMember(t);if(!n)return!1;const o=this.getStateEvents("m.room.power_levels","");let r=50;return o&&o.getContent()&&o.getContent().notifications&&a.isNumber(o.getContent().notifications[e])&&(r=o.getContent().notifications[e]),n.powerLevel>=r}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.Group=s;var r=o(n(2)),i=n(4);function s(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}r.inherits(s,i.EventEmitter),s.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},s.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},s.prototype.setInviter=function(e){this.inviter=e}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixCall=a,t.setAudioOutput=function(e){k=e},t.setAudioInput=function(e){O=e},t.setVideoInput=function(e){C=e},t.createNewMatrixCall=function(t,n,o){const i=e.window,s=e.document;if(!i||!s)return null;const c={};c.isOpenWebRTC=function(){const e=s.getElementById("script");if(!e||!e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].src.indexOf("owr.js")>-1)return!0;return!1};const u=i.navigator.getUserMedia||i.navigator.webkitGetUserMedia||i.navigator.mozGetUserMedia;u&&(c.getUserMedia=function(){return u.apply(i.navigator,arguments)});try{c.RtcPeerConnection=i.RTCPeerConnection||i.webkitRTCPeerConnection||i.mozRTCPeerConnection,c.RtcSessionDescription=i.RTCSessionDescription||i.webkitRTCSessionDescription||i.mozRTCSessionDescription,c.RtcIceCandidate=i.RTCIceCandidate||i.webkitRTCIceCandidate||i.mozRTCIceCandidate,c.vendor=null,i.mozRTCPeerConnection?c.vendor="mozilla":i.webkitRTCPeerConnection?c.vendor="webkit":i.RTCPeerConnection&&(c.vendor="generic")}catch(e){return r.logger.error("Failed to set up WebRTC object: possible browser interference?"),r.logger.error(e),null}if(!(c.RtcIceCandidate&&c.RtcSessionDescription&&c.RtcPeerConnection&&c.getUserMedia))return null;const l=!!o&&o.forceTURN;return new a({webRtc:c,client:t,URL:i.URL,roomId:n,turnServers:t.getTurnServers(),forceTURN:t._forceTURN||l})};var r=n(0),i=n(4),s=o(n(2));function a(e){this.roomId=e.roomId,this.client=e.client,this.webRtc=e.webRtc,this.forceTURN=e.forceTURN,this.URL=e.URL,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[a.FALLBACK_ICE_SERVER]}),s.forEach(this.turnServers,(function(e){s.checkObjectHasKeys(e,["urls"])})),this.callId="c"+(new Date).getTime()+Math.random(),this.state="fledgling",this.didConnect=!1,this.candidateSendQueue=[],this.candidateSendTries=0,this.mediaPromises=Object.create(null),this.screenSharingStream=null,this._answerContent=null}a.CALL_TIMEOUT_MS=6e4,a.FALLBACK_ICE_SERVER="stun:turn.matrix.org",a.ERR_LOCAL_OFFER_FAILED="local_offer_failed",a.ERR_NO_USER_MEDIA="no_user_media",a.ERR_UNKNOWN_DEVICES="unknown_devices",a.ERR_SEND_INVITE="send_invite",a.ERR_SEND_ANSWER="send_answer",s.inherits(a,i.EventEmitter),a.prototype.placeVoiceCall=function(){v("placeVoiceCall"),y(this),E(this,I("voice")),this.type="voice"},a.prototype.placeVideoCall=function(e,t){v("placeVideoCall"),y(this),this.localVideoElement=t,this.remoteVideoElement=e,E(this,I("video")),this.type="video",g(this)},a.prototype.placeScreenSharingCall=function(e,t){v("placeScreenSharingCall"),y(this);const n=w(this);if(!n)return;this.localVideoElement=t,this.remoteVideoElement=e;const o=this;this.webRtc.getUserMedia(n,(function(e){o.screenSharingStream=e,v("Got screen stream, requesting audio stream...");const t=I("voice");E(o,t)}),(function(e){o.emit("error",_(a.ERR_NO_USER_MEDIA,"Failed to get screen-sharing stream: "+e))})),this.type="video",g(this)},a.prototype.playElement=function(e,t){r.logger.log("queuing play on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return r.logger.log("previous promise completed for "+t),e.play()}),(function(){return r.logger.log("previous promise failed for "+t),e.play()})):this.mediaPromises[t]=e.play()},a.prototype.pauseElement=function(e,t){r.logger.log("queuing pause on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return r.logger.log("previous promise completed for "+t),e.pause()}),(function(){return r.logger.log("previous promise failed for "+t),e.pause()})):this.mediaPromises[t]=e.pause()},a.prototype.assignElement=function(e,t,n){r.logger.log("queuing assign on "+n+" element "+e+" for "+t),this.mediaPromises[n]?this.mediaPromises[n]=this.mediaPromises[n].then((function(){r.logger.log("previous promise completed for "+n),e.srcObject=t}),(function(){r.logger.log("previous promise failed for "+n),e.srcObject=t})):e.srcObject=t},a.prototype.getLocalVideoElement=function(){return this.localVideoElement},a.prototype.getRemoteVideoElement=function(){return this.remoteVideoElement},a.prototype.getRemoteAudioElement=function(){return this.remoteAudioElement},a.prototype.setLocalVideoElement=function(e){if(this.localVideoElement=e,e&&this.localAVStream&&"video"===this.type){e.autoplay=!0,this.assignElement(e,this.localAVStream,"localVideo"),e.muted=!0;const t=this;setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)}},a.prototype.setRemoteVideoElement=function(e){this.remoteVideoElement=e,g(this)},a.prototype.setRemoteAudioElement=function(e){this.remoteVideoElement.muted=!0,this.remoteAudioElement=e,this.remoteAudioElement.muted=!1,m(this)},a.prototype._initWithInvite=function(e){this.msg=e.getContent(),this.peerConn=b(this);const t=this;this.peerConn&&this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(this.msg.offer),R(t,t._onSetRemoteDescriptionSuccess),R(t,t._onSetRemoteDescriptionError)),l(this,"ringing"),this.direction="inbound",this.msg.offer&&this.msg.offer.sdp&&this.msg.offer.sdp.indexOf("m=video")>-1?this.type="video":this.type="voice",e.getAge()&&setTimeout((function(){"ringing"==t.state&&(v("Call invite has expired. Hanging up."),t.hangupParty="remote",l(t,"ended"),f(t),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),t.emit("hangup",t))}),this.msg.lifetime-e.getAge())},a.prototype._initWithHangup=function(e){this.msg=e.getContent(),l(this,"ended")},a.prototype.answer=function(){v("Answering call %s of type %s",this.callId,this.type);const e=this;e._answerContent?e._sendAnswer():this.localAVStream||this.waitForLocalAVStream?this.localAVStream?this._maybeGotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&l(this,"wait_local_media"):(this.webRtc.getUserMedia(I(this.type),R(e,e._maybeGotUserMediaForAnswer),R(e,e._maybeGotUserMediaForAnswer)),l(this,"wait_local_media"))},a.prototype._replacedBy=function(e){v(this.callId+" being replaced by "+e.callId),"wait_local_media"==this.state?(v("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):"create_offer"==this.state?(v("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream):"invite_sent"==this.state&&(v("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),e.localVideoElement=this.localVideoElement,e.remoteVideoElement=this.remoteVideoElement,e.remoteAudioElement=this.remoteAudioElement,this.successor=e,this.emit("replaced",e),this.hangup(!0)},a.prototype.hangup=function(e,t){if("ended"==this.state)return;v("Ending call "+this.callId),p(this,"local",e,!t);const n={version:0,call_id:this.callId,reason:e};d(this,"m.call.hangup",n)},a.prototype.setLocalVideoMuted=function(e){this.localAVStream&&c(this.localAVStream.getVideoTracks(),!e)},a.prototype.isLocalVideoMuted=function(){return!!this.localAVStream&&!u(this.localAVStream.getVideoTracks())},a.prototype.setMicrophoneMuted=function(e){this.localAVStream&&c(this.localAVStream.getAudioTracks(),!e)},a.prototype.isMicrophoneMuted=function(){return!!this.localAVStream&&!u(this.localAVStream.getAudioTracks())},a.prototype._maybeGotUserMediaForInvite=function(e){if(this.successor)return void this.successor._maybeGotUserMediaForAnswer(e);if("ended"==this.state)return;v("_maybeGotUserMediaForInvite -> "+this.type);const t=this,n=e,o={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};if(e instanceof MediaStream){const n=this.getLocalVideoElement();n&&"video"==this.type&&(n.autoplay=!0,this.screenSharingStream?(v("Setting screen sharing stream to the local video element"),this.assignElement(n,this.screenSharingStream,"localVideo")):this.assignElement(n,e,"localVideo"),n.muted=!0,setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),this.screenSharingStream&&(this.screenSharingStream.addTrack(e.getAudioTracks()[0]),e=this.screenSharingStream),this.localAVStream=e,c(e.getAudioTracks(),!0),this.peerConn=b(this),this.peerConn.addStream(e)}else{if("PermissionDeniedError"!==n.name)return v("Failed to getUserMedia: "+n.name),void this._getUserMediaFailed(n);v("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only."),this.peerConn=b(this)}this.peerConn.createOffer(R(t,t._gotLocalOffer),R(t,t._getLocalOfferFailed),o),l(t,"create_offer")},a.prototype._sendAnswer=function(e){d(this,"m.call.answer",this._answerContent).then(()=>{l(this,"connecting"),S(this)}).catch(e=>{l(this,"ringing"),this.client.cancelPendingEvent(e.event);let t=a.ERR_SEND_ANSWER,n="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=a.ERR_UNKNOWN_DEVICES,n="Unknown devices present in the room"),this.emit("error",_(t,n)),e})},a.prototype._maybeGotUserMediaForAnswer=function(e){const t=this;if("ended"==t.state)return;const n=e;if(e instanceof MediaStream){const n=t.getLocalVideoElement();n&&"video"==t.type&&(n.autoplay=!0,this.assignElement(n,e,"localVideo"),n.muted=!0,setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),t.localAVStream=e,c(e.getAudioTracks(),!0),t.peerConn.addStream(e)}else{if("PermissionDeniedError"!==n.name)return v("Failed to getUserMedia: "+n.name),void this._getUserMediaFailed(n);v("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only.")}const o={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};t.peerConn.createAnswer((function(e){v("Created answer: ",e),t.peerConn.setLocalDescription(e,(function(){t._answerContent={version:0,call_id:t.callId,answer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type}},t._sendAnswer()}),(function(){v("Error setting local description!")}),o)}),(function(e){v("Failed to create answer: "+e)})),l(t,"create_answer")},a.prototype._gotLocalIceCandidate=function(e){if(e.candidate){if(v("Got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),"ended"==this.state)return;const t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};h(this,t)}},a.prototype._gotRemoteIceCandidate=function(e){"ended"!=this.state&&(v("Got remote ICE "+e.sdpMid+" candidate: "+e.candidate),this.peerConn.addIceCandidate(new this.webRtc.RtcIceCandidate(e),(function(){}),(function(e){})))},a.prototype._receivedAnswer=function(e){if("ended"==this.state)return;this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(e.answer),R(this,this._onSetRemoteDescriptionSuccess),R(this,this._onSetRemoteDescriptionError)),l(this,"connecting")},a.prototype._gotLocalOffer=function(e){const t=this;v("Created offer: ",e),"ended"!=t.state?t.peerConn.setLocalDescription(e,(function(){const e={version:0,call_id:t.callId,offer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type},lifetime:a.CALL_TIMEOUT_MS};d(t,"m.call.invite",e).then(()=>{l(t,"invite_sent"),setTimeout((function(){"invite_sent"==t.state&&t.hangup("invite_timeout")}),a.CALL_TIMEOUT_MS)}).catch(e=>{let n=a.ERR_SEND_INVITE,o="Failed to send invite";throw"UnknownDeviceError"==e.name&&(n=a.ERR_UNKNOWN_DEVICES,o="Unknown devices present in the room"),t.client.cancelPendingEvent(e.event),p(t,"local",n,!1),t.emit("error",_(n,o)),e})}),(function(){v("Error setting local description!")})):v("Ignoring newly created offer on call ID "+t.callId+" because the call has ended")},a.prototype._getLocalOfferFailed=function(e){this.emit("error",_(a.ERR_LOCAL_OFFER_FAILED,"Failed to start audio for call!"))},a.prototype._getUserMediaFailed=function(e){p(this,"local","user_media_failed",!1),this.emit("error",_(a.ERR_NO_USER_MEDIA,"Couldn't start capturing media! Is your microphone set up and does this app have permission?"))},a.prototype._onIceConnectionStateChanged=function(){"ended"!=this.state&&(v("Ice connection state changed to: "+this.peerConn.iceConnectionState),"completed"==this.peerConn.iceConnectionState||"connected"==this.peerConn.iceConnectionState?(l(this,"connected"),this.didConnect=!0):"failed"==this.peerConn.iceConnectionState&&this.hangup("ice_failed"))},a.prototype._onSignallingStateChanged=function(){v("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)},a.prototype._onSetRemoteDescriptionSuccess=function(){v("Set remote description")},a.prototype._onSetRemoteDescriptionError=function(e){v("Failed to set remote description"+e)},a.prototype._onAddStream=function(e){v("Stream id "+e.stream.id+" added");const t=e.stream;t.getVideoTracks().length>0?(this.type="video",this.remoteAVStream=t,this.remoteAStream=t):(this.type="voice",this.remoteAStream=t);const n=this;T(t,(function(e){v("Track id "+e.id+" added"),e.onstarted=R(n,n._onRemoteStreamTrackStarted)})),void 0!==e.stream.oninactive?e.stream.oninactive=R(n,n._onRemoteStreamEnded):e.stream.onended=R(n,n._onRemoteStreamEnded),e.stream.onstarted=R(n,n._onRemoteStreamStarted),"video"===this.type?(g(this),m(this)):m(this)},a.prototype._onRemoteStreamStarted=function(e){l(this,"connected")},a.prototype._onRemoteStreamEnded=function(e){v("Remote stream ended"),this.hangupParty="remote",l(this,"ended"),f(this),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit("hangup",this)},a.prototype._onRemoteStreamTrackStarted=function(e){l(this,"connected")},a.prototype._onHangupReceived=function(e){v("Hangup received"),p(this,"remote",e.reason,!0)},a.prototype._onAnsweredElsewhere=function(e){v("Answered elsewhere"),p(this,"remote","answered_elsewhere",!0)};const c=function(e,t){for(let n=0;n<e.length;n++)e[n].enabled=t},u=function(e){for(let t=0;t<e.length;t++)if(e[t].enabled)return!0;return!1},l=function(e,t){const n=e.state;e.state=t,e.emit("state",t,n)},d=function(e,t,n){return e.client.sendEvent(e.roomId,t,n)},h=function(e,t){e.candidateSendQueue.push(t),"ringing"!=e.state&&0===e.candidateSendTries&&setTimeout((function(){S(e)}),100)},p=function(e,t,n,o){e.getRemoteVideoElement()&&(e.getRemoteVideoElement().pause&&e.pauseElement(e.getRemoteVideoElement(),"remoteVideo"),e.assignElement(e.getRemoteVideoElement(),null,"remoteVideo")),e.getRemoteAudioElement()&&(e.getRemoteAudioElement().pause&&e.pauseElement(e.getRemoteAudioElement(),"remoteAudio"),e.assignElement(e.getRemoteAudioElement(),null,"remoteAudio")),e.getLocalVideoElement()&&(e.getLocalVideoElement().pause&&e.pauseElement(e.getLocalVideoElement(),"localVideo"),e.assignElement(e.getLocalVideoElement(),null,"localVideo")),e.hangupParty=t,e.hangupReason=n,l(e,"ended"),f(e),e.peerConn&&"closed"!==e.peerConn.signalingState&&e.peerConn.close(),o&&e.emit("hangup",e)},f=function(e){v("stopAllMedia (stream=%s)",e.localAVStream),e.localAVStream&&(T(e.localAVStream,(function(e){e.stop&&e.stop()})),e.localAVStream.stop&&e.localAVStream.stop()),e.screenSharingStream&&(T(e.screenSharingStream,(function(e){e.stop&&e.stop()})),e.screenSharingStream.stop&&e.screenSharingStream.stop()),e.remoteAVStream&&T(e.remoteAVStream,(function(e){e.stop&&e.stop()})),e.remoteAStream&&T(e.remoteAStream,(function(e){e.stop&&e.stop()}))},g=function(e){if(e.getRemoteVideoElement()&&e.remoteAVStream){const t=e.getRemoteVideoElement();t.autoplay=!0,e.assignElement(t,e.remoteAVStream,"remoteVideo"),setTimeout((function(){const t=e.getRemoteVideoElement();t.play&&e.playElement(t,"remoteVideo"),e.webRtc.isOpenWebRTC()&&l(e,"connected")}),0)}},m=async function(e){if(e.getRemoteAudioElement()&&e.remoteAStream){const t=e.getRemoteAudioElement();k&&await t.setSinkId(k),t.autoplay=!0,e.assignElement(t,e.remoteAStream,"remoteAudio"),setTimeout((function(){const t=e.getRemoteAudioElement();t.play&&e.playElement(t,"remoteAudio"),e.webRtc.isOpenWebRTC()&&l(e,"connected")}),0)}},y=function(e){if(0===e.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")},_=function(e,t){const n=new Error(t);return n.code=e,n},v=function(){r.logger.log(...arguments)},S=function(e){if(0===e.candidateSendQueue.length)return;const t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;const n={version:0,call_id:e.callId,candidates:t};v("Attempting to send "+t.length+" candidates"),d(e,"m.call.candidates",n).then((function(){e.candidateSendTries=0,S(e)}),(function(n){for(let n=0;n<t.length;n++)e.candidateSendQueue.push(t[n]);if(e.candidateSendTries>5)return v("Failed to send candidates on attempt %s. Giving up for now.",e.candidateSendTries),void(e.candidateSendTries=0);const o=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,v("Failed to send candidates. Retrying in "+o+"ms"),setTimeout((function(){S(e)}),o)}))},E=function(e,t){e.client.callList[e.callId]=e,e.webRtc.getUserMedia(t,R(e,e._maybeGotUserMediaForInvite),R(e,e._maybeGotUserMediaForInvite)),l(e,"wait_local_media"),e.direction="outbound",e.config=t},b=function(e){const t=new e.webRtc.RtcPeerConnection({iceTransportPolicy:e.forceTURN?"relay":void 0,iceServers:e.turnServers});return t.oniceconnectionstatechange=R(e,e._onIceConnectionStateChanged),t.onsignalingstatechange=R(e,e._onSignallingStateChanged),t.onicecandidate=R(e,e._gotLocalIceCandidate),t.onaddstream=R(e,e._onAddStream),t},w=function(t){const n=e.screen;if(n)return{video:{mediaSource:"screen",mandatory:{chromeMediaSource:"screen",chromeMediaSourceId:""+Date.now(),maxWidth:n.width,maxHeight:n.height,minFrameRate:1,maxFrameRate:10}}};t.emit("error",_(a.ERR_NO_USER_MEDIA,"Couldn't determine screen sharing constaints."))},I=function(t){const n=!!e.window.navigator.webkitGetUserMedia;switch(t){case"voice":return{audio:{deviceId:O?{ideal:O}:void 0},video:!1};case"video":return{audio:{deviceId:O?{ideal:O}:void 0},video:{deviceId:C?{ideal:C}:void 0,width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}}}}},R=function(e,t){return function(){return t.apply(e,arguments)}},T=function(e,t){!function(e,t){const n=e.getVideoTracks();for(let e=0;e<n.length;e++)t(n[e])}(e,t),function(e,t){const n=e.getAudioTracks();for(let e=0;e<n.length;e++)t(n[e])}(e,t)};let k,O,C}).call(this,n(3))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeHtmlMessage=function(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlNotice=function(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlEmote=function(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeTextMessage=function(e){return{msgtype:"m.text",body:e}},t.makeNotice=function(e){return{msgtype:"m.notice",body:e}},t.makeEmoteMessage=function(e){return{msgtype:"m.emote",body:e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exists=function(e,t){return new Promise((n,o)=>{let r=!0;const i=e.open(t);i.onupgradeneeded=()=>{r=!1},i.onblocked=()=>o(),i.onsuccess=()=>{i.result.close(),r||e.deleteDatabase(t),n(r)},i.onerror=e=>o(e.target.error)})}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.OlmDevice=u,t.WITHHELD_MESSAGES=void 0;var r=n(0),i=n(9),s=o(n(41));const a=49152;function c(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>a)throw new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is "+a+" bytes.")}function u(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={}}u.prototype.init=async function(){let t;const n=new e.Olm.Account;try{await async function(e,t,n){await e.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT],o=>{e.getAccount(o,r=>{null!==r?n.unpickle(t,r):(n.create(),r=n.pickle(t),e.storeAccount(o,r))})})}(this._cryptoStore,this._pickleKey,n),t=JSON.parse(n.identity_keys()),this._maxOneTimeKeys=n.max_number_of_one_time_keys()}finally{n.free()}this.deviceCurve25519Key=t.curve25519,this.deviceEd25519Key=t.ed25519},u.getOlmVersion=function(){return e.Olm.get_library_version()},u.prototype._getAccount=function(t,n){this._cryptoStore.getAccount(t,t=>{const o=new e.Olm.Account;try{o.unpickle(this._pickleKey,t),n(o)}finally{o.free()}})},u.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},u.prototype._getSession=function(e,t,n,o){this._cryptoStore.getEndToEndSession(e,t,n,e=>{this._unpickleSession(e,o)})},u.prototype._unpickleSession=function(t,n){const o=new e.Olm.Session;try{o.unpickle(this._pickleKey,t.session),n(Object.assign({},t,{session:o}))}finally{o.free()}},u.prototype._saveSession=function(e,t,n){const o=t.session.session_id(),r=Object.assign(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,o,r,n)},u.prototype._getUtility=function(t){const n=new e.Olm.Utility;try{return t(n)}finally{n.free()}},u.prototype.sign=async function(e){let t;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_ACCOUNT],n=>{this._getAccount(n,n=>{t=n.sign(e)})}),t},u.prototype.getOneTimeKeys=async function(){let e;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this._getAccount(t,t=>{e=JSON.parse(t.one_time_keys())})}),e},u.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},u.prototype.markKeysAsPublished=async function(){await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this._getAccount(e,t=>{t.mark_keys_as_published(),this._storeAccount(e,t)})})},u.prototype.generateOneTimeKeys=function(e){return this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this._getAccount(t,n=>{n.generate_one_time_keys(e),this._storeAccount(t,n)})})},u.prototype.createOutboundSession=async function(t,n){let o;return await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT,i.IndexedDBCryptoStore.STORE_SESSIONS],r=>{this._getAccount(r,i=>{const s=new e.Olm.Session;try{s.create_outbound(i,t,n),o=s.session_id(),this._storeAccount(r,i);const e={session:s,lastReceivedMessageTs:Date.now()};this._saveSession(t,e,r)}finally{s.free()}})}),o},u.prototype.createInboundSession=async function(t,n,o){if(0!==n)throw new Error("Need messageType == 0 to create inbound session");let r;return await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT,i.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this._getAccount(i,s=>{const a=new e.Olm.Session;try{a.create_inbound_from(s,t,o),s.remove_one_time_keys(a),this._storeAccount(i,s);const e=a.decrypt(n,o),c={session:a,lastReceivedMessageTs:Date.now()};this._saveSession(t,c,i),r={payload:e,session_id:a.session_id()}}finally{a.free()}})}),r},u.prototype.getSessionIdsForDevice=async function(e){if(this._sessionsInProgress[e]){r.logger.log("waiting for olm session to be created");try{await this._sessionsInProgress[e]}catch(e){}}let t;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_SESSIONS],n=>{this._cryptoStore.getEndToEndSessions(e,n,e=>{t=Object.keys(e)})}),t},u.prototype.getSessionIdForDevice=async function(e,t){const n=await this.getSessionInfoForDevice(e,t);if(0===n.length)return null;let o=0;for(let e=1;e<n.length;e++){const t=n[e],r=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,i=n[o],s=void 0===i.lastReceivedMessageTs?0:i.lastReceivedMessageTs;(r>s||r===s&&t.sessionId<i.sessionId)&&(o=e)}return n[o].sessionId},u.prototype.getSessionInfoForDevice=async function(e,t){if(this._sessionsInProgress[e]&&!t){r.logger.log("waiting for olm session to be created");try{await this._sessionsInProgress[e]}catch(e){}}const n=[];return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_SESSIONS],t=>{this._cryptoStore.getEndToEndSessions(e,t,e=>{const t=Object.keys(e).sort();for(const o of t)this._unpickleSession(e[o],e=>{n.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:o})})})}),n},u.prototype.encryptMessage=async function(e,t,n){let o;return c(n),await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this._getSession(e,t,i,s=>{const a=s.session.describe();r.logger.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),o=s.session.encrypt(n),this._saveSession(e,s,i)})}),o},u.prototype.decryptMessage=async function(e,t,n,o){let s;return await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this._getSession(e,t,i,a=>{const c=a.session.describe();r.logger.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),s=a.session.decrypt(n,o),a.lastReceivedMessageTs=Date.now(),this._saveSession(e,a,i)})}),s},u.prototype.matchesSession=async function(e,t,n,o){if(0!==n)return!1;let r;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_SESSIONS],n=>{this._getSession(e,t,n,e=>{r=e.session.matches_inbound(o)})}),r},u.prototype.recordSessionProblem=async function(e,t,n){await this._cryptoStore.storeEndToEndSessionProblem(e,t,n)},u.prototype.sessionMayHaveProblems=async function(e,t){return await this._cryptoStore.getEndToEndSessionProblem(e,t)},u.prototype.filterOutNotifiedErrorDevices=async function(e){return await this._cryptoStore.filterOutNotifiedErrorDevices(e)},u.prototype._saveOutboundGroupSession=function(e){const t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},u.prototype._getOutboundGroupSession=function(t,n){const o=this._outboundGroupSessionStore[t];if(void 0===o)throw new Error("Unknown outbound group session "+t);const r=new e.Olm.OutboundGroupSession;try{return r.unpickle(this._pickleKey,o),n(r)}finally{r.free()}},u.prototype.createOutboundGroupSession=function(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this._saveOutboundGroupSession(t),t.session_id()}finally{t.free()}},u.prototype.encryptGroupMessage=function(e,t){const n=this;return r.logger.log(`encrypting msg with megolm session ${e}`),c(t),this._getOutboundGroupSession(e,(function(e){const o=e.encrypt(t);return n._saveOutboundGroupSession(e),o}))},u.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},u.prototype._unpickleInboundGroupSession=function(t,n){const o=new e.Olm.InboundGroupSession;try{return o.unpickle(this._pickleKey,t.session),n(o)}finally{o.free()}},u.prototype._getInboundGroupSession=function(e,t,n,o,r){this._cryptoStore.getEndToEndInboundGroupSession(t,n,o,(t,n)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this._unpickleInboundGroupSession(t,e=>{r(e,t,n)})}else r(null,null,n)})},u.prototype.addInboundGroupSession=async function(t,n,o,s,a,c,u){await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(t,n,s,i,(l,d)=>{const h=new e.Olm.InboundGroupSession;try{if(u?h.import_session(a):h.create(a),s!=h.session_id())throw new Error("Mismatched group session ID from senderKey: "+n);if(l&&(r.logger.log("Update for megolm session "+n+"/"+s),l.first_known_index()<=h.first_known_index()))return void r.logger.log(`Keeping existing megolm session ${s}`);const e={room_id:t,session:h.pickle(this._pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:o};this._cryptoStore.storeEndToEndInboundGroupSession(n,s,e,i)}finally{h.free()}})})},u.prototype.addInboundGroupSessionWithheld=async function(e,t,n,o,r){await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,n,{room_id:e,code:o,reason:r},i)})};const l={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function d(e){return e.code&&e.code in l?l[e.code]:e.reason?e.reason:"decryption key withheld"}t.WITHHELD_MESSAGES=l,u.prototype.decryptGroupMessage=async function(e,t,n,o,r,a){let c,u;if(await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(e,t,n,i,(e,l,h)=>{if(null===e)return h&&(u=new s.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",d(h),{session:t+"|"+n})),void(c=null);let p;try{p=e.decrypt(o)}catch(e){return void(u=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&h?new s.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",d(h),{session:t+"|"+n}):e)}let f=p.plaintext;if(void 0===f)f=p;else{const e=t+"|"+n+"|"+p.message_index;if(e in this._inboundGroupSessionMessageIndexes){const t=this._inboundGroupSessionMessageIndexes[e];if(t.id!==r||t.timestamp!==a)return void(u=new Error("Duplicate message index, possible replay attack: "+e))}this._inboundGroupSessionMessageIndexes[e]={id:r,timestamp:a}}l.session=e.pickle(this._pickleKey),this._cryptoStore.storeEndToEndInboundGroupSession(t,n,l,i),c={result:f,keysClaimed:l.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:l.forwardingCurve25519KeyChain||[]}})}),u)throw u;return c},u.prototype.hasInboundSessionKeys=async function(e,t,n){let o;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.getEndToEndInboundGroupSession(t,n,i,i=>{null!==i?e!==i.room_id?(r.logger.warn(`requested keys for inbound group session ${t}|`+`${n}, with incorrect room_id `+`(expected ${i.room_id}, `+`was ${e})`),o=!1):o=!0:o=!1})}),o},u.prototype.getInboundGroupSessionKey=async function(e,t,n,o){let r;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(e,t,n,i,(e,t)=>{if(null===e)return void(r=null);void 0===o&&(o=e.first_known_index());const n=e.export_session(o),i=(t.keysClaimed||{}).ed25519||null;r={chain_index:o,key:n,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:i}})}),r},u.prototype.exportInboundGroupSession=function(e,t,n){return this._unpickleInboundGroupSession(n,o=>{const r=o.first_known_index();return{sender_key:e,sender_claimed_keys:n.keysClaimed,room_id:n.room_id,session_id:t,session_key:o.export_session(r),forwarding_curve25519_key_chain:o.forwardingCurve25519KeyChain||[],first_known_index:o.first_known_index()}})},u.prototype.verifySignature=function(e,t,n){this._getUtility((function(o){o.ed25519_verify(e,t,n)}))}}).call(this,n(3))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(84),n(85);var o=n(25);Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})}))},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceTrustLevel=t.UserTrustLevel=t.CrossSigningLevel=t.CrossSigningInfo=void 0;var o=n(7),r=n(4),i=n(0);function s(e){return Object.values(e.keys)[0]}class a extends r.EventEmitter{constructor(e,t){super(),Object.defineProperty(this,"userId",{enumerable:!0,value:e}),this._callbacks=t||{},this.keys={},this.firstUse=!0}async getCrossSigningKey(t,n){if(!this._callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");void 0===n&&(n=this.getId(t));const o=await this._callbacks.getCrossSigningKey(t,n);if(!o)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");const r=new e.Olm.PkSigning,i=r.init_with_seed(o);if(i!==n)throw r.free(),new Error("Key type "+t+" from getCrossSigningKey callback did not match");return[i,r]}static fromStorage(e,t){const n=new a(t);for(const t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n}toStorage(){return{keys:this.keys,firstUse:this.firstUse}}async isStoredInSecretStorage(e){let t=!0;for(const n of["master","self_signing","user_signing"])t&=await e.isStored(`m.cross_signing.${n}`,!1);return t}static async storeInSecretStorage(e,t){for(const n of Object.keys(e)){const r=(0,o.encodeBase64)(e[n]);await t.store(`m.cross_signing.${n}`,r)}}static async getFromSecretStorage(e,t){const n=await t.get(`m.cross_signing.${e}`);return(0,o.decodeBase64)(n)}getId(e){if(e=e||"master",!this.keys[e])return null;return s(this.keys[e])}async resetKeys(t){if(!this._callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&c.MASTER||!this.keys.master)t=c.MASTER|c.USER_SIGNING|c.SELF_SIGNING;else if(0===t)return;const n={},r={};let i,s;try{if(t&c.MASTER?(i=new e.Olm.PkSigning,n.master=i.generate_seed(),s=i.init_with_seed(n.master),r.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+s]:s}}):[s,i]=await this.getCrossSigningKey("master"),t&c.SELF_SIGNING){const t=new e.Olm.PkSigning;try{n.self_signing=t.generate_seed();const e=t.init_with_seed(n.self_signing);r.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},(0,o.pkSign)(r.self_signing,i,this.userId,s)}finally{t.free()}}if(t&c.USER_SIGNING){const t=new e.Olm.PkSigning;try{n.user_signing=t.generate_seed();const e=t.init_with_seed(n.user_signing);r.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},(0,o.pkSign)(r.user_signing,i,this.userId,s)}finally{t.free()}}Object.assign(this.keys,r),this._callbacks.saveCrossSigningKeys(n)}finally{i&&i.free()}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw i.logger.error(t),new Error(t)}this.keys.master?s(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const n=s(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw i.logger.error(t),new Error(t)}try{(0,o.pkVerify)(e.user_signing,n,this.userId)}catch(e){throw i.logger.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw i.logger.error(t),new Error(t)}try{(0,o.pkVerify)(e.self_signing,n,this.userId)}catch(e){throw i.logger.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[n,r]=await this.getCrossSigningKey(t);try{return(0,o.pkSign)(e,r,this.userId,n),e}finally{r.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new u(!0,this.firstUse);if(!this.keys.user_signing)return new u(!1,e.firstUse);let t;const n=e.keys.master,r=this.getId("user_signing");try{(0,o.pkVerify)(n,r,this.userId),t=!0}catch(e){t=!1}return new u(t,e.firstUse)}checkDeviceTrust(e,t,n){const r=this.checkUserTrust(e),i=e.keys.self_signing;if(!i)return new l(!1,!1,n);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,o.pkVerify)(i,e.getId(),e.userId),(0,o.pkVerify)(a,s(i),e.userId),l.fromUserTrustLevel(r,n)}catch(e){return new l(!1,!1,n)}}}t.CrossSigningInfo=a;const c={MASTER:4,USER_SIGNING:2,SELF_SIGNING:1};t.CrossSigningLevel=c;class u{constructor(e,t){this._crossSigningVerified=e,this._tofu=t}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this._crossSigningVerified}isTofu(){return this._tofu}}t.UserTrustLevel=u;class l{constructor(e,t,n){this._crossSigningVerified=e,this._tofu=t,this._localVerified=n}static fromUserTrustLevel(e,t){return new l(e._crossSigningVerified,e._tofu,t)}isVerified(){return this.isCrossSigningVerified()||this.isLocallyVerified()}isCrossSigningVerified(){return this._crossSigningVerified}isLocallyVerified(){return this._localVerified}isTofu(){return this._tofu}}t.DeviceTrustLevel=l}).call(this,n(3))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationBase=void 0;var o=n(6),r=n(4),i=n(0),s=n(14),a=n(10);const c=new Error("Verification timed out");class u extends r.EventEmitter{constructor(e,t,n,o,r,i){super(),this._channel=e,this._baseApis=t,this.userId=n,this.deviceId=o,this.startEvent=r,this.request=i,this.cancelled=!1,this._done=!1,this._promise=null,this._transactionTimeoutTimer=null,this._resetTimer()}_resetTimer(){i.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(i.logger.info("Triggering verification timeout"),this.cancel(c))},6e5)}_endTimer(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}_send(e,t){return this._channel.send(e,t)}_waitForEvent(e){return this._done?Promise.reject(new Error("Verification is already done")):(this._expectedEvent=e,new Promise((e,t)=>{this._resolveEvent=e,this._rejectEvent=t}))}handleEvent(e){if(!this._done)if(e.getType()===this._expectedEvent)"m.key.verification.done"!==this._expectedEvent&&(this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const e=this._reject;this._reject=void 0,e(new Error("Other side cancelled verification"))}else{const t=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){const e=this._rejectEvent;this._rejectEvent=void 0,e(t)}this.cancel(t)}}done(){this._endTimer(),this._done||(this._channel.needsDoneMessage&&this._send("m.key.verification.done",{}),this._resolve())}cancel(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.userId&&this.deviceId)if(e===c){const e=(0,a.newTimeoutError)();this._send(e.getType(),e.getContent())}else if(e instanceof o.MatrixEvent){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this._send("m.key.verification.cancel",t)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this._promise?this._reject&&this._reject(e):this._promise=Promise.reject(e),this.emit("cancel",e)}}verify(){return this._promise?this._promise:(this._promise=new Promise((e,t)=>{this._resolve=(...t)=>{this._done=!0,this._endTimer(),e(...t)},this._reject=(...e)=>{this._done=!0,this._endTimer(),t(...e)}}),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),Promise.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this))),this._promise)}async _verifyKeys(e,t,n){const o=[];for(const[r,a]of Object.entries(t)){const t=r.split(":",2)[1],c=await this._baseApis.getStoredDevice(e,t);if(c)await n(r,c,a),o.push(t);else{const c=this._baseApis._crypto._deviceList.getStoredCrossSigningForUser(e);c&&c.getId()===t?(await n(r,s.DeviceInfo.fromStorage({keys:{[r]:t}},t),a),o.push(t)):i.logger.warn(`verification: Could not find device ${t} to verify`)}}if(!o.length)throw new Error("No devices could be verified");for(const t of o)await this._baseApis.setDeviceVerified(e,t)}}t.VerificationBase=u},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.keyFromAuthData=async function(t,n){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return await i(n,t.private_key_salt,t.private_key_iterations)},t.keyFromPassphrase=async function(t){if(!e.Olm)throw new Error("Olm is not available");const n=(0,o.randomString)(32);return{key:await i(t,n,r),salt:n,iterations:r}},t.deriveKey=i;var o=n(15);const r=5e5;async function i(t,n,o){const r=e.crypto.subtle,i=e.TextEncoder;if(!r||!i)throw new Error("Password-based backup is not avaiable on this platform");const s=await r.importKey("raw",(new i).encode(t),{name:"PBKDF2"},!1,["deriveBits"]),a=await r.deriveBits({name:"PBKDF2",salt:(new i).encode(n),iterations:o,hash:"SHA-512"},s,8*e.Olm.PRIVATE_KEY_LENGTH);return new Uint8Array(a)}}).call(this,n(3))},function(e,t,n){"use strict";(function(e,o){var r=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.encodeRecoveryKey=function(t){const n=new e(s.length+t.length+1);n.set(s,0),n.set(t,s.length);let o=0;for(let e=0;e<n.length-1;++e)o^=n[e];return n[n.length-1]=o,i.default.encode(n).match(/.{1,4}/g).join(" ")},t.decodeRecoveryKey=function(e){const t=i.default.decode(e.replace(/ /g,""));let n=0;for(const e of t)n^=e;if(0!==n)throw new Error("Incorrect parity");for(let e=0;e<s.length;++e)if(t[e]!==s[e])throw new Error("Incorrect prefix");if(t.length!==s.length+o.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return t.slice(s.length,s.length+o.Olm.PRIVATE_KEY_LENGTH)};var i=r(n(91));const s=[139,1]}).call(this,n(23).Buffer,n(3))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncAccumulator=void 0;var o=n(0),r=n(2);function i(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}t.SyncAccumulator=class{constructor(e){(e=e||{}).maxTimelineEntries=e.maxTimelineEntries||50,this.opts=e,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}accumulate(e){this._accumulateRooms(e),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}_accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}_accumulateRooms(e){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(t=>{this._accumulateRoom(t,"invite",e.rooms.invite[t])}),e.rooms.join&&Object.keys(e.rooms.join).forEach(t=>{this._accumulateRoom(t,"join",e.rooms.join[t])}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(t=>{this._accumulateRoom(t,"leave",e.rooms.leave[t])}))}_accumulateRoom(e,t,n){switch(t){case"invite":this._accumulateInviteState(e,n);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,n);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:o.logger.error("Unknown cateogory: ",t)}}_accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const n=this.inviteRooms[e];t.invite_state.events.forEach(e=>{let t=!1;for(let o=0;o<n.invite_state.events.length;o++){const r=n.invite_state.events[o];r.type===e.type&&r.state_key==e.state_key&&(n.invite_state.events[o]=e,t=!0)}t||n.invite_state.events.push(e)})}_accumulateJoinState(e,t){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const n=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{n._accountData[e.type]=e}),t.unread_notifications&&(n._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",o="m.invited_member_count",r="m.joined_member_count",i=n._summary,s=t.summary;i[e]=s[e]||i[e],i[r]=s[r]||i[r],i[o]=s[o]||i[o]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach(e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach(t=>{e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach(o=>{n._readReceipts[o]={data:e.content[t]["m.read"][o],eventId:t}})})}),t.timeline&&t.timeline.limited&&(n._timeline=[]),t.state&&t.state.events&&t.state.events.forEach(e=>{i(n._currentState,e)}),t.timeline&&t.timeline.events&&t.timeline.events.forEach((e,o)=>{i(n._currentState,e),n._timeline.push({event:e,token:0===o?t.timeline.prev_batch:null})}),n._timeline.length>this.opts.maxTimelineEntries){for(let e=n._timeline.length-this.opts.maxTimelineEntries;e<n._timeline.length;e++)if(n._timeline[e].token){n._timeline=n._timeline.slice(e,n._timeline.length);break}}}_accumulateGroups(e){e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach(t=>{this._accumulateGroup(t,"invite",e.groups.invite[t])}),e.groups.join&&Object.keys(e.groups.join).forEach(t=>{this._accumulateGroup(t,"join",e.groups.join[t])}),e.groups.leave&&Object.keys(e.groups.leave).forEach(t=>{this._accumulateGroup(t,"leave",e.groups.leave[t])}))}_accumulateGroup(e,t,n){for(const t of["invite","join","leave"])delete this.groups[t][e];this.groups[t][e]=n}getJSON(){const e={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(t=>{e.invite[t]=this.inviteRooms[t]}),Object.keys(this.joinRooms).forEach(t=>{const n=this.joinRooms[t],o={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:n._unreadNotifications,summary:n._summary};Object.keys(n._accountData).forEach(e=>{o.account_data.events.push(n._accountData[e])});const s={type:"m.receipt",room_id:t,content:{}};Object.keys(n._readReceipts).forEach(e=>{const t=n._readReceipts[e];s.content[t.eventId]||(s.content[t.eventId]={"m.read":{}}),s.content[t.eventId]["m.read"][e]=t.data}),Object.keys(s.content).length>0&&o.ephemeral.events.push(s),n._timeline.forEach(e=>{if(!o.timeline.prev_batch){if(!e.token)return;o.timeline.prev_batch=e.token}o.timeline.events.push(e.event)});const a=Object.create(null);for(let e=o.timeline.events.length-1;e>=0;e--){const t=o.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const n=(0,r.deepCopy)(t);n.unsigned&&(n.unsigned.prev_content&&(n.content=n.unsigned.prev_content),n.unsigned.prev_sender&&(n.sender=n.unsigned.prev_sender)),i(a,n)}Object.keys(n._currentState).forEach(e=>{Object.keys(n._currentState[e]).forEach(t=>{let r=n._currentState[e][t];a[e]&&a[e][t]&&(r=a[e][t]),o.state.events.push(r)})}),e.join[t]=o});const t=[];return Object.keys(this.accountData).forEach(e=>{t.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:e,groupsData:this.groups,accountData:t}}getNextBatchToken(){return this.nextBatch}}},function(e,t,n){"use strict";var o=String.prototype.replace,r=/%20/g,i=n(27),s={RFC1738:"RFC1738",RFC3986:"RFC3986"};e.exports=i.assign({default:s.RFC3986,formatters:{RFC1738:function(e){return o.call(e,r,"+")},RFC3986:function(e){return String(e)}}},s)},function(e,t){for(var n=[],o=0;o<256;++o)n[o]=(o+256).toString(16).substr(1);e.exports=function(e,t){var o=t||0,r=n;return[r[e[o++]],r[e[o++]],r[e[o++]],r[e[o++]],"-",r[e[o++]],r[e[o++]],"-",r[e[o++]],r[e[o++]],"-",r[e[o++]],r[e[o++]],"-",r[e[o++]],r[e[o++]],r[e[o++]],r[e[o++]],r[e[o++]],r[e[o++]]].join("")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o,r=n(50),i=(o=r)&&o.__esModule?o:{default:o};t.default=i.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=c(n(28)),i=(c(n(29)),function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(53))),s=n(108),a=c(n(114));function c(e){return e&&e.__esModule?e:{default:e}}n(115);var u="https://matrix.rhok.space",l="@anonymouscat:rhok.space",d="Support Chat",h=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));n.leaveRoom=function(){n.state.room_id&&n.state.client.leave(n.state.room_id).then((function(e){console.log("Left room",e)}))},n.createRoom=function(){return n.state.client.createRoom({room_alias_name:"private-support-chat-"+(0,s.uuid)(),invite:[l],visibility:"private",name:d}).then((function(e){n.setState({room_id:e.room_id})}))},n.sendMessage=function(){var e={body:n.state.inputValue,msgtype:"m.text"};n.state.client.sendEvent(n.state.room_id,"m.room.message",e,"").then((function(e){n.setState({inputValue:""}),n.chatboxInput.current.focus()})).catch((function(e){console.log(e)}))},n.handleInputChange=function(e){n.setState({inputValue:e.currentTarget.value})},n.handleSubmit=function(e){return e.preventDefault(),Boolean(n.state.inputValue)?n.state.room_id?void n.sendMessage():n.createRoom().then(n.sendMessage):null};var o=i.createClient(u);return n.state={client:o,ready:!1,rooms:{chunk:[]},access_token:null,user_id:null,messages:[],inputValue:""},n.chatboxInput=r.default.createRef(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),o(t,[{key:"componentDidMount",value:function(){var e=this;this.state.client.registerRequest({}).then((function(e){console.log("Empty registration request to get session",e)})).catch((function(t){var n=(0,s.uuid)(),o=(0,s.uuid)();e.state.client.registerRequest({auth:{session:t.data.session,type:"m.login.dummy"},inhibit_login:!1,password:o,username:n,x_show_msisdn:!0}).then((function(t){console.log("Registered user",t),e.setState({access_token:t.access_token,user_id:t.user_id,username:n,client:i.createClient({baseUrl:u,accessToken:t.access_token,userId:t.user_id})})})).catch((function(e){console.log("Registration error",e)}))}))}},{key:"componentDidUpdate",value:function(e,t){var n=this;t.client!==this.state.client&&(this.state.client.startClient(),this.state.client.once("sync",(function(e,t,o){"PREPARED"===e&&n.setState({ready:!0})})),this.state.client.on("Room.timeline",(function(e,t,o){if("m.room.message"===e.getType()){var r=[].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(n.state.messages));r.push(e),n.setState({messages:r})}})))}},{key:"componentWillUnmount",value:function(){this.leaveRoom()}},{key:"render",value:function(){var e=this.state,t=e.ready,n=e.messages,o=e.inputValue,i=e.user_id;return t?r.default.createElement("div",{id:"ocrcc-chatbox"},r.default.createElement("div",{className:"message-window"},n.map((function(e,t){return r.default.createElement(a.default,{key:e.event.event_id,message:e,user_id:i})}))),r.default.createElement("div",{className:"input-window"},r.default.createElement("form",{onSubmit:this.handleSubmit},r.default.createElement("input",{type:"text",onChange:this.handleInputChange,value:o,autoFocus:!0,ref:this.chatboxInput}),r.default.createElement("input",{type:"submit",value:"Send"})))):r.default.createElement("div",{className:"loader"},"loading...")}}]),t}(r.default.Component);h.propTypes={},h.defaultProps={},t.default=h},function(e,t,n){"use strict";var o=n(52);function r(){}function i(){}i.resetWarningCache=r,e.exports=function(){function e(e,t,n,r,i,s){if(s!==o){var a=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw a.name="Invariant Violation",a}}function t(){return e}e.isRequired=e;var n={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:i,resetWarningCache:r};return n.PropTypes=n,n}},function(e,t,n){"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},function(e,t,n){"use strict";(function(e){var o=n(5),r=n(1);Object.defineProperty(t,"__esModule",{value:!0});var i={};t.default=void 0;var s=r(n(30));Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=o(n(104)),c=o(n(105));let u;s.request((function(e,t){return e.qs=c.default.stringify(e.qs||{},e.qsStringifyOptions),(0,a.default)(e,t)}));try{u=e.indexedDB}catch(e){}u&&s.setCryptoStoreFactory((function(){return new s.IndexedDBCryptoStore(u,"matrix-js-sdk:crypto")}));var l=s;t.default=l,e.matrixcs=s}).call(this,n(3))},function(e,t){function n(t){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=n=function(e){return typeof e}:e.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(t)}e.exports=n},function(e,t,n){var o,r;!function(i,s){"use strict";void 0===(r="function"==typeof(o=function(){var e=function(){},t="undefined",n=typeof window!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"];function r(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function i(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function s(t,n){for(var r=0;r<o.length;r++){var i=o[r];this[i]=r<t?e:this.methodFactory(i,t,n)}this.log=this.debug}function a(e,n,o){return function(){typeof console!==t&&(s.call(this,n,o),this[e].apply(this,arguments))}}function c(o,s,c){return function(o){return"debug"===o&&(o="log"),typeof console!==t&&("trace"===o&&n?i:void 0!==console[o]?r(console,o):void 0!==console.log?r(console,"log"):e)}(o)||a.apply(this,arguments)}function u(e,n,r){var i,a=this,u="loglevel";function l(){var e;if(typeof window!==t){try{e=window.localStorage[u]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,o=n.indexOf(encodeURIComponent(u)+"=");-1!==o&&(e=/^([^;]+)/.exec(n.slice(o))[1])}catch(e){}return void 0===a.levels[e]&&(e=void 0),e}}e&&(u+=":"+e),a.name=e,a.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},a.methodFactory=r||c,a.getLevel=function(){return i},a.setLevel=function(n,r){if("string"==typeof n&&void 0!==a.levels[n.toUpperCase()]&&(n=a.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=a.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(i=n,!1!==r&&function(e){var n=(o[e]||"silent").toUpperCase();if(typeof window!==t){try{return void(window.localStorage[u]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+n+";"}catch(e){}}}(n),s.call(a,n,e),typeof console===t&&n<a.levels.SILENT)return"No console available for logging"},a.setDefaultLevel=function(e){l()||a.setLevel(e,!1)},a.enableAll=function(e){a.setLevel(a.levels.TRACE,e)},a.disableAll=function(e){a.setLevel(a.levels.SILENT,e)};var d=l();null==d&&(d=null==n?"WARN":n),a.setLevel(d,!1)}var l=new u,d={};l.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=d[e];return t||(t=d[e]=new u(e,l.getLevel(),l.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return l.noConflict=function(){return typeof window!==t&&window.log===l&&(window.log=h),l},l.getLoggers=function(){return d},l})?o.call(t,n,t,e):o)||(e.exports=r)}()},function(e,t,n){"use strict";var o=n(57);var r=RegExp(Object.keys(o).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function i(e){return o[e]}e.exports=function(e){return e.replace(r,i)}},function(e){e.exports=JSON.parse('{"0":"O","1":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\\u2028":" ","\\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":">","":">","":">","":"4","":"b","":"b","":"d","":"J","":"L","":"P","":"U","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","`":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'\'","\\"":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'\'","":"\'\'\'","":"\'\'\'\'","":"\'B","":"\'D","":"\'n","":"\'P","":"\'T","":"\'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\\\\\","":"\\\\\\\\","":"\\\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">","":">","":">","":">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","":"","":"","":"","":"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"","":"","":"","":"","":"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"","":"","":"","":"4,","":"4.","":"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"","":"","":"","":"","":"","":"a/c","":"a/s","":"aa","":"AA","":"ae","":"ae","":"AE","":"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"","":"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b\'","":"bl","":"","":"","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"c","":"c","":"C","":"C","":"C\'","":"c/o","":"c/u","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"d","":"","":"d","":"d\'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","":"","":"","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G\'","":"","":"","":"","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J","":"","":"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"k","":"K","":"K","":"K","":"K","":"K","":"K\'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","I":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l,","":"l.","":"l\'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","":"","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"","":"","":"","":"o","":"","":"o","":"o","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"O,","":"O.","":"o\'","":"O\'","":"O\'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"p","":"p","":"p","":"P\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"q","":"QE","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"r","":"r","":"r","":"r","":"r","":"r\'","":"rn","m":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"","":"","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"s","":"s","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"sss","":"st","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"t","":"T","":"T","":"","":"T","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"","":"","":"u","":"u","":"U","":"U","":"U","":"U\'","":"ue","":"uo","":"","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"w","":"w","":"W","":"w","":"","":"","":"","":"","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"x","":"X","":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"/","":"","":"","":"","":"","":"","":"\'","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":"b","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"b","":"d","":"P","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}')},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixScheduler=a;var r=o(n(2)),i=n(0);const s=!1;function a(e,t){this.retryAlgorithm=e||a.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||a.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function c(e){e._procFn&&r.forEach(r.filter(r.keys(e._queues),(function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})),(function(t){e._activeQueues.push(t),l("Spinning up queue: '%s'",t),function e(t,n){const o=function(e,t){const n=e._queues[t];if(!r.isArray(n))return null;return n[0]}(t,n);if(!o){const e=t._activeQueues.indexOf(n);return e>=0&&t._activeQueues.splice(e,1),void l("Stopping queue '%s' as it is now empty",n)}l("Queue '%s' has %s pending events",n,t._queues[n].length);Promise.resolve().then(()=>t._procFn(o.event)).then((function(r){u(t,n),l("Queue '%s' sent event %s",n,o.event.getId()),o.defer.resolve(r),e(t,n)}),(function(r){o.attempts+=1;const i=t.retryAlgorithm(o.event,o.attempts,r);l("retry(%s) err=%s event_id=%s waitTime=%s",o.attempts,r,o.event.getId(),i),-1===i?(l("Queue '%s' giving up on event %s",n,o.event.getId()),u(t,n),o.defer.reject(r),e(t,n)):setTimeout((function(){e(t,n)}),i)}))}(e,t)}))}function u(e,t){const n=e._queues[t];return r.isArray(n)?n.shift():null}function l(){s&&i.logger.log(...arguments)}a.prototype.getQueueForEvent=function(e){const t=this.queueAlgorithm(e);return t&&this._queues[t]?r.map(this._queues[t],(function(e){return e.event})):null},a.prototype.removeEventFromQueue=function(e){const t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;let n=!1;return r.removeElement(this._queues[t],(function(t){if(t.event.getId()===e.getId())return n=!0,!0})),n},a.prototype.setProcessFunction=function(e){this._procFn=e,c(this)},a.prototype.queueEvent=function(e){const t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);const n=r.defer();return this._queues[t].push({event:e,defer:n,attempts:0}),l("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),c(this),n.promise},a.RETRY_BACKOFF_RATELIMIT=function(e,t,n){if(400===n.httpStatus||403===n.httpStatus||401===n.httpStatus)return-1;if("rejected"===n.cors)return-1;if("M_TOO_LARGE"===n.name)return-1;if("M_LIMIT_EXCEEDED"===n.name){const e=n.data.retry_after_ms;if(e)return e}return t>4?-1:1e3*Math.pow(2,t)},a.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null}},function(e,t,n){"use strict";(function(e){var o=n(1),r=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixClient=A,t.CRYPTO_ENABLED=void 0;var i=r(n(17)),s=n(4),a=n(66),c=n(19),u=n(70),l=n(6),d=n(8),h=n(74),p=n(76),f=n(37),g=o(n(2)),m=n(12),y=n(13),_=o(n(38)),v=o(n(7)),S=n(21),E=n(80),b=n(0),w=n(83),I=n(45),R=n(44),T=n(15),k=n(18);const O=(0,w.isCryptoAvailable)();t.CRYPTO_ENABLED=O;function C(e,t,n){const o=[];for(const[r,i]of Object.entries(e))try{const e=D(i,t);e.session_id=r,e.room_id=n,o.push(e)}catch(e){b.logger.log("Failed to decrypt megolm session from backup",e)}return o}function D(e,t){return JSON.parse(t.decrypt(e.session_data.ephemeral,e.session_data.mac,e.session_data.ciphertext))}function A(e){e.baseUrl=g.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=g.ensureNoTrailingSlash(e.idBaseUrl),a.MatrixBaseApis.call(this,e),this.olmVersion=null,this.reEmitter=new S.ReEmitter(this),this.store=e.store||new p.StubStore,this.deviceId=e.deviceId||null;const t=e.userId||null;if(this.credentials={userId:t},this.scheduler=e.scheduler,this.scheduler){const e=this;this.scheduler.setProcessFunction((function(t){const n=e.getRoom(t.getRoomId());return t.status!==l.EventStatus.SENDING&&N(n,t,l.EventStatus.SENDING),L(e,t)}))}this.clientRunning=!1,this.callList={};const n=(0,f.createNewMatrixCall)(this);this._supportsVoip=!1,n&&(!function(e){const t={};let n=[];function o(){if("SYNCING"===e.getSyncState()){if(n.some(e=>e.isBeingDecrypted()))return;const e={};for(let t=n.length-1;t>=0;t--){const o=n[t];"m.call.answer"!==o.getType()&&"m.call.hangup"!==o.getType()||(e[o.getContent().call_id]="yep")}n.forEach((function(t){"m.call.invite"===t.getType()&&e[t.getContent().call_id]||r(t)})),n=[]}}function r(n){const o=n.getContent();let r,i=o.call_id?e.callList[o.call_id]:void 0;if("m.call.invite"===n.getType()){if(n.getSender()===e.credentials.userId)return;if(n.getAge()>o.lifetime)return;if(i&&"ended"===i.state)return;if(i&&b.logger.log("WARN: Already have a MatrixCall with id %s but got an invite. Clobbering.",o.call_id),!(i=(0,f.createNewMatrixCall)(e,n.getRoomId(),{forceTURN:e._forceTURN})))return void b.logger.log("Incoming call ID "+o.call_id+" but this client doesn't support WebRTC");if(i.callId=o.call_id,i._initWithInvite(n),e.callList[i.callId]=i,t[i.callId])for(r=0;r<t[i.callId].length;r++)i._gotRemoteIceCandidate(t[i.callId][r]);let s;const a=g.values(e.callList);for(r=0;r<a.length;++r){const e=a[r];if(i.roomId===e.roomId&&"outbound"===e.direction&&-1!==["wait_local_media","create_offer","invite_sent"].indexOf(e.state)){s=e;break}}s?"wait_local_media"===s.state||"create_offer"===s.state||s.callId>i.callId?(b.logger.log("Glare detected: answering incoming call "+i.callId+" and canceling outgoing call "+s.callId),s._replacedBy(i),i.answer()):(b.logger.log("Glare detected: rejecting incoming call "+i.callId+" and keeping outgoing call "+s.callId),i.hangup()):e.emit("Call.incoming",i)}else if("m.call.answer"===n.getType()){if(!i)return;n.getSender()===e.credentials.userId?"ringing"===i.state&&i._onAnsweredElsewhere(o):i._receivedAnswer(o)}else if("m.call.candidates"===n.getType()){if(n.getSender()===e.credentials.userId)return;if(i)for(r=0;r<o.candidates.length;r++)i._gotRemoteIceCandidate(o.candidates[r]);else t[o.call_id]||(t[o.call_id]=[]),t[o.call_id]=t[o.call_id].concat(o.candidates)}else"m.call.hangup"===n.getType()&&(i?"ended"!==i.state&&(i._onHangupReceived(o),delete e.callList[o.call_id]):(i=(0,f.createNewMatrixCall)(e,n.getRoomId()))&&(i.callId=o.call_id,i._initWithHangup(n),e.callList[o.call_id]=i))}e.on("sync",o),e.on("event",(function(e){(0===e.getType().indexOf("m.call.")||e.isBeingDecrypted())&&n.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",()=>{-1!==e.getType().indexOf("m.call.")&&(n.includes(e)?o():r(e))})}))}(this),this._supportsVoip=!0),this._syncingRetry=null,this._syncApi=null,this._peekSync=null,this._isGuest=!1,this._ongoingScrollbacks={},this.timelineSupport=Boolean(e.timelineSupport),this.urlPreviewCache={},this._notifTimelineSet=null,this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this._crypto=null,this._cryptoStore=e.cryptoStore,this._sessionStore=e.sessionStore,this._verificationMethods=e.verificationMethods,this._cryptoCallbacks=e.cryptoCallbacks||{},this._forceTURN=e.forceTURN||!1,this._fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this._roomList=new E.RoomList(this._cryptoStore),this._pushProcessor=new k.PushProcessor(this),this._serverVersionsCache=null,this._cachedCapabilities=null,this.on("Event.decrypted",e=>{const t=e.getPushActions(),n=this._pushProcessor.actionsForEvent(e);e.setPushActions(n);const o=this.getRoom(e.getRoomId());if(!o)return;const r=o.getUnreadNotificationCount("highlight"),i=!(!t||!t.tweaks)&&!!t.tweaks.highlight,s=!(!n||!n.tweaks)&&!!n.tweaks.highlight;if((i!==s||r>0)&&!o.hasUserReadEvent(this.getUserId(),e.getId())){let e=r;s&&!i&&e++,!s&&i&&e--,o.setUnreadNotificationCount("highlight",e),o.getUnreadNotificationCount("total")<e&&o.setUnreadNotificationCount("total",e)}}),this.on("Room.receipt",(e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const n=e.getContent();if(!(Object.keys(n).filter(e=>Object.keys(n[e]["m.read"]).includes(this.getUserId())).length>0))return;const o=20,r=t.getLiveTimeline().getEvents();let i=0;for(let e=r.length-1;e>=0;e--){if(e===r.length-o)return;const n=r[e];if(t.hasUserReadEvent(this.getUserId(),n.getId()))break;i+=this.getPushActionsForEvent(n).tweaks.highlight?1:0}t.setUnreadNotificationCount("highlight",i)}})}async function P(e,t,n,o,r,i){if(!e._crypto)throw new Error("End-to-End encryption disabled");await e._crypto.setDeviceVerification(t,n,o,r,i)}function M(e,t){for(const n of t)e.prototype[n]=function(...e){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto[n](...e)}}function U(e,t,n,o){return Promise.resolve().then((function(){const o=function(e,t,n){if(t.isEncrypted())return null;if(!e.isRoomEncrypted(t.getRoomId()))return null;if("m.reaction"===t.getType())return null;if(!e._crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return e._crypto.encryptEvent(t,n)}(e,n,t);return o?(N(t,n,l.EventStatus.ENCRYPTING),o.then(()=>{N(t,n,l.EventStatus.SENDING)})):null})).then((function(){let o;return e.scheduler&&(o=e.scheduler.queueEvent(n))&&e.scheduler.getQueueForEvent(n).length>1&&N(t,n,l.EventStatus.QUEUED),o||(o=L(e,n)),o})).then((function(e){return t&&t.updatePendingEvent(n,l.EventStatus.SENT,e.event_id),o&&o(null,e),e}),(function(e){b.logger.error("Error sending event",e.stack||e);try{n.error=e,N(t,n,l.EventStatus.NOT_SENT),e.event=n,o&&o(e)}catch(t){b.logger.error("Exception in error handler!",t.stack||e)}throw e}))}function N(e,t,n){e?e.updatePendingEvent(t,n):t.setStatus(n)}function L(e,t){const n=t._txnId?t._txnId:e.makeTxnId(),o={$roomId:t.getRoomId(),$eventType:t.getWireType(),$stateKey:t.getStateKey(),$txnId:n};let r;if(t.isState()){let e="/rooms/$roomId/state/$eventType";t.getStateKey()&&t.getStateKey().length>0&&(e="/rooms/$roomId/state/$eventType/$stateKey"),r=g.encodeUri(e,o)}else if(t.isRedaction()){const e="/rooms/$roomId/redact/$redactsEventId/$txnId";r=g.encodeUri(e,Object.assign({$redactsEventId:t.event.redacts},o))}else r=g.encodeUri("/rooms/$roomId/send/$eventType/$txnId",o);return e._http.authedRequest(void 0,"PUT",r,void 0,t.getWireContent()).then(e=>(b.logger.log(`Event sent to ${t.getRoomId()} with event id ${e.event_id}`),e))}function x(e,t,n,o,r,i){g.isFunction(r)&&(i=r,r=void 0);const s=g.encodeUri("/rooms/$room_id/$membership",{$room_id:t,$membership:o});return e._http.authedRequest(i,"POST",s,void 0,{user_id:n,reason:r})}function K(e,t,n,o){const r=g.encodeUri("/presence/list/$userId",{$userId:t.credentials.userId});return t._http.authedRequest(e,o,r,void 0,n)}function B(e,t,n){e&&e(n),t(n)}function q(e,t,n){e&&e(null,n),t(n)}function j(e){return function(t){const n=new l.MatrixEvent(t);n.isEncrypted()&&(e.reEmitter.reEmit(n,["Event.decrypted"]),n.attemptDecryption(e._crypto));const o=e.getRoom(n.getRoomId());return o&&o.reEmitter.reEmit(n,["Event.replaced"]),n}}g.inherits(A,s.EventEmitter),g.extend(A.prototype,a.MatrixBaseApis.prototype),A.prototype.clearStores=function(){if(this._clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this._cryptoStore&&e.push(this._cryptoStore.deleteAllData()),Promise.all(e)},A.prototype.getUserId=function(){return this.credentials&&this.credentials.userId?this.credentials.userId:null},A.prototype.getDomain=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null},A.prototype.getUserIdLocalpart=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null},A.prototype.getDeviceId=function(){return this.deviceId},A.prototype.supportsVoip=function(){return this._supportsVoip},A.prototype.setForceTURN=function(e){this._forceTURN=e},A.prototype.getSyncState=function(){return this._syncApi?this._syncApi.getSyncState():null},A.prototype.getSyncStateData=function(){return this._syncApi?this._syncApi.getSyncStateData():null},A.prototype.isInitialSyncComplete=function(){const e=this.getSyncState();return!!e&&("PREPAED"===e||"SYNCING"===e)},A.prototype.isGuest=function(){return this._isGuest},A.prototype.getScheduler=function(){return this.scheduler},A.prototype.setGuest=function(e){this._isGuest=e},A.prototype.retryImmediately=function(){return this._syncApi.retryImmediately()},A.prototype.getNotifTimelineSet=function(){return this._notifTimelineSet},A.prototype.setNotifTimelineSet=function(e){this._notifTimelineSet=e},A.prototype.getCapabilities=function(e=!1){const t=(new Date).getTime();return this._cachedCapabilities&&!e&&t<this._cachedCapabilities.expiration?(b.logger.log("Returning cached capabilities"),Promise.resolve(this._cachedCapabilities.capabilities)):this._http.authedRequest(void 0,"GET","/capabilities").catch(e=>(b.logger.error(e),null)).then(e=>{e||(e={});const n=e.capabilities||{},o=Object.keys(n).length?216e5:6e4+5e3*Math.random();return this._cachedCapabilities={capabilities:n,expiration:t+o},b.logger.log("Caching capabilities: ",n),n})},A.prototype.initCrypto=async function(){if(!(0,w.isCryptoAvailable)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this._crypto)return void b.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this._sessionStore)throw new Error("Cannot enable encryption: no sessionStore provided");if(!this._cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");b.logger.log("Crypto: initialising roomlist..."),await this._roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new w.Crypto(this,this._sessionStore,e,this.deviceId,this.store,this._cryptoStore,this._roomList,this._verificationMethods);this.reEmitter.reEmit(t,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","deviceVerificationChanged","userTrustStatusChanged","crossSigning.keysChanged"]),b.logger.log("Crypto: initialising crypto object..."),await t.init(),this.olmVersion=w.Crypto.getOlmVersion(),t.registerEventHandlers(this),this._crypto=t},A.prototype.isCryptoEnabled=function(){return null!==this._crypto},A.prototype.getDeviceEd25519Key=function(){return this._crypto?this._crypto.getDeviceEd25519Key():null},A.prototype.uploadKeys=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.uploadDeviceKeys()},A.prototype.downloadKeys=function(e,t){return null===this._crypto?Promise.reject(new Error("End-to-end encryption disabled")):this._crypto.downloadKeys(e,t)},A.prototype.getStoredDevicesForUser=async function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevicesForUser(e)||[]},A.prototype.getStoredDevice=async function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevice(e,t)||null},A.prototype.setDeviceVerified=function(e,t,n){void 0===n&&(n=!0);const o=P(this,e,t,n,null);return e==this.credentials.userId&&this._crypto.checkKeyBackup(),o},A.prototype.setDeviceBlocked=function(e,t,n){return void 0===n&&(n=!0),P(this,e,t,null,n)},A.prototype.setDeviceKnown=function(e,t,n){return void 0===n&&(n=!0),P(this,e,t,null,null,n)},A.prototype.requestVerificationDM=function(e,t,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerificationDM(e,t,n)},A.prototype.acceptVerificationDM=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.acceptVerificationDM(e,t)},A.prototype.requestVerification=function(e,t,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerification(e,t,n)},A.prototype.beginKeyVerification=function(e,t,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.beginKeyVerification(e,t,n)},A.prototype.setGlobalBlacklistUnverifiedDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalBlacklistUnverifiedDevices(e)},A.prototype.getGlobalBlacklistUnverifiedDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalBlacklistUnverifiedDevices()},A.prototype.setGlobalErrorOnUnknownDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalErrorOnUnknownDevices(e)},A.prototype.getGlobalErrorOnUnknownDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalErrorOnUnknownDevices()},M(A,["resetCrossSigningKeys","getCrossSigningId","getStoredCrossSigningForUser","checkUserTrust","checkDeviceTrust","checkOwnCrossSigningTrust","checkCrossSigningPrivateKey"]),A.prototype.checkEventSenderTrust=async function(e){const t=await this.getEventSenderDeviceInfo(e);return t?await this._crypto.checkDeviceTrust(e.getSender(),t.deviceId):0},M(A,["createRecoveryKeyFromPassphrase","bootstrapSecretStorage","addSecretStorageKey","hasSecretStorageKey","storeSecret","getSecret","isSecretStored","requestSecret","getDefaultSecretStorageKeyId","setDefaultSecretStorageKeyId","checkSecretStoragePrivateKey"]),A.prototype.getEventSenderDeviceInfo=async function(e){return this._crypto?this._crypto.getEventSenderDeviceInfo(e):null},A.prototype.isEventSenderVerified=async function(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()},A.prototype.cancelAndResendEventRoomKeyRequest=function(e){return e.cancelAndResendKeyRequest(this._crypto,this.getUserId())},A.prototype.setRoomEncryption=function(e,t){if(!this._crypto)throw new Error("End-to-End encryption disabled");return this._crypto.setRoomEncryption(e,t)},A.prototype.isRoomEncrypted=function(e){const t=this.getRoom(e);return!!t&&(!!t.currentState.getStateEvents("m.room.encryption","")||this._roomList.isRoomEncrypted(e))},A.prototype.forceDiscardSession=function(e){if(!this._crypto)throw new Error("End-to-End encryption disabled");this._crypto.forceDiscardSession(e)},A.prototype.exportRoomKeys=function(){return this._crypto?this._crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))},A.prototype.importRoomKeys=function(e){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.importRoomKeys(e)},A.prototype.checkKeyBackup=function(){return this._crypto.checkKeyBackup()},A.prototype.getKeyBackupVersion=function(){return this._http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:m.PREFIX_UNSTABLE}).then(e=>{if(e.algorithm!==v.MEGOLM_BACKUP_ALGORITHM){const t="Unknown backup algorithm: "+e.algorithm;return Promise.reject(t)}if("object"==typeof e.auth_data&&e.auth_data.public_key)return e;{const e="Invalid backup data returned";return Promise.reject(e)}}).catch(e=>{if("M_NOT_FOUND"===e.errcode)return null;throw e})},A.prototype.isKeyBackupTrusted=function(e){return this._crypto.isKeyBackupTrusted(e)},A.prototype.getKeyBackupEnabled=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return Boolean(this._crypto.backupKey)},A.prototype.enableKeyBackup=function(t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=t,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=new e.Olm.PkEncryption,this._crypto.backupKey.set_recipient_key(t.auth_data.public_key),this.emit("crypto.keyBackupStatus",!0),this._crypto.scheduleKeyBackupSend()},A.prototype.disableKeyBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=null,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=null,this.emit("crypto.keyBackupStatus",!1)},A.prototype.prepareKeyBackupVersion=async function(e,{secureSecretStorage:t=!1}={}){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const[n,o,r]=await this.createRecoveryKeyFromPassphrase(e);t&&(await this.storeSecret("m.megolm_backup.v1",(0,v.encodeBase64)(r)),b.logger.info("Key backup private key stored in secret storage"));const i={public_key:n.pubkey};return n.passphrase&&(i.private_key_salt=n.passphrase.salt,i.private_key_iterations=n.passphrase.iterations),{algorithm:v.MEGOLM_BACKUP_ALGORITHM,auth_data:i,recovery_key:o}},A.prototype.isKeyBackupKeyStored=async function(){return this.isSecretStored("m.megolm_backup.v1",!1)},A.prototype.createKeyBackupVersion=async function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const t={algorithm:e.algorithm,auth_data:e.auth_data};await this._crypto._signObject(t.auth_data),this._cryptoCallbacks.getCrossSigningKey&&this._crypto._crossSigningInfo.getId()&&await this._crypto._crossSigningInfo.signObject(t.auth_data,"master");const n=await this._http.authedRequest(void 0,"POST","/room_keys/version",void 0,t,{prefix:m.PREFIX_UNSTABLE});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||b.logger.error("Key backup not usable even though we just created it"),n},A.prototype.deleteKeyBackupVersion=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo&&this._crypto.backupInfo.version===e&&this.disableKeyBackup();const t=g.encodeUri("/room_keys/version/$version",{$version:e});return this._http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:m.PREFIX_UNSTABLE})},A.prototype._makeKeyBackupPath=function(e,t,n){let o;return{path:o=void 0!==t?g.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?g.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",queryData:void 0===n?void 0:{version:n}}},A.prototype.sendKeyBackup=function(e,t,n,o){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const r=this._makeKeyBackupPath(e,t,n);return this._http.authedRequest(void 0,"PUT",r.path,r.queryData,o,{prefix:m.PREFIX_UNSTABLE})},A.prototype.scheduleAllGroupSessionsForBackup=async function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");await this._crypto.scheduleAllGroupSessionsForBackup()},A.prototype.flagAllGroupSessionsForBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.flagAllGroupSessionsForBackup()},A.prototype.isValidRecoveryKey=function(e){try{return(0,I.decodeRecoveryKey)(e),!0}catch(e){return!1}},A.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY",A.prototype.restoreKeyBackupWithPassword=async function(e,t,n,o){const r=await(0,R.keyFromAuthData)(o.auth_data,e);return this._restoreKeyBackup(r,t,n,o)},A.prototype.restoreKeyBackupWithSecretStorage=async function(e,t,n){const o=(0,v.decodeBase64)(await this.getSecret("m.megolm_backup.v1"));return this._restoreKeyBackup(o,t,n,e)},A.prototype.restoreKeyBackupWithRecoveryKey=function(e,t,n,o){const r=(0,I.decodeRecoveryKey)(e);return this._restoreKeyBackup(r,t,n,o)},A.prototype._restoreKeyBackup=function(t,n,o,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");let i=0,s=[];const a=this._makeKeyBackupPath(n,o,r.version),c=new e.Olm.PkDecryption;let u;try{u=c.init_with_private_key(t)}catch(e){throw c.free(),e}return u!==r.auth_data.public_key?Promise.reject({errcode:A.RESTORE_BACKUP_ERROR_BAD_KEY}):this._http.authedRequest(void 0,"GET",a.path,a.queryData,void 0,{prefix:m.PREFIX_UNSTABLE}).then(e=>{if(e.rooms)for(const[t,n]of Object.entries(e.rooms)){if(!n.sessions)continue;i+=Object.keys(n.sessions).length;const e=C(n.sessions,c,t);for(const n of e)n.room_id=t,s.push(n)}else if(e.sessions)i=Object.keys(e.sessions).length,s=C(e.sessions,c,n);else{i=1;try{const t=D(e,c);t.room_id=n,t.session_id=o,s.push(t)}catch(e){b.logger.log("Failed to decrypt megolm session from backup",e)}}return this.importRoomKeys(s)}).then(()=>this._crypto.setTrustedBackupPubKey(u)).then(()=>({total:i,imported:s.length})).finally(()=>{c.free()})},A.prototype.deleteKeysFromBackup=function(e,t,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const o=this._makeKeyBackupPath(e,t,n);return this._http.authedRequest(void 0,"DELETE",o.path,o.queryData,void 0,{prefix:m.PREFIX_UNSTABLE})},A.prototype.getGroup=function(e){return this.store.getGroup(e)},A.prototype.getGroups=function(){return this.store.getGroups()},A.prototype.getMediaConfig=function(e){return this._http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:m.PREFIX_MEDIA_R0})},A.prototype.getRoom=function(e){return this.store.getRoom(e)},A.prototype.getRooms=function(){return this.store.getRooms()},A.prototype.getVisibleRooms=function(){const e=this.store.getRooms(),t=new Set;for(const n of e){const e=n.currentState.getStateEvents("m.room.create","");if(e){const n=e.getContent().predecessor;n&&n.room_id&&t.add(n.room_id)}}return e.filter(e=>{return!e.currentState.getStateEvents("m.room.tombstone","")||!t.has(e.roomId)})},A.prototype.getUser=function(e){return this.store.getUser(e)},A.prototype.getUsers=function(){return this.store.getUsers()},A.prototype.setAccountData=function(e,t,n){const o=g.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this._http.authedRequest(n,"PUT",o,void 0,t)},A.prototype.getAccountData=function(e){return this.store.getAccountData(e)},A.prototype.getAccountDataFromServer=async function(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=g.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this._http.authedRequest(void 0,"GET",t,void 0)},A.prototype.getIgnoredUsers=function(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]},A.prototype.setIgnoredUsers=function(e,t){const n={ignored_users:{}};return e.map(e=>n.ignored_users[e]={}),this.setAccountData("m.ignored_user_list",n,t)},A.prototype.isUserIgnored=function(e){return-1!==this.getIgnoredUsers().indexOf(e)},A.prototype.joinRoom=function(e,t,n){if(g.isFunction(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const o=this.getRoom(e);if(o&&o.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(o);let r=Promise.resolve();t.inviteSignUrl&&(r=this._http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));const i={};t.viaServers&&(i.server_name=t.viaServers);const s={qsStringifyOptions:{arrayFormat:"repeat"}},a=this;return new Promise((o,c)=>{r.then((function(t){const n={};t&&(n.third_party_signed=t);const o=g.encodeUri("/join/$roomid",{$roomid:e});return a._http.authedRequest(void 0,"POST",o,i,n,s)})).then((function(e){const n=e.room_id,o=new u.SyncApi(a,a._clientOpts).createRoom(n);return t.syncRoom,Promise.resolve(o)})).then((function(e){q(n,o,e)}),(function(e){B(n,c,e)}))})},A.prototype.resendEvent=function(e,t){return N(t,e,l.EventStatus.SENDING),U(this,t,e)},A.prototype.cancelPendingEvent=function(e){if([l.EventStatus.QUEUED,l.EventStatus.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e),N(this.getRoom(e.getRoomId()),e,l.EventStatus.CANCELLED)},A.prototype.setRoomName=function(e,t,n){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,n)},A.prototype.setRoomTopic=function(e,t,n){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,n)},A.prototype.getRoomTags=function(e,t){const n=g.encodeUri("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this._http.authedRequest(t,"GET",n,void 0)},A.prototype.setRoomTag=function(e,t,n,o){const r=g.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(o,"PUT",r,void 0,n)},A.prototype.deleteRoomTag=function(e,t,n){const o=g.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(n,"DELETE",o,void 0,void 0)},A.prototype.setRoomAccountData=function(e,t,n,o){const r=g.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this._http.authedRequest(o,"PUT",r,void 0,n)},A.prototype.setPowerLevel=function(e,t,n,o,r){let i={users:{}};o&&"m.room.power_levels"===o.getType()&&(i=g.deepCopy(o.getContent())),i.users[t]=n;const s=g.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this._http.authedRequest(r,"PUT",s,void 0,i)},A.prototype.sendEvent=function(e,t,n,o,r){return this._sendCompleteEvent(e,{type:t,content:n},o,r)},A.prototype._sendCompleteEvent=function(e,t,n,o){g.isFunction(n)&&(o=n,n=void 0),n||(n=this.makeTxnId());const r=new l.MatrixEvent(Object.assign(t,{event_id:"~"+e+":"+n,user_id:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),i=this.getRoom(e),s=r.getAssociatedId();if(s&&s.startsWith("~")){const e=i.getPendingEvents().find(e=>e.getId()===s);e.once("Event.localEventIdReplaced",()=>{r.updateAssociatedId(e.getId())})}const a=r.getType();return b.logger.log(`sendEvent of type ${a} in ${e} with txnId ${n}`),r._txnId=n,r.setStatus(l.EventStatus.SENDING),i&&i.addPendingEvent(r,n),r.status===l.EventStatus.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):U(this,i,r,o)},A.prototype.redactEvent=function(e,t,n,o){return this._sendCompleteEvent(e,{type:"m.room.redaction",content:{},redacts:t},n,o)},A.prototype.sendMessage=function(e,t,n,o){return g.isFunction(n)&&(o=n,n=void 0),this.sendEvent(e,"m.room.message",t,n,o)},A.prototype.sendTextMessage=function(e,t,n,o){const r=_.makeTextMessage(t);return this.sendMessage(e,r,n,o)},A.prototype.sendNotice=function(e,t,n,o){const r=_.makeNotice(t);return this.sendMessage(e,r,n,o)},A.prototype.sendEmoteMessage=function(e,t,n,o){const r=_.makeEmoteMessage(t);return this.sendMessage(e,r,n,o)},A.prototype.sendImageMessage=function(e,t,n,o,r){g.isFunction(o)&&(r=o,o=void 0),o||(o="Image");const i={msgtype:"m.image",url:t,info:n,body:o};return this.sendMessage(e,i,r)},A.prototype.sendStickerMessage=function(e,t,n,o,r){g.isFunction(o)&&(r=o,o=void 0),o||(o="Sticker");const i={url:t,info:n,body:o};return this.sendEvent(e,"m.sticker",i,r,void 0)},A.prototype.sendHtmlMessage=function(e,t,n,o){const r=_.makeHtmlMessage(t,n);return this.sendMessage(e,r,o)},A.prototype.sendHtmlNotice=function(e,t,n,o){const r=_.makeHtmlNotice(t,n);return this.sendMessage(e,r,o)},A.prototype.sendHtmlEmote=function(e,t,n,o){const r=_.makeHtmlEmote(t,n);return this.sendMessage(e,r,o)},A.prototype.sendReceipt=function(e,t,n,o){if("function"==typeof n&&(o=n,n={}),this.isGuest())return Promise.resolve({});const r=g.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),i=this._http.authedRequest(o,"POST",r,void 0,n||{}),s=this.getRoom(e.getRoomId());return s&&s._addLocalEchoReceipt(this.credentials.userId,e,t),i},A.prototype.sendReadReceipt=async function(e,t,n){"function"==typeof t&&(n=t,t={}),t||(t={});const o=e.getId(),r=this.getRoom(e.getRoomId());if(r&&r.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);const i={"m.hidden":Boolean(t.hidden)};return this.sendReceipt(e,"m.read",i,n)},A.prototype.setRoomReadMarkers=async function(e,t,n,o){const r=this.getRoom(e);if(r&&r.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let i;if(n){if(i=n.getId(),r&&r.hasPendingEvent(i))throw new Error(`Cannot set read receipt to a pending event (${i})`);r&&r._addLocalEchoReceipt(this.credentials.userId,n,"m.read")}return this.setRoomReadMarkersHttpRequest(e,t,i,o)},A.prototype.getUrlPreview=function(e,t,n){const o=t+"_"+e,r=this.urlPreviewCache[o];if(r)return Promise.resolve(r);const i=this;return this._http.authedRequest(n,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:m.PREFIX_MEDIA_R0}).then((function(e){return i.urlPreviewCache[o]=e,e}))},A.prototype.sendTyping=function(e,t,n,o){if(this.isGuest())return Promise.resolve({});const r=g.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),i={typing:t};return t&&(i.timeout=n||2e4),this._http.authedRequest(o,"PUT",r,void 0,i)},A.prototype.getRoomUpgradeHistory=function(e,t=!1){let n=this.getRoom(e);if(!n)return[];const o=[n];let r=n.currentState.getStateEvents("m.room.create","");for(;r;){b.logger.log(`Looking at ${r.getId()}`);const e=r.getContent().predecessor;if(!e||!e.room_id)break;{b.logger.log(`Looking at predecessor ${e.room_id}`);const n=this.getRoom(e.room_id);if(!n)break;if(t){const e=n.currentState.getStateEvents("m.room.tombstone","");if(!e||e.getContent().replacement_room!==n.roomId)break}o.splice(0,0,n),r=n.currentState.getStateEvents("m.room.create","")}}let i=n.currentState.getStateEvents("m.room.tombstone","");for(;i;){const e=this.getRoom(i.getContent().replacement_room);if(!e)break;if(e.roomId===n.roomId)break;if(t){if(!(r=e.currentState.getStateEvents("m.room.create",""))||!r.getContent().predecessor)break;if(r.getContent().predecessor.room_id!==n.roomId)break}if(o.push(e),new Set(o.map(e=>e.roomId)).size<o.length)return o.slice(0,o.length-1);i=(n=e).currentState.getStateEvents("m.room.tombstone","")}return o},A.prototype.invite=function(e,t,n){return x(this,e,t,"invite",void 0,n)},A.prototype.inviteByEmail=function(e,t,n){return this.inviteByThreePid(e,"email",t,n)},A.prototype.inviteByThreePid=async function(e,t,n,o){const r=g.encodeUri("/rooms/$roomId/invite",{$roomId:e}),i=this.getIdentityServerUrl(!0);if(!i)return Promise.reject(new m.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const s={id_server:i,medium:t,address:n};if(this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(s.id_access_token=e)}return this._http.authedRequest(o,"POST",r,void 0,s)},A.prototype.leave=function(e,t){return x(this,e,void 0,"leave",void 0,t)},A.prototype.leaveRoomChain=function(e,t=!0){const n=this.getRoomUpgradeHistory(e);let o=n;if(!t){o=[];for(const t of n)if(o.push(t),t.roomId===e)break}const r={},i=[],s=e=>this.leave(e).then(()=>{r[e]=null}).catch(t=>(r[e]=t,null));for(const e of o)i.push(s(e.roomId));return Promise.all(i).then(()=>r)},A.prototype.ban=function(e,t,n,o){return x(this,e,t,"ban",n,o)},A.prototype.forget=function(e,t,n){void 0===t&&(t=!0);const o=x(this,e,void 0,"forget",void 0,n);if(!t)return o;const r=this;return o.then((function(t){return r.store.removeRoom(e),r.emit("deleteRoom",e),t}))},A.prototype.unban=function(e,t,n){const o=g.encodeUri("/rooms/$roomId/unban",{$roomId:e}),r={user_id:t};return this._http.authedRequest(n,"POST",o,void 0,r)},A.prototype.kick=function(e,t,n,o){return function(e,t,n,o,r,i){g.isFunction(r)&&(i=r,r=void 0);const s=g.encodeUri("/rooms/$roomId/state/m.room.member/$userId",{$roomId:t,$userId:n});return e._http.authedRequest(i,"PUT",s,void 0,{membership:o,reason:r})}(this,e,t,"leave",n,o)},A.prototype.getPushActionsForEvent=function(e){return e.getPushActions()||e.setPushActions(this._pushProcessor.actionsForEvent(e)),e.getPushActions()},A.prototype.setProfileInfo=function(e,t,n){const o=g.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this._http.authedRequest(n,"PUT",o,void 0,t)},A.prototype.setDisplayName=function(e,t){return this.setProfileInfo("displayname",{displayname:e},t)},A.prototype.setAvatarUrl=function(e,t){return this.setProfileInfo("avatar_url",{avatar_url:e},t)},A.prototype.mxcUrlToHttp=function(e,t,n,o,r){return(0,y.getHttpUriForMxc)(this.baseUrl,e,t,n,o,r)},A.prototype._unstable_setStatusMessage=function(e){const t="im.vector.user_status";return Promise.all(this.getRooms().map(n=>{const o="join"===n.getMyMembership(),r=2===n.getInvitedAndJoinedMemberCount();return o&&r&&n.currentState.mayClientSendStateEvent(t,this)?this.sendStateEvent(n.roomId,t,{status:e},this.getUserId()):Promise.resolve()}))},A.prototype.setPresence=function(e,t){const n=g.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1==["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this._http.authedRequest(t,"PUT",n,void 0,e)},A.prototype.getPresenceList=function(e){return K(e,this,void 0,"GET")},A.prototype.inviteToPresenceList=function(e,t){return K(e,this,{invite:t},"POST")},A.prototype.dropFromPresenceList=function(e,t){return K(e,this,{drop:t},"POST")},A.prototype.scrollback=function(e,t,n){g.isFunction(t)&&(n=t,t=void 0),t=t||30;let o=0,r=this._ongoingScrollbacks[e.roomId]||{};if(r.promise)return r.promise;if(r.errorTs){const e=Date.now()-r.errorTs;o=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const i=this.store.scrollback(e,t).length;if(i===t)return Promise.resolve(e);t-=i;const s=this,a=new Promise((r,i)=>{(0,g.sleep)(o).then((function(){return s._createMessagesRequest(e.roomId,e.oldState.paginationToken,t,"b")})).then((function(t){const o=g.map(t.chunk,j(s));if(t.state){const n=g.map(t.state,j(s));e.currentState.setUnknownStateEvents(n)}e.addEventsToTimeline(o,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),s.store.storeEvents(e,o,t.end,!0),s._ongoingScrollbacks[e.roomId]=null,q(n,r,e)}),(function(t){s._ongoingScrollbacks[e.roomId]={errorTs:Date.now()},B(n,i,t)}))});return r={promise:a,errorTs:null},this._ongoingScrollbacks[e.roomId]=r,a},A.prototype.getEventTimeline=function(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return Promise.resolve(e.getTimelineForEvent(t));const n=g.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let o=void 0;this._clientOpts.lazyLoadMembers&&(o={filter:JSON.stringify(c.Filter.LAZY_LOADING_MESSAGES_FILTER)});const r=this;return r._http.authedRequest(void 0,"GET",n,o).then((function(n){if(!n.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);n.events_after.reverse();const o=n.events_after.concat([n.event]).concat(n.events_before),i=g.map(o,r.getEventMapper());let s=e.getTimelineForEvent(i[0].getId());if(s){const e=g.map(n.state,r.getEventMapper());s.getState(d.EventTimeline.BACKWARDS).setUnknownStateEvents(e)}else(s=e.addTimeline()).initialiseState(g.map(n.state,r.getEventMapper())),s.getState(d.EventTimeline.FORWARDS).paginationToken=n.end;return e.addEventsToTimeline(i,!0,s,n.start),e.getTimelineForEvent(t)||s}))},A.prototype._createMessagesRequest=function(e,t,n,o,r){const i=g.encodeUri("/rooms/$roomId/messages",{$roomId:e});void 0===n&&(n=30);const s={from:t,limit:n,dir:o};let a=null;return this._clientOpts.lazyLoadMembers&&(a=Object.assign({},c.Filter.LAZY_LOADING_MESSAGES_FILTER)),r&&(a=a||{},Object.assign(a,r.getRoomTimelineFilterComponent())),a&&(s.filter=JSON.stringify(a)),this._http.authedRequest(void 0,"GET",i,s)},A.prototype.paginateEventTimeline=function(e,t){const n=e.getTimelineSet()===this._notifTimelineSet,o=(t=t||{}).backwards||!1;if(n&&!o)throw new Error("paginateNotifTimeline can only paginate backwards");const r=o?d.EventTimeline.BACKWARDS:d.EventTimeline.FORWARDS,i=e.getPaginationToken(r);if(!i)return Promise.resolve(!1);const s=e._paginationRequests[r];if(s)return s;let a,c,u;const l=this;if(n)a="/notifications",c={limit:"limit"in t?t.limit:30,only:"highlight"},i&&"end"!==i&&(c.from=i),u=this._http.authedRequest(void 0,"GET","/notifications",c,void 0).then((function(t){const n=t.next_token,i=[];for(let e=0;e<t.notifications.length;e++){const n=t.notifications[e],o=l.getEventMapper()(n.event);o.setPushActions(k.PushProcessor.actionListToActionsObject(n.actions)),o.event.room_id=n.room_id,i[e]=o}return e.getTimelineSet().addEventsToTimeline(i,o,e,n),o&&!t.next_token&&e.setPaginationToken(null,r),!!t.next_token})).finally((function(){e._paginationRequests[r]=null})),e._paginationRequests[r]=u;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());(u=this._createMessagesRequest(e.getRoomId(),i,t.limit,r,e.getFilter())).then((function(t){if(t.state){const n=e.getState(r),o=g.map(t.state,l.getEventMapper());n.setUnknownStateEvents(o)}const n=t.end,i=g.map(t.chunk,l.getEventMapper());return e.getTimelineSet().addEventsToTimeline(i,o,e,n),o&&t.end==t.start&&e.setPaginationToken(null,r),t.end!=t.start})).finally((function(){e._paginationRequests[r]=null})),e._paginationRequests[r]=u}return u},A.prototype.resetNotifTimelineSet=function(){this._notifTimelineSet&&this._notifTimelineSet.resetLiveTimeline("end",null)},A.prototype.peekInRoom=function(e){return this._peekSync&&this._peekSync.stopPeeking(),this._peekSync=new u.SyncApi(this,this._clientOpts),this._peekSync.peek(e)},A.prototype.stopPeeking=function(){this._peekSync&&(this._peekSync.stopPeeking(),this._peekSync=null)},A.prototype.setGuestAccess=function(e,t){const n=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"});let o=Promise.resolve();return t.allowRead&&(o=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"})),Promise.all([o,n])},A.prototype.requestRegisterEmailToken=function(e,t,n,o){return this._requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:o})},A.prototype.requestRegisterMsisdnToken=function(e,t,n,o,r){return this._requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:o,next_link:r})},A.prototype.requestAdd3pidEmailToken=function(e,t,n,o){return this._requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:o})},A.prototype.requestAdd3pidMsisdnToken=function(e,t,n,o,r){return this._requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:o,next_link:r})},A.prototype.requestPasswordEmailToken=function(e,t,n,o){return this._requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:n,next_link:o})},A.prototype.requestPasswordMsisdnToken=function(e,t,n,o,r){return this._requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:n,send_attempt:o,next_link:r})},A.prototype._requestTokenFromEndpoint=async function(e,t){const n=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){const e=i.default.parse(this.idBaseUrl);if(!e.host)throw new Error("Invalid ID server URL: "+this.idBaseUrl);if(n.id_server=e.host,this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(n.id_access_token=e)}}return this._http.request(void 0,"POST",e,void 0,n)},A.prototype.getRoomPushRule=function(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let n=0;n<this.pushRules[e].room.length;n++){const o=this.pushRules[e].room[n];if(o.rule_id===t)return o}},A.prototype.setRoomMutePushRule=function(e,t,n){const o=this;let r,i;const s=this.getRoomPushRule(e,t);if(s&&0<=s.actions.indexOf("dont_notify")&&(i=!0),n?s?i||(r=g.defer(),this.deletePushRule(e,"room",s.rule_id).then((function(){o.addPushRule(e,"room",t,{actions:["dont_notify"]}).then((function(){r.resolve()}),(function(e){r.reject(e)}))}),(function(e){r.reject(e)})),r=r.promise):r=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):i&&(r=this.deletePushRule(e,"room",s.rule_id)),r)return new Promise((e,t)=>{r.then((function(){o.getPushRules().then((function(t){o.pushRules=t,e()}),(function(e){t(e)}))}),(function(e){o.getPushRules().then((function(n){o.pushRules=n,t(e)}),(function(n){t(e)}))}))})},A.prototype.searchMessageText=function(e,t){const n={search_term:e.query};return"keys"in e&&(n.keys=e.keys),this.search({body:{search_categories:{room_events:n}}},t)},A.prototype.searchRoomEvents=function(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},n={_query:t,results:[],highlights:[]};return this.search({body:t}).then(this._processRoomEventsSearch.bind(this,n))},A.prototype.backPaginateRoomEventsSearch=function(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},n=this.search(t).then(this._processRoomEventsSearch.bind(this,e)).finally((function(){e.pendingRequest=null}));return e.pendingRequest=n,n},A.prototype._processRoomEventsSearch=function(e,t){const n=t.search_categories.room_events;e.count=n.count,e.next_batch=n.next_batch;const o={};n.highlights.forEach((function(e){o[e]=1})),e.highlights.forEach((function(e){o[e]=1})),e.highlights=Object.keys(o);for(let t=0;t<n.results.length;t++){const o=h.SearchResult.fromJson(n.results[t],this.getEventMapper());e.results.push(o)}return e},A.prototype.syncLeftRooms=function(){if(this._syncedLeftRooms)return Promise.resolve([]);if(this._syncLeftRoomsPromise)return this._syncLeftRoomsPromise;const e=this,t=new u.SyncApi(this,this._clientOpts);return this._syncLeftRoomsPromise=t.syncLeftRooms(),this._syncLeftRoomsPromise.then((function(t){b.logger.log("Marking success of sync left room request"),e._syncedLeftRooms=!0})).finally((function(){e._syncLeftRoomsPromise=null})),this._syncLeftRoomsPromise},A.prototype.createFilter=function(e){const t=this,n=g.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",n,void 0,e).then((function(n){const o=c.Filter.fromJson(t.credentials.userId,n.filter_id,e);return t.store.storeFilter(o),o}))},A.prototype.getFilter=function(e,t,n){if(n){const n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}const o=this,r=g.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this._http.authedRequest(void 0,"GET",r,void 0,void 0).then((function(n){const r=c.Filter.fromJson(e,t,n);return o.store.storeFilter(r),r}))},A.prototype.getOrCreateFilter=function(e,t){const n=this.store.getFilterIdByName(e);let o=Promise.resolve();const r=this;return n&&(o=r.getFilter(r.credentials.userId,n,!0).then((function(o){const i=o.getDefinition(),s=t.getDefinition();if(g.deepCompare(i,s))return Promise.resolve(n);r.store.setFilterIdByName(e,void 0)}),(function(t){if(404!==t.httpStatus||"M_UNKNOWN"!==t.errcode&&"M_NOT_FOUND"!==t.errcode)throw t;r.store.setFilterIdByName(e,void 0)}))),o.then((function(n){return n||r.createFilter(t.getDefinition()).then((function(t){return r.store.setFilterIdByName(e,t.filterId),t.filterId}))}))},A.prototype.getOpenIdToken=function(){const e=g.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",e,void 0,{})},A.prototype.turnServer=function(e){return this._http.authedRequest(e,"GET","/voip/turnServer")},A.prototype.getTurnServers=function(){return this._turnServers||[]},A.prototype.setFallbackICEServerAllowed=function(e){this._fallbackICEServerAllowed=e},A.prototype.isFallbackICEServerAllowed=function(){return this._fallbackICEServerAllowed},A.prototype.isSynapseAdministrator=function(){const e=g.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this._http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then(e=>e.admin)},A.prototype.whoisSynapseUser=function(e){const t=g.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this._http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})},A.prototype.deactivateSynapseUser=function(e){const t=g.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this._http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})},A.prototype.startClient=async function(e){this.clientRunning||(this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e}),this._crypto&&(this._crypto.uploadDeviceKeys(),this._crypto.start()),function e(t){if(!t._supportsVoip)return;if(t.isGuest())return;t.turnServer().then((function(n){if(n.uris){b.logger.log("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs");const o={urls:n.uris,username:n.username,credential:n.password};t._turnServers=[o],t._checkTurnServersTimeoutID=setTimeout(()=>{e(t)},1e3*(n.ttl||3600)*.9)}}),(function(n){b.logger.error("Failed to get TURN URIs"),t._checkTurnServersTimeoutID=setTimeout((function(){e(t)}),6e4)}))}(this),this._syncApi&&(b.logger.error("Still have sync object whilst not running: stopping old one"),this._syncApi.stop()),(e=Object.assign({},e)).crypto=this._crypto,e.canResetEntireTimeline=e=>!!this._canResetTimelineCallback&&this._canResetTimelineCallback(e),this._clientOpts=e,this._syncApi=new u.SyncApi(this,e),this._syncApi.sync())},A.prototype._storeClientOptions=function(){const e=["boolean","string","number"],t=Object.entries(this._clientOpts).filter(([t,n])=>e.includes(typeof n)).reduce((e,[t,n])=>(e[t]=n,e),{});return this.store.storeClientOptions(t)},A.prototype.stopClient=function(){b.logger.log("stopping MatrixClient"),this.clientRunning=!1,this._syncApi&&(this._syncApi.stop(),this._syncApi=null),this._crypto&&this._crypto.stop(),this._peekSync&&this._peekSync.stopPeeking(),e.clearTimeout(this._checkTurnServersTimeoutID)},A.prototype.getVersions=async function(){return null===this._serverVersionsCache&&(this._serverVersionsCache=await this._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""})),this._serverVersionsCache},A.prototype.isVersionSupported=async function(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)},A.prototype.doesServerSupportLazyLoading=async function(){const e=await this.getVersions(),t=e.versions,n=e.unstable_features;return t&&t.includes("r0.5.0")||n&&n["m.lazy_load_members"]},A.prototype.doesServerRequireIdServerParam=async function(){const e=await this.getVersions(),t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const n=e.unstable_features;return void 0===n["m.require_identity_server"]||n["m.require_identity_server"]},A.prototype.doesServerAcceptIdentityAccessToken=async function(){const e=await this.getVersions(),t=e.versions,n=e.unstable_features;return t&&t.includes("r0.6.0")||n&&n["m.id_access_token"]},A.prototype.doesServerSupportSeparateAddAndBind=async function(){const e=await this.getVersions(),t=e.versions,n=e.unstable_features;return t&&t.includes("r0.6.0")||n&&n["m.separate_add_and_bind"]},A.prototype.hasLazyLoadMembersEnabled=function(){return!!this._clientOpts.lazyLoadMembers},A.prototype.setCanResetTimelineCallback=function(e){this._canResetTimelineCallback=e},A.prototype.getCanResetTimelineCallback=function(){return this._canResetTimelineCallback},A.prototype.relations=async function(e,t,n,o,r={}){const i=function(e,t,n){return"m.reaction"===n?n:e.isRoomEncrypted(t)?"m.room.encrypted":n}(this,e,o),s=await this.fetchRelations(e,t,n,i,r),a=this.getEventMapper();let c;s.original_event&&(c=a(s.original_event));let u=s.chunk.map(a);if("m.room.encrypted"===i){const e=c?u.concat(c):u;await Promise.all(e.map(e=>new Promise(t=>e.once("Event.decrypted",t)))),u=u.filter(e=>e.getType()===o)}return{originalEvent:c,events:u,nextBatch:s.next_batch}},A.prototype.getEventMapper=function(){return j(this)},A.prototype.generateClientSecret=function(){return(0,T.randomString)(32)}}).call(this,n(3))},function(e,t,n){(function(e,o){var r;/*! https://mths.be/punycode v1.4.1 by @mathias */!function(i){t&&t.nodeType,e&&e.nodeType;var s="object"==typeof o&&o;s.global!==s&&s.window!==s&&s.self;var a,c=2147483647,u=36,l=1,d=26,h=38,p=700,f=72,g=128,m="-",y=/^xn--/,_=/[^\x20-\x7E]/,v=/[\x2E\u3002\uFF0E\uFF61]/g,S={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},E=u-l,b=Math.floor,w=String.fromCharCode;function I(e){throw new RangeError(S[e])}function R(e,t){for(var n=e.length,o=[];n--;)o[n]=t(e[n]);return o}function T(e,t){var n=e.split("@"),o="";return n.length>1&&(o=n[0]+"@",e=n[1]),o+R((e=e.replace(v,".")).split("."),t).join(".")}function k(e){for(var t,n,o=[],r=0,i=e.length;r<i;)(t=e.charCodeAt(r++))>=55296&&t<=56319&&r<i?56320==(64512&(n=e.charCodeAt(r++)))?o.push(((1023&t)<<10)+(1023&n)+65536):(o.push(t),r--):o.push(t);return o}function O(e){return R(e,(function(e){var t="";return e>65535&&(t+=w((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=w(e)})).join("")}function C(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function D(e,t,n){var o=0;for(e=n?b(e/p):e>>1,e+=b(e/t);e>E*d>>1;o+=u)e=b(e/E);return b(o+(E+1)*e/(e+h))}function A(e){var t,n,o,r,i,s,a,h,p,y,_,v=[],S=e.length,E=0,w=g,R=f;for((n=e.lastIndexOf(m))<0&&(n=0),o=0;o<n;++o)e.charCodeAt(o)>=128&&I("not-basic"),v.push(e.charCodeAt(o));for(r=n>0?n+1:0;r<S;){for(i=E,s=1,a=u;r>=S&&I("invalid-input"),((h=(_=e.charCodeAt(r++))-48<10?_-22:_-65<26?_-65:_-97<26?_-97:u)>=u||h>b((c-E)/s))&&I("overflow"),E+=h*s,!(h<(p=a<=R?l:a>=R+d?d:a-R));a+=u)s>b(c/(y=u-p))&&I("overflow"),s*=y;R=D(E-i,t=v.length+1,0==i),b(E/t)>c-w&&I("overflow"),w+=b(E/t),E%=t,v.splice(E++,0,w)}return O(v)}function P(e){var t,n,o,r,i,s,a,h,p,y,_,v,S,E,R,T=[];for(v=(e=k(e)).length,t=g,n=0,i=f,s=0;s<v;++s)(_=e[s])<128&&T.push(w(_));for(o=r=T.length,r&&T.push(m);o<v;){for(a=c,s=0;s<v;++s)(_=e[s])>=t&&_<a&&(a=_);for(a-t>b((c-n)/(S=o+1))&&I("overflow"),n+=(a-t)*S,t=a,s=0;s<v;++s)if((_=e[s])<t&&++n>c&&I("overflow"),_==t){for(h=n,p=u;!(h<(y=p<=i?l:p>=i+d?d:p-i));p+=u)R=h-y,E=u-y,T.push(w(C(y+R%E,0))),h=b(R/E);T.push(w(C(h,0))),i=D(n,S,o==r),n=0,++o}++n,++t}return T.join("")}a={version:"1.4.1",ucs2:{decode:k,encode:O},decode:A,encode:P,toASCII:function(e){return T(e,(function(e){return _.test(e)?"xn--"+P(e):e}))},toUnicode:function(e){return T(e,(function(e){return y.test(e)?A(e.slice(4).toLowerCase()):e}))}},void 0===(r=function(){return a}.call(t,n,t,e))||(e.exports=r)}()}).call(this,n(61)(e),n(3))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";e.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},function(e,t,n){"use strict";t.decode=t.parse=n(64),t.encode=t.stringify=n(65)},function(e,t,n){"use strict";function o(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,n,i){t=t||"&",n=n||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var c=1e3;i&&"number"==typeof i.maxKeys&&(c=i.maxKeys);var u=e.length;c>0&&u>c&&(u=c);for(var l=0;l<u;++l){var d,h,p,f,g=e[l].replace(a,"%20"),m=g.indexOf(n);m>=0?(d=g.substr(0,m),h=g.substr(m+1)):(d=g,h=""),p=decodeURIComponent(d),f=decodeURIComponent(h),o(s,p)?r(s[p])?s[p].push(f):s[p]=[s[p],f]:s[p]=f}return s};var r=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},function(e,t,n){"use strict";var o=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,n,a){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==typeof e?i(s(e),(function(s){var a=encodeURIComponent(o(s))+n;return r(e[s])?i(e[s],(function(e){return a+encodeURIComponent(o(e))})).join(t):a+encodeURIComponent(o(e[s]))})).join(t):a?encodeURIComponent(o(a))+n+encodeURIComponent(o(e)):""};var r=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function i(e,t){if(e.map)return e.map(t);for(var n=[],o=0;o<e.length;o++)n.push(t(e[o],o));return n}var s=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixBaseApis=l;var r=n(32),i=n(0),s=n(18),a=o(n(2)),c=n(12);function u(e,t){switch(e){case r.SERVICE_TYPES.IS:return t+c.PREFIX_IDENTITY_V2+"/terms";case r.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}function l(e){a.checkObjectHasKeys(e,["baseUrl","request"]),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer;const t={baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:c.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader};this._http=new c.MatrixHttpApi(this,t),this._txnCtr=0}l.prototype.getHomeserverUrl=function(){return this.baseUrl},l.prototype.getIdentityServerUrl=function(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl},l.prototype.setIdentityServerUrl=function(e){this.idBaseUrl=a.ensureNoTrailingSlash(e),this._http.setIdBaseUrl(this.idBaseUrl)},l.prototype.getAccessToken=function(){return this._http.opts.accessToken||null},l.prototype.isLoggedIn=function(){return void 0!==this._http.opts.accessToken},l.prototype.makeTxnId=function(){return"m"+(new Date).getTime()+"."+this._txnCtr++},l.prototype.isUsernameAvailable=function(e){return this._http.authedRequest(void 0,"GET","/register/available",{username:e}).then(e=>e.available)},l.prototype.register=function(e,t,n,o,r,i,s,a){!0===r?r={email:!0}:null==r&&(r={}),"function"==typeof s&&(a=s,s=void 0),null==o&&(o={}),n&&(o.session=n);const c={auth:o};return null!=e&&(c.username=e),null!=t&&(c.password=t),r.email&&(c.bind_email=!0),r.msisdn&&(c.bind_msisdn=!0),null!=i&&(c.guest_access_token=i),null!=s&&(c.inhibit_login=s),null!=t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,a)},l.prototype.registerGuest=function(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)},l.prototype.registerRequest=function(e,t,n){const o={};return t&&(o.kind=t),this._http.request(n,"POST","/register",o,e)},l.prototype.loginFlows=function(e){return this._http.request(e,"GET","/login")},l.prototype.login=function(e,t,n){const o={type:e};return a.extend(o,t),this._http.authedRequest((e,t)=>{t&&t.access_token&&t.user_id&&(this._http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),n&&n(e,t)},"POST","/login",void 0,o)},l.prototype.loginWithPassword=function(e,t,n){return this.login("m.login.password",{user:e,password:t},n)},l.prototype.loginWithSAML2=function(e,t){return this.login("m.login.saml2",{relay_state:e},t)},l.prototype.getCasLoginUrl=function(e){return this.getSsoLoginUrl(e,"cas")},l.prototype.getSsoLoginUrl=function(e,t){return void 0===t&&(t="sso"),this._http.getUrl("/login/"+t+"/redirect",{redirectUrl:e},c.PREFIX_R0)},l.prototype.loginWithToken=function(e,t){return this.login("m.login.token",{token:e},t)},l.prototype.logout=function(e){return this._http.authedRequest(e,"POST","/logout")},l.prototype.deactivateAccount=function(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const n={};return e&&(n.auth=e),void 0!==t&&(n.erase=t),this._http.authedRequest(void 0,"POST","/account/deactivate",void 0,n)},l.prototype.getFallbackAuthUrl=function(e,t){const n=a.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this._http.getUrl(n,{session:t},c.PREFIX_R0)},l.prototype.createRoom=function(e,t){return this._http.authedRequest(t,"POST","/createRoom",void 0,e)},l.prototype.fetchRelations=async function(e,t,n,o,r){const i={};r.from&&(i.from=r.from);const s=a.encodeParams(i),u=a.encodeUri("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+s,{$roomId:e,$eventId:t,$relationType:n,$eventType:o});return await this._http.authedRequest(void 0,"GET",u,null,null,{prefix:c.PREFIX_UNSTABLE})},l.prototype.roomState=function(e,t){const n=a.encodeUri("/rooms/$roomId/state",{$roomId:e});return this._http.authedRequest(t,"GET",n)},l.prototype.fetchRoomEvent=function(e,t,n){const o=a.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(n,"GET",o)},l.prototype.members=function(e,t,n,o,r){const i={};t&&(i.membership=t),n&&(i.not_membership=n),o&&(i.at=o);const s=a.encodeParams(i),c=a.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this._http.authedRequest(r,"GET",c)},l.prototype.upgradeRoom=function(e,t){const n=a.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this._http.authedRequest(void 0,"POST",n,void 0,{new_version:t})},l.prototype.getGroupSummary=function(e){const t=a.encodeUri("/groups/$groupId/summary",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupProfile=function(e){const t=a.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.setGroupProfile=function(e,t){const n=a.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"POST",n,void 0,t)},l.prototype.setGroupJoinPolicy=function(e,t){const n=a.encodeUri("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this._http.authedRequest(void 0,"PUT",n,void 0,{"m.join_policy":t})},l.prototype.getGroupUsers=function(e){const t=a.encodeUri("/groups/$groupId/users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupInvitedUsers=function(e){const t=a.encodeUri("/groups/$groupId/invited_users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupRooms=function(e){const t=a.encodeUri("/groups/$groupId/rooms",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.inviteUserToGroup=function(e,t){const n=a.encodeUri("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},l.prototype.removeUserFromGroup=function(e,t){const n=a.encodeUri("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},l.prototype.addUserToGroupSummary=function(e,t,n){const o=a.encodeUri(n?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:n,$userId:t});return this._http.authedRequest(void 0,"PUT",o,void 0,{})},l.prototype.removeUserFromGroupSummary=function(e,t){const n=a.encodeUri("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"DELETE",n,void 0,{})},l.prototype.addRoomToGroupSummary=function(e,t,n){const o=a.encodeUri(n?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:n,$roomId:t});return this._http.authedRequest(void 0,"PUT",o,void 0,{})},l.prototype.removeRoomFromGroupSummary=function(e,t){const n=a.encodeUri("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",n,void 0,{})},l.prototype.addRoomToGroup=function(e,t,n){void 0===n&&(n=!0);const o=a.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",o,void 0,{"m.visibility":{type:n?"public":"private"}})},l.prototype.updateGroupRoomVisibility=function(e,t,n){const o=a.encodeUri("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",o,void 0,{type:n?"public":"private"})},l.prototype.removeRoomFromGroup=function(e,t){const n=a.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",n,void 0,{})},l.prototype.acceptGroupInvite=function(e,t=null){const n=a.encodeUri("/groups/$groupId/self/accept_invite",{$groupId:e});return this._http.authedRequest(void 0,"PUT",n,void 0,t||{})},l.prototype.joinGroup=function(e){const t=a.encodeUri("/groups/$groupId/self/join",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},l.prototype.leaveGroup=function(e){const t=a.encodeUri("/groups/$groupId/self/leave",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},l.prototype.getJoinedGroups=function(){const e=a.encodeUri("/joined_groups");return this._http.authedRequest(void 0,"GET",e)},l.prototype.createGroup=function(e){const t=a.encodeUri("/create_group");return this._http.authedRequest(void 0,"POST",t,void 0,e)},l.prototype.getPublicisedGroups=function(e){const t=a.encodeUri("/publicised_groups");return this._http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})},l.prototype.setGroupPublicity=function(e,t){const n=a.encodeUri("/groups/$groupId/self/update_publicity",{$groupId:e});return this._http.authedRequest(void 0,"PUT",n,void 0,{publicise:t})},l.prototype.getStateEvent=function(e,t,n,o){const r={$roomId:e,$eventType:t,$stateKey:n};let i=a.encodeUri("/rooms/$roomId/state/$eventType",r);return void 0!==n&&(i=a.encodeUri(i+"/$stateKey",r)),this._http.authedRequest(o,"GET",i)},l.prototype.sendStateEvent=function(e,t,n,o,r){const i={$roomId:e,$eventType:t,$stateKey:o};let s=a.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==o&&(s=a.encodeUri(s+"/$stateKey",i)),this._http.authedRequest(r,"PUT",s,void 0,n)},l.prototype.roomInitialSync=function(e,t,n){a.isFunction(t)&&(n=t,t=void 0);const o=a.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this._http.authedRequest(n,"GET",o,{limit:t})},l.prototype.setRoomReadMarkersHttpRequest=function(e,t,n,o){const r=a.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),i={"m.fully_read":t,"m.read":n,"m.hidden":Boolean(!!o&&o.hidden)};return this._http.authedRequest(void 0,"POST",r,void 0,i)},l.prototype.getJoinedRooms=function(){const e=a.encodeUri("/joined_rooms");return this._http.authedRequest(void 0,"GET",e)},l.prototype.getJoinedRoomMembers=function(e){const t=a.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.publicRooms=function(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const n={};return e.server&&(n.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(n).length?this._http.authedRequest(t,"GET","/publicRooms"):this._http.authedRequest(t,"POST","/publicRooms",n,e)},l.prototype.createAlias=function(e,t,n){const o=a.encodeUri("/directory/room/$alias",{$alias:e}),r={room_id:t};return this._http.authedRequest(n,"PUT",o,void 0,r)},l.prototype.deleteAlias=function(e,t){const n=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"DELETE",n,void 0,void 0)},l.prototype.getRoomIdForAlias=function(e,t){const n=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"GET",n)},l.prototype.resolveRoomAlias=function(e,t){const n=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.request(t,"GET",n)},l.prototype.getRoomDirectoryVisibility=function(e,t){const n=a.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(t,"GET",n)},l.prototype.setRoomDirectoryVisibility=function(e,t,n){const o=a.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(n,"PUT",o,void 0,{visibility:t})},l.prototype.setRoomDirectoryVisibilityAppService=function(e,t,n,o){const r=a.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this._http.authedRequest(o,"PUT",r,void 0,{visibility:n})},l.prototype.searchUserDirectory=function(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this._http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)},l.prototype.uploadContent=function(e,t){return this._http.uploadContent(e,t)},l.prototype.cancelUpload=function(e){return this._http.cancelUpload(e)},l.prototype.getCurrentUploads=function(){return this._http.getCurrentUploads()},l.prototype.getProfileInfo=function(e,t,n){a.isFunction(t)&&(n=t,t=void 0);const o=t?a.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):a.encodeUri("/profile/$userId",{$userId:e});return this._http.authedRequest(n,"GET",o)},l.prototype.getThreePids=function(e){return this._http.authedRequest(e,"GET","/account/3pid",void 0,void 0)},l.prototype.addThreePid=function(e,t,n){const o={threePidCreds:e,bind:t};return this._http.authedRequest(n,"POST","/account/3pid",null,o)},l.prototype.addThreePidOnly=async function(e){const t=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/add",null,e,{prefix:t})},l.prototype.bindThreePid=async function(e){const t=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/bind",null,e,{prefix:t})},l.prototype.unbindThreePid=async function(e,t){const n={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},o=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/unbind",null,n,{prefix:o})},l.prototype.deleteThreePid=function(e,t){const n={medium:e,address:t};return this._http.authedRequest(void 0,"POST","/account/3pid/delete",null,n)},l.prototype.setPassword=function(e,t,n){const o={auth:e,new_password:t};return this._http.authedRequest(n,"POST","/account/password",null,o)},l.prototype.getDevices=function(){return this._http.authedRequest(void 0,"GET","/devices",void 0,void 0)},l.prototype.setDeviceDetails=function(e,t){const n=a.encodeUri("/devices/$device_id",{$device_id:e});return this._http.authedRequest(void 0,"PUT",n,void 0,t)},l.prototype.deleteDevice=function(e,t){const n=a.encodeUri("/devices/$device_id",{$device_id:e}),o={};return t&&(o.auth=t),this._http.authedRequest(void 0,"DELETE",n,void 0,o)},l.prototype.deleteMultipleDevices=function(e,t){const n={devices:e};t&&(n.auth=t);return this._http.authedRequest(void 0,"POST","/delete_devices",void 0,n)},l.prototype.getPushers=function(e){return this._http.authedRequest(e,"GET","/pushers",void 0,void 0)},l.prototype.setPusher=function(e,t){return this._http.authedRequest(t,"POST","/pushers/set",null,e)},l.prototype.getPushRules=function(e){return this._http.authedRequest(e,"GET","/pushrules/").then(e=>s.PushProcessor.rewriteDefaultRules(e))},l.prototype.addPushRule=function(e,t,n,o,r){const i=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this._http.authedRequest(r,"PUT",i,void 0,o)},l.prototype.deletePushRule=function(e,t,n,o){const r=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:n});return this._http.authedRequest(o,"DELETE",r)},l.prototype.setPushRuleEnabled=function(e,t,n,o,r){const i=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:n});return this._http.authedRequest(r,"PUT",i,void 0,{enabled:o})},l.prototype.setPushRuleActions=function(e,t,n,o,r){const i=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:n});return this._http.authedRequest(r,"PUT",i,void 0,{actions:o})},l.prototype.search=function(e,t){const n={};return e.next_batch&&(n.next_batch=e.next_batch),this._http.authedRequest(t,"POST","/search",n,e.body)},l.prototype.uploadKeysRequest=function(e,t,n){const o=(t=t||{}).device_id;let r;return r=o?a.encodeUri("/keys/upload/$deviceId",{$deviceId:o}):"/keys/upload",this._http.authedRequest(n,"POST",r,void 0,e)},l.prototype.uploadKeySignatures=function(e){return this._http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:c.PREFIX_UNSTABLE})},l.prototype.downloadKeysForUsers=function(e,t){if(a.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const n={device_keys:{}};return"token"in(t=t||{})&&(n.token=t.token),e.forEach(e=>{n.device_keys[e]={}}),this._http.authedRequest(void 0,"POST","/keys/query",void 0,n)},l.prototype.claimOneTimeKeys=function(e,t){const n={};void 0===t&&(t="signed_curve25519");for(let o=0;o<e.length;++o){const r=e[o][0],i=e[o][1],s=n[r]||{};n[r]=s,s[i]=t}const o={one_time_keys:n};return this._http.authedRequest(void 0,"POST","/keys/claim",void 0,o)},l.prototype.getKeyChanges=function(e,t){const n={from:e,to:t};return this._http.authedRequest(void 0,"GET","/keys/changes",n,void 0)},l.prototype.uploadDeviceSigningKeys=function(e,t){const n=Object.assign({},t,{auth:e});return this._http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,n,{prefix:c.PREFIX_UNSTABLE})},l.prototype.registerWithIdentityServer=function(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");const t=this.idBaseUrl+c.PREFIX_IDENTITY_V2+"/account/register";return this._http.requestOtherUrl(void 0,"POST",t,null,e)},l.prototype.requestEmailToken=async function(e,t,n,o,r,s){const a={client_secret:t,email:e,send_attempt:n,next_link:o};try{const e=await this._http.idServerRequest(void 0,"POST","/validate/email/requestToken",a,c.PREFIX_IDENTITY_V2,s);return r&&r(null,e),e}catch(e){if("rejected"===e.cors||404===e.httpStatus)return i.logger.warn("IS doesn't support v2, falling back to deprecated v1"),await this._http.idServerRequest(r,"POST","/validate/email/requestToken",a,c.PREFIX_IDENTITY_V1);throw r&&r(e),e}},l.prototype.requestMsisdnToken=async function(e,t,n,o,r,s,a){const u={client_secret:n,country:e,phone_number:t,send_attempt:o,next_link:r};try{const e=await this._http.idServerRequest(void 0,"POST","/validate/msisdn/requestToken",u,c.PREFIX_IDENTITY_V2,a);return s&&s(null,e),e}catch(e){if("rejected"===e.cors||404===e.httpStatus)return i.logger.warn("IS doesn't support v2, falling back to deprecated v1"),await this._http.idServerRequest(s,"POST","/validate/msisdn/requestToken",u,c.PREFIX_IDENTITY_V1);throw s&&s(e),e}},l.prototype.submitMsisdnToken=async function(e,t,n,o){const r={sid:e,client_secret:t,token:n};try{return await this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",r,c.PREFIX_IDENTITY_V2,o)}catch(e){if("rejected"===e.cors||404===e.httpStatus)return i.logger.warn("IS doesn't support v2, falling back to deprecated v1"),await this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",r,c.PREFIX_IDENTITY_V1);throw e}},l.prototype.submitMsisdnTokenOtherUrl=function(e,t,n,o){const r={sid:t,client_secret:n,token:o};return this._http.requestOtherUrl(void 0,"POST",e,void 0,r)},l.prototype.getIdentityHashDetails=function(e){return this._http.idServerRequest(void 0,"GET","/hash_details",null,c.PREFIX_IDENTITY_V2,e)},l.prototype.identityHashedLookup=async function(t,n){const o={},r=await this.getIdentityHashDetails(n);if(!r||!r.lookup_pepper||!r.algorithms)throw new Error("Unsupported identity server: bad response");o.pepper=r.lookup_pepper;const i={};if(r.algorithms.includes("sha256")){const n=new e.Olm.Utility;o.addresses=t.map(e=>{const t=e[0].toLowerCase(),r=e[1].toLowerCase(),s=n.sha256(`${t} ${r} ${o.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return i[s]=e[0],s}),o.algorithm="sha256"}else{if(!r.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");o.addresses=t.map(e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return i[t]=e[0],t}),o.algorithm="none"}const s=await this._http.idServerRequest(void 0,"POST","/lookup",o,c.PREFIX_IDENTITY_V2,n);if(!s||!s.mappings)return[];const a=[];for(const e of Object.keys(s.mappings)){const t=s.mappings[e],n=i[e];if(!n)throw new Error("Identity server returned more results than expected");a.push({address:n,mxid:t})}return a},l.prototype.lookupThreePid=async function(e,t,n,o){try{const r=(await this.identityHashedLookup([[t,e]],o)).find(e=>e.address===t);if(!r)return n&&n(null,{}),{};const i={address:t,medium:e,mxid:r.mxid};return n&&n(null,i),i}catch(o){if("rejected"===o.cors||404===o.httpStatus){const o={medium:e,address:t};return i.logger.warn("IS doesn't support v2, falling back to deprecated v1"),await this._http.idServerRequest(n,"GET","/lookup",o,c.PREFIX_IDENTITY_V1)}throw n&&n(o,void 0),o}},l.prototype.bulkLookupThreePids=async function(e,t){try{const n=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),o=[];for(const t of n){const n=e.find(e=>e[1]===t.address);if(!n)throw new Error("Identity sever returned unexpected results");o.push([n[0],t.address,t.mxid])}return{threepids:o}}catch(n){if("rejected"===n.cors||404===n.httpStatus){const n={threepids:e};return i.logger.warn("IS doesn't support v2, falling back to deprecated v1"),await this._http.idServerRequest(void 0,"POST","/bulk_lookup",n,c.PREFIX_IDENTITY_V1,t)}throw n}},l.prototype.getIdentityAccount=function(e){return this._http.idServerRequest(void 0,"GET","/account",void 0,c.PREFIX_IDENTITY_V2,e)},l.prototype.sendToDevice=function(e,t,n){const o=a.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:n||this.makeTxnId()}),r={messages:t},s=Object.keys(t).reduce((e,n)=>(e[n]=Object.keys(t[n]),e),{});return i.logger.log(`PUT ${o}`,s),this._http.authedRequest(void 0,"PUT",o,void 0,r)},l.prototype.getThirdpartyProtocols=function(){return this._http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then(e=>{if(!e||"object"!=typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e})},l.prototype.getThirdpartyLocation=function(e,t){const n=a.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",n,t,void 0)},l.prototype.getThirdpartyUser=function(e,t){const n=a.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",n,t,void 0)},l.prototype.getTerms=function(e,t){const n=u(e,t);return this._http.requestOtherUrl(void 0,"GET",n)},l.prototype.agreeToTerms=function(e,t,n,o){const r=u(e,t),i={Authorization:"Bearer "+n};return this._http.requestOtherUrl(void 0,"POST",r,null,{user_accepts:o},{headers:i})},l.prototype.reportEvent=function(e,t,n,o){const r=a.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(void 0,"POST",r,null,{score:n,reason:o})}}).call(this,n(3))},function(e,t,n){"use strict";
/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var o=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,r=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,i=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,a=/([\\"])/g,c=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function u(e){var t=String(e);if(i.test(t))return t;if(t.length>0&&!r.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(a,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}t.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,n=e.type;if(!n||!c.test(n))throw new TypeError("invalid type");var o=n;if(t&&"object"==typeof t)for(var r,s=Object.keys(t).sort(),a=0;a<s.length;a++){if(r=s[a],!i.test(r))throw new TypeError("invalid parameter name");o+="; "+r+"="+u(t[r])}return o},t.parse=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var n=t.indexOf(";"),r=-1!==n?t.substr(0,n).trim():t.trim();if(!c.test(r))throw new TypeError("invalid media type");var i=new l(r.toLowerCase());if(-1!==n){var a,u,d;for(o.lastIndex=n;u=o.exec(t);){if(u.index!==n)throw new TypeError("invalid parameter format");n+=u[0].length,a=u[1].toLowerCase(),'"'===(d=u[2])[0]&&(d=d.substr(1,d.length-2).replace(s,"$1")),i.parameters[a]=d}if(n!==t.length)throw new TypeError("invalid parameter format")}return i}},function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.setNow=function(e){u=e||Date.now},t.setTimeout=function(e,t){(t=t||0)<0&&(t=0);const n=Array.prototype.slice.call(arguments,2),o=u()+t,r=s++;c("setTimeout: scheduling cb",r,"at",o,"(delay",t,")");const i={runAt:o,func:e,params:n,key:r},d=function(e,t){let n=0,o=e.length;for(;n<o;){const r=n+o>>1;t(e[r])>0?o=r:n=r+1}return n}(a,(function(e){return e.runAt-o}));return a.splice(d,0,i),l(),r},t.clearTimeout=function(e){if(0===a.length)return;let t;for(t=0;t<a.length;t++){if(a[t].key==e){a.splice(t,1);break}}0===t&&l()};var o=n(0);const r=1e3;let i,s=0;const a=[],c=function(){};let u=Date.now;function l(){i&&e.clearTimeout(i);const t=a[0];if(!t)return void c("_scheduleRealCallback: no more callbacks, not rescheduling");const n=u(),o=Math.min(t.runAt-n,r);c("_scheduleRealCallback: now:",n,"delay:",o),i=e.setTimeout(d,o)}function d(){let t;const n=u();c("_runCallbacks: now:",n);const r=[];for(;;){const e=a[0];if(!e||e.runAt>n)break;t=a.shift(),c("_runCallbacks: popping",t.key),r.push(t)}l();for(let n=0;n<r.length;n++){t=r[n];try{t.func.apply(e,t.params)}catch(e){o.logger.error("Uncaught exception in callback function",e.stack||e)}}}}).call(this,n(3))},function(e,t,n){"use strict";function o(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}Object.defineProperty(t,"__esModule",{value:!0}),t.FilterComponent=o,o.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},o.prototype._checkFields=function(e,t,n,o){const r={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const n=t.slice(0,-1);return e.substr(0,n.length)===n}return e===t}(n,e)}},i=this;for(let e=0;e<Object.keys(r).length;e++){const t=Object.keys(r)[e],n=r[t];if(i["not_"+t].filter(n).length>0)return!1;const o=i[t];if(o&&!o.map(n))return!1}const s=this.filter_json.contains_url;return void 0===s||s===o},o.prototype.filter=function(e){return e.filter(this.check,this)},o.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncApi=m;var r=n(11),i=n(33),s=n(36),a=o(n(2)),c=n(19),u=n(8),l=n(18),d=n(0),h=n(22);const p=!0;function f(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function g(...e){p&&d.logger.log(...e)}function m(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoomId=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function y(e,t){const n=new r.User(t);return e.reEmitter.reEmit(n,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),n}m.prototype.createRoom=function(e){const t=this.client,{timelineSupport:n,unstableClientRelationAggregation:o}=t,r=new i.Room(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:n,unstableClientRelationAggregation:o});return t.reEmitter.reEmit(r,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(r),r},m.prototype.createGroup=function(e){const t=this.client,n=new s.Group(e);return t.reEmitter.reEmit(n,["Group.profile","Group.myMembership"]),t.store.storeGroup(n),n},m.prototype._registerStateListeners=function(e){const t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,n,o){o.user=t.getUser(o.userId),t.reEmitter.reEmit(o,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},m.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},m.prototype.syncLeftRooms=function(){const e=this.client,t=this,n=new c.Filter(this.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);const o=this.opts.pollTimeout+8e4,r={timeout:0};return e.getOrCreateFilter(f(e.credentials.userId,"LEFT_ROOMS"),n).then((function(t){return r.filter=t,e._http.authedRequest(void 0,"GET","/sync",r,void 0,o)})).then((function(n){let o=[];n.rooms&&n.rooms.leave&&(o=t._mapSyncResponseToRoomArray(n.rooms.leave));const r=[];return o.forEach((function(n){const o=n.room;if(r.push(o),!n.isBrandNewRoom)return;n.timeline=n.timeline||{};const i=t._mapSyncEventsFormat(n.timeline,o),s=t._mapSyncEventsFormat(n.state,o);o.getLiveTimeline().setPaginationToken(n.timeline.prev_batch,u.EventTimeline.BACKWARDS),t._processRoomEvents(o,s,i),o.recalculate(),e.store.storeRoom(o),e.emit("Room",o),t._processEventsForNotifs(o,i)})),r}))},m.prototype.peek=function(e){const t=this,n=this.client;return this._peekRoomId=e,this.client.roomInitialSync(e,20).then((function(o){o.messages=o.messages||{},o.messages.chunk=o.messages.chunk||[],o.state=o.state||[];const r=t.createRoom(e),i=a.map(a.deepCopy(o.state),n.getEventMapper()),s=a.map(o.state,n.getEventMapper()),c=a.map(o.messages.chunk,n.getEventMapper());return o.presence&&a.isArray(o.presence)&&o.presence.map(n.getEventMapper()).forEach((function(e){let t=n.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=y(n,e.getContent().user_id)).setPresenceEvent(e),n.store.storeUser(t)),n.emit("event",e)})),o.messages.start&&(r.oldState.paginationToken=o.messages.start),r.oldState.setStateEvents(i),r.currentState.setStateEvents(s),t._resolveInvites(r),r.recalculate(),r.addEventsToTimeline(c.reverse(),!0,r.getLiveTimeline(),o.messages.start),n.store.storeRoom(r),n.emit("Room",r),t._peekPoll(r),r}))},m.prototype.stopPeeking=function(){this._peekRoomId=null},m.prototype._peekPoll=function(e,t){if(this._peekRoomId!==e.roomId)return void g("Stopped peeking in room %s",e.roomId);const n=this;this.client._http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then((function(t){if(n._peekRoomId!==e.roomId)return void g("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(n.client.getEventMapper()).forEach((function(e){let t=n.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=y(n.client,e.getContent().user_id)).setPresenceEvent(e),n.client.store.storeUser(t)),n.client.emit("event",e)}));const o=t.chunk.filter((function(t){return t.room_id===e.roomId})).map(n.client.getEventMapper());e.addLiveEvents(o),n._peekPoll(e,t.end)}),(function(o){d.logger.error("[%s] Peek poll failed: %s",e.roomId,o),setTimeout((function(){n._peekPoll(e,t)}),3e4)}))},m.prototype.getSyncState=function(){return this._syncState},m.prototype.getSyncStateData=function(){return this._syncStateData},m.prototype.recoverFromSyncStartupError=async function(e,t){await e;const n=this._startKeepAlives();this._updateSyncState("ERROR",{error:t}),await n},m.prototype._wasLazyLoadingToggled=async function(e){e=!!e;let t=!1;if(!await this.client.store.isNewlyCreated()){const n=await this.client.store.getClientOptions();return n&&(t=!!n.lazyLoadMembers),t!==e}return!1},m.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.logger.warn("Token no longer valid - assuming logout"),this.stop(),!0)},m.prototype.sync=function(){const t=this.client,n=this;this._running=!0,e.document&&(this._onOnlineBound=this._onOnline.bind(this),e.document.addEventListener("online",this._onOnlineBound,!1));let o=Promise.resolve(),r=null;const i=async()=>{if(g("Checking lazy load status..."),this.opts.lazyLoadMembers&&t.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){if(g("Checking server lazy load support..."),await t.doesServerSupportLazyLoading())try{g("Creating and storing lazy load sync filter..."),this.opts.filter=await t.createFilter(c.Filter.LAZY_LOADING_SYNC_FILTER),g("Created and stored lazy load sync filter")}catch(e){throw d.logger.error("Creating and storing lazy load sync filter failed",e),e}else g("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1}if(g("Checking whether lazy loading has changed in store..."),await this._wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this._storeIsInvalid=!0;const e=h.InvalidStoreError.TOGGLED_LAZY_LOADING,t=new h.InvalidStoreError(e,!!this.opts.lazyLoadMembers);return this._updateSyncState("ERROR",{error:t}),void d.logger.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{g("Storing client options..."),await this.client._storeClientOptions(),g("Stored client options")}catch(e){throw d.logger.error("Storing client options failed",e),e}!async function e(){g("Getting filter...");let i;n.opts.filter?i=n.opts.filter:(i=new c.Filter(t.credentials.userId)).setTimelineLimit(n.opts.initialSyncLimit);let s;try{s=await t.getOrCreateFilter(f(t.credentials.userId),i)}catch(t){if(d.logger.error("Getting filter failed",t),n._shouldAbortSync(t))return;return g("Waiting for saved sync before retrying filter..."),await n.recoverFromSyncStartupError(o,t),void e()}t.resetNotifTimelineSet();null===n._currentSyncRequest&&(g("Sending first sync request..."),n._currentSyncRequest=n._doSyncRequest({filterId:s},r));g("Waiting for saved sync before starting sync processing...");await o;n._sync({filterId:s})}()};t.isGuest()?n._sync({}):(g("Getting saved sync token..."),o=t.store.getSavedSyncToken().then(e=>(g("Got saved sync token"),r=e,g("Getting saved sync..."),t.store.getSavedSync())).then(e=>{if(g(`Got reply from saved sync, exists? ${!!e}`),e)return n._syncFromCache(e)}).catch(e=>{d.logger.error("Getting saved sync failed",e)}),async function e(){try{g("Getting push rules...");const e=await t.getPushRules();g("Got push rules"),t.pushRules=e}catch(t){if(d.logger.error("Getting push rules failed",t),n._shouldAbortSync(t))return;return g("Waiting for saved sync before retrying push rules..."),await n.recoverFromSyncStartupError(o,t),void e()}i()}())},m.prototype.stop=function(){g("SyncApi.stop"),e.document&&(e.document.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},m.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},m.prototype._syncFromCache=async function(e){g("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const n={oldSyncToken:null,nextSyncToken:t,catchingUp:!1},o={next_batch:t,rooms:e.roomsData,groups:e.groupsData,account_data:{events:e.accountData}};try{await this._processSyncResponse(n,o)}catch(e){d.logger.error("Error processing cached sync",e.stack||e)}this._storeIsInvalid||this._updateSyncState("PREPARED",n)},m.prototype._sync=async function(e){const t=this.client;if(!this._running)return g("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");const n=t.store.getSyncToken();let o;try{null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(e,n)),o=await this._currentSyncRequest}catch(t){return void this._onSyncError(t,e)}finally{this._currentSyncRequest=null}t.store.setSyncToken(o.next_batch),this._failedSyncCount=0,await t.store.setSyncData(o);const r={oldSyncToken:n,nextSyncToken:o.next_batch,catchingUp:this._catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(r);try{await this._processSyncResponse(r,o)}catch(e){d.logger.error("Caught /sync error",e.stack||e),this.client.emit("sync.unexpectedError",e)}r.catchingUp=this._catchingUp,e.hasSyncedBefore||(this._updateSyncState("PREPARED",r),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(r),this._updateSyncState("SYNCING",r),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this._sync(e)},m.prototype._doSyncRequest=function(e,t){const n=this._getSyncParams(e,t);return this.client._http.authedRequest(void 0,"GET","/sync",n,void 0,n.timeout+8e4)},m.prototype._getSyncParams=function(e,t){let n=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,n=0);let o=e.filterId;this.client.isGuest()&&!o&&(o=this._getGuestFilter());const r={filter:o,timeout:n};return this.opts.disablePresence&&(r.set_presence="offline"),t?r.since=t:r._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(r.timeout=0),r},m.prototype._onSyncError=function(e,t){if(!this._running)return g("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");d.logger.error("/sync error %s",e),d.logger.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,d.logger.log("Number of consecutive failed sync requests:",this._failedSyncCount),g("Starting keep-alive"),this._startKeepAlives().then(e=>{e&&"ERROR"===this.getSyncState()&&this._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this._sync(t)}),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},m.prototype._processSyncResponse=async function(e,t){const n=this.client,o=this;if(t.presence&&a.isArray(t.presence.events)&&t.presence.events.map(n.getEventMapper()).forEach((function(e){let t=n.store.getUser(e.getSender());t?t.setPresenceEvent(e):((t=y(n,e.getSender())).setPresenceEvent(e),n.store.storeUser(t)),n.emit("event",e)})),t.account_data&&a.isArray(t.account_data.events)){const e=t.account_data.events.map(n.getEventMapper());n.store.storeAccountDataEvents(e),e.forEach((function(e){if("m.push_rules"===e.getType()){const t=e.getContent();n.pushRules=l.PushProcessor.rewriteDefaultRules(t)}return n.emit("accountData",e),e}))}if(t.to_device&&a.isArray(t.to_device.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(n.getEventMapper()).map(t=>{if("m.key.verification.cancel"===t.getType()){const n=t.getContent().transaction_id;n&&e.push(n)}return t}).forEach((function(t){const o=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=o.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const n=o.transaction_id;e.includes(n)&&t.flagCancelled()}n.emit("toDeviceEvent",t)}else d.logger.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this._catchingUp=!1;t.groups&&(t.groups.invite&&this._processGroupSyncEntry(t.groups.invite,"invite"),t.groups.join&&this._processGroupSyncEntry(t.groups.join,"join"),t.groups.leave&&this._processGroupSyncEntry(t.groups.leave,"leave"));let r=[],i=[],s=[];if(t.rooms&&(t.rooms.invite&&(r=this._mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(i=this._mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(s=this._mapSyncResponseToRoomArray(t.rooms.leave))),this._notifEvents=[],r.forEach((function(e){const t=e.room,r=o._mapSyncEventsFormat(e.invite_state,t);o._processRoomEvents(t,r),e.isBrandNewRoom&&(t.recalculate(),n.store.storeRoom(t),n.emit("Room",t)),r.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("invite")})),await a.promiseMapSeries(i,(async function(t){const r=t.room,i=o._mapSyncEventsFormat(t.state,r),s=o._mapSyncEventsFormat(t.timeline,r),c=o._mapSyncEventsFormat(t.ephemeral),l=o._mapSyncEventsFormat(t.account_data);if(t.unread_notifications){r.setUnreadNotificationCount("total",t.unread_notifications.notification_count);const e=n.isRoomEncrypted(r.roomId);(!e||e&&r.getUnreadNotificationCount("highlight")<=0)&&r.setUnreadNotificationCount("highlight",t.unread_notifications.highlight_count)}if(t.timeline=t.timeline||{},t.isBrandNewRoom)r.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,u.EventTimeline.BACKWARDS);else if(t.timeline.limited){let i=!0;for(let e=s.length-1;e>=0;e--){const t=s[e].getId();if(r.getTimelineForEvent(t)){g("Already have event "+t+" in limited sync - not resetting"),i=!1,s.splice(0,e);break}}i&&(o._deregisterStateListeners(r),r.resetLiveTimeline(t.timeline.prev_batch,o.opts.canResetEntireTimeline(r.roomId)?null:e.oldSyncToken),n.resetNotifTimelineSet(),o._registerStateListeners(r))}async function d(e){if(n.emit("event",e),e.isState()&&"m.room.encryption"==e.getType()&&o.opts.crypto&&await o.opts.crypto.onCryptoEvent(e),e.isState()&&"im.vector.user_status"===e.getType()){let t=n.store.getUser(e.getStateKey());t?t._unstable_updateStatusMessage(e):((t=y(n,e.getStateKey()))._unstable_updateStatusMessage(e),n.store.storeUser(t))}}o._processRoomEvents(r,i,s),t.summary&&r.setSummary(t.summary),r.addEphemeralEvents(c),r.addAccountData(l),r.recalculate(),t.isBrandNewRoom&&(n.store.storeRoom(r),n.emit("Room",r)),o._processEventsForNotifs(r,s),await a.promiseMapSeries(i,d),await a.promiseMapSeries(s,d),c.forEach((function(e){n.emit("event",e)})),l.forEach((function(e){n.emit("event",e)})),r.updateMyMembership("join")})),s.forEach((function(e){const t=e.room,r=o._mapSyncEventsFormat(e.state,t),i=o._mapSyncEventsFormat(e.timeline,t),s=o._mapSyncEventsFormat(e.account_data);o._processRoomEvents(t,r,i),t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(n.store.storeRoom(t),n.emit("Room",t)),o._processEventsForNotifs(t,i),r.forEach((function(e){n.emit("event",e)})),i.forEach((function(e){n.emit("event",e)})),s.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("leave")})),e.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){n.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}},m.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);const t=this;return e>0?t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),e):t._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=a.defer()),this._connectionReturnedDefer.promise},m.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);const t=this;function n(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((function(){n()}),(function(o){400==o.httpStatus||404==o.httpStatus?t._keepAliveTimer=setTimeout(n,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:o}))}))},m.prototype._processGroupSyncEntry=function(e,t){for(const n of Object.keys(e)){const o=e[n];let r=this.client.store.getGroup(n);const i=null===r;null===r&&(r=this.createGroup(n)),o.profile&&r.setProfile(o.profile.name,o.profile.avatar_url),o.inviter&&r.setInviter({userId:o.inviter}),r.setMyMembership(t),i&&this.client.emit("Group",r)}},m.prototype._mapSyncResponseToRoomArray=function(e){const t=this.client,n=this;return a.keys(e).map((function(o){const r=e[o];let i=t.store.getRoom(o),s=!1;return i||(i=n.createRoom(o),s=!0),r.room=i,r.isBrandNewRoom=s,r}))},m.prototype._mapSyncEventsFormat=function(e,t){if(!e||!a.isArray(e.events))return[];const n=this.client.getEventMapper();return e.events.map((function(e){return t&&(e.room_id=t.roomId),n(e)}))},m.prototype._resolveInvites=function(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(n){if(n._requestedProfileInfo)return;n._requestedProfileInfo=!0;const o=t.getUser(n.userId);let r;(r=o?Promise.resolve({avatar_url:o.avatarUrl,displayname:o.displayName}):t.getProfileInfo(n.userId)).then((function(t){const o=n.events.member;"invite"===o.getContent().membership&&(o.getContent().avatar_url=t.avatar_url,o.getContent().displayname=t.displayname,n.setMembershipEvent(o,e.currentState))}),(function(e){}))}))},m.prototype._processRoomEvents=function(e,t,n){const o=e.getLiveTimeline(),r=0==o.getEvents().length;if(r){for(const e of t)this.client.getPushActionsForEvent(e);o.initialiseState(t)}this._resolveInvites(e),e.recalculate(),r||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(n||[])},m.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(let e=0;e<t.length;e++){const n=this.client.getPushActionsForEvent(t[e]);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this._notifEvents.push(t[e])}},m.prototype._getGuestFilter=function(){return this.client._guestRooms?JSON.stringify({room:{timeline:{limit:20}}}):"{}"},m.prototype._updateSyncState=function(e,t){const n=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,n,t)},m.prototype._onOnline=function(){g("Browser thinks we are back online"),this._startKeepAlives(0)}}).call(this,n(3))},function(e,t,n){"use strict";var o=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.Relations=void 0;var r=o(n(72)),i=n(4),s=n(6);class a extends i.EventEmitter{constructor(e,t,n){super(),(0,r.default)(this,"_onEventStatus",(e,t)=>{e.isSending()?t===s.EventStatus.CANCELLED&&(e.removeListener("Event.status",this._onEventStatus),this._removeEvent(e)):e.removeListener("Event.status",this._onEventStatus)}),(0,r.default)(this,"_onBeforeRedaction",e=>{this._relations.has(e)&&(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.removeListener("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.redaction",e))}),this.relationType=e,this.eventType=t,this._relations=new Set,this._annotationsByKey={},this._annotationsBySender={},this._sortedAnnotationsByKey=[],this._targetEvent=null}addEvent(e){if(this._relations.has(e))return;const t=e.getRelation();if(!t)return void console.error("Event must have relation info");const n=t.rel_type,o=e.getType();this.relationType===n&&this.eventType===o?(e.isSending()&&e.on("Event.status",this._onEventStatus),this._relations.add(e),"m.annotation"===this.relationType?this._addAnnotationToAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.on("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.add",e)):console.error("Event relation info doesn't match this container")}_removeEvent(e){if(!this._relations.has(e))return;const t=e.getRelation();if(!t)return void console.error("Event must have relation info");const n=t.rel_type,o=e.getType();this.relationType===n&&this.eventType===o?(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),this.emit("Relations.remove",e)):console.error("Event relation info doesn't match this container")}getRelations(){return[...this._relations]}_addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let n=this._annotationsByKey[t];n||(n=this._annotationsByKey[t]=new Set,this._sortedAnnotationsByKey.push([t,n])),n.add(e),this._sortedAnnotationsByKey.sort((e,t)=>{const n=e[1];return t[1].size-n.size});const o=e.getSender();let r=this._annotationsBySender[o];r||(r=this._annotationsBySender[o]=new Set),r.add(e)}_removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const n=this._annotationsByKey[t];n&&(n.delete(e),this._sortedAnnotationsByKey.sort((e,t)=>{const n=e[1];return t[1].size-n.size}));const o=e.getSender(),r=this._annotationsBySender[o];r&&r.delete(e)}getSortedAnnotationsByKey(){return"m.annotation"!==this.relationType?null:this._sortedAnnotationsByKey}getAnnotationsBySender(){return"m.annotation"!==this.relationType?null:this._annotationsBySender}getLastReplacement(){if("m.replace"!==this.relationType)return null;if(!this._targetEvent)return null;const e=this._targetEvent.getServerAggregatedRelation("m.replace"),t=e&&e.origin_server_ts;return this.getRelations().reduce((e,n)=>n.getSender()!==this._targetEvent.getSender()?e:t&&t>n.getTs()?e:e&&e.getTs()>n.getTs()?e:n,null)}setTargetEvent(e){if(!this._targetEvent&&(this._targetEvent=e,"m.replace"===this.relationType)){const e=this.getLastReplacement();e&&this._targetEvent.makeReplaced(e)}}}t.Relations=a},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomSummary=function(e,t){this.roomId=e,this.info=t}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.SearchResult=s;var r=o(n(2)),i=n(75);function s(e,t){this.rank=e,this.context=t}s.fromJson=function(e,t){const n=e.context||{},o=n.events_before||[],a=n.events_after||[],c=new i.EventContext(t(e.result));return c.setPaginateToken(n.start,!0),c.addEvents(r.map(o,t),!0),c.addEvents(r.map(a,t),!1),c.setPaginateToken(n.end,!1),new s(e.rank,c)}},function(e,t,n){"use strict";function o(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}Object.defineProperty(t,"__esModule",{value:!0}),t.EventContext=o,o.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},o.prototype.getTimeline=function(){return this._timeline},o.prototype.getOurEventIndex=function(){return this._ourEventIndex},o.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},o.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},o.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)}},function(e,t,n){"use strict";function o(){this.fromToken=null}Object.defineProperty(t,"__esModule",{value:!0}),t.StubStore=o,o.prototype={isNewlyCreated:function(){return Promise.resolve(!0)},getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeGroup:function(e){},getGroup:function(e){return null},getGroups:function(){return[]},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,n,o){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return Promise.resolve()},getOutOfBandMembers:function(){return Promise.resolve(null)},setOutOfBandMembers:function(){return Promise.resolve()},clearOutOfBandMembers:function(){return Promise.resolve()},getClientOptions:function(){return Promise.resolve()},storeClientOptions:function(){return Promise.resolve()}}},function(e,t,n){"use strict";t.byteLength=function(e){var t=u(e),n=t[0],o=t[1];return 3*(n+o)/4-o},t.toByteArray=function(e){var t,n,o=u(e),s=o[0],a=o[1],c=new i(function(e,t,n){return 3*(t+n)/4-n}(0,s,a)),l=0,d=a>0?s-4:s;for(n=0;n<d;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],c[l++]=t>>16&255,c[l++]=t>>8&255,c[l++]=255&t;2===a&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,c[l++]=255&t);1===a&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,c[l++]=t>>8&255,c[l++]=255&t);return c},t.fromByteArray=function(e){for(var t,n=e.length,r=n%3,i=[],s=0,a=n-r;s<a;s+=16383)i.push(l(e,s,s+16383>a?a:s+16383));1===r?(t=e[n-1],i.push(o[t>>2]+o[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],i.push(o[t>>10]+o[t>>4&63]+o[t<<2&63]+"="));return i.join("")};for(var o=[],r=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,c=s.length;a<c;++a)o[a]=s[a],r[s.charCodeAt(a)]=a;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e,t,n){for(var r,i,s=[],a=t;a<n;a+=3)r=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(o[(i=r)>>18&63]+o[i>>12&63]+o[i>>6&63]+o[63&i]);return s.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,o,r){var i,s,a=8*r-o-1,c=(1<<a)-1,u=c>>1,l=-7,d=n?r-1:0,h=n?-1:1,p=e[t+d];for(d+=h,i=p&(1<<-l)-1,p>>=-l,l+=a;l>0;i=256*i+e[t+d],d+=h,l-=8);for(s=i&(1<<-l)-1,i>>=-l,l+=o;l>0;s=256*s+e[t+d],d+=h,l-=8);if(0===i)i=1-u;else{if(i===c)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,o),i-=u}return(p?-1:1)*s*Math.pow(2,i-o)},t.write=function(e,t,n,o,r,i){var s,a,c,u=8*i-r-1,l=(1<<u)-1,d=l>>1,h=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,p=o?0:i-1,f=o?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*c-1)*Math.pow(2,r),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,r),s=0));r>=8;e[n+p]=255&a,p+=f,a/=256,r-=8);for(s=s<<r|a,u+=r;u>0;e[n+p]=255&s,p+=f,s/=256,u-=8);e[n+p-f]|=128*g}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomList=void 0;var o=n(9);t.RoomList=class{constructor(e){this._cryptoStore=e,this._roomEncryption={}}async init(){await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ROOMS],e=>{this._cryptoStore.getEndToEndRooms(e,e=>{this._roomEncryption=e})})}getRoomEncryption(e){return this._roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this._roomEncryption[e]=t,await this._cryptoStore.doTxn("readwrite",[o.IndexedDBCryptoStore.STORE_ROOMS],n=>{this._cryptoStore.storeEndToEndRoom(e,t,n)})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageCryptoStore=void 0;var o=n(0),r=n(16);const i="crypto.",s=i+"account",a=i+"cross_signing_keys",c=i+"notified_error_devices",u=i+"device_data",l=i+"inboundgroupsessions/",d=i+"inboundgroupsessions.withheld/",h=i+"rooms/",p=i+"sessionsneedingbackup";function f(e){return i+"sessions/"+e}function g(e){return i+"session.problems/"+e}function m(e,t){return l+e+"/"+t}function y(e,t){return d+e+"/"+t}function _(e){return h+e}class v extends r.MemoryCryptoStore{constructor(e){super(),this.store=e}static exists(e){const t=e.length;for(let n=0;n<t;n++)if(e.key(n).startsWith(i))return!0;return!1}countEndToEndSessions(e,t){let n=0;for(let e=0;e<this.store.length;++e)this.store.key(e).startsWith(f(""))&&++n;t(n)}_getEndToEndSessions(e,t,n){const o=S(this.store,f(e)),r={};for(const[e,t]of Object.entries(o||{}))r[e]="string"==typeof t?{session:t}:t;return r}getEndToEndSession(e,t,n,o){o(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,n){n(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e)if(this.store.key(e).startsWith(f(""))){const n=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(n)))t(e)}}storeEndToEndSession(e,t,n,o){const r=this._getEndToEndSessions(e)||{};r[t]=n,E(this.store,f(e),r)}async storeEndToEndSessionProblem(e,t,n){const o=g(e),r=S(this.store,o)||[];r.push({type:t,fixed:n,time:Date.now()}),r.sort((e,t)=>e.time-t.time),E(this.store,o,r)}async getEndToEndSessionProblem(e,t){const n=g(e),o=S(this.store,n)||[];if(!o.length)return null;const r=o[o.length-1];for(const e of o)if(e.time>t)return Object.assign({},e,{fixed:r.fixed});return r.fixed?null:r}async filterOutNotifiedErrorDevices(e){const t=S(this.store,c)||{},n=[];for(const o of e){const{userId:e,deviceInfo:r}=o;e in t?r.deviceId in t[e]||(n.push(o),t[e][r.deviceId]=!0):(n.push(o),t[e]={[r.deviceId]:!0})}return E(this.store,c,t),n}getEndToEndInboundGroupSession(e,t,n,o){o(S(this.store,m(e,t)),S(this.store,y(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const n=this.store.key(e);n.startsWith(l)&&t({senderKey:n.substr(l.length,43),sessionId:n.substr(l.length+44),sessionData:S(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,n,o){S(this.store,m(e,t))||this.storeEndToEndInboundGroupSession(e,t,n,o)}storeEndToEndInboundGroupSession(e,t,n,o){E(this.store,m(e,t),n)}storeEndToEndInboundGroupSessionWithheld(e,t,n,o){E(this.store,y(e,t),n)}getEndToEndDeviceData(e,t){t(S(this.store,u))}storeEndToEndDeviceData(e,t){E(this.store,u,e)}storeEndToEndRoom(e,t,n){E(this.store,_(e),t)}getEndToEndRooms(e,t){const n={},o=_("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(t.startsWith(o)){n[t.substr(o.length)]=S(this.store,t)}}t(n)}getSessionsNeedingBackup(e){const t=S(this.store,p)||{},n=[];for(const o in t)if(Object.prototype.hasOwnProperty.call(t,o)){const t=o.substr(0,43),r=o.substr(44);if(this.getEndToEndInboundGroupSession(t,r,null,e=>{n.push({senderKey:t,sessionId:r,sessionData:e})}),e&&o.length>=e)break}return Promise.resolve(n)}countSessionsNeedingBackup(){const e=S(this.store,p)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=S(this.store,p)||{};for(const n of e)delete t[n.senderKey+"/"+n.sessionId];return E(this.store,p,t),Promise.resolve()}markSessionsNeedingBackup(e){const t=S(this.store,p)||{};for(const n of e)t[n.senderKey+"/"+n.sessionId]=!0;return E(this.store,p,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(s),Promise.resolve()}getAccount(e,t){t(S(this.store,s))}storeAccount(e,t){E(this.store,s,t)}getCrossSigningKeys(e,t){t(S(this.store,a))}storeCrossSigningKeys(e,t){E(this.store,a,t)}doTxn(e,t,n){return Promise.resolve(n(null))}}function S(e,t){try{return JSON.parse(e.getItem(t))}catch(e){o.logger.log("Error: Failed to get key %s: %s",t,e.stack||e),o.logger.log(e.stack)}return null}function E(e,t,n){e.setItem(t,JSON.stringify(n))}t.LocalStorageCryptoStore=v},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.upgradeDatabase=function(e,t){r.logger.log(`Upgrading IndexedDBCryptoStore from version ${t}`+` to ${s}`),t<1&&function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e);t<2&&e.createObjectStore("account");if(t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]});t<5&&e.createObjectStore("device_data");t<6&&e.createObjectStore("rooms");t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]});t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]});if(t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}},t.Backend=t.VERSION=void 0;var r=n(0),i=o(n(2));const s=9;t.VERSION=s;function a(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function c(e){return new Promise((t,n)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&n(e._mx_abortexception),t()},e.onerror=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(r.logger.log("Error performing indexeddb txn",t),n(t.target.error))},e.onabort=t=>{void 0!==e._mx_abortexception?n(e._mx_abortexception):(r.logger.log("Error performing indexeddb txn",t),n(t.target.error))}})}t.Backend=class{constructor(e){this._db=e,e.onversionchange=t=>{r.logger.log(`versionchange for indexeddb ${this._dbName}: closing`),e.close()}}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise((n,o)=>{const i=this._db.transaction("outgoingRoomKeyRequests","readwrite");i.onerror=o,this._getOutgoingRoomKeyRequest(i,t,o=>{if(o)return r.logger.log("already have key request outstanding for "+`${t.room_id} / ${t.session_id}: `+"not sending another"),void n(o);r.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),i.oncomplete=()=>{n(e)},i.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,n)=>{const o=this._db.transaction("outgoingRoomKeyRequests","readonly");o.onerror=n,this._getOutgoingRoomKeyRequest(o,e,e=>{t(e)})})}_getOutgoingRoomKeyRequest(e,t,n){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=e=>{const o=e.target.result;if(!o)return void n(null);const r=o.value;i.deepCompare(r.requestBody,t)?n(r):o.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,n=0;const o=this._db.transaction("outgoingRoomKeyRequests","readonly"),r=o.objectStore("outgoingRoomKeyRequests"),i=e[n];return r.index("state").openCursor(i).onsuccess=function o(r){const i=r.target.result;if(i)return void(t=i.value);if(++n>=e.length)return;const s=e[n];r.target.source.openCursor(s).onsuccess=o},c(o).then(()=>t)}getOutgoingRoomKeyRequestsByTarget(e,t,n){let o=0;const r=[];const i=this._db.transaction("outgoingRoomKeyRequests","readonly"),s=i.objectStore("outgoingRoomKeyRequests"),a=n[o];return s.index("state").openCursor(a).onsuccess=function i(s){const a=s.target.result;if(a){const n=a.value;n.recipients.includes({userId:e,deviceId:t})&&r.push(n),a.continue()}else{if(++o>=n.length)return;const e=n[o];s.target.source.openCursor(e).onsuccess=i}},c(i).then(()=>r)}updateOutgoingRoomKeyRequest(e,t,n){let o=null;const i=this._db.transaction("outgoingRoomKeyRequests","readwrite");return i.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){const i=e.target.result;if(!i)return;const s=i.value;s.state==t?(Object.assign(s,n),i.update(s),o=s):r.logger.warn(`Cannot update room key request from ${t} `+`as it was already updated to ${s.state}`)},c(i).then(()=>o)}deleteOutgoingRoomKeyRequest(e,t){const n=this._db.transaction("outgoingRoomKeyRequests","readwrite");return n.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=e=>{const n=e.target.result;if(!n)return;const o=n.value;o.state==t?n.delete():r.logger.warn(`Cannot delete room key request in state ${o.state} `+`(expected ${t})`)},c(n)}getAccount(e,t){const n=e.objectStore("account").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){a(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const n=e.objectStore("account").get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(t){a(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}countEndToEndSessions(e,t){const n=e.objectStore("sessions").count();n.onsuccess=function(){t(n.result)}}getEndToEndSessions(e,t,n){const o=t.objectStore("sessions").index("deviceKey").openCursor(e),r={};o.onsuccess=function(){const e=o.result;if(e)r[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{n(r)}catch(e){a(t,e)}}}getEndToEndSession(e,t,n,o){const r=n.objectStore("sessions").get([e,t]);r.onsuccess=function(){try{r.result?o({session:r.result.session,lastReceivedMessageTs:r.result.lastReceivedMessageTs}):o(null)}catch(e){a(n,e)}}}getAllEndToEndSessions(e,t){const n=e.objectStore("sessions").openCursor();n.onsuccess=function(){const o=n.result;if(o)t(o.value),o.continue();else try{t(null)}catch(t){a(e,t)}}}storeEndToEndSession(e,t,n,o){o.objectStore("sessions").put({deviceKey:e,sessionId:t,session:n.session,lastReceivedMessageTs:n.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,n){const o=this._db.transaction("session_problems","readwrite");return o.objectStore("session_problems").put({deviceKey:e,type:t,fixed:n,time:Date.now()}),c(o)}async getEndToEndSessionProblem(e,t){let n;const o=this._db.transaction("session_problems","readwrite"),r=o.objectStore("session_problems").index("deviceKey").getAll(e);return r.onsuccess=e=>{const o=r.result;if(!o.length)return void(n=null);o.sort((e,t)=>e.time-t.time);const i=o[o.length-1];for(const e of o)if(e.time>t)return void(n=Object.assign({},e,{fixed:i.fixed}));n=i.fixed?null:i},await c(o),n}async filterOutNotifiedErrorDevices(e){const t=this._db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),n=[];return await Promise.all(e.map(e=>new Promise(o=>{const{userId:r,deviceInfo:i}=e,s=t.get([r,i.deviceId]);s.onsuccess=function(){s.result||(t.put({userId:r,deviceId:i.deviceId}),n.push(e)),o()}}))),n}getEndToEndInboundGroupSession(e,t,n,o){let r=!1,i=!1;const s=n.objectStore("inbound_group_sessions").get([e,t]);s.onsuccess=function(){try{r=s.result?s.result.session:null,!1!==i&&o(r,i)}catch(e){a(n,e)}};const c=n.objectStore("inbound_group_sessions_withheld").get([e,t]);c.onsuccess=function(){try{i=c.result?c.result.session:null,!1!==r&&o(r,i)}catch(e){a(n,e)}}}getAllEndToEndInboundGroupSessions(e,t){const n=e.objectStore("inbound_group_sessions").openCursor();n.onsuccess=function(){const o=n.result;if(o){try{t({senderKey:o.value.senderCurve25519Key,sessionId:o.value.sessionId,sessionData:o.value.session})}catch(t){a(e,t)}o.continue()}else try{t(null)}catch(t){a(e,t)}}}addEndToEndInboundGroupSession(e,t,n,o){const i=o.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:n});i.onerror=n=>{"ConstraintError"===i.error.name?(n.stopPropagation(),n.preventDefault(),r.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):a(o,new Error("Failed to add inbound group session: "+i.error))}}storeEndToEndInboundGroupSession(e,t,n,o){o.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:n})}storeEndToEndInboundGroupSessionWithheld(e,t,n,o){o.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:n})}getEndToEndDeviceData(e,t){const n=e.objectStore("device_data").get("-");n.onsuccess=function(){try{t(n.result||null)}catch(t){a(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,n){n.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const n={},o=e.objectStore("rooms").openCursor();o.onsuccess=function(){const r=o.result;if(r)n[r.key]=r.value,r.continue();else try{t(n)}catch(t){a(e,t)}}}getSessionsNeedingBackup(e){return new Promise((t,n)=>{const o=[],r=this._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");r.onerror=n,r.oncomplete=function(){t(o)};const i=r.objectStore("sessions_needing_backup"),s=r.objectStore("inbound_group_sessions"),a=i.openCursor();a.onsuccess=function(){const t=a.result;if(t){const n=s.get(t.key);n.onsuccess=function(){o.push({senderKey:n.result.senderCurve25519Key,sessionId:n.result.sessionId,sessionData:n.result.session})},(!e||o.length<e)&&t.continue()}}})}countSessionsNeedingBackup(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise((e,n)=>{const o=t.count();o.onerror=n,o.onsuccess=()=>e(o.result)})}unmarkSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,o)=>{const r=n.delete([e.senderKey,e.sessionId]);r.onsuccess=t,r.onerror=o})))}markSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const n=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,o)=>{const r=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});r.onsuccess=t,r.onerror=o})))}doTxn(e,t,n){const o=this._db.transaction(t,e),r=c(o),i=n(o);return r.then(()=>i)}}},function(e,t,n){"use strict";(function(e){var o=n(1),r=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.isCryptoAvailable=function(){return Boolean(e.Olm)},t.Crypto=D,t.verificationMethods=void 0;var i=r(n(24)),s=n(4),a=n(21),c=n(0),u=o(n(2)),l=n(40),d=o(n(7)),h=n(86),p=n(14),f=o(n(41)),g=n(42),m=n(87),y=n(88),_=n(9),v=n(89),S=n(90),E=n(44),b=n(45),w=n(26),I=n(95),R=n(96),T=o(n(12));const k=p.DeviceInfo.DeviceVerification,O={[v.ScanQRCode.NAME]:v.ScanQRCode,[v.ShowQRCode.NAME]:v.ShowQRCode,[S.SAS.NAME]:S.SAS},C={QR_CODE_SCAN:v.ScanQRCode.NAME,QR_CODE_SHOW:v.ShowQRCode.NAME,SAS:S.SAS.NAME};t.verificationMethods=C;function D(e,t,n,o,r,i,s,c){if(this._onDeviceListUserCrossSigningUpdated=this._onDeviceListUserCrossSigningUpdated.bind(this),this._reEmitter=new a.ReEmitter(this),this._baseApis=e,this._sessionStore=t,this._userId=n,this._deviceId=o,this._clientStore=r,this._cryptoStore=i,this._roomList=s,this._verificationMethods=new Map,c)for(const e of c)"string"==typeof e?O[e]&&this._verificationMethods.set(e,O[e]):e.NAME&&this._verificationMethods.set(e.NAME,e);this.backupInfo=null,this.backupKey=null,this._checkedForBackup=!1,this._sendingBackups=!1,this._olmDevice=new l.OlmDevice(i),this._deviceList=new h.DeviceList(e,i,this._olmDevice),this._deviceList.on("userCrossSigningUpdated",this._onDeviceListUserCrossSigningUpdated),this._reEmitter.reEmit(this._deviceList,["crypto.devicesUpdated"]),this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=u.keys(f.DECRYPTION_CLASSES),this._deviceKeys={},this._globalBlacklistUnverifiedDevices=!1,this._globalErrorOnUnknownDevices=!0,this._outgoingRoomKeyRequestManager=new y.OutgoingRoomKeyRequestManager(e,this._deviceId,this._cryptoStore),this._receivedRoomKeyRequests=[],this._receivedRoomKeyRequestCancellations=[],this._processingRoomKeyRequests=!1,this._lazyLoadMembers=!1,this._roomDeviceTrackingState={},this._lastNewSessionForced={},this._toDeviceVerificationRequests=new Map,this._inRoomVerificationRequests=new Map;const d=this._baseApis._cryptoCallbacks||{};this._crossSigningInfo=new g.CrossSigningInfo(n,d),this._secretStorage=new m.SecretStorage(e,d,this._crossSigningInfo),!d.getCrossSigningKey&&d.getSecretStorageKey&&(d.getCrossSigningKey=async e=>g.CrossSigningInfo.getFromSecretStorage(e,this._secretStorage))}function A(e){const t=5;if(e._oneTimeKeyCheckInProgress)return;const n=Date.now();if(null!==e._lastOneTimeKeyCheck&&n-e._lastOneTimeKeyCheck<6e4)return;e._lastOneTimeKeyCheck=n;const o=e._olmDevice.maxNumberOfOneTimeKeys(),r=Math.floor(o/2);function i(n){if(r<=n)return Promise.resolve();const o=Math.min(r-n,t);return e._olmDevice.generateOneTimeKeys(o).then(()=>(async function(e){const t=await e._olmDevice.getOneTimeKeys(),n={},o=[];for(const r in t.curve25519)if(t.curve25519.hasOwnProperty(r)){const i={key:t.curve25519[r]};n["signed_curve25519:"+r]=i,o.push(e._signObject(i))}await Promise.all(o);const r=await e._baseApis.uploadKeysRequest({one_time_keys:n},{device_id:e._deviceId});return await e._olmDevice.markKeysAsPublished(),r})(e)).then(e=>{if(e.one_time_key_counts&&e.one_time_key_counts.signed_curve25519)return i(e.one_time_key_counts.signed_curve25519);throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")})}e._oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>void 0!==e._oneTimeKeyCount?Promise.resolve(e._oneTimeKeyCount):e._baseApis.uploadKeysRequest({},{device_id:e._deviceId}).then(e=>e.one_time_key_counts.signed_curve25519||0)).then(e=>i(e)).catch(e=>{c.logger.error("Error uploading one-time keys",e.stack||e)}).finally(()=>{e._oneTimeKeyCount=void 0,e._oneTimeKeyCheckInProgress=!1})}u.inherits(D,s.EventEmitter),D.prototype.init=async function(){c.logger.log("Crypto: initialising Olm..."),await e.Olm.init(),c.logger.log("Crypto: initialising Olm device..."),await this._olmDevice.init(),c.logger.log("Crypto: loading device list..."),await this._deviceList.load(),this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,c.logger.log("Crypto: fetching own devices...");let t=this._deviceList.getRawStoredDevicesForUser(this._userId);if(t||(t={}),!t[this._deviceId]){c.logger.log("Crypto: adding this device to the store...");const e={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:k.VERIFIED,known:!0};t[this._deviceId]=e,this._deviceList.storeDevicesForUser(this._userId,t),this._deviceList.saveIfDirty()}await this._cryptoStore.doTxn("readonly",[_.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this._cryptoStore.getCrossSigningKeys(e,e=>{e&&(c.logger.log("Loaded cross-signing public keys from crypto store"),this._crossSigningInfo.setKeys(e))})}),this._deviceList.startTrackingDeviceList(this._userId),c.logger.log("Crypto: checking for key backup..."),this._checkAndStartKeyBackup()},D.prototype.createRecoveryKeyFromPassphrase=async function(t){const n=new e.Olm.PkDecryption;try{const e={};if(t){const o=await(0,E.keyFromPassphrase)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:o.iterations,salt:o.salt},e.pubkey=n.init_with_private_key(o.key)}else e.pubkey=n.generate_key();const o=n.get_private_key();return[e,(0,b.encodeRecoveryKey)(o),o]}finally{n&&n.free()}},D.prototype.bootstrapSecretStorage=async function({authUploadDeviceSigningKeys:e,createSecretStorageKey:t=(async()=>{}),keyBackupInfo:n}={}){c.logger.log("Bootstrapping Secure Secret Storage");let o={};const r=Object.assign({},this._baseApis._cryptoCallbacks);try{const i=await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage);if(this._crossSigningInfo.getId()&&i?c.logger.log("Cross signing keys are present in secret storage"):(c.logger.log("Cross-signing public and/or private keys not found, checking secret storage for private keys"),i?(c.logger.log("Cross-signing private keys found in secret storage"),await this.checkOwnCrossSigningTrust()):(c.logger.log("Cross-signing private keys not found in secret storage, creating new keys"),this._baseApis._cryptoCallbacks.saveCrossSigningKeys=e=>o=e,this._baseApis._cryptoCallbacks.getCrossSigningKey=e=>o[e],await this.resetCrossSigningKeys(g.CrossSigningLevel.MASTER,{authUploadDeviceSigningKeys:e}))),await this.hasSecretStorageKey())c.logger.log("Have secret storage key");else{let e;if(n){c.logger.log("Secret storage default key not found, using key backup key");const t={pubkey:n.auth_data.public_key};n.auth_data.private_key_salt&&n.auth_data.private_key_iterations&&(t.passphrase={algorithm:"m.pbkdf2",iterations:n.auth_data.private_key_iterations,salt:n.auth_data.private_key_salt}),e=await this.addSecretStorageKey(m.SECRET_STORAGE_ALGORITHM_V1,t),this._secretStorage.storePassthrough("m.megolm_backup.v1",e),(await this.checkKeyBackup(n)).trustInfo.usable?(console.log("Adding cross signing signature to key backup"),await this._crossSigningInfo.signObject(n.auth_data,"master"),await this._baseApis._http.authedRequest(void 0,"PUT","/room_keys/version/"+n.version,void 0,n,{prefix:T.PREFIX_UNSTABLE})):console.log("Key backup is NOT TRUSTED: NOT adding cross signing signature")}else{c.logger.log("Secret storage default key not found, creating new key");const n=await t();e=await this.addSecretStorageKey(m.SECRET_STORAGE_ALGORITHM_V1,n)}await this.setDefaultSecretStorageKeyId(e)}Object.keys(o).length&&(c.logger.log("Storing cross-signing private keys in secret storage"),await this._secretStorage.signKey(),r.saveCrossSigningKeys||await g.CrossSigningInfo.storeInSecretStorage(o,this._secretStorage))}finally{this._baseApis._cryptoCallbacks=r}c.logger.log("Secure Secret Storage ready")},D.prototype.addSecretStorageKey=function(e,t,n){return this._secretStorage.addKey(e,t,n)},D.prototype.hasSecretStorageKey=function(e){return this._secretStorage.hasKey(e)},D.prototype.storeSecret=function(e,t,n){return this._secretStorage.store(e,t,n)},D.prototype.getSecret=function(e){return this._secretStorage.get(e)},D.prototype.isSecretStored=function(e,t){return this._secretStorage.isStored(e,t)},D.prototype.requestSecret=function(e,t){return t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(this._userId))),this._secretStorage.request(e,t)},D.prototype.getDefaultSecretStorageKeyId=function(){return this._secretStorage.getDefaultKeyId()},D.prototype.setDefaultSecretStorageKeyId=function(e){return this._secretStorage.setDefaultKeyId(e)},D.prototype.checkSecretStoragePrivateKey=function(t,n){let o=null;try{return(o=new e.Olm.PkDecryption).init_with_private_key(t)===n}finally{o&&o.free()}},D.prototype.checkCrossSigningPrivateKey=function(t,n){let o=null;try{return(o=new e.Olm.PkSigning).init_with_seed(t)===n}finally{o&&o.free()}},D.prototype.resetCrossSigningKeys=async function(e,{authUploadDeviceSigningKeys:t=(async e=>await e())}={}){c.logger.info(`Resetting cross-signing keys at level ${e}`);const n=Object.assign({},this._crossSigningInfo.keys);try{await this._crossSigningInfo.resetKeys(e),await this._signObject(this._crossSigningInfo.keys.master);const n={};for(const[e,t]of Object.entries(this._crossSigningInfo.keys))n[e+"_key"]=t;await t(async e=>{await this._baseApis.uploadDeviceSigningKeys(e,n)}),await this._cryptoStore.doTxn("readwrite",[_.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this._cryptoStore.storeCrossSigningKeys(e,this._crossSigningInfo.keys)})}catch(e){throw c.logger.error("Resetting cross-signing keys failed, revert to previous keys",e),this._crossSigningInfo.keys=n,e}this._baseApis.emit("crossSigning.keysChanged",{}),await this._afterCrossSigningLocalKeyChange(),c.logger.info("Cross-signing key reset complete")},D.prototype._afterCrossSigningLocalKeyChange=async function(){const e=this._deviceList.getStoredDevice(this._userId,this._deviceId),t=await this._crossSigningInfo.signDevice(this._userId,e);await this._baseApis.uploadKeySignatures({[this._userId]:{[this._deviceId]:t}});const n={};for(const[e,t]of Object.entries(this._deviceList._crossSigningInfo)){const o=await this._checkForDeviceVerificationUpgrade(e,g.CrossSigningInfo.fromStorage(t,e));o&&(n[e]=o)}const o=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(Object.keys(n).length>0&&o)try{const e=await o({users:n});if(e)for(const t of e)t in n&&await this._baseApis.setDeviceVerified(t,n[t].crossSigningInfo.getId())}catch(e){c.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}},D.prototype._checkForDeviceVerificationUpgrade=async function(e,t){const n=this._crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.verified){const n=this._deviceList.getRawStoredDevicesForUser(e),o=await this._checkForValidDeviceSignature(e,t.keys.master,n);if(o.length)return{devices:o.map(e=>p.DeviceInfo.fromStorage(n[e],e)),crossSigningInfo:t}}},D.prototype._checkForValidDeviceSignature=async function(e,t,n){const o=[];if(n&&t.signatures&&t.signatures[e])for(const r of Object.keys(t.signatures[e])){const[,i]=r.split(":",2);if(i in n&&n[i].verified===k.VERIFIED)try{await d.verifySignature(this._olmDevice,t,e,i,n[i].keys[r]),o.push(i)}catch(e){}}return o},D.prototype.getCrossSigningId=function(e){return this._crossSigningInfo.getId(e)},D.prototype.getStoredCrossSigningForUser=function(e){return this._deviceList.getStoredCrossSigningForUser(e)},D.prototype.checkUserTrust=function(e){const t=this._deviceList.getStoredCrossSigningForUser(e);return t?this._crossSigningInfo.checkUserTrust(t):new g.UserTrustLevel(!1,!1)},D.prototype.checkDeviceTrust=function(e,t){const n=this._deviceList.getStoredDevice(e,t),o=n&&n.isVerified(),r=this._deviceList.getStoredCrossSigningForUser(e);return n&&r?this._crossSigningInfo.checkDeviceTrust(r,n,o):new g.DeviceTrustLevel(!1,!1,o)},D.prototype._onDeviceListUserCrossSigningUpdated=async function(e){if(e===this._userId){const t=this._deviceList.getStoredCrossSigningForUser(e),n=t?t.getId():null,o=this._crossSigningInfo.getId(),r=o!==n;o&&n&&!r?await this.checkOwnCrossSigningTrust():this.emit("crossSigning.keysChanged",{})}else await this._checkDeviceVerifications(e),this.emit("userTrustStatusChanged",e,this.checkUserTrust(e))},D.prototype.checkOwnCrossSigningTrust=async function(){const e=this._userId,t=this._deviceList.getStoredCrossSigningForUser(e);if(!t)return void c.logger.error("Got cross-signing update event for user "+e+" but no new cross-signing information found!");const n=t.getId(),o=this._crossSigningInfo.getId()!==n;if(o){c.logger.info("Got new master public key",n);let e=null;try{if(!(e=(await this._crossSigningInfo.getCrossSigningKey("master",n))[1]))throw new Error("Cross-signing master private key not available")}finally{e&&e.free()}c.logger.info("Got matching private key from callback for new public master key")}const r=this._crossSigningInfo.getId("self_signing"),i=this._crossSigningInfo.getId("user_signing");this._crossSigningInfo.setKeys(t.keys),await this._cryptoStore.doTxn("readwrite",[_.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this._cryptoStore.storeCrossSigningKeys(e,this._crossSigningInfo.keys)});const s={};if(r!==t.getId("self_signing")){c.logger.info("Got new self-signing key",t.getId("self_signing"));const e=this._deviceList.getStoredDevice(this._userId,this._deviceId),n=await this._crossSigningInfo.signDevice(this._userId,e);s[this._deviceId]=n}i!==t.getId("user_signing")&&c.logger.info("Got new user-signing key",t.getId("user_signing")),o&&(await this._signObject(this._crossSigningInfo.keys.master),s[this._crossSigningInfo.getId()]=this._crossSigningInfo.keys.master),Object.keys(s).length&&await this._baseApis.uploadKeySignatures({[this._userId]:s}),this.emit("userTrustStatusChanged",e,this.checkUserTrust(e)),o&&(this._baseApis.emit("crossSigning.keysChanged",{}),await this._afterCrossSigningLocalKeyChange()),await this.checkKeyBackup()},D.prototype._checkDeviceVerifications=async function(e){if(this._crossSigningInfo.keys.user_signing){const t=this._deviceList.getStoredCrossSigningForUser(e);if(t){const n=await this._checkForDeviceVerificationUpgrade(e,t),o=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(n&&o){(await o({users:{[e]:n}})).includes(e)&&await this._baseApis.setDeviceVerified(e,t.getId())}}}},D.prototype._checkAndStartKeyBackup=async function(){if(c.logger.log("Checking key backup status..."),this._baseApis.isGuest())return c.logger.log("Skipping key backup check since user is guest"),this._checkedForBackup=!0,null;let e;try{e=await this._baseApis.getKeyBackupVersion()}catch(e){return c.logger.log("Error checking for active key backup",e),e.httpStatus/100==4&&(this._checkedForBackup=!0),null}this._checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(c.logger.log("Found usable key backup v"+e.version+": enabling key backups"),this._baseApis.enableKeyBackup(e)):!t.usable&&this.backupInfo?(c.logger.log("No usable key backup: disabling key backup"),this._baseApis.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(c.logger.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this._baseApis.disableKeyBackup(),this._baseApis.enableKeyBackup(e)):c.logger.log("Backup version "+e.version+" still current")):c.logger.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}},D.prototype.setTrustedBackupPubKey=async function(e){this._sessionStore.setLocalTrustedBackupPubKey(e),await this.checkKeyBackup()},D.prototype.checkKeyBackup=async function(){return this._checkedForBackup=!1,this._checkAndStartKeyBackup()},D.prototype.isKeyBackupTrusted=async function(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.public_key&&e.auth_data.signatures))return c.logger.info("Key backup is absent or missing required data"),t;const n=this._sessionStore.getLocalTrustedBackupPubKey();e.auth_data.public_key===n&&(c.logger.info("Backup public key "+n+" is trusted locally"),t.trusted_locally=!0);const o=e.auth_data.signatures[this._userId]||[];for(const n of Object.keys(o)){const o=n.split(":");if("ed25519"!==o[0]){c.logger.log("Ignoring unknown signature type: "+o[0]);continue}const r={deviceId:o[1]},i=this._crossSigningInfo.getId();if(i===r.deviceId){r.crossSigningId=!0;try{await d.verifySignature(this._olmDevice,e.auth_data,this._userId,r.deviceId,i),r.valid=!0}catch(e){c.logger.warning("Bad signature from cross signing key "+i,e),r.valid=!1}t.sigs.push(r);continue}const s=this._deviceList.getStoredDevice(this._userId,r.deviceId);if(s){r.device=s,r.deviceTrust=await this.checkDeviceTrust(this._userId,r.deviceId);try{await d.verifySignature(this._olmDevice,e.auth_data,this._userId,s.deviceId,s.getFingerprint()),r.valid=!0}catch(t){c.logger.info("Bad signature from key ID "+n+" userID "+this._userId+" device ID "+s.deviceId+" fingerprint: "+s.getFingerprint(),e.auth_data,t),r.valid=!1}}else r.valid=null,c.logger.info("Ignoring signature from unknown key "+n);t.sigs.push(r)}return t.usable=t.sigs.some(e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId)),t.usable|=t.trusted_locally,t},D.prototype.enableLazyLoading=function(){this._lazyLoadMembers=!0},D.prototype.registerEventHandlers=function(e){const t=this;e.on("RoomMember.membership",(function(e,n,o){try{t._onRoomMembership(e,n,o)}catch(e){c.logger.error("Error handling membership change:",e)}})),e.on("toDeviceEvent",(function(e){t._onToDeviceEvent(e)})),e.on("Room.timeline",(function(e){t._onTimelineEvent(e)})),e.on("Event.decrypted",(function(e){t._onTimelineEvent(e)}))},D.prototype.start=function(){this._outgoingRoomKeyRequestManager.start()},D.prototype.stop=function(){this._outgoingRoomKeyRequestManager.stop(),this._deviceList.stop()},D.getOlmVersion=function(){return l.OlmDevice.getOlmVersion()},D.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},D.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},D.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},D.prototype.setGlobalErrorOnUnknownDevices=function(e){this._globalErrorOnUnknownDevices=e},D.prototype.getGlobalErrorOnUnknownDevices=function(){return this._globalErrorOnUnknownDevices},D.prototype.uploadDeviceKeys=function(){const e=this,t=e._userId,n=e._deviceId,o={algorithms:e._supportedAlgorithms,device_id:n,keys:e._deviceKeys,user_id:t};return e._signObject(o).then(()=>e._baseApis.uploadKeysRequest({device_keys:o},{device_id:n}))},D.prototype.updateOneTimeKeyCount=function(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this._oneTimeKeyCount=e},D.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},D.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},D.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},D.prototype.saveDeviceList=function(e){return this._deviceList.saveIfDirty(e)},D.prototype.setDeviceVerification=async function(e,t,n,o,r){void 0===n&&(n=null),void 0===o&&(o=null),void 0===r&&(r=null);const i=this._deviceList.getStoredCrossSigningForUser(e);if(i&&i.getId()===t){if(null!==o||null!==r)throw new Error("Cannot set blocked or known for a cross-signing key");if(!n)throw new Error("Cannot set a cross-signing key as unverified");const s=await this._crossSigningInfo.signUser(i);return s&&await this._baseApis.uploadKeySignatures({[e]:{[t]:s}}),s}const s=this._deviceList.getRawStoredDevicesForUser(e);if(!s||!s[t])throw new Error("Unknown device "+e+":"+t);const a=s[t];let c=a.verified;n?c=k.VERIFIED:null!==n&&c==k.VERIFIED&&(c=k.UNVERIFIED),o?c=k.BLOCKED:null!==o&&c==k.BLOCKED&&(c=k.UNVERIFIED);let u=a.known;if(null!==r&&(u=r),a.verified===c&&a.known===u||(a.verified=c,a.known=u,this._deviceList.storeDevicesForUser(e,s),this._deviceList.saveIfDirty()),n&&e===this._userId){const n=await this._crossSigningInfo.signDevice(e,p.DeviceInfo.fromStorage(a,t));n&&await this._baseApis.uploadKeySignatures({[e]:{[t]:n}})}const l=p.DeviceInfo.fromStorage(a,t);return this.emit("deviceVerificationChanged",e,t,l),l},D.prototype.requestVerificationDM=async function(e,t,n){const o=new I.InRoomChannel(this._baseApis,t,e),r=await this._requestVerificationWithChannel(e,n,o,this._inRoomVerificationRequests);return await r.waitForVerifier()},D.prototype.acceptVerificationDM=function(e,t){if(!I.InRoomChannel.validateEvent(e,this._baseApis))return;const n=e.getSender(),o=this._inRoomVerificationRequests.get(n);if(!o)return;const r=I.InRoomChannel.getTransactionId(e),i=o.get(r);return i?i.beginKeyVerification(t):void 0},D.prototype.requestVerification=async function(e,t,n){n||(n=Object.keys(this._deviceList.getRawStoredDevicesForUser(e)));const o=new R.ToDeviceChannel(this._baseApis,e,n),r=await this._requestVerificationWithChannel(e,t,o,this._toDeviceVerificationRequests);return await r.waitForVerifier()},D.prototype._requestVerificationWithChannel=async function(e,t,n,o){t||(t=[...this._verificationMethods.keys()]);const r=new w.VerificationRequest(n,this._verificationMethods,e,this._baseApis);await r.sendRequest();let i=o.get(e);return i||(i=new Map,o.set(e,i)),i.set(n.transactionId,r),r},D.prototype.beginKeyVerification=function(e,t,n,o=null){let r,i=this._toDeviceVerificationRequests.get(t);if(i||(i=new Map,this._toDeviceVerificationRequests.set(t,i)),o)r=i.get(o);else{o=R.ToDeviceChannel.makeTransactionId();const e=new R.ToDeviceChannel(this._baseApis,t,[n],o,n);r=new w.VerificationRequest(e,this._verificationMethods,t,this._baseApis),i.set(o,r)}if(!r)throw new Error(`No request found for user ${t} with transactionId ${o}`);return r.beginKeyVerification(e,{userId:t,deviceId:n})},D.prototype.getOlmSessionsForUser=async function(e){const t=this.getStoredDevicesForUser(e)||[],n={};for(let e=0;e<t.length;++e){const o=t[e],r=o.getIdentityKey(),i=await this._olmDevice.getSessionInfoForDevice(r);n[o.deviceId]={deviceIdKey:r,sessions:i}}return n},D.prototype.getEventSenderDeviceInfo=function(e){const t=e.getSenderKey(),n=e.getWireContent().algorithm;if(!t||!n)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;const o=this._deviceList.getDeviceByIdentityKey(n,t);if(null===o)return null;const r=e.getClaimedEd25519Key();return r?r!==o.getFingerprint()?(c.logger.warn("Event "+e.getId()+" claims ed25519 key "+r+"but sender device has key "+o.getFingerprint()),null):o:(c.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},D.prototype.forceDiscardSession=function(e){const t=this._roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()},D.prototype.setRoomEncryption=async function(e,t,n){if(!t.algorithm)return void c.logger.log("Ignoring setRoomEncryption with no algorithm");const o=this._roomList.getRoomEncryption(e);if(o&&JSON.stringify(o)!=JSON.stringify(t))return void c.logger.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this._roomEncryptors[e])return;let r=null;o||(r=this._roomList.setRoomEncryption(e,t));const i=f.ENCRYPTION_CLASSES[t.algorithm];if(!i)throw new Error("Unable to encrypt with "+t.algorithm);const s=new i({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e,config:t});this._roomEncryptors[e]=s,r&&await r,this._lazyLoadMembers?c.logger.log("Enabling encryption in "+e):(c.logger.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),this.inhibitDeviceQuery||this._deviceList.refreshOutdatedDeviceLists())},D.prototype.trackRoomDevices=function(e){const t=async()=>{if(!this._roomEncryptors[e])return;const t=this._clientStore.getRoom(e);if(!t)throw new Error(`Unable to start tracking devices in unknown room ${e}`);c.logger.log(`Starting to track devices for room ${e} ...`),(await t.getEncryptionTargetMembers()).forEach(e=>{this._deviceList.startTrackingDeviceList(e.userId)})};let n=this._roomDeviceTrackingState[e];return n||(n=t(),this._roomDeviceTrackingState[e]=n),n},D.prototype.ensureOlmSessionsForUsers=function(e){const t={};for(let n=0;n<e.length;++n){const o=e[n];t[o]=[];const r=this.getStoredDevicesForUser(o)||[];for(let e=0;e<r.length;++e){const n=r[e];n.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(n.verified!=k.BLOCKED&&t[o].push(n))}}return d.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},D.prototype.exportRoomKeys=async function(){const e=[];return await this._cryptoStore.doTxn("readonly",[_.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],t=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(t,t=>{if(null===t)return;const n=this._olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete n.first_known_index,n.algorithm=d.MEGOLM_ALGORITHM,e.push(n)})}),e},D.prototype.importRoomKeys=function(e){return Promise.all(e.map(e=>{if(!e.room_id||!e.algorithm)return c.logger.warn("ignoring room key entry with missing fields",e),null;return this._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e)}))},D.prototype.scheduleKeyBackupSend=async function(e=1e4){if(!this._sendingBackups){this._sendingBackups=!0;try{const t=Math.random()*e;await(0,u.sleep)(t);let n=0;for(;;){if(!this.backupKey)return;try{if(0===await this._backupPendingKeys(200))return;n=0}catch(e){if(n++,c.logger.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.emit("crypto.keyBackupFailed",e.data.errcode),e}n&&await(0,u.sleep)(1e3*Math.pow(2,Math.min(n-1,4)))}}finally{this._sendingBackups=!1}}},D.prototype._backupPendingKeys=async function(e){const t=await this._cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let n=await this._cryptoStore.countSessionsNeedingBackup();this.emit("crypto.keyBackupSessionsRemaining",n);const o={};for(const e of t){const t=e.sessionData.room_id;void 0===o[t]&&(o[t]={sessions:{}});const n=await this._olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);n.algorithm=d.MEGOLM_ALGORITHM,delete n.session_id,delete n.room_id;const r=n.first_known_index;delete n.first_known_index;const i=this.backupKey.encrypt(JSON.stringify(n)),s=(n.forwarding_curve25519_key_chain||[]).length,a=this._deviceList.getDeviceByIdentityKey(d.MEGOLM_ALGORITHM,e.senderKey);o[t].sessions[e.sessionId]={first_message_index:r,forwarded_count:s,is_verified:!(!a||!a.isVerified()),session_data:i}}return await this._baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:o}),await this._cryptoStore.unmarkSessionsNeedingBackup(t),n=await this._cryptoStore.countSessionsNeedingBackup(),this.emit("crypto.keyBackupSessionsRemaining",n),t.length},D.prototype.backupGroupSession=async function(e,t,n,o,r,i,s){if(!this.backupInfo)throw new Error("Key backups are not enabled");await this._cryptoStore.markSessionsNeedingBackup([{senderKey:t,sessionId:o}]),this.scheduleKeyBackupSend()},D.prototype.scheduleAllGroupSessionsForBackup=async function(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)},D.prototype.flagAllGroupSessionsForBackup=async function(){await this._cryptoStore.doTxn("readwrite",[_.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,_.IndexedDBCryptoStore.STORE_BACKUP],e=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(e,t=>{null!==t&&this._cryptoStore.markSessionsNeedingBackup([t],e)})});const e=await this._cryptoStore.countSessionsNeedingBackup();return this.emit("crypto.keyBackupSessionsRemaining",e),e},D.prototype.encryptEvent=async function(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const n=e.getRoomId(),o=this._roomEncryptors[n];if(!o)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this._roomDeviceTrackingState[n]||this.trackRoomDevices(n),await this._roomDeviceTrackingState[n];let r=e.getContent();const i=r["m.relates_to"];i&&delete(r=Object.assign({},r))["m.relates_to"];const s=await o.encryptMessage(t,e.getType(),r);i&&(s["m.relates_to"]=i),e.makeEncrypted("m.room.encrypted",s,this._olmDevice.deviceCurve25519Key,this._olmDevice.deviceEd25519Key)},D.prototype.decryptEvent=function(e){if(e.isRedacted())return Promise.resolve({clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{}}});const t=e.getWireContent();return this._getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)},D.prototype.handleDeviceListChanges=async function(e,t){e.oldSyncToken&&await this._evalDeviceListChanges(t)},D.prototype.requestRoomKey=function(e,t,n=!1){return this._outgoingRoomKeyRequestManager.sendRoomKeyRequest(e,t,n).catch(e=>{c.logger.error("Error requesting key for event",e)})},D.prototype.cancelRoomKeyRequest=function(e){this._outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(e=>{c.logger.warn("Error clearing pending room key requests",e)})},D.prototype.onCryptoEvent=async function(e){const t=e.getRoomId(),n=e.getContent();try{await this.setRoomEncryption(t,n,!0)}catch(e){c.logger.error("Error configuring encryption in room "+t+":",e)}},D.prototype.onSyncWillProcess=async function(e){e.oldSyncToken||(c.logger.log("Initial sync performed - resetting device tracking state"),this._deviceList.stopTrackingAllDeviceLists(),this._deviceList.startTrackingDeviceList(this._userId),this._roomDeviceTrackingState={})},D.prototype.onSyncCompleted=async function(e){const t=e.nextSyncToken;this._deviceList.setSyncToken(e.nextSyncToken),this._deviceList.saveIfDirty(),this._deviceList.lastKnownSyncToken=t,this._deviceList.startTrackingDeviceList(this._userId),this._deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(A(this),this._processReceivedRoomKeyRequests())},D.prototype._evalDeviceListChanges=async function(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach(e=>{this._deviceList.invalidateUserDeviceList(e)}),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this._getTrackedE2eUsers());e.left.forEach(e=>{t.has(e)||this._deviceList.stopTrackingDeviceList(e)})}},D.prototype._getTrackedE2eUsers=async function(){const e=[];for(const t of this._getTrackedE2eRooms()){const n=await t.getEncryptionTargetMembers();for(const t of n)e.push(t.userId)}return e},D.prototype._getTrackedE2eRooms=function(){return this._clientStore.getRooms().filter(e=>{if(!this._roomEncryptors[e.roomId])return!1;if(!this._roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t})},D.prototype._onToDeviceEvent=function(e){try{c.logger.log(`received to_device ${e.getType()} from: `+`${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this._onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this._onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this._secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this._secretStorage._onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this._onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this._onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this._onToDeviceBadEncrypted(e):e.isBeingDecrypted()&&e.once("Event.decrypted",e=>{this._onToDeviceEvent(e)})}catch(e){c.logger.error("Error handling toDeviceEvent:",e)}},D.prototype._onRoomKeyEvent=function(e){const t=e.getContent();t.room_id&&t.algorithm?(this._checkedForBackup||this._checkAndStartKeyBackup(),this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)):c.logger.error("key event is missing fields")},D.prototype._onRoomKeyWithheldEvent=function(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void c.logger.error("key withheld event is missing fields");c.logger.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) `+`for ${t.algorithm}/${t.room_id}/${t.session_id} `+`with reason ${t.code} (${t.reason})`);const n=this._getRoomDecryptor(t.room_id,t.algorithm);if(n.onRoomKeyWithheldEvent&&n.onRoomKeyWithheldEvent(e),!t.room_id){const e=this._getRoomDecryptors(t.algorithm);for(const n of e)n.retryDecryptionFromSender(t.sender_key)}},D.prototype._onKeyVerificationMessage=function(e){if(!R.ToDeviceChannel.validateEvent(e,this._baseApis))return;const t=R.ToDeviceChannel.getTransactionId(e);this._handleVerificationEvent(e,t,this._toDeviceVerificationRequests,e=>{if(!R.ToDeviceChannel.canCreateRequest(R.ToDeviceChannel.getEventType(e)))return;const t=e.getContent(),n=t&&t.from_device;if(!n)return;const o=e.getSender(),r=new R.ToDeviceChannel(this._baseApis,o,[n]);return new w.VerificationRequest(r,this._verificationMethods,o,this._baseApis)})},D.prototype._onTimelineEvent=function(e){if(!I.InRoomChannel.validateEvent(e,this._baseApis))return;const t=I.InRoomChannel.getTransactionId(e);this._handleVerificationEvent(e,t,this._inRoomVerificationRequests,e=>{if(!I.InRoomChannel.canCreateRequest(I.InRoomChannel.getEventType(e)))return;const t=e.getSender(),n=new I.InRoomChannel(this._baseApis,e.getRoomId(),t);return new w.VerificationRequest(n,this._verificationMethods,t,this._baseApis)})},D.prototype._handleVerificationEvent=async function(e,t,n,o){const r=e.getSender();let i=n.get(r),s=!1,a=i&&i.get(t);if(!a){if(!(a=o(e)))return;s=!0,i||(i=new Map,n.set(r,i)),i.set(t,a)}try{const t=!!a.verifier;await a.channel.handleEvent(e,a),!t&&a.verifier&&this._baseApis.emit("crypto.verification.start",a.verifier)}catch(t){console.error("error while handling verification event",e,t)}a.pending?s&&!a.initiatedByMe&&this._baseApis.emit("crypto.verification.request",a):(i.delete(t),0===i.size&&n.delete(r))},D.prototype._onToDeviceBadEncrypted=async function(e){const t=e.getWireContent(),n=e.getSender(),o=t.algorithm,r=t.sender_key,i=()=>{const e=this._getRoomDecryptors(d.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(r)};if(void 0===n||void 0===r||void 0===r)return;this._lastNewSessionForced[n]=this._lastNewSessionForced[n]||{};const s=this._lastNewSessionForced[n][r]||0;if(s+36e5>Date.now())return c.logger.debug("New session already forced with device "+n+":"+r+" at "+s+": not forcing another"),await this._olmDevice.recordSessionProblem(r,"wedged",!0),void i();const a=this._deviceList.getDeviceByIdentityKey(o,r);if(!a)return c.logger.info("Couldn't find device for identity key "+r+": not re-establishing session"),await this._olmDevice.recordSessionProblem(r,"wedged",!1),void i();const u={};u[n]=[a],await d.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,u,!0),this._lastNewSessionForced[n][r]=Date.now();const l={algorithm:d.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await d.encryptMessageForDevice(l.ciphertext,this._userId,this._deviceId,this._olmDevice,n,a,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(r,"wedged",!0),i(),await this._baseApis.sendToDevice("m.room.encrypted",{[n]:{[a.deviceId]:l}});const h=await this._outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,a.deviceId);for(const e of h)this.requestRoomKey(e.requestBody,e.recipients,!0)},D.prototype._onRoomMembership=function(e,t,n){const o=t.roomId,r=this._roomEncryptors[o];r&&(this._roomDeviceTrackingState[o]&&("join"==t.membership?(c.logger.log("Join event for "+t.userId+" in "+o),this._deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this._clientStore.getRoom(o).shouldEncryptForInvitedMembers()&&(c.logger.log("Invite event for "+t.userId+" in "+o),this._deviceList.startTrackingDeviceList(t.userId))),r.onRoomMembership(e,t,n))},D.prototype._onRoomKeyRequestEvent=function(e){const t=e.getContent();if("request"===t.action){const t=new P(e);this._receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new M(e);this._receivedRoomKeyRequestCancellations.push(t)}},D.prototype._processReceivedRoomKeyRequests=async function(){if(!this._processingRoomKeyRequests){this._processingRoomKeyRequests=!0;try{const e=this._receivedRoomKeyRequests;this._receivedRoomKeyRequests=[];const t=this._receivedRoomKeyRequestCancellations;this._receivedRoomKeyRequestCancellations=[],await Promise.all(e.map(e=>this._processReceivedRoomKeyRequest(e))),await Promise.all(t.map(e=>this._processReceivedRoomKeyRequestCancellation(e)))}catch(e){c.logger.error(`Error processing room key requsts: ${e}`)}finally{this._processingRoomKeyRequests=!1}}},D.prototype._processReceivedRoomKeyRequest=async function(e){const t=e.userId,n=e.deviceId,o=e.requestBody,r=o.room_id,i=o.algorithm;if(c.logger.log(`m.room_key_request from ${t}:${n}`+` for ${r} / ${o.session_id} (id ${e.requestId})`),t!==this._userId){if(!this._roomEncryptors[r])return void c.logger.debug(`room key request for unencrypted room ${r}`);const e=this._roomEncryptors[r],i=this._deviceList.getStoredDevice(t,n);if(!i)return void c.logger.debug(`Ignoring keyshare for unknown device ${t}:${n}`);try{await e.reshareKeyWithDevice(o.sender_key,o.session_id,t,i)}catch(e){c.logger.warn("Failed to re-share keys for session "+o.session_id+" with device "+t+":"+i.deviceId,e)}return}if(!this._roomDecryptors[r])return void c.logger.log(`room key request for unencrypted room ${r}`);const s=this._roomDecryptors[r][i];if(!s)return void c.logger.log(`room key request for unknown alg ${i} in room ${r}`);if(!await s.hasKeysForKeyRequest(e))return void c.logger.log(`room key request for unknown session ${r} / `+o.session_id);e.share=()=>{s.shareKeysWithDevice(e)};const a=this._deviceList.getStoredDevice(t,n);if(a&&a.isVerified())return c.logger.log("device is already verified: sharing keys"),void e.share();this.emit("crypto.roomKeyRequest",e)},D.prototype._processReceivedRoomKeyRequestCancellation=async function(e){c.logger.log(`m.room_key_request cancellation for ${e.userId}:`+`${e.deviceId} (id ${e.requestId})`),this.emit("crypto.roomKeyRequestCancellation",e)},D.prototype._getRoomDecryptor=function(e,t){let n,o;if((e=e||null)&&((n=this._roomDecryptors[e])||(this._roomDecryptors[e]=n={}),o=n[t]))return o;const r=f.DECRYPTION_CLASSES[t];if(!r)throw new f.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return o=new r({userId:this._userId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e}),n&&(n[t]=o),o},D.prototype._getRoomDecryptors=function(e){const t=[];for(const n of Object.values(this._roomDecryptors))e in n&&t.push(n[e]);return t},D.prototype._signObject=async function(e){const t=e.signatures||{},n=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=await this._olmDevice.sign(i.default.stringify(e)),e.signatures=t,void 0!==n&&(e.unsigned=n)};class P{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class M{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,n(3))},function(e,t,n){"use strict";var o=n(1),r=n(0),i=o(n(2)),s=o(n(7)),a=n(14),c=n(25);const u=a.DeviceInfo.DeviceVerification;function l(e){(0,i.polyfillSuper)(this,c.EncryptionAlgorithm,e),this._sessionPrepared=!1,this._prepPromise=null}function d(e){(0,i.polyfillSuper)(this,c.DecryptionAlgorithm,e)}i.inherits(l,c.EncryptionAlgorithm),l.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return Promise.resolve();const t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(n){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},l.prototype.encryptMessage=async function(e,t,n){const o=await e.getEncryptionTargetMembers(),r=i.map(o,(function(e){return e.userId})),a=this;await this._ensureSession(r);const c={room_id:e.roomId,type:t,content:n},l={algorithm:s.OLM_ALGORITHM,sender_key:a._olmDevice.deviceCurve25519Key,ciphertext:{}},d=[];for(let e=0;e<r.length;++e){const t=r[e],n=a._crypto.getStoredDevicesForUser(t);for(let e=0;e<n.length;++e){const o=n[e];o.getIdentityKey()!=a._olmDevice.deviceCurve25519Key&&(o.verified!=u.BLOCKED&&d.push(s.encryptMessageForDevice(l.ciphertext,a._userId,a._deviceId,a._olmDevice,t,o,c)))}}return await Promise.all(d).then(()=>l)},i.inherits(d,c.DecryptionAlgorithm),d.prototype.decryptEvent=async function(e){const t=e.getWireContent(),n=t.sender_key,o=t.ciphertext;if(!o)throw new c.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this._olmDevice.deviceCurve25519Key in o))throw new c.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const r=o[this._olmDevice.deviceCurve25519Key];let i;try{i=await this._decryptMessage(n,r)}catch(e){throw new c.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:e})}const s=JSON.parse(i);if(s.recipient!=this._userId)throw new c.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+s.recipient);if(s.recipient_keys.ed25519!=this._olmDevice.deviceEd25519Key)throw new c.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:s.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});if(s.sender!=e.getSender())throw new c.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+s.sender,{reported_sender:e.getSender()});if(s.room_id!==e.getRoomId())throw new c.DecryptionError("OLM_BAD_ROOM","Message intended for room "+s.room_id,{reported_room:e.room_id});return{clearEvent:s,senderCurve25519Key:n,claimedEd25519Key:(s.keys||{}).ed25519||null}},d.prototype._decryptMessage=async function(e,t){const n=await this._olmDevice.getSessionIdsForDevice(e),o={};for(let i=0;i<n.length;i++){const s=n[i];try{const n=await this._olmDevice.decryptMessage(e,s,t.type,t.body);return r.logger.log("Decrypted Olm message from "+e+" with session "+s),n}catch(n){if(await this._olmDevice.matchesSession(e,s,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+s+": "+n.message);o[s]=n.message}}if(0!==t.type){if(0===n.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(o))}let i;try{i=await this._olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw o["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(o))}return r.logger.log("created new inbound Olm session ID "+i.session_id+" with "+e),i.payload},(0,c.registerAlgorithm)(s.OLM_ALGORITHM,l,d)},function(e,t,n){"use strict";var o=n(1),r=n(0),i=o(n(2)),s=o(n(7)),a=n(25),c=n(40);function u(e){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={},this.blockedDevicesNotified={}}function l(e){(0,i.polyfillSuper)(this,a.EncryptionAlgorithm,e),this._setupPromise=Promise.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function d(e){(0,i.polyfillSuper)(this,a.DecryptionAlgorithm,e),this._pendingEvents={},this.olmlib=s}u.prototype.needsRotation=function(e,t){const n=(new Date).getTime()-this.creationTime;return(this.useCount>=e||n>=t)&&(r.logger.log("Rotating megolm session after "+this.useCount+" messages, "+n+"ms"),!0)},u.prototype.markSharedWithDevice=function(e,t,n){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=n},u.prototype.markNotifiedBlockedDevice=function(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0},u.prototype.sharedWithTooManyDevices=function(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return r.logger.log("Starting new megolm session because we shared with "+t),!0;for(const n in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(n)&&!e[t].hasOwnProperty(n))return r.logger.log("Starting new megolm session because we shared with "+t+":"+n),!0}},i.inherits(l,a.EncryptionAlgorithm),l.prototype._ensureOutboundSession=async function(e,t){const n=this;let o;function i(){return o}const s=this._setupPromise.then((async function(i){(o=i)&&o.needsRotation(n._sessionRotationPeriodMsgs,n._sessionRotationPeriodMs)&&(r.logger.log("Starting new megolm session because we need to rotate."),o=null),o&&o.sharedWithTooManyDevices(e)&&(o=null),o||(r.logger.log(`Starting new megolm session for room ${n._roomId}`),o=await n._prepareNewSession(),r.logger.log(`Started new megolm session ${o.sessionId} `+`for room ${n._roomId}`),n._outboundSessions[o.sessionId]=o);const s={};for(const t in e){if(!e.hasOwnProperty(t))continue;const r=e[t];for(const e in r){if(!r.hasOwnProperty(e))continue;const i=r[e];i.getIdentityKey()!=n._olmDevice.deviceCurve25519Key&&(o.sharedWithDevices[t]&&void 0!==o.sharedWithDevices[t][e]||(s[t]=s[t]||[],s[t].push(i)))}}const a=[];await n._shareKeyWithDevices(o,s,a);const u={};for(const e in t){if(!t.hasOwnProperty(e))continue;const n=t[e];for(const t in n)n.hasOwnProperty(t)&&(o.blockedDevicesNotified[e]&&void 0!==o.blockedDevicesNotified[e][t]||(u[e]=u[e]||[],u[e].push(n[t])))}const l=await n._olmDevice.filterOutNotifiedErrorDevices(a);for(const{userId:e,deviceInfo:t}of l)u[e]=u[e]||[],u[e].push({code:"m.no_olm",reason:c.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:t});await n._notifyBlockedDevices(o,u)}));return this._setupPromise=s.then(i,i),s.then(i)},l.prototype._prepareNewSession=async function(){const e=this._olmDevice.createOutboundGroupSession(),t=this._olmDevice.getOutboundGroupSessionKey(e);return await this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key,{ed25519:this._olmDevice.deviceEd25519Key}),this._crypto.backupInfo&&this._crypto.backupGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key).catch(e=>{r.logger.log("Failed to back up megolm session",e)}),new u(e)},l.prototype._splitUserDeviceMap=function(e,t,n,o,i){const s=[];let a=0,c=0;for(const u of Object.keys(o)){const l=o[u],d=n[u];for(let n=0;n<l.length;n++){const o=l[n],h=o.deviceId;d[h].sessionId?(r.logger.log("share keys with device "+u+":"+h),s[a]||(s[a]=[]),s[a].push({userId:u,deviceInfo:o}),c++):(e.markSharedWithDevice(u,h,t),i.push({userId:u,deviceInfo:o}))}c>20&&(c=0,a++)}return s},l.prototype._splitBlockedDevices=function(e){let t=[];const n=[t];for(const o of Object.keys(e)){const r=e[o];for(const e of r)t.push({userId:o,blockedInfo:e});t.length>20&&(t=[],n.push(t))}return 0===t.length&&n.pop(),n},l.prototype._encryptAndSendKeysToDevices=function(e,t,n,o){const r={},i=[];for(let e=0;e<n.length;e++){const t={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},a=n[e],c=a.userId,u=a.deviceInfo,l=u.deviceId;r[c]||(r[c]={}),r[c][l]=t,i.push(s.encryptMessageForDevice(t.ciphertext,this._userId,this._deviceId,this._olmDevice,c,u,o))}return Promise.all(i).then(()=>this._baseApis.sendToDevice("m.room.encrypted",r).then(()=>{for(const n of Object.keys(r))for(const o of Object.keys(r[n]))e.markSharedWithDevice(n,o,t)}))},l.prototype._sendBlockedNotificationsToDevices=async function(e,t,n){const o={};for(const e of t){const t=e.userId,r=e.blockedInfo,i=r.deviceInfo.deviceId,s=Object.assign({},n);s.code=r.code,s.reason=r.reason,"m.no_olm"===s.code&&(delete s.room_id,delete s.session_id),o[t]||(o[t]={}),o[t][i]=s}await this._baseApis.sendToDevice("org.matrix.room_key.withheld",o);for(const t of Object.keys(o))for(const n of Object.keys(o[t]))e.markNotifiedBlockedDevice(t,n)},l.prototype.reshareKeyWithDevice=async function(e,t,n,o){const i=this._outboundSessions[t];if(!i)return void r.logger.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===i.sharedWithDevices[n])return void r.logger.debug(`megolm session ${t} never shared with user ${n}`);const a=i.sharedWithDevices[n][o.deviceId];if(void 0===a)return void r.logger.debug("megolm session ID "+t+" never shared with device "+n+":"+o.deviceId);const c=await this._olmDevice.getInboundGroupSessionKey(this._roomId,e,t,a);if(!c)return void r.logger.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[n]:{[o.deviceId]:o}});const u={type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain}},l={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(l.ciphertext,this._userId,this._deviceId,this._olmDevice,n,o,u),await this._baseApis.sendToDevice("m.room.encrypted",{[n]:{[o.deviceId]:l}}),r.logger.debug(`Re-shared key for megolm session ${t} `+`with ${n}:${o.deviceId}`)},l.prototype._shareKeyWithDevices=async function(e,t,n){const o=this._olmDevice.getOutboundGroupSessionKey(e.sessionId),i={type:"m.room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:e.sessionId,session_key:o.key,chain_index:o.chain_index}},a=await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t),c=this._splitUserDeviceMap(e,o.chain_index,a,t,n);for(let t=0;t<c.length;t++)try{await this._encryptAndSendKeysToDevices(e,o.chain_index,c[t],i),r.logger.log(`Completed megolm keyshare for ${e.sessionId} `+`in ${this._roomId} (slice ${t+1}/${c.length})`)}catch(n){throw r.logger.log(`megolm keyshare for ${e.sessionId} in ${this._roomId} `+`(slice ${t+1}/${c.length}) failed`),n}},l.prototype._notifyBlockedDevices=async function(e,t){const n={room_id:this._roomId,session_id:e.sessionId,algorithm:s.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key},o=this._splitBlockedDevices(t);for(let t=0;t<o.length;t++)try{await this._sendBlockedNotificationsToDevices(e,o[t],n),r.logger.log(`Completed blacklist notification for ${e.sessionId} `+`in ${this._roomId} (slice ${t+1}/${o.length})`)}catch(n){throw r.logger.log(`blacklist notification for ${e.sessionId} in `+`${this._roomId} (slice ${t+1}/${o.length}) failed`),n}},l.prototype.encryptMessage=async function(e,t,n){const o=this;r.logger.log(`Starting to encrypt event for ${this._roomId}`);const[i,a]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&o._checkForUnknownDevices(i);const c=await o._ensureOutboundSession(i,a),u={room_id:o._roomId,type:t,content:n},l=o._olmDevice.encryptGroupMessage(c.sessionId,JSON.stringify(u)),d={algorithm:s.MEGOLM_ALGORITHM,sender_key:o._olmDevice.deviceCurve25519Key,ciphertext:l,session_id:c.sessionId,device_id:o._deviceId};return c.useCount++,d},l.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then(()=>null)},l.prototype._checkForUnknownDevices=function(e){const t={};if(Object.keys(e).forEach(n=>{Object.keys(e[n]).forEach(o=>{const r=e[n][o];r.isUnverified()&&!r.isKnown()&&(t[n]||(t[n]={}),t[n][o]=r)})}),Object.keys(t).length)throw new a.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},l.prototype._getDevicesInRoom=async function(e){const t=await e.getEncryptionTargetMembers(),n=i.map(t,(function(e){return e.userId}));let o=this._crypto.getGlobalBlacklistUnverifiedDevices();"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(o=e.getBlacklistUnverifiedDevices());const r=await this._crypto.downloadKeys(n,!1),s={};for(const e in r){if(!r.hasOwnProperty(e))continue;const t=r[e];for(const n in t)if(t.hasOwnProperty(n)&&(t[n].isBlocked()||t[n].isUnverified()&&o)){s[e]||(s[e]={});const o=t[n].isBlocked()?{code:"m.blacklisted",reason:c.WITHHELD_MESSAGES["m.blacklisted"]}:{code:"m.unverified",reason:c.WITHHELD_MESSAGES["m.unverified"]};o.deviceInfo=t[n],s[e][n]=o,delete t[n]}}return[r,s]},i.inherits(d,a.DecryptionAlgorithm);const h={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};d.prototype.decryptEvent=async function(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new a.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");let n;this._addEventToPendingList(e);try{n=await this._olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(n){if("DecryptionError"===n.name)throw n;let o="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw n&&"OLM.UNKNOWN_MESSAGE_INDEX"===n.message&&(this._requestKeysForEvent(e),o="OLM_UNKNOWN_MESSAGE_INDEX"),new a.DecryptionError(o,n?n.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===n){this._requestKeysForEvent(e);const n=await this._olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(n){let e=h[n.type]||h.unknown;throw n.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this._removeEventFromPendingList(e);const o=JSON.parse(n.result);if(o.room_id!==e.getRoomId())throw new a.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+o.room_id);return{clearEvent:o,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain}},d.prototype._requestKeysForEvent=function(e){const t=e.getWireContent(),n=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},n)},d.prototype._addEventToPendingList=function(e){const t=e.getWireContent(),n=t.sender_key,o=t.session_id;this._pendingEvents[n]||(this._pendingEvents[n]=new Map);const r=this._pendingEvents[n];r.has(o)||r.set(o,new Set),r.get(o).add(e)},d.prototype._removeEventFromPendingList=function(e){const t=e.getWireContent(),n=t.sender_key,o=t.session_id,r=this._pendingEvents[n],i=r&&r.get(o);i&&(i.delete(e),0===i.size&&r.delete(n),0===r.size&&delete this._pendingEvents[n])},d.prototype.onRoomKeyEvent=function(e){const t=e.getContent(),n=t.session_id;let o,s=e.getSenderKey(),a=[],c=!1;if(t.room_id&&n&&t.session_key){if(s){if("m.forwarded_room_key"==e.getType()){if(c=!0,a=t.forwarding_curve25519_key_chain,i.isArray(a)||(a=[]),(a=a.slice()).push(s),!(s=t.sender_key))return void r.logger.error("forwarded_room_key event is missing sender_key field");const e=t.sender_claimed_ed25519_key;if(!e)return void r.logger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");o={ed25519:e}}else o=e.getKeysClaimed();return r.logger.log(`Received and adding key for megolm session ${s}|${n}`),this._olmDevice.addInboundGroupSession(t.room_id,s,a,n,t.session_key,o,c).then(()=>{this._retryDecryption(s,n).then(e=>{e&&this._crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:s})})}).then(()=>{this._crypto.backupInfo&&this._crypto.backupGroupSession(t.room_id,s,a,t.session_id,t.session_key,o,c).catch(e=>{r.logger.log("Failed to back up megolm session",e)})}).catch(e=>{r.logger.error(`Error handling m.room_key_event: ${e}`)})}r.logger.error("key event has no sender key (not encrypted?)")}else r.logger.error("key event is missing fields")},d.prototype.onRoomKeyWithheldEvent=async function(e){const t=e.getContent(),n=t.sender_key;if("m.no_olm"===t.code){const o=e.getSender();if(await this._olmDevice.getSessionIdForDevice(n))return await this._olmDevice.recordSessionProblem(n,"no_olm",!0),void this.retryDecryptionFromSender(n);const i=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,n);if(!i)return r.logger.info("Couldn't find device for identity key "+n+": not establishing session"),await this._olmDevice.recordSessionProblem(n,"no_olm",!1),void this.retryDecryptionFromSender(n);await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[o]:[i]},!1);const a={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(a.ciphertext,this._userId,this._deviceId,this._olmDevice,o,i,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(n,"no_olm",!0),this.retryDecryptionFromSender(n),await this._baseApis.sendToDevice("m.room.encrypted",{[o]:{[i.deviceId]:a}})}else await this._olmDevice.addInboundGroupSessionWithheld(t.room_id,n,t.session_id,t.code,t.reason)},d.prototype.hasKeysForKeyRequest=function(e){const t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},d.prototype.shareKeysWithDevice=function(e){const t=e.userId,n=e.deviceId,o=this._crypto.getStoredDevice(t,n),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[t]:[o]}).then(e=>{return e[t][n].sessionId?(r.logger.log("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+t+":"+n),this._buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null}).then(e=>{const r={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(r.ciphertext,this._userId,this._deviceId,this._olmDevice,t,o,e).then(()=>{const e={[t]:{[n]:r}};return this._baseApis.sendToDevice("m.room.encrypted",e)})})},d.prototype._buildKeyForwardingMessage=async function(e,t,n){const o=await this._olmDevice.getInboundGroupSessionKey(e,t,n);return{type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:o.sender_claimed_ed25519_key,session_id:n,session_key:o.key,chain_index:o.chain_index,forwarding_curve25519_key_chain:o.forwarding_curve25519_key_chain}}},d.prototype.importRoomKey=function(e){return this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).then(()=>{this._crypto.backupInfo&&this._crypto.backupGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).catch(e=>{r.logger.log("Failed to back up megolm session",e)}),this._retryDecryption(e.sender_key,e.session_id)})},d.prototype._retryDecryption=async function(e,t){const n=this._pendingEvents[e];if(!n)return!0;const o=n.get(t);return!o||(o.delete(t),0===o.size&&this._pendingEvents[e],await Promise.all([...o].map(async e=>{try{await e.attemptDecryption(this._crypto)}catch(e){}})),!(this._pendingEvents[e]||{})[t])},d.prototype.retryDecryptionFromSender=async function(e){const t=this._pendingEvents[e];return r.logger.warn(t),!t||(delete this._pendingEvents[e],await Promise.all([...t].map(async([e,t])=>{await Promise.all([...t].map(async e=>{try{r.logger.warn(e.getId()),await e.attemptDecryption(this._crypto)}catch(e){}}))})),!this._pendingEvents[e])},(0,a.registerAlgorithm)(s.MEGOLM_ALGORITHM,l,d)},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceList=void 0;var r=n(4),i=n(0),s=n(14),a=n(42),c=o(n(7)),u=n(9),l=n(2);const d=0,h=1,p=2,f=3;class g extends r.EventEmitter{constructor(e,t,n){super(),this._cryptoStore=t,this._devices={},this._crossSigningInfo={},this._userByIdentityKey={},this._deviceTrackingStatus={},this._syncToken=null,this._serialiser=new m(e,n,this),this._keyDownloadsInProgressByUser={},this._dirty=!1,this._savePromise=null,this._resolveSavePromise=null,this._savePromiseTime=null,this._saveTimer=null}async load(){await this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_DEVICE_DATA],e=>{this._cryptoStore.getEndToEndDeviceData(e,e=>{this._devices=e?e.devices:{},this._crossSigningInfo=e&&e.crossSigningInfo||{},this._deviceTrackingStatus=e?e.trackingStatus:{},this._syncToken=e?e.syncToken:null,this._userByIdentityKey={};for(const e of Object.keys(this._devices)){const t=this._devices[e];for(const n of Object.keys(t)){const o=t[n].keys["curve25519:"+n];void 0!==o&&(this._userByIdentityKey[o]=e)}}})});for(const e of Object.keys(this._deviceTrackingStatus))this._deviceTrackingStatus[e]==p&&(this._deviceTrackingStatus[e]=h)}stop(){null!==this._saveTimer&&clearTimeout(this._saveTimer)}async saveIfDirty(e){if(!this._dirty)return Promise.resolve(!1);void 0===e&&(e=500);const t=Date.now+e;this._savePromiseTime&&t<this._savePromiseTime&&(clearTimeout(this._saveTimer),this._saveTimer=null,this._savePromiseTime=null);let n=this._savePromise;if(null===n&&(n=new Promise((e,t)=>{this._resolveSavePromise=e}),this._savePromise=n),null===this._saveTimer){const n=this._resolveSavePromise;this._savePromiseTime=t,this._saveTimer=setTimeout(()=>{i.logger.log("Saving device tracking data at token "+this._syncToken),this._savePromiseTime=null,this._saveTimer=null,this._savePromise=null,this._resolveSavePromise=null,this._dirty=!1,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_DEVICE_DATA],e=>{this._cryptoStore.storeEndToEndDeviceData({devices:this._devices,crossSigningInfo:this._crossSigningInfo,trackingStatus:this._deviceTrackingStatus,syncToken:this._syncToken},e)}).then(()=>{n()})},e)}return n}getSyncToken(){return this._syncToken}setSyncToken(e){this._syncToken=e}downloadKeys(e,t){const n=[],o=[];if(e.forEach(e=>{const r=this._deviceTrackingStatus[e];this._keyDownloadsInProgressByUser[e]?(i.logger.log("downloadKeys: already have a download in progress for "+`${e}: awaiting its result`),o.push(this._keyDownloadsInProgressByUser[e])):(t||r!=f)&&n.push(e)}),0!=n.length){i.logger.log("downloadKeys: downloading for",n);const e=this._doKeyDownload(n);o.push(e)}return 0===o.length&&i.logger.log("downloadKeys: already have all necessary keys"),Promise.all(o).then(()=>this._getDevicesFromStore(e))}_getDevicesFromStore(e){const t={},n=this;return e.map((function(e){t[e]={},(n.getStoredDevicesForUser(e)||[]).map((function(n){t[e][n.deviceId]=n}))})),t}getStoredDevicesForUser(e){const t=this._devices[e];if(!t)return null;const n=[];for(const e in t)t.hasOwnProperty(e)&&n.push(s.DeviceInfo.fromStorage(t[e],e));return n}getRawStoredDevicesForUser(e){return this._devices[e]}getStoredCrossSigningForUser(e){return this._crossSigningInfo[e]?a.CrossSigningInfo.fromStorage(this._crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this._crossSigningInfo[e]=t,this._dirty=!0}getStoredDevice(e,t){const n=this._devices[e];if(n&&n[t])return s.DeviceInfo.fromStorage(n[t],t)}getDeviceByIdentityKey(e,t){const n=this._userByIdentityKey[t];if(!n)return null;if(e!==c.OLM_ALGORITHM&&e!==c.MEGOLM_ALGORITHM)return null;const o=this._devices[n];if(!o)return null;for(const e in o){if(!o.hasOwnProperty(e))continue;const n=o[e];for(const o in n.keys){if(!n.keys.hasOwnProperty(o))continue;if(0!==o.indexOf("curve25519:"))continue;if(n.keys[o]==t)return s.DeviceInfo.fromStorage(n,e)}}return null}storeDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[t,n]of Object.entries(this._devices[e])){const e=n.keys["curve25519:"+t];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[n,o]of Object.entries(t)){const t=o.keys["curve25519:"+n];this._userByIdentityKey[t]=e}this._dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(i.logger.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=h,this._dirty=!0)}stopTrackingDeviceList(e){this._deviceTrackingStatus[e]&&(i.logger.log("No longer tracking device list for "+e),this._deviceTrackingStatus[e]=d,this._dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this._deviceTrackingStatus))this._deviceTrackingStatus[e]=d;this._dirty=!0}invalidateUserDeviceList(e){this._deviceTrackingStatus[e]&&(i.logger.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=h,this._dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this._deviceTrackingStatus)){this._deviceTrackingStatus[t]==h&&e.push(t)}return this._doKeyDownload(e)}_setRawStoredDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[t,n]of Object.entries(this._devices[e])){const e=n.keys["curve25519:"+t];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[n,o]of Object.entries(t)){const t=o.keys["curve25519:"+n];this._userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this._crossSigningInfo[e]=t}_doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this._serialiser.updateDevicesForUsers(e,this._syncToken).then(()=>{n(!0)},t=>{throw i.logger.error("Error downloading keys for "+e+":",t),n(!1),t});e.forEach(e=>{this._keyDownloadsInProgressByUser[e]=t,this._deviceTrackingStatus[e]==h&&(this._deviceTrackingStatus[e]=p)});const n=n=>{e.forEach(e=>{if(this._dirty=!0,this._keyDownloadsInProgressByUser[e]!==t)return void i.logger.log("Another update in the queue for",e,"- not marking up-to-date");delete this._keyDownloadsInProgressByUser[e],this._deviceTrackingStatus[e]==p&&(n?(this._deviceTrackingStatus[e]=f,i.logger.log("Device list for",e,"now up to date")):this._deviceTrackingStatus[e]=h)}),this.saveIfDirty(),this.emit("crypto.devicesUpdated",e)};return t}}t.DeviceList=g;class m{constructor(e,t,n){this._baseApis=e,this._olmDevice=t,this._deviceList=n,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._syncToken=null}updateDevicesForUsers(e,t){return e.forEach(e=>{this._keyDownloadsQueuedByUser[e]=!0}),this._queuedQueryDeferred||(this._queuedQueryDeferred=(0,l.defer)()),this._syncToken=t,this._downloadInProgress?(i.logger.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}_doQueuedQueries(){if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");const e=Object.keys(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};const t=this._queuedQueryDeferred;this._queuedQueryDeferred=null,i.logger.log("Starting key download for",e),this._downloadInProgress=!0;const n={};return this._syncToken&&(n.token=this._syncToken),this._baseApis.downloadKeysForUsers(e,n).then(t=>{const n=t.device_keys||{},o=t.master_keys||{},r=t.self_signing_keys||{},i=t.user_signing_keys||{};let s=Promise.resolve();for(const t of e)s=s.then((0,l.sleep)(5)).then(()=>this._processQueryResponseForUser(t,n[t],{master:o[t],self_signing:r[t],user_signing:i[t]}));return s}).then(()=>{i.logger.log("Completed key download for "+e),this._downloadInProgress=!1,t.resolve(),this._queuedQueryDeferred&&this._doQueuedQueries()},n=>{i.logger.warn("Error downloading keys for "+e+":",n),this._downloadInProgress=!1,t.reject(n)}),t.promise}async _processQueryResponseForUser(e,t,n,o){i.logger.log("got device keys for "+e+":",t),i.logger.log("got cross-signing keys for "+e+":",n);{const n={},o=this._deviceList.getRawStoredDevicesForUser(e);o&&Object.keys(o).forEach(e=>{const t=s.DeviceInfo.fromStorage(o[e],e);n[e]=t}),await async function(e,t,n,o){let r=!1;for(const e in n)n.hasOwnProperty(e)&&(e in o||(i.logger.log("Device "+t+":"+e+" has been removed"),delete n[e],r=!0));for(const s in o){if(!o.hasOwnProperty(s))continue;const a=o[s];a.user_id===t?a.device_id===s?await y(e,n,a)&&(r=!0):i.logger.warn("Mismatched device_id "+a.device_id+" in keys from "+t+":"+s):i.logger.warn("Mismatched user_id "+a.user_id+" in keys from "+t+":"+s)}return r}(this._olmDevice,e,n,t||{});const r={};Object.keys(n).forEach(e=>{r[e]=n[e].toStorage()}),this._deviceList._setRawStoredDevicesForUser(e,r)}if(n&&(n.master||n.self_signing||n.user_signing)){const t=this._deviceList.getStoredCrossSigningForUser(e)||new a.CrossSigningInfo(e);t.setKeys(n),this._deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this._deviceList.emit("userCrossSigningUpdated",e)}}}async function y(e,t,n){if(!n.keys)return!1;const o=n.device_id,r=n.user_id,a="ed25519:"+o,u=n.keys[a];if(!u)return i.logger.warn("Device "+r+":"+o+" has no ed25519 key"),!1;const l=n.unsigned||{},d=n.signatures||{};try{await c.verifySignature(e,n,r,o,u)}catch(e){return i.logger.warn("Unable to verify signature on device "+r+":"+o+":"+e),!1}let h;if(o in t){if((h=t[o]).getFingerprint()!=u)return i.logger.warn("Ed25519 key for device "+r+":"+o+" has changed"),!1}else t[o]=h=new s.DeviceInfo(o);return h.keys=n.keys||{},h.algorithms=n.algorithms||[],h.unsigned=l,h.signatures=d,!0}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.SecretStorage=t.SECRET_STORAGE_ALGORITHM_V1=void 0;var r=n(4),i=n(0),s=o(n(7)),a=n(15);const c="m.secret_storage.v1.curve25519-aes-sha2";t.SECRET_STORAGE_ALGORITHM_V1=c;class u extends r.EventEmitter{constructor(e,t,n){super(),this._baseApis=e,this._cryptoCallbacks=t,this._crossSigningInfo=n,this._requests={},this._incomingRequests={}}async getDefaultKeyId(){const e=await this._baseApis.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(t=>{const n=o=>{"m.secret_storage.default_key"===o.getType()&&o.getContent().key===e&&(this._baseApis.removeListener("accountData",n),t())};this._baseApis.on("accountData",n),this._baseApis.setAccountData("m.secret_storage.default_key",{key:e})})}async addKey(t,n,o){const r={algorithm:t};switch(n||(n={}),n.name&&(r.name=n.name),t){case c:{const t=new e.Olm.PkDecryption;try{const{passphrase:e,pubkey:o}=n;e&&o?(r.passphrase=e,r.pubkey=o):r.pubkey=o||t.generate_key()}finally{t.free()}break}default:throw new Error(`Unknown key algorithm ${n.algorithm}`)}if(!o)do{o=(0,a.randomString)(32)}while(await this._baseApis.getAccountDataFromServer(`m.secret_storage.key.${o}`));return await this._crossSigningInfo.signObject(r,"master"),await this._baseApis.setAccountData(`m.secret_storage.key.${o}`,r),o}async signKey(e){if(e||(e=await this.getDefaultKeyId()),!e)throw new Error("signKey requires a key ID");const t=await this._baseApis.getAccountDataFromServer(`m.secret_storage.key.${e}`);if(!t)throw new Error(`Key ${e} does not exist in account data`);await this._crossSigningInfo.signObject(t,"master"),await this._baseApis.setAccountData(`m.secret_storage.key.${e}`,t)}async hasKey(e){return e||(e=await this.getDefaultKeyId()),!!e&&!!this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e)}async store(t,n,o){const r={};if(!o){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");o=[e]}if(0===o.length)throw new Error("Zero keys given to encrypt with!");for(const t of o){const o=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+t);if(!o)throw new Error("Unknown key: "+t);switch((0,s.pkVerify)(o,this._crossSigningInfo.getId("master"),this._crossSigningInfo.userId),o.algorithm){case c:{const i=new e.Olm.PkEncryption;try{i.set_recipient_key(o.pubkey),r[t]=i.encrypt(n)}finally{i.free()}break}default:i.logger.warn("unknown algorithm for secret storage key "+t+": "+o.algorithm)}}await this._baseApis.setAccountData(t,{encrypted:r})}storePassthrough(e,t){return this._baseApis.setAccountData(e,{[t]:{passthrough:!0}})}async get(e){const t=await this._baseApis.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted)throw new Error("Content is not encrypted!");const n={};for(const e of Object.keys(t.encrypted)){const o=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e),r=t.encrypted[e];switch(o.algorithm){case c:o.pubkey&&r.ciphertext&&r.mac&&r.ephemeral&&(n[e]=o)}}let o,r;try{[o,r]=await this._getSecretStorageKey(n);const e=t.encrypted[o];if(e.passthrough)return r.get_private_key();switch(n[o].algorithm){case c:return r.decrypt(e.ephemeral,e.mac,e.ciphertext)}}finally{r&&r.free()}}async isStored(e,t){const n=await this._baseApis.getAccountDataFromServer(e);if(!n||!n.encrypted)return!1;void 0===t&&(t=!0);for(const e of Object.keys(n.encrypted)){const o=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);if(!o)return!1;const r=n.encrypted[e];switch(t&&(0,s.pkVerify)(o,this._crossSigningInfo.getId("master"),this._crossSigningInfo.userId),o.algorithm){case c:if(o.pubkey&&r.ciphertext&&r.mac&&r.ephemeral)return!0}}return!1}request(e,t){const n=this._baseApis.makeTxnId(),o=this._requests[n]={devices:t},r=new Promise((e,t)=>{o.resolve=e,o.reject=t}),i={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:n},s={};for(const e of t)s[e]=i;return this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:s}),{request_id:n,promise:r,cancel:e=>{const r={action:"request_cancellation",requesting_device_id:this._baseApis.deviceId,request_id:n},i={};for(const e of t)i[e]=r;this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:i}),o.reject(new Error(e||"Cancelled"))}}}async _onRequestReceived(e){const t=e.getSender(),n=e.getContent();if(t!==this._baseApis.getUserId()||!(n.name&&n.action&&n.requesting_device_id&&n.request_id))return;const o=n.requesting_device_id;if("request_cancellation"===n.action)this._incomingRequests[o]&&this._incomingRequests[o][n.request_id]&&(i.logger.info("received request cancellation for secret ("+t+", "+o+", "+n.request_id+")"),this.baseApis.emit("crypto.secrets.requestCancelled",{user_id:t,device_id:o,request_id:n.request_id}));else if("request"===n.action){if(o===this._baseApis.deviceId)return;if(i.logger.info("received request for secret ("+t+", "+o+", "+n.request_id+")"),!this._cryptoCallbacks.onSecretRequested)return;const e=await this._cryptoCallbacks.onSecretRequested({user_id:t,device_id:o,request_id:n.request_id,name:n.name,device_trust:this._baseApis.checkDeviceTrust(t,o)});if(e){const r={type:"m.secret.send",content:{request_id:n.request_id,secret:e}},i={algorithm:s.OLM_ALGORITHM,sender_key:this._baseApis._crypto._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.ensureOlmSessionsForDevices(this._baseApis._crypto._olmDevice,this._baseApis,{[t]:[await this._baseApis.getStoredDevice(t,o)]}),await s.encryptMessageForDevice(i.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis._crypto._olmDevice,t,this._baseApis._crypto.getStoredDevice(t,o),r);const a={[t]:{[o]:i}};this._baseApis.sendToDevice("m.room.encrypted",a)}}}_onSecretReceived(e){if(e.getSender()!==this._baseApis.getUserId())return;const t=e.getContent();i.logger.log("got secret share for request ",t.request_id);const n=this._requests[t.request_id];if(n){const o=this._baseApis._crypto._deviceList.getDeviceByIdentityKey(s.OLM_ALGORITHM,e.getSenderKey());if(!o)return void i.logger.log("secret share from unknown device with key",e.getSenderKey());if(!n.devices.includes(o.deviceId))return void i.logger.log("unsolicited secret share from device",o.deviceId);n.resolve(t.secret)}}async _getSecretStorageKey(t){if(!this._cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const n=await this._cryptoCallbacks.getSecretStorageKey({keys:t});if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[o,r]=n;if(!t[o])throw new Error("App returned unknown key from getSecretStorageKey!");switch(t[o].algorithm){case c:{const n=new e.Olm.PkDecryption;let i;try{i=n.init_with_private_key(r)}catch(e){throw n.free(),new Error("getSecretStorageKey callback returned invalid key")}if(i!==t[o].pubkey)throw n.free(),new Error("getSecretStorageKey callback returned incorrect key");return[o,n]}default:throw new Error("Unknown key type: "+t[o].algorithm)}}}t.SecretStorage=u}).call(this,n(3))},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.OutgoingRoomKeyRequestManager=void 0;var r=n(0),i=o(n(2));const s=500,a={UNSENT:0,SENT:1,CANCELLATION_PENDING:2,CANCELLATION_PENDING_AND_WILL_RESEND:3};function c(e){return e.room_id+" / "+e.session_id}function u(e){return"["+i.map(e,e=>`${e.userId}:${e.deviceId}`).join(",")+"]"}t.OutgoingRoomKeyRequestManager=class{constructor(e,t,n){this._baseApis=e,this._deviceId=t,this._cryptoStore=n,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}start(){this._clientRunning=!0,this._startTimer()}stop(){r.logger.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}async sendRoomKeyRequest(e,t,n=!1){const o=await this._cryptoStore.getOutgoingRoomKeyRequest(e);if(o)switch(o.state){case a.CANCELLATION_PENDING_AND_WILL_RESEND:case a.UNSENT:return;case a.CANCELLATION_PENDING:{const e=n?a.CANCELLATION_PENDING_AND_WILL_RESEND:a.SENT;await this._cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,a.CANCELLATION_PENDING,{state:e,cancellationTxnId:this._baseApis.makeTxnId()});break}case a.SENT:if(n){const i=a.CANCELLATION_PENDING_AND_WILL_RESEND,s=await this._cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,a.SENT,{state:i,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()});if(!s)return await this.sendRoomKeyRequest(e,t,n);try{await this._sendOutgoingRoomKeyRequestCancellation(s,!0)}catch(e){r.logger.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+o.state)}else await this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this._baseApis.makeTxnId(),state:a.UNSENT});this._startTimer()}cancelRoomKeyRequest(e){return this._cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case a.CANCELLATION_PENDING:case a.CANCELLATION_PENDING_AND_WILL_RESEND:return;case a.UNSENT:return r.logger.log("deleting unnecessary room key request for "+c(e)),this._cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,a.UNSENT);case a.SENT:return this._cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,a.SENT,{state:a.CANCELLATION_PENDING,cancellationTxnId:this._baseApis.makeTxnId()}).then(t=>{t?this._sendOutgoingRoomKeyRequestCancellation(t).catch(e=>{r.logger.error("Error sending room key request cancellation; will retry later.",e),this._startTimer()}):r.logger.log("Tried to cancel room key request for "+c(e)+" but it was already cancelled in another tab")});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[a.SENT])}_startTimer(){if(this._sendOutgoingRoomKeyRequestsTimer)return;this._sendOutgoingRoomKeyRequestsTimer=e.setTimeout(()=>{if(this._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this._sendOutgoingRoomKeyRequestsRunning=!0,this._sendOutgoingRoomKeyRequests().finally(()=>{this._sendOutgoingRoomKeyRequestsRunning=!1}).catch(e=>{r.logger.warn(`error in OutgoingRoomKeyRequestManager: ${e}`)})},s)}_sendOutgoingRoomKeyRequests(){return this._clientRunning?(r.logger.log("Looking for queued outgoing room key requests"),this._cryptoStore.getOutgoingRoomKeyRequestByState([a.CANCELLATION_PENDING,a.CANCELLATION_PENDING_AND_WILL_RESEND,a.UNSENT]).then(e=>{if(!e)return r.logger.log("No more outgoing room key requests"),void(this._sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case a.UNSENT:t=this._sendOutgoingRoomKeyRequest(e);break;case a.CANCELLATION_PENDING:t=this._sendOutgoingRoomKeyRequestCancellation(e);break;case a.CANCELLATION_PENDING_AND_WILL_RESEND:t=this._sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then(()=>this._sendOutgoingRoomKeyRequests()).catch(e=>{r.logger.error("Error sending room key request; will retry later.",e),this._sendOutgoingRoomKeyRequestsTimer=null,this._startTimer()})})):(this._sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}_sendOutgoingRoomKeyRequest(e){r.logger.log(`Requesting keys for ${c(e.requestBody)}`+` from ${u(e.recipients)}`+`(id ${e.requestId})`);const t={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,a.UNSENT,{state:a.SENT}))}_sendOutgoingRoomKeyRequestCancellation(e,t){r.logger.log("Sending cancellation for key request for "+`${c(e.requestBody)} to `+`${u(e.recipients)} `+`(cancellation id ${e.cancellationTxnId})`);const n={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then(()=>t?this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,a.CANCELLATION_PENDING_AND_WILL_RESEND,{state:a.UNSENT}):this._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,a.CANCELLATION_PENDING))}_sendMessageToDevices(e,t,n){const o={};for(const n of t)o[n.userId]||(o[n.userId]={}),o[n.userId][n.deviceId]=e;return this._baseApis.sendToDevice("m.room_key_request",o,n)}}}).call(this,n(3))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScanQRCode=t.ShowQRCode=void 0;var o=n(43),r=n(10);const i=/^(?:https?:\/\/)?(?:www\.)?matrix\.to\/#\/([#@!+][^?]+)\?(.+)$/,s=/^key_([^:]+:.+)$/,a=(0,r.errorFactory)("m.qr_code.invalid","Invalid QR code");class c extends o.VerificationBase{_doVerification(){if(!this._done){const e="https://matrix.to/#/"+this._baseApis.getUserId()+"?device="+encodeURIComponent(this._baseApis.deviceId)+"&action=verify&key_ed25519%3A"+encodeURIComponent(this._baseApis.deviceId)+"="+encodeURIComponent(this._baseApis.getDeviceEd25519Key());this.emit("show_qr_code",{url:e})}}}t.ShowQRCode=c,c.NAME="m.qr_code.show.v1";class u extends o.VerificationBase{static factory(...e){return new u(...e)}async _doVerification(){const e=(await new Promise((e,t)=>{this.emit("scan",{done:e,cancel:()=>t((0,r.newUserCancelledError)())})})).match(i);let t;const n={};if(!e)throw a();const o=e[1],c=e[2].split("&").map(e=>e.split("=",2).map(decodeURIComponent));let u;for(const[e,o]of c)if("device"===e)t=o;else if("action"===e)u=o;else{const t=e.match(s);t&&(n[t[1]]=o)}if(!t||"verify"!==u||0===Object.keys(n).length)throw a();if(this.userId){if(this.userId!==o)throw(0,r.newUserMismatchError)({expected:this.userId,actual:o})}else await new Promise((e,t)=>{this.emit("confirm_user_id",{userId:o,confirm:e,cancel:()=>t((0,r.newUserMismatchError)())})});await this._verifyKeys(o,n,(e,t,n)=>{if(t.keys[e]!==n)throw(0,r.newKeyMismatchError)()})}}t.ScanQRCode=u,u.NAME="m.qr_code.scan.v1"},function(e,t,n){"use strict";(function(e){var o=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.SAS=void 0;var r=n(43),i=o(n(24)),s=n(10);const a=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let c;const u=(0,s.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),l=(0,s.errorFactory)("m.mismatched_commitment","Mismatched commitment");const d=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];const h={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map(e=>d[e])}};function p(e,t){const n={};for(const o of t)o in h&&(n[o]=h[o](e));return n}const f={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"},g=["curve25519"],m=["sha256"],y=["hkdf-hmac-sha256","hmac-sha256"],_=Object.keys(h),v=new Set(g),S=new Set(m),E=new Set(y),b=new Set(_);function w(e,t){return e instanceof Array?e.filter(e=>t.has(e)):[]}class I extends r.VerificationBase{static get NAME(){return"m.sas.v1"}get events(){return a}async _doVerification(){return await e.Olm.init(),c=c||new e.Olm.Utility,await this._baseApis.downloadKeys([this.userId]),this.startEvent?await this._doRespondVerification():await this._doSendVerification()}async _doSendVerification(){const t="m.key.verification.start",n=this._channel.completeContent(t,{method:I.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:g,hashes:m,message_authentication_codes:y,short_authentication_string:_});this._channel.sendCompleted(t,n);let o=await this._waitForEvent("m.key.verification.accept"),r=o.getContent();const a=w(r.short_authentication_string,b);if(!(v.has(r.key_agreement_protocol)&&S.has(r.hash)&&E.has(r.message_authentication_code)&&a.length))throw(0,s.newUnknownMethodError)();if("string"!=typeof r.commitment)throw(0,s.newInvalidMessageError)();const d=r.message_authentication_code,h=r.commitment,f=new e.Olm.SAS;try{this._send("m.key.verification.key",{key:f.get_pubkey()});const e=(r=(o=await this._waitForEvent("m.key.verification.key")).getContent()).key+i.default.stringify(n);if(c.sha256(e)!==h)throw l();f.set_their_key(r.key);const t="MATRIX_KEY_VERIFICATION_SAS"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,g=f.generate_bytes(t,6),m=new Promise((e,t)=>{this.emit("show_sas",{sas:p(g,a),confirm:()=>{this._sendMAC(f,d),e()},cancel:()=>t((0,s.newUserCancelledError)()),mismatch:()=>t(u())})});[o]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),m]),r=o.getContent(),await this._checkMAC(f,r,d)}finally{f.free()}}async _doRespondVerification(){let t=this._channel.completedContentFromEvent(this.startEvent);const n=w(g,new Set(t.key_agreement_protocols))[0],o=w(m,new Set(t.hashes))[0],r=w(y,new Set(t.message_authentication_codes))[0],a=w(t.short_authentication_string,b);if(void 0===n||void 0===o||void 0===r||!a.length)throw(0,s.newUnknownMethodError)();const l=new e.Olm.SAS;try{const e=l.get_pubkey()+i.default.stringify(t);this._send("m.key.verification.accept",{key_agreement_protocol:n,hash:o,message_authentication_code:r,short_authentication_string:a,commitment:c.sha256(e)});let d=await this._waitForEvent("m.key.verification.key");t=d.getContent(),l.set_their_key(t.key),this._send("m.key.verification.key",{key:l.get_pubkey()});const h="MATRIX_KEY_VERIFICATION_SAS"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId,f=l.generate_bytes(h,6),g=new Promise((e,t)=>{this.emit("show_sas",{sas:p(f,a),confirm:()=>{this._sendMAC(l,r),e()},cancel:()=>t((0,s.newUserCancelledError)()),mismatch:()=>t(u())})});[d]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),g]),t=d.getContent(),await this._checkMAC(l,t,r)}finally{l.free()}}_sendMAC(e,t){const n={},o=[],r="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,i=`ed25519:${this._baseApis.deviceId}`;n[i]=e[f[t]](this._baseApis.getDeviceEd25519Key(),r+i),o.push(i);const s=this._baseApis.getCrossSigningId();if(s){const i=`ed25519:${s}`;n[i]=e[f[t]](s,r+i),o.push(i)}const a=e[f[t]](o.sort().join(","),r+"KEY_IDS");this._send("m.key.verification.mac",{mac:n,keys:a})}async _checkMAC(e,t,n){const o="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId;if(t.keys!==e[f[n]](Object.keys(t.mac).sort().join(","),o+"KEY_IDS"))throw(0,s.newKeyMismatchError)();await this._verifyKeys(this.userId,t.mac,(t,r,i)=>{if(i!==e[f[n]](r.keys[t],o+t))throw(0,s.newKeyMismatchError)()})}}t.SAS=I}).call(this,n(3))},function(e,t,n){var o=n(92);e.exports=o("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")},function(e,t,n){"use strict";var o=n(93).Buffer;e.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");var t=new Uint8Array(256);t.fill(255);for(var n=0;n<e.length;n++){var r=e.charAt(n),i=r.charCodeAt(0);if(255!==t[i])throw new TypeError(r+" is ambiguous");t[i]=n}var s=e.length,a=e.charAt(0),c=Math.log(s)/Math.log(256),u=Math.log(256)/Math.log(s);function l(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return o.alloc(0);var n=0;if(" "!==e[n]){for(var r=0,i=0;e[n]===a;)r++,n++;for(var u=(e.length-n)*c+1>>>0,l=new Uint8Array(u);e[n];){var d=t[e.charCodeAt(n)];if(255===d)return;for(var h=0,p=u-1;(0!==d||h<i)&&-1!==p;p--,h++)d+=s*l[p]>>>0,l[p]=d%256>>>0,d=d/256>>>0;if(0!==d)throw new Error("Non-zero carry");i=h,n++}if(" "!==e[n]){for(var f=u-i;f!==u&&0===l[f];)f++;var g=o.allocUnsafe(r+(u-f));g.fill(0,0,r);for(var m=r;f!==u;)g[m++]=l[f++];return g}}}return{encode:function(t){if(!o.isBuffer(t))throw new TypeError("Expected Buffer");if(0===t.length)return"";for(var n=0,r=0,i=0,c=t.length;i!==c&&0===t[i];)i++,n++;for(var l=(c-i)*u+1>>>0,d=new Uint8Array(l);i!==c;){for(var h=t[i],p=0,f=l-1;(0!==h||p<r)&&-1!==f;f--,p++)h+=256*d[f]>>>0,d[f]=h%s>>>0,h=h/s>>>0;if(0!==h)throw new Error("Non-zero carry");r=p,i++}for(var g=l-r;g!==l&&0===d[g];)g++;for(var m=a.repeat(n);g<l;++g)m+=e.charAt(d[g]);return m},decodeUnsafe:l,decode:function(e){var t=l(e);if(t)return t;throw new Error("Non-base"+s+" character")}}}},function(e,t,n){var o=n(23),r=o.Buffer;function i(e,t){for(var n in e)t[n]=e[n]}function s(e,t,n){return r(e,t,n)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=o:(i(o,t),t.Buffer=s),s.prototype=Object.create(r.prototype),i(r,s),s.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,n)},s.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var o=r(e);return void 0!==t?"string"==typeof n?o.fill(t,n):o.fill(t):o.fill(0),o},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return o.SlowBuffer(e)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RequestCallbackChannel=void 0;t.RequestCallbackChannel=class{constructor(e,t){this._request=e,this._channel=t}get transactionId(){return this._channel.transactionId}get needsDoneMessage(){return this._channel.needsDoneMessage}handleEvent(e,t){return this._channel.handleEvent(e,t)}completedContentFromEvent(e){return this._channel.completedContentFromEvent(e)}completeContent(e,t){return this._channel.completeContent(e,t)}async send(e,t){return this._request.handleVerifierSend(e,t),await this._channel.send(e,t)}async sendCompleted(e,t){return this._request.handleVerifierSend(e,t),await this._channel.sendCompleted(e,t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InRoomChannel=void 0;var o=n(26);const r="m.room.message",i="m.reference",s="m.relates_to";class a{constructor(e,t,n){this._client=e,this._roomId=t,this._userId=n,this._requestEventId=null}get needsDoneMessage(){return!0}get transactionId(){return this._requestEventId}static getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===o.REQUEST_TYPE}static getTransactionId(e){if(a.getEventType(e)===o.REQUEST_TYPE)return e.getId();{const t=e.getRelation();if(t&&t.rel_type===i)return t.event_id}}static validateEvent(e,t){const n=a.getTransactionId(e);if("string"!=typeof n||0===n.length)return!1;const r=a.getEventType(e),i=e.getContent();if(r===o.REQUEST_TYPE){if("string"!=typeof i.to||!i.to.length)return!1;const n=t.getUserId();if(e.getSender()!==n&&i.to!==n)return!1}return o.VerificationRequest.validateEvent(r,e,a.getTimestamp(e),t)}static getEventType(e){const t=e.getType();if(t===r){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===o.REQUEST_TYPE)return o.REQUEST_TYPE}}return t}async handleEvent(e,t){const n=a.getEventType(e);if(e.getRoomId()===this._roomId&&e.getSender()===this._userId)return this._requestEventId||n!==o.REQUEST_TYPE||(this._requestEventId=e.getId()),await t.handleEvent(n,e,a.getTimestamp(e))}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t[s]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==o.REQUEST_TYPE&&e!==o.START_TYPE||(t.from_device=this._client.getDeviceId()),e===o.REQUEST_TYPE?t={body:this._client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:o.REQUEST_TYPE,to:this._userId,from_device:t.from_device,methods:t.methods}:t[s]={rel_type:i,event_id:this.transactionId},t}send(e,t){const n=this.completeContent(e,t);return this.sendCompleted(e,n)}async sendCompleted(e,t){let n=e;e===o.REQUEST_TYPE&&(n=r);const i=await this._client.sendEvent(this._roomId,n,t);e===o.REQUEST_TYPE&&(this._requestEventId=i.event_id)}}t.InRoomChannel=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceChannel=void 0;var o=n(15),r=n(0),i=n(26),s=n(10);class a{constructor(e,t,n,o=null,r=null){this._client=e,this._userId=t,this._devices=n,this.transactionId=o,this._deviceId=r}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===i.REQUEST_TYPE||e===i.START_TYPE}static validateEvent(e,t){if(e.isCancelled())return r.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;const n=e.getContent();if(!n)return!1;if(!n.transaction_id)return!1;const o=e.getType();if(o===i.REQUEST_TYPE){if(!Number.isFinite(n.timestamp))return!1;if(e.getSender()===t.getUserId()&&n.from_device==t.getDeviceId())return!1}return i.VerificationRequest.validateEvent(o,e,a.getTimestamp(e),t)}static getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t){const n=e.getType(),o=e.getContent();if(n===i.REQUEST_TYPE||n===i.START_TYPE){this.transactionId||(this.transactionId=o.transaction_id);const e=o.from_device;if(!this._deviceId&&this._devices.includes(e)&&(this._deviceId=e),!this._deviceId||this._deviceId!==e){const t=this.completeContent((0,s.errorFromEvent)((0,s.newUnexpectedMessageError)()));return this._sendToDevices(i.CANCEL_TYPE,t,[e])}}const r=t.phase===i.PHASE_STARTED;await t.handleEvent(e.getType(),e,a.getTimestamp(e));const c=t.phase===i.PHASE_STARTED;if(n===i.START_TYPE&&!r&&c&&this._deviceId){const e=this._devices.filter(e=>e!==this._deviceId);if(e.length){const t=this.completeContent({code:"m.accepted",reason:"Verification request accepted by another device"});await this._sendToDevices(i.CANCEL_TYPE,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==i.REQUEST_TYPE&&e!==i.START_TYPE||(t.from_device=this._client.getDeviceId()),e===i.REQUEST_TYPE&&(t.timestamp=Date.now()),t}send(e,t={}){e!==i.REQUEST_TYPE&&e!==i.START_TYPE||this.transactionId||(this.transactionId=a.makeTransactionId());const n=this.completeContent(e,t);return this.sendCompleted(e,n)}sendCompleted(e,t){return e===i.REQUEST_TYPE?this._sendToDevices(e,t,this._devices):this._sendToDevices(e,t,[this._deviceId])}_sendToDevices(e,t,n){if(n.length){const o={};for(const e of n)o[e]=t;return this._client.sendToDevice(e,{[this._userId]:o})}return Promise.resolve()}static makeTransactionId(){return(0,o.randomString)(32)}}t.ToDeviceChannel=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoDiscovery=void 0;var o=n(0),r=n(17);class i{static get ERROR_INVALID(){return"Invalid homeserver discovery response"}static get ERROR_GENERIC_FAILURE(){return"Failed to get autodiscovery configuration from server"}static get ERROR_INVALID_HS_BASE_URL(){return"Invalid base_url for m.homeserver"}static get ERROR_INVALID_HOMESERVER(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}static get ERROR_INVALID_IS_BASE_URL(){return"Invalid base_url for m.identity_server"}static get ERROR_INVALID_IDENTITY_SERVER(){return"Identity server URL does not appear to be a valid identity server"}static get ERROR_INVALID_IS(){return"Invalid identity server discovery response"}static get ERROR_MISSING_WELLKNOWN(){return"No .well-known JSON file found"}static get ERROR_INVALID_JSON(){return"Invalid JSON"}static get ALL_ERRORS(){return[i.ERROR_INVALID,i.ERROR_GENERIC_FAILURE,i.ERROR_INVALID_HS_BASE_URL,i.ERROR_INVALID_HOMESERVER,i.ERROR_INVALID_IS_BASE_URL,i.ERROR_INVALID_IDENTITY_SERVER,i.ERROR_INVALID_IS,i.ERROR_MISSING_WELLKNOWN,i.ERROR_INVALID_JSON]}static get FAIL_ERROR(){return"FAIL_ERROR"}static get FAIL_PROMPT(){return"FAIL_PROMPT"}static get PROMPT(){return"PROMPT"}static get SUCCESS(){return"SUCCESS"}static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:i.FAIL_ERROR,error:i.ERROR_INVALID,base_url:null},"m.identity_server":{state:i.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return o.logger.error("No m.homeserver key in config"),t["m.homeserver"].state=i.FAIL_PROMPT,t["m.homeserver"].error=i.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return o.logger.error("No m.homeserver base_url in config"),t["m.homeserver"].state=i.FAIL_PROMPT,t["m.homeserver"].error=i.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const n=this._sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!n)return o.logger.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=i.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const r=await this._fetchWellKnownObject(`${n}/_matrix/client/versions`);if(!r||!r.raw.versions)return o.logger.error("Invalid /versions response"),t["m.homeserver"].error=i.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=n,Promise.resolve(t);t["m.homeserver"]={state:i.SUCCESS,error:null,base_url:n};let s="";if(e["m.identity_server"]){const n={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:i.FAIL_PROMPT,error:i.ERROR_INVALID_IS,base_url:null}};if(!(s=this._sanitizeWellKnownUrl(e["m.identity_server"].base_url)))return o.logger.error("Invalid base_url for m.identity_server"),n["m.identity_server"].error=i.ERROR_INVALID_IS_BASE_URL,Promise.resolve(n);const r=await this._fetchWellKnownObject(`${s}/_matrix/identity/api/v1`);if(!r||!r.raw||"SUCCESS"!==r.action)return o.logger.error("Invalid /api/v1 response"),n["m.identity_server"].error=i.ERROR_INVALID_IDENTITY_SERVER,n["m.identity_server"].base_url=s,Promise.resolve(n)}return s&&s.length>0&&(t["m.identity_server"]={state:i.SUCCESS,error:null,base_url:s}),Object.keys(e).map(n=>{if("m.homeserver"===n||"m.identity_server"===n){const o=["error","state","base_url"];for(const r of Object.keys(e[n]))o.includes(r)||(t[n][r]=e[n][r])}else t[n]=e[n]}),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:i.FAIL_ERROR,error:i.ERROR_INVALID,base_url:null},"m.identity_server":{state:i.PROMPT,error:null,base_url:null}},n=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return n&&"SUCCESS"===n.action?i.fromDiscoveryConfig(n.raw):(o.logger.error("No response or error when parsing .well-known"),n.reason&&o.logger.error(n.reason),"IGNORE"===n.action?t["m.homeserver"]={state:i.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=i.FAIL_PROMPT,t["m.homeserver"].error=i.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static _sanitizeWellKnownUrl(e){if(!e)return!1;try{let t=null;try{t=r.URL?new r.URL(e):new URL(e)}catch(n){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;const n=t.port?`:${t.port}`:"",o=t.pathname?t.pathname:"";let i=`${t.protocol}//${t.hostname}${n}${o}`;return i.endsWith("/")&&(i=i.substring(0,i.length-1)),i}catch(e){return o.logger.error(e),!1}}static async _fetchWellKnownObject(e){return new Promise((function(t,o){const r=n(30).getRequest();if(!r)throw new Error("No request library available");r({method:"GET",uri:e,timeout:5e3},(e,n,o)=>{if(e||n.statusCode<200||n.statusCode>=300){let o="FAIL_PROMPT",r=(e?e.message:null)||"General failure";return 404===n.statusCode&&(o="IGNORE",r=i.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:o,reason:r,error:e})}try{t({raw:JSON.parse(o),action:"SUCCESS"})}catch(e){let n=i.ERROR_INVALID;"SyntaxError"===e.name&&(n=i.ERROR_INVALID_JSON),t({raw:{},action:"FAIL_PROMPT",reason:n,error:e})}})}))}}t.AutoDiscovery=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimelineWindow=i,t.TimelineIndex=s;var o=n(8);n(0);const r=function(){};function i(e,t,n){n=n||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=n.windowLimit||1e3}function s(e,t){this.timeline=e,this.index=t}i.prototype.load=function(e,t){const n=this;t=t||20;const o=function(o){let r;const i=o.getEvents();if(e){for(let t=0;t<i.length;t++)if(i[t].getId()==e){r=t;break}if(void 0===r)throw new Error("getEventTimeline result didn't include requested event")}else r=i.length;const a=Math.min(i.length,r+Math.ceil(t/2)),c=Math.max(0,a-t);n._start=new s(o,c-o.getBaseIndex()),n._end=new s(o,a-o.getBaseIndex()),n._eventCount=a-c};if(e){const t=this._timelineSet.getTimelineForEvent(e);return t?(o(t),Promise.resolve(t)):this._client.getEventTimeline(this._timelineSet,e).then(o)}return o(this._timelineSet.getLiveTimeline()),Promise.resolve()},i.prototype.canPaginate=function(e){let t;if(e==o.EventTimeline.BACKWARDS)t=this._start;else{if(e!=o.EventTimeline.FORWARDS)throw new Error("Invalid direction '"+e+"'");t=this._end}if(!t)return r("TimelineWindow: no timeline yet"),!1;if(e==o.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},i.prototype.paginate=function(e,t,n,i){let s;if(void 0===n&&(n=!0),void 0===i&&(i=5),e==o.EventTimeline.BACKWARDS)s=this._start;else{if(e!=o.EventTimeline.FORWARDS)throw new Error("Invalid direction '"+e+"'");s=this._end}if(!s)return r("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;const a=e==o.EventTimeline.BACKWARDS?s.retreat(t):s.advance(t);if(a){this._eventCount+=a,r("TimelineWindow: increased cap by "+a+" (now "+this._eventCount+")");const t=this._eventCount-this._windowLimit;return t>0&&this.unpaginate(t,e!=o.EventTimeline.BACKWARDS),Promise.resolve(!0)}if(!n||0===i)return Promise.resolve(!1);if(!s.timeline.getPaginationToken(e))return r("TimelineWindow: no token"),Promise.resolve(!1);r("TimelineWindow: starting request");const c=this,u=this._client.paginateEventTimeline(s.timeline,{backwards:e==o.EventTimeline.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=null})).then((function(n){return r("TimelineWindow: request completed with result "+n),!!n&&c.paginate(e,t,!0,i-1)}));return s.pendingPaginate=u,u},i.prototype.unpaginate=function(e,t){const n=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){const o=t?n.advance(e):n.retreat(e);if(o<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=o,this._eventCount-=o,r("TimelineWindow.unpaginate: dropped "+o+" (now "+this._eventCount+")")}},i.prototype.getEvents=function(){if(!this._start)return[];const e=[];let t=this._start.timeline;for(;;){const n=t.getEvents();let r=0,i=n.length;t===this._start.timeline&&(r=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(i=this._end.index+t.getBaseIndex());for(let t=r;t<i;t++)e.push(n[t]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(o.EventTimeline.FORWARDS)}return e},s.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},s.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},s.prototype.advance=function(e){if(!e)return 0;let t;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;const n=this.timeline.getNeighbouringTimeline(e<0?o.EventTimeline.BACKWARDS:o.EventTimeline.FORWARDS);return n?(this.timeline=n,this.index=e<0?this.maxIndex():this.minIndex(),r("paginate: switched to new neighbour"),this.advance(e)):0},s.prototype.retreat=function(e){return-1*this.advance(-1*e)}},function(e,t,n){"use strict";var o=n(1),r=n(5);Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveAuth=c;var i=r(n(17)),s=o(n(2)),a=n(0);function c(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}c.prototype={attemptAuth:function(){return new Promise((e,t)=>{this._resolveFunc=e,this._rejectFunc=t,this._data.flows?this._startNextAuthStage():(this._busyChangedCallback&&this._busyChangedCallback(!0),this._doRequest(this._data).finally(()=>{this._busyChangedCallback&&this._busyChangedCallback(!1)}))})},poll:async function(){if(!this._data.session)return;if(this._submitPromise)return;let e={};if("m.login.email.identity"==this._currentStage&&this._emailSid){const t={sid:this._emailSid,client_secret:this._clientSecret};if(await this._matrixClient.doesServerRequireIdServerParam()){const e=i.default.parse(this._matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:"m.login.email.identity",threepid_creds:t}}this.submitAuthDict(e,!0)},getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){let t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow(){return this._chosenFlow},submitAuthDict:async function(e,t){if(!this._resolveFunc)throw new Error("submitAuthDict() called before attemptAuth()");for(!t&&this._busyChangedCallback&&this._busyChangedCallback(!0);this._submitPromise;)try{await this._submitPromise}catch(e){}const n={session:this._data.session};s.extend(n,e);try{this._submitPromise=this._doRequest(n,t),await this._submitPromise}finally{this._submitPromise=null,!t&&this._busyChangedCallback&&this._busyChangedCallback(!1)}},getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:async function(e,t){try{const n=await this._requestCallback(e,t);this._resolveFunc(n)}catch(e){const n=e.data?e.data.flows:null,o=Boolean(this._data.flows)||Boolean(n);if(401===e.httpStatus&&e.data&&o||(t?a.logger.log("Background poll request failed doing UI auth: ignoring",e):this._rejectFunc(e)),e.data.flows||e.data.completed||e.data.session||(e.data.flows=this._data.flows,e.data.completed=this._data.completed,e.data.session=this._data.session),this._data=e.data,this._startNextAuthStage(),!this._emailSid&&!this._requestingEmailToken&&this._chosenFlow.stages.includes("m.login.email.identity")){this._requestingEmailToken=!0;try{const e=await this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session);this._emailSid=e.sid}catch(e){this._rejectFunc(e)}finally{this._requestingEmailToken=!1}}}},_startNextAuthStage:function(){const e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"===e)return void this.submitAuthDict({type:"m.login.dummy"});if(this._data.errcode||this._data.error)return void this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});const t={};"m.login.email.identity"==e&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),a.logger.log("Active flow => %s",JSON.stringify(this._chosenFlow));const e=this._firstUncompletedStage(this._chosenFlow);return a.logger.log("Next stage: %s",e),e},_chooseFlow:function(){const e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),n=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber);for(const o of e){let e=!1,r=!1;for(const t of o.stages)"m.login.email.identity"===t?e=!0:"m.login.msisdn"==t&&(r=!0);if(e==t&&r==n)return o}const o=new Error("No appropriate authentication flow found");throw o.name="NoAuthFlowFoundError",o.required_stages=[],t&&o.required_stages.push("m.login.email.identity"),n&&o.required_stages.push("m.login.msisdn"),o.available_flows=e,o},_firstUncompletedStage:function(e){const t=(this._data||{}).completed||[];for(let n=0;n<e.stages.length;++n){const o=e.stages[n];if(-1===t.indexOf(o))return o}}}},function(e,t,n){"use strict";(function(e){var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBStore=h;var r=n(31),i=o(n(2)),s=n(4),a=n(101),c=n(102),u=n(11),l=n(6),d=n(0);function h(t){if(r.MemoryStore.call(this,t),!t.indexedDB)throw new Error("Missing required option: indexedDB");if(t.workerScript){let n=t.workerApi;n||(n=e.Worker),this.backend=new c.RemoteIndexedDBStoreBackend(t.workerScript,t.dbName,n)}else this.backend=new a.LocalIndexedDBStoreBackend(t.indexedDB,t.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}}function p(e,t){return async function(...n){try{return await e.call(this,...n)}catch(e){d.logger.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emit("degraded",e);try{d.logger.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),d.logger.log("IndexedDBStore delete after degrading succeeeded")}catch(e){d.logger.warn("IndexedDBStore delete after degrading failed",e)}if(Object.setPrototypeOf(this,r.MemoryStore.prototype),t)return await r.MemoryStore.prototype[t].call(this,...n)}}}i.inherits(h,r.MemoryStore),i.extend(h.prototype,s.EventEmitter.prototype),h.exists=function(e,t){return a.LocalIndexedDBStoreBackend.exists(e,t)},h.prototype.startup=function(){return this.startedUp?(d.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(d.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then(()=>(d.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{d.logger.log("IndexedDBStore.startup: processing presence events"),e.forEach(([e,t])=>{const n=new u.User(e);t&&n.setPresenceEvent(new l.MatrixEvent(t)),this._userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)})}))},h.prototype.getSavedSync=p((function(){return this.backend.getSavedSync()}),"getSavedSync"),h.prototype.isNewlyCreated=p((function(){return this.backend.isNewlyCreated()}),"isNewlyCreated"),h.prototype.getSavedSyncToken=p((function(){return this.backend.getNextBatchToken()}),"getSavedSyncToken"),h.prototype.deleteAllData=p((function(){return r.MemoryStore.prototype.deleteAllData.call(this),this.backend.clearDatabase().then(()=>{d.logger.log("Deleted indexeddb data.")},e=>{throw d.logger.error(`Failed to delete indexeddb data: ${e}`),e})})),h.prototype.wantsSave=function(){return Date.now()-this._syncTs>3e5},h.prototype.save=function(e){return e||this.wantsSave()?this._reallySave():Promise.resolve()},h.prototype._reallySave=p((function(){this._syncTs=Date.now();const e=[];for(const t of this.getUsers())this._userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this._userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),h.prototype.setSyncData=p((function(e){return this.backend.setSyncData(e)}),"setSyncData"),h.prototype.getOutOfBandMembers=p((function(e){return this.backend.getOutOfBandMembers(e)}),"getOutOfBandMembers"),h.prototype.setOutOfBandMembers=p((function(e,t){return r.MemoryStore.prototype.setOutOfBandMembers.call(this,e,t),this.backend.setOutOfBandMembers(e,t)}),"setOutOfBandMembers"),h.prototype.clearOutOfBandMembers=p((function(e){return r.MemoryStore.prototype.clearOutOfBandMembers.call(this),this.backend.clearOutOfBandMembers(e)}),"clearOutOfBandMembers"),h.prototype.getClientOptions=p((function(){return this.backend.getClientOptions()}),"getClientOptions"),h.prototype.storeClientOptions=p((function(e){return r.MemoryStore.prototype.storeClientOptions.call(this,e),this.backend.storeClientOptions(e)}),"storeClientOptions")}).call(this,n(3))},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.LocalIndexedDBStoreBackend=h;var r=n(46),i=o(n(2)),s=o(n(39)),a=n(0);function c(e,t,n){const o=e.openCursor(t);return new Promise((e,t)=>{const r=[];o.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},o.onsuccess=t=>{const o=t.target.result;o?(r.push(n(o)),o.continue()):e(r)}})}function u(e){return new Promise((t,n)=>{e.oncomplete=function(e){t(e)},e.onerror=function(e){n(e.target.error)}})}function l(e){return new Promise((t,n)=>{e.onsuccess=function(e){t(e)},e.onerror=function(e){n(e.target.error)}})}function d(e){return l(e).then(e=>e.target.result)}function h(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new r.SyncAccumulator,this._isNewlyCreated=!1}h.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),s.exists(e,t)},h.prototype={connect:function(){if(!this._disconnected)return a.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this._disconnected=!1,a.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this._dbName,3);return e.onupgradeneeded=e=>{const t=e.target.result,n=e.oldVersion;a.logger.log(`LocalIndexedDBStoreBackend.connect: upgrading from ${n}`),n<1&&(this._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(t)),n<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(t),n<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(t)},e.onblocked=()=>{a.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},a.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),l(e).then(e=>(a.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.target.result,this.db.onversionchange=()=>{this.db.close()},this._init()))},isNewlyCreated:function(){return Promise.resolve(this._isNewlyCreated)},_init:function(){return Promise.all([this._loadAccountData(),this._loadSyncData()]).then(([e,t])=>{a.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this._syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,groups:t.groupsData,account_data:{events:e}})})},getOutOfBandMembers:function(e){return new Promise((t,n)=>{const o=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),r=IDBKeyRange.only(e),i=o.openCursor(r),s=[];let a=!1;i.onsuccess=e=>{const n=e.target.result;if(!n)return s.length||a?t(s):t(null);const o=n.value;o.oob_written?a=!0:s.push(o),n.continue()},i.onerror=e=>{n(e)}}).then(t=>(a.logger.log(`LL: got ${t&&t.length}`+` membershipEvents from storage for room ${e} ...`),t))},setOutOfBandMembers:async function(e,t){a.logger.log(`LL: backend about to store ${t.length}`+` members for ${e}`);const n=this.db.transaction(["oob_membership_events"],"readwrite"),o=n.objectStore("oob_membership_events");t.forEach(e=>{o.put(e)});const r={room_id:e,oob_written:!0,state_key:0};o.put(r),await u(n),a.logger.log(`LL: backend done storing for ${e}!`)},clearOutOfBandMembers:async function(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),n=IDBKeyRange.only(e),o=d(t.openKeyCursor(n,"next")).then(e=>e&&e.primaryKey[1]),r=d(t.openKeyCursor(n,"prev")).then(e=>e&&e.primaryKey[1]),[i,s]=await Promise.all([o,r]),c=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),u=IDBKeyRange.bound([e,i],[e,s]);var l;a.logger.log("LL: Deleting all users + marker in storage for "+`room ${e}, with key range:`,[e,i],[e,s]),await(l=c.delete(u),new Promise((e,t)=>{l.onsuccess=()=>e(l),l.onerror=e=>t(e)}))},clearDatabase:function(){return new Promise((e,t)=>{a.logger.log(`Removing indexeddb instance: ${this._dbName}`);const n=this.indexedDB.deleteDatabase(this._dbName);n.onblocked=()=>{a.logger.log(`can't yet delete indexeddb ${this._dbName}`+" because it is open elsewhere")},n.onerror=t=>{a.logger.warn(`unable to delete js-sdk store indexeddb: ${t.target.error}`),e()},n.onsuccess=()=>{a.logger.log(`Removed indexeddb instance: ${this._dbName}`),e()}})},getSavedSync:function(e){void 0===e&&(e=!0);const t=this._syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(i.deepCopy(t)):Promise.resolve(t):Promise.resolve(null)},getNextBatchToken:function(){return Promise.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){return Promise.resolve().then(()=>{this._syncAccumulator.accumulate(e)})},syncToDatabase:function(e){const t=this._syncAccumulator.getJSON();return Promise.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,n){return a.logger.log("Persisting sync data up to ",e),i.promiseTry(()=>{const o=this.db.transaction(["sync"],"readwrite");return o.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:n}),u(o)})},_persistAccountData:function(e){return i.promiseTry(()=>{const t=this.db.transaction(["accountData"],"readwrite"),n=t.objectStore("accountData");for(let t=0;t<e.length;t++)n.put(e[t]);return u(t)})},_persistUserPresenceEvents:function(e){return i.promiseTry(()=>{const t=this.db.transaction(["users"],"readwrite"),n=t.objectStore("users");for(const t of e)n.put({userId:t[0],event:t[1]});return u(t)})},getUserPresenceEvents:function(){return i.promiseTry(()=>{return c(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event])})},_loadAccountData:function(){return a.logger.log("LocalIndexedDBStoreBackend: loading account data..."),i.promiseTry(()=>{return c(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(a.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e))})},_loadSyncData:function(){return a.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),i.promiseTry(()=>{return c(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(a.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&a.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{}))})},getClientOptions:function(){return Promise.resolve().then(()=>{return c(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{if(e.value&&e.value&&e.value.options)return e.value.options}).then(e=>e[0])})},storeClientOptions:async function(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await u(t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteIndexedDBStoreBackend=i;var o=n(0),r=n(2);function i(e,t,n){this._workerScript=e,this._dbName=t,this._workerApi=n,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null}i.prototype={connect:function(){return this._ensureStarted().then(()=>this._doCmd("connect"))},clearDatabase:function(){return this._ensureStarted().then(()=>this._doCmd("clearDatabase"))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then(()=>{o.logger.log("IndexedDB worker is ready")})),this._startPromise},_doCmd:function(e,t){return Promise.resolve().then(()=>{const n=this._nextSeq++,o=(0,r.defer)();return this._inFlight[n]=o,this._worker.postMessage({command:e,seq:n,args:t}),o.promise})},_onWorkerMessage:function(e){const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void o.logger.error("Got reply from worker with no seq");const e=this._inFlight[t.seq];if(void 0===e)return void o.logger.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const n=new Error(t.error.message);n.name=t.error.name,e.reject(n)}}else o.logger.warn("Unrecognised message from worker: "+t)}}},function(e,t,n){"use strict";var o=n(1);Object.defineProperty(t,"__esModule",{value:!0}),t.WebStorageSessionStore=c;var r=o(n(2)),i=n(0);const s=!1,a="session.e2e.";function c(e){if(this.store=e,!(r.isFunction(e.getItem)&&r.isFunction(e.setItem)&&r.isFunction(e.removeItem)&&r.isFunction(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}c.prototype={removeEndToEndAccount:function(){this.store.removeItem(u)},getEndToEndAccount:function(){return this.store.getItem(u)},getAllEndToEndDevices:function(){const e=p(""),t={};for(let n=0;n<this.store.length;++n){const o=this.store.key(n),r=o.substr(e.length);o.startsWith(e)&&(t[r]=m(this.store,o))}return t},getEndToEndDeviceTrackingStatus:function(){return m(this.store,d)},getEndToEndDeviceSyncToken:function(){return m(this.store,l)},removeEndToEndDeviceData:function(){_(this.store,p("")),_(this.store,d),_(this.store,l)},getEndToEndSessions:function(e){return m(this.store,f(e))},getAllEndToEndSessions:function(){const e=y(this.store,f("")),t={};for(const n of e){t[n.substr(f("").length)]=m(this.store,n)}return t},removeAllEndToEndSessions:function(){_(this.store,f(""))},getAllEndToEndInboundGroupSessionKeys:function(){const e=a+"inboundgroupsessions/",t=[];for(let n=0;n<this.store.length;n++){const o=this.store.key(n);o.startsWith(e)&&t.push({senderKey:o.substr(e.length,43),sessionId:o.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){const n=function(e,t){return a+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(n)},removeAllEndToEndInboundGroupSessions:function(){_(this.store,a+"inboundgroupsessions/")},getAllEndToEndRooms:function(){const e=y(this.store,g("")),t={};for(const n of e){t[n.substr(g("").length)]=m(this.store,n)}return t},removeAllEndToEndRooms:function(){_(this.store,g(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(h,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(h)}};const u=a+"account",l=a+"device_sync_token",d=a+"device_tracking",h=a+"trusted_backup_pubkey";function p(e){return a+"devices/"+e}function f(e){return a+"sessions/"+e}function g(e){return a+"rooms/"+e}function m(e,t){try{return JSON.parse(e.getItem(t))}catch(e){v("Failed to get key %s: %s",t,e),v(e.stack)}return null}function y(e,t){const n=[];for(let o=0;o<e.length;++o){const r=e.key(o);r.startsWith(t)&&n.push(r)}return n}function _(e,t){const n=[];for(let o=0;o<e.length;++o){const r=e.key(o);r.startsWith(t)&&n.push(r)}for(const t of n)e.removeItem(t)}function v(){s&&i.logger.log(...arguments)}},function(e,t,n){var o,r,i;r=[],void 0===(i="function"==typeof(o=function(){var e=XMLHttpRequest;if(!e)throw new Error("missing XMLHttpRequest");function t(i,s){if("function"!=typeof s)throw new Error("Bad callback given: "+s);if(!i)throw new Error("No options given");var a=i.onResponse;if((i="string"==typeof i?{uri:i}:JSON.parse(JSON.stringify(i))).onResponse=a,i.verbose&&(t.log=function(){var e,t,n={},i=["trace","debug","info","warn","error"];for(t=0;t<i.length;t++)n[e=i[t]]=o,"undefined"!=typeof console&&console&&console[e]&&(n[e]=r(console,e));return n}()),i.url&&(i.uri=i.url,delete i.url),!i.uri&&""!==i.uri)throw new Error("options.uri is a required argument");if("string"!=typeof i.uri)throw new Error("options.uri must be a string");for(var c=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],u=0;u<c.length;u++)if(i[c[u]])throw new Error("options."+c[u]+" is not supported");if(i.callback=s,i.method=i.method||"GET",i.headers=i.headers||{},i.body=i.body||null,i.timeout=i.timeout||t.DEFAULT_TIMEOUT,i.headers.host)throw new Error("Options.headers.host is not supported");i.json&&(i.headers.accept=i.headers.accept||"application/json","GET"!==i.method&&(i.headers["content-type"]="application/json"),"boolean"!=typeof i.json?i.body=JSON.stringify(i.json):"string"!=typeof i.body&&(i.body=JSON.stringify(i.body)));var l=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};if(i.qs){var d="string"==typeof i.qs?i.qs:l(i.qs);-1!==i.uri.indexOf("?")?i.uri=i.uri+"&"+d:i.uri=i.uri+"?"+d}if(i.form){if("string"==typeof i.form)throw"form name unsupported";if("POST"===i.method){var h=(i.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(i.headers["content-type"]=h,h){case"application/x-www-form-urlencoded":i.body=l(i.form).replace(/%20/g,"+");break;case"multipart/form-data":var p=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var n=[];for(var o in e)e.hasOwnProperty(o)&&n.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+o+'"\n\n'+e[o]+"\n");return n.push("--"+t.boundry+"--"),t.body=n.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t}(i.form);i.body=p.body,i.headers["content-type"]=p.type;break;default:throw new Error("unsupported encoding:"+h)}}}return i.onResponse=i.onResponse||o,!0===i.onResponse&&(i.onResponse=s,i.callback=o),!i.headers.authorization&&i.auth&&(i.headers.authorization="Basic "+function(e){var t,n,o,r,i,s,a,c,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,d=0,h="",p=[];if(!e)return e;do{t=e.charCodeAt(l++),n=e.charCodeAt(l++),o=e.charCodeAt(l++),r=(c=t<<16|n<<8|o)>>18&63,i=c>>12&63,s=c>>6&63,a=63&c,p[d++]=u.charAt(r)+u.charAt(i)+u.charAt(s)+u.charAt(a)}while(l<e.length);switch(h=p.join(""),e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h}(i.auth.username+":"+i.auth.password)),function(o){var r=new e,i=!1,s=function(e){var t,n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(e){(t=document.createElement("a")).href="",t=t.href}var o=n.exec(t.toLowerCase())||[],r=n.exec(e.toLowerCase());return!(!r||r[1]==o[1]&&r[2]==o[2]&&(r[3]||("http:"===r[1]?80:443))==(o[3]||("http:"===o[1]?80:443)))}(o.uri),a="withCredentials"in r;if(n+=1,r.seq_id=n,r.id=n+": "+o.method+" "+o.uri,r._id=r.id,s&&!a){var c=new Error("Browser does not support cross-origin request: "+o.uri);return c.cors="unsupported",o.callback(c,r)}r.timeoutTimer=setTimeout((function(){i=!0;var e=new Error("ETIMEDOUT");return e.code="ETIMEDOUT",e.duration=o.timeout,t.log.error("Timeout",{id:r._id,milliseconds:o.timeout}),o.callback(e,r)}),o.timeout);var u={response:!1,loading:!1,end:!1};return r.onreadystatechange=function(n){if(i)return t.log.debug("Ignoring timed out state change",{state:r.readyState,id:r.id});if(t.log.debug("State change",{state:r.readyState,id:r.id,timed_out:i}),r.readyState===e.OPENED)for(var s in t.log.debug("Request started",{id:r.id}),o.headers)r.setRequestHeader(s,o.headers[s]);else r.readyState===e.HEADERS_RECEIVED?l():r.readyState===e.LOADING?(l(),d()):r.readyState===e.DONE&&(l(),d(),function(){if(!u.end){if(u.end=!0,t.log.debug("Request done",{id:r.id}),r.body=r.responseText,o.json)try{r.body=JSON.parse(r.responseText)}catch(e){return o.callback(e,r)}o.callback(null,r,r.body)}}())},r.open(o.method,o.uri,!0),s&&(r.withCredentials=!!o.withCredentials),r.send(o.body),r;function l(){if(!u.response){if(u.response=!0,t.log.debug("Got response",{id:r.id,status:r.status}),clearTimeout(r.timeoutTimer),r.statusCode=r.status,s&&0==r.statusCode){var e=new Error("CORS request rejected: "+o.uri);return e.cors="rejected",u.loading=!0,u.end=!0,o.callback(e,r)}o.onResponse(null,r)}}function d(){u.loading||(u.loading=!0,t.log.debug("Response body loading",{id:r.id}))}}(i)}t.log={trace:o,debug:o,info:o,warn:o,error:o};var n=0;function o(){}function r(e,t){return function(n,o){return"object"==typeof o&&(n+=" "+JSON.stringify(o)),e[t].call(e,n)}}return t.withCredentials=!1,t.DEFAULT_TIMEOUT=18e4,t.defaults=function(e,n){var o=function(t){return function(n,o){for(var r in n="string"==typeof n?{uri:n}:JSON.parse(JSON.stringify(n)),e)void 0===n[r]&&(n[r]=e[r]);return t(n,o)}},r=o(t);return r.get=o(t.get),r.post=o(t.post),r.put=o(t.put),r.head=o(t.head),r},["get","put","post","head"].forEach((function(e){var n=e.toUpperCase();t[e.toLowerCase()]=function(e){"string"==typeof e?e={method:n,uri:e}:(e=JSON.parse(JSON.stringify(e))).method=n;var o=[e].concat(Array.prototype.slice.apply(arguments,[1]));return t.apply(this,o)}})),t.couch=function(e,n){return"string"==typeof e&&(e={uri:e}),e.json=!0,e.body&&(e.json=e.body),delete e.body,n=n||o,t(e,(function(e,t,o){if(e)return n(e,t,o);if((t.statusCode<200||t.statusCode>299)&&o.error){for(var r in e=new Error("CouchDB error: "+(o.error.reason||o.error.error)),o)e[r]=o[r];return n(e,t,o)}return n(e,t,o)}))},t})?o.apply(t,r):o)||(e.exports=i)},function(e,t,n){"use strict";var o=n(106),r=n(107),i=n(47);e.exports={formats:i,parse:r,stringify:o}},function(e,t,n){"use strict";var o=n(27),r=n(47),i=Object.prototype.hasOwnProperty,s={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},a=Array.isArray,c=Array.prototype.push,u=function(e,t){c.apply(e,a(t)?t:[t])},l=Date.prototype.toISOString,d=r.default,h={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:o.encode,encodeValuesOnly:!1,format:d,formatter:r.formatters[d],indices:!1,serializeDate:function(e){return l.call(e)},skipNulls:!1,strictNullHandling:!1},p=function e(t,n,r,i,s,c,l,d,p,f,g,m,y){var _,v=t;if("function"==typeof l?v=l(n,v):v instanceof Date?v=f(v):"comma"===r&&a(v)&&(v=v.join(",")),null===v){if(i)return c&&!m?c(n,h.encoder,y,"key"):n;v=""}if("string"==typeof(_=v)||"number"==typeof _||"boolean"==typeof _||"symbol"==typeof _||"bigint"==typeof _||o.isBuffer(v))return c?[g(m?n:c(n,h.encoder,y,"key"))+"="+g(c(v,h.encoder,y,"value"))]:[g(n)+"="+g(String(v))];var S,E=[];if(void 0===v)return E;if(a(l))S=l;else{var b=Object.keys(v);S=d?b.sort(d):b}for(var w=0;w<S.length;++w){var I=S[w];s&&null===v[I]||(a(v)?u(E,e(v[I],"function"==typeof r?r(n,I):n,r,i,s,c,l,d,p,f,g,m,y)):u(E,e(v[I],n+(p?"."+I:"["+I+"]"),r,i,s,c,l,d,p,f,g,m,y)))}return E};e.exports=function(e,t){var n,o=e,c=function(e){if(!e)return h;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||h.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var n=r.default;if(void 0!==e.format){if(!i.call(r.formatters,e.format))throw new TypeError("Unknown format option provided.");n=e.format}var o=r.formatters[n],s=h.filter;return("function"==typeof e.filter||a(e.filter))&&(s=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:h.addQueryPrefix,allowDots:void 0===e.allowDots?h.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:h.charsetSentinel,delimiter:void 0===e.delimiter?h.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:h.encode,encoder:"function"==typeof e.encoder?e.encoder:h.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:h.encodeValuesOnly,filter:s,formatter:o,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:h.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:h.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:h.strictNullHandling}}(t);"function"==typeof c.filter?o=(0,c.filter)("",o):a(c.filter)&&(n=c.filter);var l,d=[];if("object"!=typeof o||null===o)return"";l=t&&t.arrayFormat in s?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var f=s[l];n||(n=Object.keys(o)),c.sort&&n.sort(c.sort);for(var g=0;g<n.length;++g){var m=n[g];c.skipNulls&&null===o[m]||u(d,p(o[m],m,f,c.strictNullHandling,c.skipNulls,c.encode?c.encoder:null,c.filter,c.sort,c.allowDots,c.serializeDate,c.formatter,c.encodeValuesOnly,c.charset))}var y=d.join(c.delimiter),_=!0===c.addQueryPrefix?"?":"";return c.charsetSentinel&&("iso-8859-1"===c.charset?_+="utf8=%26%2310003%3B&":_+="utf8=%E2%9C%93&"),y.length>0?_+y:""}},function(e,t,n){"use strict";var o=n(27),r=Object.prototype.hasOwnProperty,i=Array.isArray,s={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:o.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},c=function(e,t,n){if(e){var o=n.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,i=/(\[[^[\]]*])/g,s=n.depth>0&&/(\[[^[\]]*])/.exec(o),a=s?o.slice(0,s.index):o,c=[];if(a){if(!n.plainObjects&&r.call(Object.prototype,a)&&!n.allowPrototypes)return;c.push(a)}for(var u=0;n.depth>0&&null!==(s=i.exec(o))&&u<n.depth;){if(u+=1,!n.plainObjects&&r.call(Object.prototype,s[1].slice(1,-1))&&!n.allowPrototypes)return;c.push(s[1])}return s&&c.push("["+o.slice(s.index)+"]"),function(e,t,n){for(var o=t,r=e.length-1;r>=0;--r){var i,s=e[r];if("[]"===s&&n.parseArrays)i=[].concat(o);else{i=n.plainObjects?Object.create(null):{};var a="["===s.charAt(0)&&"]"===s.charAt(s.length-1)?s.slice(1,-1):s,c=parseInt(a,10);n.parseArrays||""!==a?!isNaN(c)&&s!==a&&String(c)===a&&c>=0&&n.parseArrays&&c<=n.arrayLimit?(i=[])[c]=o:i[a]=o:i={0:o}}o=i}return o}(c,t,n)}};e.exports=function(e,t){var n=function(e){if(!e)return s;if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new Error("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?s.charset:e.charset;return{allowDots:void 0===e.allowDots?s.allowDots:!!e.allowDots,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:s.allowPrototypes,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:s.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:s.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:s.comma,decoder:"function"==typeof e.decoder?e.decoder:s.decoder,delimiter:"string"==typeof e.delimiter||o.isRegExp(e.delimiter)?e.delimiter:s.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:s.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:s.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:s.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:s.plainObjects,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:s.strictNullHandling}}(t);if(""===e||null==e)return n.plainObjects?Object.create(null):{};for(var u="string"==typeof e?function(e,t){var n,c={},u=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,l=t.parameterLimit===1/0?void 0:t.parameterLimit,d=u.split(t.delimiter,l),h=-1,p=t.charset;if(t.charsetSentinel)for(n=0;n<d.length;++n)0===d[n].indexOf("utf8=")&&("utf8=%E2%9C%93"===d[n]?p="utf-8":"utf8=%26%2310003%3B"===d[n]&&(p="iso-8859-1"),h=n,n=d.length);for(n=0;n<d.length;++n)if(n!==h){var f,g,m=d[n],y=m.indexOf("]="),_=-1===y?m.indexOf("="):y+1;-1===_?(f=t.decoder(m,s.decoder,p,"key"),g=t.strictNullHandling?null:""):(f=t.decoder(m.slice(0,_),s.decoder,p,"key"),g=t.decoder(m.slice(_+1),s.decoder,p,"value")),g&&t.interpretNumericEntities&&"iso-8859-1"===p&&(g=a(g)),g&&"string"==typeof g&&t.comma&&g.indexOf(",")>-1&&(g=g.split(",")),m.indexOf("[]=")>-1&&(g=i(g)?[g]:g),r.call(c,f)?c[f]=o.combine(c[f],g):c[f]=g}return c}(e,n):e,l=n.plainObjects?Object.create(null):{},d=Object.keys(u),h=0;h<d.length;++h){var p=d[h],f=c(p,u[p],n);l=o.merge(l,f,n)}return o.compact(l)}},function(e,t,n){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(n(109)),i=o(n(111));t.uuid=function(){return r.default()};const s={v4:/(?:^[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[a-f0-9]{4}-[a-f0-9]{12}$)|(?:^0{8}-0{4}-0{4}-0{4}-0{12}$)/u,v5:/(?:^[a-f0-9]{8}-[a-f0-9]{4}-5[a-f0-9]{3}-[a-f0-9]{4}-[a-f0-9]{12}$)|(?:^0{8}-0{4}-0{4}-0{4}-0{12}$)/u};t.regex=s;t.isUuid=function(e){return s.v4.test(e)||s.v5.test(e)};t.empty=function(){return"00000000-0000-0000-0000-000000000000"};t.fromString=function(e){return i.default(e,"bb5d0ffa-9a4c-4d7c-8fc2-0a7d2220ba45")}},function(e,t,n){var o=n(110),r=n(48);e.exports=function(e,t,n){var i=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var s=(e=e||{}).random||(e.rng||o)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t)for(var a=0;a<16;++a)t[i+a]=s[a];return t||r(s)}},function(e,t){var n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(n){var o=new Uint8Array(16);e.exports=function(){return n(o),o}}else{var r=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),r[t]=e>>>((3&t)<<3)&255;return r}}},function(e,t,n){var o=n(112),r=n(113);e.exports=o("v5",80,r)},function(e,t,n){var o=n(48);e.exports=function(e,t,n){var r=function(e,r,i,s){var a=i&&s||0;if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=new Array(e.length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)),"string"==typeof r&&(r=function(e){var t=[];return e.replace(/[a-fA-F0-9]{2}/g,(function(e){t.push(parseInt(e,16))})),t}(r)),!Array.isArray(e))throw TypeError("value must be an array of bytes");if(!Array.isArray(r)||16!==r.length)throw TypeError("namespace must be uuid string or an Array of 16 byte values");var c=n(r.concat(e));if(c[6]=15&c[6]|t,c[8]=63&c[8]|128,i)for(var u=0;u<16;++u)i[a+u]=c[u];return i||o(c)};try{r.name=e}catch(e){}return r.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",r.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",r}},function(e,t,n){"use strict";function o(e,t,n,o){switch(e){case 0:return t&n^~t&o;case 1:return t^n^o;case 2:return t&n^t&o^n&o;case 3:return t^n^o}}function r(e,t){return e<<t|e>>>32-t}e.exports=function(e){var t=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var i=unescape(encodeURIComponent(e));e=new Array(i.length);for(var s=0;s<i.length;s++)e[s]=i.charCodeAt(s)}e.push(128);var a=e.length/4+2,c=Math.ceil(a/16),u=new Array(c);for(s=0;s<c;s++){u[s]=new Array(16);for(var l=0;l<16;l++)u[s][l]=e[64*s+4*l]<<24|e[64*s+4*l+1]<<16|e[64*s+4*l+2]<<8|e[64*s+4*l+3]}for(u[c-1][14]=8*(e.length-1)/Math.pow(2,32),u[c-1][14]=Math.floor(u[c-1][14]),u[c-1][15]=8*(e.length-1)&4294967295,s=0;s<c;s++){for(var d=new Array(80),h=0;h<16;h++)d[h]=u[s][h];for(h=16;h<80;h++)d[h]=r(d[h-3]^d[h-8]^d[h-14]^d[h-16],1);var p=n[0],f=n[1],g=n[2],m=n[3],y=n[4];for(h=0;h<80;h++){var _=Math.floor(h/20),v=r(p,5)+o(_,f,g,m)+y+t[_]+d[h]>>>0;y=m,m=g,g=r(f,30)>>>0,f=p,p=v}n[0]=n[0]+p>>>0,n[1]=n[1]+f>>>0,n[2]=n[2]+g>>>0,n[3]=n[3]+m>>>0,n[4]=n[4]+y>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,255&n[0],n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,255&n[1],n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,255&n[2],n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,255&n[3],n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,255&n[4]]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=r(n(28));r(n(29));function r(e){return e&&e.__esModule?e:{default:e}}t.default=function(e){var t=e.message,n=e.user_id,r=t.sender.userId===n;return o.default.createElement("div",{className:"message "+(r?"from-me":"from-support")},o.default.createElement("div",{className:"text"},t.event.content.body))}},function(e,t,n){var o=n(116);"string"==typeof o&&(o=[[e.i,o,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};n(117)(o,r);o.locals&&(e.exports=o.locals)},function(e,t,n){},function(e,t,n){var o,r,i={},s=(o=function(){return window&&document&&document.all&&!window.atob},function(){return void 0===r&&(r=o.apply(this,arguments)),r}),a=function(e,t){return t?t.querySelector(e):document.querySelector(e)},c=function(e){var t={};return function(e,n){if("function"==typeof e)return e();if(void 0===t[e]){var o=a.call(this,e,n);if(window.HTMLIFrameElement&&o instanceof window.HTMLIFrameElement)try{o=o.contentDocument.head}catch(e){o=null}t[e]=o}return t[e]}}(),u=null,l=0,d=[],h=n(118);function p(e,t){for(var n=0;n<e.length;n++){var o=e[n],r=i[o.id];if(r){r.refs++;for(var s=0;s<r.parts.length;s++)r.parts[s](o.parts[s]);for(;s<o.parts.length;s++)r.parts.push(v(o.parts[s],t))}else{var a=[];for(s=0;s<o.parts.length;s++)a.push(v(o.parts[s],t));i[o.id]={id:o.id,refs:1,parts:a}}}}function f(e,t){for(var n=[],o={},r=0;r<e.length;r++){var i=e[r],s=t.base?i[0]+t.base:i[0],a={css:i[1],media:i[2],sourceMap:i[3]};o[s]?o[s].parts.push(a):n.push(o[s]={id:s,parts:[a]})}return n}function g(e,t){var n=c(e.insertInto);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var o=d[d.length-1];if("top"===e.insertAt)o?o.nextSibling?n.insertBefore(t,o.nextSibling):n.appendChild(t):n.insertBefore(t,n.firstChild),d.push(t);else if("bottom"===e.insertAt)n.appendChild(t);else{if("object"!=typeof e.insertAt||!e.insertAt.before)throw new Error("[Style Loader]\n\n Invalid value for parameter 'insertAt' ('options.insertAt') found.\n Must be 'top', 'bottom', or Object.\n (https://github.com/webpack-contrib/style-loader#insertat)\n");var r=c(e.insertAt.before,n);n.insertBefore(t,r)}}function m(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e);var t=d.indexOf(e);t>=0&&d.splice(t,1)}function y(e){var t=document.createElement("style");if(void 0===e.attrs.type&&(e.attrs.type="text/css"),void 0===e.attrs.nonce){var o=function(){0;return n.nc}();o&&(e.attrs.nonce=o)}return _(t,e.attrs),g(e,t),t}function _(e,t){Object.keys(t).forEach((function(n){e.setAttribute(n,t[n])}))}function v(e,t){var n,o,r,i;if(t.transform&&e.css){if(!(i="function"==typeof t.transform?t.transform(e.css):t.transform.default(e.css)))return function(){};e.css=i}if(t.singleton){var s=l++;n=u||(u=y(t)),o=b.bind(null,n,s,!1),r=b.bind(null,n,s,!0)}else e.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=function(e){var t=document.createElement("link");return void 0===e.attrs.type&&(e.attrs.type="text/css"),e.attrs.rel="stylesheet",_(t,e.attrs),g(e,t),t}(t),o=I.bind(null,n,t),r=function(){m(n),n.href&&URL.revokeObjectURL(n.href)}):(n=y(t),o=w.bind(null,n),r=function(){m(n)});return o(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;o(e=t)}else r()}}e.exports=function(e,t){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(t=t||{}).attrs="object"==typeof t.attrs?t.attrs:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=s()),t.insertInto||(t.insertInto="head"),t.insertAt||(t.insertAt="bottom");var n=f(e,t);return p(n,t),function(e){for(var o=[],r=0;r<n.length;r++){var s=n[r];(a=i[s.id]).refs--,o.push(a)}e&&p(f(e,t),t);for(r=0;r<o.length;r++){var a;if(0===(a=o[r]).refs){for(var c=0;c<a.parts.length;c++)a.parts[c]();delete i[a.id]}}}};var S,E=(S=[],function(e,t){return S[e]=t,S.filter(Boolean).join("\n")});function b(e,t,n,o){var r=n?"":o.css;if(e.styleSheet)e.styleSheet.cssText=E(t,r);else{var i=document.createTextNode(r),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(i,s[t]):e.appendChild(i)}}function w(e,t){var n=t.css,o=t.media;if(o&&e.setAttribute("media",o),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}function I(e,t,n){var o=n.css,r=n.sourceMap,i=void 0===t.convertToAbsoluteUrls&&r;(t.convertToAbsoluteUrls||i)&&(o=h(o)),r&&(o+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(r))))+" */");var s=new Blob([o],{type:"text/css"}),a=e.href;e.href=URL.createObjectURL(s),a&&URL.revokeObjectURL(a)}},function(e,t){e.exports=function(e){var t="undefined"!=typeof window&&window.location;if(!t)throw new Error("fixUrls requires window.location");if(!e||"string"!=typeof e)return e;var n=t.protocol+"//"+t.host,o=n+t.pathname.replace(/\/[^\/]*$/,"/");return e.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,(function(e,t){var r,i=t.trim().replace(/^"(.*)"$/,(function(e,t){return t})).replace(/^'(.*)'$/,(function(e,t){return t}));return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/|\s*$)/i.test(i)?e:(r=0===i.indexOf("//")?i:0===i.indexOf("/")?n+i:o+i.replace(/^\.\//,""),"url("+JSON.stringify(r)+")")}))}}])}));